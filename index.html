<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agro Pro - IA Preditiva</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f0f13;
            color: #fff;
            line-height: 1.6;
        }

        .app {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #1a1a1f;
            padding: 24px;
            border-right: 1px solid #2a2a30;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #00b09b, #96c93d);
            border-radius: 10px;
        }

        .brand h1 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .brand p {
            font-size: 12px;
            color: #888;
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 30px;
        }

        .nav a {
            padding: 12px;
            color: #888;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .nav a:hover {
            background: #25252b;
            color: #fff;
        }

        .nav a.active {
            background: #00b09b;
            color: #fff;
        }

        .main {
            flex: 1;
            padding: 24px;
            background: #0f0f13;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .title h2 {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .title p {
            color: #888;
            font-size: 14px;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            background: #2a2a30;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #35353d;
        }

        .btn.primary {
            background: #00b09b;
        }

        .btn.primary:hover {
            background: #009688;
        }

        .card {
            background: #1a1a1f;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a2a30;
        }

        .kpi {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi .card {
            text-align: center;
        }

        .kpi .card h3 {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }

        .kpi .card .big {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .kpi .card .sub {
            font-size: 12px;
            color: #888;
        }

        .section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .tableWrap {
            overflow-x: auto;
            background: #1a1a1f;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a2a30;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            color: #888;
            font-weight: normal;
            font-size: 12px;
            border-bottom: 1px solid #2a2a30;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #2a2a30;
        }

        .pill {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .pill.success {
            background: rgba(0, 176, 155, 0.2);
            color: #00b09b;
        }

        .pill.warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .toastHost {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: #2a2a30;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 10px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid #00b09b;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ==================== FUN√á√ïES UTILIT√ÅRIAS ====================
        const Storage = {
            key: "agro_pro_v1",
            load() {
                try {
                    const raw = localStorage.getItem(this.key);
                    if (!raw) return null;
                    return JSON.parse(raw);
                } catch (e) { return null; }
            },
            save(db) {
                localStorage.setItem(this.key, JSON.stringify(db));
            }
        };

        function uid(prefix = "id") {
            return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
        }

        function nowISO() {
            const d = new Date();
            const pad = n => String(n).padStart(2, "0");
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
        }

        function escapeHtml(str) {
            return String(str ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function toast(title, msg) {
            const host = document.getElementById("toastHost") || (() => {
                const h = document.createElement("div");
                h.id = "toastHost";
                h.className = "toastHost";
                document.body.appendChild(h);
                return h;
            })();

            const el = document.createElement("div");
            el.className = "toast";
            el.innerHTML = `<b>${escapeHtml(title)}</b><p>${escapeHtml(msg)}</p>`;
            host.appendChild(el);

            setTimeout(() => { el.style.opacity = "0"; el.style.transform = "translateY(6px)"; }, 3200);
            setTimeout(() => { el.remove(); }, 3800);
        }

        function downloadText(filename, text) {
            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // ==================== DB / SEED ====================
        function seedDB() {
            const empresaId = uid("emp");
            const fazendaId = uid("faz");
            const talhaoId = uid("tal");
            const maqId = uid("maq");
            const opId = uid("peq");
            const prd1 = uid("prd");
            const prd2 = uid("prd");

            return {
                meta: { createdAt: new Date().toISOString(), version: 2 },
                session: { empresaId },
                empresas: [{
                    id: empresaId,
                    nome: "Agro Demo LTDA",
                    cnpj: "00.000.000/0001-00",
                    responsavel: "Admin",
                    cidade: "Sorriso",
                    uf: "MT",
                    observacoes: "Ambiente de demonstra√ß√£o."
                }],
                fazendas: [{
                    id: fazendaId,
                    empresaId,
                    nome: "Fazenda Horizonte",
                    cidade: "Sorriso",
                    uf: "MT",
                    areaHa: 1450,
                    observacoes: "Soja/Milho safrinha"
                }],
                talhoes: [{
                    id: talhaoId,
                    empresaId,
                    fazendaId,
                    nome: "T-12",
                    areaHa: 78.5,
                    cultura: "Soja",
                    safra: "2025/26",
                    solo: "Argiloso",
                    coordenadas: "",
                    observacoes: ""
                }, {
                    id: uid("tal"),
                    empresaId,
                    fazendaId,
                    nome: "T-15",
                    areaHa: 120.0,
                    cultura: "Milho",
                    safra: "2025/26",
                    solo: "Argiloso",
                    coordenadas: "",
                    observacoes: ""
                }],
                produtos: [{
                    id: prd1,
                    empresaId,
                    tipo: "Herbicida",
                    nome: "Glifosato 480",
                    ingrediente: "Glifosato",
                    fabricante: "Gen√©rico",
                    registro: "",
                    carenciaDias: 7,
                    reentradaHoras: 24,
                    unidade: "L",
                    preco: 45.90,
                    obs: ""
                }, {
                    id: prd2,
                    empresaId,
                    tipo: "Fungicida",
                    nome: "Triazol+Estrobilurina",
                    ingrediente: "Mistura",
                    fabricante: "Gen√©rico",
                    registro: "",
                    carenciaDias: 14,
                    reentradaHoras: 24,
                    unidade: "L",
                    preco: 89.90,
                    obs: ""
                }],
                estoque: [{
                    id: uid("stk"),
                    empresaId,
                    produtoId: prd1,
                    deposito: "Central",
                    lote: "",
                    validade: "",
                    qtd: 1200,
                    unidade: "L",
                    obs: "Demo"
                }, {
                    id: uid("stk"),
                    empresaId,
                    produtoId: prd2,
                    deposito: "Central",
                    lote: "",
                    validade: "",
                    qtd: 240,
                    unidade: "L",
                    obs: "Demo"
                }],
                equipe: [{
                    id: opId,
                    empresaId,
                    nome: "Operador 1",
                    funcao: "Tratorista",
                    telefone: "",
                    nr: "",
                    obs: ""
                }],
                maquinas: [{
                    id: maqId,
                    empresaId,
                    nome: "Pulverizador Autopropelido",
                    placa: "",
                    horimetro: 0,
                    capacidadeL: 3000,
                    bicos: "",
                    obs: ""
                }],
                clima: [{
                    id: uid("cli"),
                    empresaId,
                    data: nowISO(),
                    fazendaId,
                    talhaoId,
                    chuvaMm: 12,
                    tempMin: 22,
                    tempMax: 33,
                    umidade: 68,
                    vento: 9,
                    obs: "Chuva isolada √† tarde"
                }],
                dieselEstoque: [{
                    id: uid("dsl"),
                    empresaId,
                    deposito: "Tanque Principal",
                    litros: 5000,
                    obs: "Saldo pode ficar negativo"
                }],
                combustivel: [{
                    id: uid("cmb"),
                    empresaId,
                    data: nowISO(),
                    tipo: "Diesel S10",
                    deposito: "Tanque Principal",
                    posto: "Posto Exemplo",
                    maquinaId: maqId,
                    operadorId: opId,
                    fazendaId,
                    talhaoId,
                    litros: 120,
                    precoLitro: 6.19,
                    kmOuHora: 0,
                    obs: "Abastecimento demo"
                }],
                aplicacoes: [{
                    id: uid("apl"),
                    empresaId,
                    data: nowISO(),
                    fazendaId,
                    talhaoId: talhaoId,
                    areaHaAplicada: 25,
                    cultura: "Soja",
                    alvo: "Plantas daninhas",
                    operacao: "Pulveriza√ß√£o terrestre",
                    maquinaId: maqId,
                    operadorId: opId,
                    condicoes: { vento: 8, temp: 31, umidade: 60 },
                    caldaLHa: 120,
                    velocidadeKmH: 14,
                    bico: "Leque 11002",
                    pressaoBar: 3,
                    produtos: [{ produtoNome: "Glifosato 480", dosePorHa: 2.0, unidade: "L/ha" }],
                    custoTotal: 450.00,
                    obs: "Aplica√ß√£o padr√£o (demo)."
                }, {
                    id: uid("apl"),
                    empresaId,
                    data: "2026-02-10",
                    fazendaId,
                    talhaoId: uid("tal"),
                    areaHaAplicada: 40,
                    cultura: "Milho",
                    alvo: "Lagartas",
                    operacao: "Pulveriza√ß√£o terrestre",
                    maquinaId: maqId,
                    operadorId: opId,
                    condicoes: { vento: 5, temp: 28, umidade: 65 },
                    caldaLHa: 150,
                    velocidadeKmH: 12,
                    bico: "Leque 11002",
                    pressaoBar: 3,
                    produtos: [{ produtoNome: "Triazol+Estrobilurina", dosePorHa: 1.5, unidade: "L/ha" }],
                    custoTotal: 680.00,
                    obs: "Aplica√ß√£o preventiva"
                }]
            };
        }

        function getDB() {
            let db = Storage.load();
            if (!db) db = seedDB();
            Storage.save(db);
            return db;
        }

        function setDB(db) { Storage.save(db); }

        function getEmpresaId() {
            const db = getDB();
            return db.session?.empresaId || (db.empresas[0]?.id ?? null);
        }

        function setEmpresaId(id) {
            const db = getDB();
            db.session = db.session || {};
            db.session.empresaId = id;
            setDB(db);
        }

        // ==================== HELPERS ====================
        function onlyEmpresa(arr) {
            const eid = getEmpresaId();
            return (arr || []).filter(x => x.empresaId === eid);
        }

        function findNameById(arr, id, fallback = "-") {
            const o = (arr || []).find(x => x.id === id);
            return o ? (o.nome ?? fallback) : fallback;
        }

        function num(v, casas = 2) {
            return new Intl.NumberFormat("pt-BR", {
                minimumFractionDigits: casas,
                maximumFractionDigits: casas
            }).format(Number(v || 0));
        }

        function brl(v) {
            return new Intl.NumberFormat("pt-BR", {
                style: "currency",
                currency: "BRL"
            }).format(Number(v || 0));
        }

        function setTopActions(html) {
            const el = document.getElementById("topActions");
            if (el) el.innerHTML = html || "";
        }

        // ==================== P√ÅGINAS ====================
        const PAGES = [
            { key: "dashboard", label: "Dashboard", icon: "üìä" },
            { key: "ia", label: "IA Preditiva", icon: "ü§ñ" },
            { key: "empresas", label: "Empresas", icon: "üè¢" },
            { key: "fazendas", label: "Fazendas", icon: "üåæ" },
            { key: "talhoes", label: "Talh√µes", icon: "üß≠" },
            { key: "produtos", label: "Produtos", icon: "üß™" }
        ];

        let currentPage = "dashboard";

        function renderShell() {
            const db = getDB();
            const empresaId = getEmpresaId();
            const empresa = db.empresas.find(e => e.id === empresaId);

            const nav = PAGES.map(p => {
                const active = (p.key === currentPage) ? "active" : "";
                return `<a class="${active}" onclick="navigateTo('${p.key}')"><span class="ico">${p.icon}</span> ${escapeHtml(p.label)}</a>`;
            }).join("");

            const empresaOptions = db.empresas.map(e => {
                const sel = e.id === empresaId ? "selected" : "";
                return `<option value="${e.id}" ${sel}>${escapeHtml(e.nome)}</option>`;
            }).join("");

            const titles = {
                dashboard: { title: "Dashboard", subtitle: "Vis√£o geral do sistema" },
                ia: { title: "IA Preditiva", subtitle: "An√°lises inteligentes com machine learning" },
                empresas: { title: "Empresas", subtitle: "Gerencie organiza√ß√µes" },
                fazendas: { title: "Fazendas", subtitle: "Unidades produtivas" },
                talhoes: { title: "Talh√µes", subtitle: "√Åreas de cultivo" },
                produtos: { title: "Produtos", subtitle: "Insumos agr√≠colas" }
            };

            const currentTitles = titles[currentPage] || { title: "Agro Pro", subtitle: "" };

            const root = document.getElementById("app");
            root.innerHTML = `
                <div class="app">
                    <aside class="sidebar">
                        <div class="brand">
                            <div class="logo"></div>
                            <div>
                                <h1>Agro Pro</h1>
                                <p>Controle Agron√¥mico ‚Ä¢ Multiempresa</p>
                            </div>
                        </div>

                        <div class="tenant">
                            <div class="row">
                                <span class="badge"><span class="dot"></span> Ambiente Offline</span>
                                <button class="btn noPrint" id="btnBackup">Backup</button>
                            </div>
                            <div class="hr"></div>
                            <small>Empresa ativa</small>
                            <select class="select" id="empresaSelect">${empresaOptions}</select>
                            <div style="margin-top:10px" class="row">
                                <button class="btn primary" id="btnNovaEmpresa">+ Nova empresa</button>
                                <button class="btn danger" id="btnResetDemo">Reset demo</button>
                            </div>
                        </div>

                        <nav class="nav">${nav}</nav>
                    </aside>

                    <main class="main">
                        <div class="topbar">
                            <div class="title">
                                <h2>${escapeHtml(currentTitles.title)}</h2>
                                <p>${escapeHtml(currentTitles.subtitle)}</p>
                            </div>
                            <div class="actions noPrint" id="topActions"></div>
                        </div>

                        <div id="content"></div>
                    </main>
                </div>
            `;

            document.getElementById("empresaSelect").addEventListener("change", (e) => {
                setEmpresaId(e.target.value);
                toast("Empresa alterada", "Atualizando a p√°gina‚Ä¶");
                setTimeout(() => renderCurrentPage(), 200);
            });

            document.getElementById("btnResetDemo").addEventListener("click", () => {
                if (!confirm("Isso vai resetar o banco local e voltar para o demo. Continuar?")) return;
                localStorage.removeItem(Storage.key);
                seedDB();
                toast("Reset conclu√≠do", "Banco local restaurado para o demo.");
                setTimeout(() => renderCurrentPage(), 200);
            });

            document.getElementById("btnBackup").addEventListener("click", () => {
                const db2 = getDB();
                downloadText(`agro-pro-backup-${nowISO()}.json`, JSON.stringify(db2, null, 2));
                toast("Backup gerado", "Arquivo .json baixado.");
            });

            document.getElementById("btnNovaEmpresa").addEventListener("click", () => {
                const nome = prompt("Nome da nova empresa:");
                if (!nome) return;
                const db2 = getDB();
                const id = uid("emp");
                db2.empresas.push({ id, nome, cnpj: "", responsavel: "", cidade: "", uf: "", observacoes: "" });
                setDB(db2);
                setEmpresaId(id);
                toast("Empresa criada", "Agora voc√™ est√° nessa empresa.");
                setTimeout(() => renderCurrentPage(), 200);
            });

            renderCurrentPage();
        }

        function navigateTo(page) {
            currentPage = page;
            renderShell();
        }

        function renderCurrentPage() {
            if (currentPage === "dashboard") pageDashboard();
            else if (currentPage === "ia") pageIAPreditiva();
            else if (currentPage === "empresas") pageEmpresas();
            else if (currentPage === "fazendas") pageFazendas();
            else if (currentPage === "talhoes") pageTalhoes();
            else if (currentPage === "produtos") pageProdutos();
        }

        // ==================== P√ÅGINA IA ====================
        function pageIAPreditiva() {
            const db = getDB();
            const empresaId = getEmpresaId();

            if (!empresaId) {
                toast("Aten√ß√£o", "Selecione uma empresa primeiro");
                return;
            }

            const fazendas = onlyEmpresa(db.fazendas);
            const talhoes = onlyEmpresa(db.talhoes);
            const produtos = onlyEmpresa(db.produtos);
            const aplicacoes = onlyEmpresa(db.aplicacoes);
            const clima = onlyEmpresa(db.clima);
            const combustivel = onlyEmpresa(db.combustivel);

            setTopActions(`
                <button class="btn" id="btnAtualizar">üîÑ Atualizar</button>
                <button class="btn primary" id="btnExportar">üì• Exportar An√°lise</button>
            `);

            // Calcular estat√≠sticas
            const totalTalhoes = talhoes.length;
            const totalAplicacoes = aplicacoes.length;
            const totalArea = talhoes.reduce((s, t) => s + Number(t.areaHa || 0), 0);

            const custoAplicacoes = aplicacoes.reduce((s, a) => s + Number(a.custoTotal || 0), 0);
            const custoCombustivel = combustivel.reduce((s, c) => s + (Number(c.litros || 0) * Number(c.precoLitro || 0)), 0);
            const custoTotal = custoAplicacoes + custoCombustivel;

            const chuvas = clima.filter(c => c.chuvaMm).map(c => Number(c.chuvaMm));
            const totalChuva = chuvas.reduce((a, b) => a + b, 0);
            const mediaChuva = chuvas.length ? totalChuva / chuvas.length : 0;

            // Atividades por talh√£o
            const atividadesPorTalhao = {};
            aplicacoes.forEach(a => {
                if (a.talhaoId) {
                    atividadesPorTalhao[a.talhaoId] = (atividadesPorTalhao[a.talhaoId] || 0) + 1;
                }
            });

            const talhoesAtivos = talhoes
                .map(t => ({
                    nome: t.nome,
                    fazenda: findNameById(fazendas, t.fazendaId),
                    atividades: atividadesPorTalhao[t.id] || 0
                }))
                .sort((a, b) => b.atividades - a.atividades)
                .slice(0, 5);

            // Produtos mais usados
            const usoProdutos = {};
            aplicacoes.forEach(a => {
                (a.produtos || []).forEach(p => {
                    if (p.produtoNome) {
                        usoProdutos[p.produtoNome] = (usoProdutos[p.produtoNome] || 0) + 1;
                    }
                });
            });

            const produtosMaisUsados = Object.entries(usoProdutos)
                .map(([nome, qtd]) => ({ nome, qtd }))
                .sort((a, b) => b.qtd - a.qtd)
                .slice(0, 5);

            // Recomenda√ß√µes
            const recomendacoes = [];
            const hoje = new Date();

            talhoes.forEach(t => {
                const temAplicacao = aplicacoes.some(a => a.talhaoId === t.id);
                if (!temAplicacao) {
                    recomendacoes.push(`üå± Talh√£o ${t.nome} nunca recebeu aplica√ß√£o`);
                }
            });

            const chuvasRecentes = clima.filter(c => {
                const dataRegistro = new Date(c.data);
                const diff = Math.floor((hoje - dataRegistro) / (1000 * 60 * 60 * 24));
                return diff <= 7 && c.chuvaMm > 0;
            });

            if (chuvasRecentes.length > 0) {
                const totalChuvaRecente = chuvasRecentes.reduce((s, c) => s + Number(c.chuvaMm || 0), 0);
                recomendacoes.push(`üåßÔ∏è ${totalChuvaRecente.toFixed(1)}mm de chuva nos √∫ltimos 7 dias`);
            }

            if (recomendacoes.length === 0) {
                recomendacoes.push('‚úÖ Todas as opera√ß√µes est√£o em dia');
            }

            const content = document.getElementById("content");
            content.innerHTML = `
                <div class="kpi">
                    <div class="card">
                        <h3>üìä Talh√µes</h3>
                        <div class="big">${totalTalhoes}</div>
                        <div class="sub">${totalArea.toFixed(1)} ha totais</div>
                    </div>
                    <div class="card">
                        <h3>üí∞ Custo Total</h3>
                        <div class="big">${brl(custoTotal)}</div>
                        <div class="sub">R$ ${(totalArea ? (custoTotal / totalArea).toFixed(2) : '0.00')}/ha</div>
                    </div>
                    <div class="card">
                        <h3>üåßÔ∏è Chuvas</h3>
                        <div class="big">${mediaChuva.toFixed(1)} mm</div>
                        <div class="sub">M√©dia por registro</div>
                    </div>
                    <div class="card">
                        <h3>üìù Aplica√ß√µes</h3>
                        <div class="big">${totalAplicacoes}</div>
                        <div class="sub">${combustivel.length} abastecimentos</div>
                    </div>
                </div>

                <div class="section">
                    <div class="tableWrap">
                        <h3 style="margin-bottom: 15px;">üå± Top 5 Talh√µes Mais Ativos</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Talh√£o</th>
                                    <th>Fazenda</th>
                                    <th>Aplica√ß√µes</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${talhoesAtivos.map(t => `
                                    <tr>
                                        <td><b>${escapeHtml(t.nome)}</b></td>
                                        <td>${escapeHtml(t.fazenda)}</td>
                                        <td>${t.atividades}</td>
                                        <td><span class="pill ${t.atividades > 0 ? 'success' : 'warning'}">${t.atividades > 0 ? 'Ativo' : 'Inativo'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="tableWrap">
                        <h3 style="margin-bottom: 15px;">üß™ Produtos Mais Utilizados</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Vezes Usado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${produtosMaisUsados.map(p => `
                                    <tr>
                                        <td>${escapeHtml(p.nome)}</td>
                                        <td><b>${p.qtd}</b> vezes</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="card">
                        <h3>üí∞ Detalhamento de Custos</h3>
                        <table style="width:100%; margin-top:15px;">
                            <tr>
                                <td><b>Aplica√ß√µes:</b></td>
                                <td style="text-align:right">${brl(custoAplicacoes)}</td>
                            </tr>
                            <tr>
                                <td><b>Combust√≠vel:</b></td>
                                <td style="text-align:right">${brl(custoCombustivel)}</td>
                            </tr>
                            <tr>
                                <td><b>Total:</b></td>
                                <td style="text-align:right"><b>${brl(custoTotal)}</b></td>
                            </tr>
                        </table>
                    </div>

                    <div class="card">
                        <h3>üéØ Recomenda√ß√µes da IA</h3>
                        <ul style="margin-top:15px; padding-left:20px;">
                            ${recomendacoes.map(r => `<li style="margin-bottom:8px;">${escapeHtml(r)}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;

            document.getElementById("btnAtualizar").addEventListener("click", () => {
                toast("Atualizando", "Recarregando dados...");
                setTimeout(() => renderCurrentPage(), 500);
            });

            document.getElementById("btnExportar").addEventListener("click", () => {
                const relatorio = {
                    data: nowISO(),
                    estatisticas: {
                        talhoes: totalTalhoes,
                        area: totalArea,
                        custoTotal,
                        custoPorHa: totalArea ? custoTotal / totalArea : 0,
                        mediaChuva,
                        totalAplicacoes
                    },
                    talhoesAtivos,
                    produtosMaisUsados,
                    recomendacoes
                };

                downloadText(`ia-analise-${nowISO()}.json`, JSON.stringify(relatorio, null, 2));
                toast("Exportado", "An√°lise salva com sucesso!");
            });
        }

        // ==================== P√ÅGINAS SIMPLES ====================
        function pageDashboard() {
            const db = getDB();
            const fazendas = onlyEmpresa(db.fazendas);
            const talhoes = onlyEmpresa(db.talhoes);
            const aplicacoes = onlyEmpresa(db.aplicacoes);

            const content = document.getElementById("content");
            content.innerHTML = `
                <div class="kpi">
                    <div class="card">
                        <h3>Fazendas</h3>
                        <div class="big">${fazendas.length}</div>
                    </div>
                    <div class="card">
                        <h3>Talh√µes</h3>
                        <div class="big">${talhoes.length}</div>
                    </div>
                    <div class="card">
                        <h3>Aplica√ß√µes</h3>
                        <div class="big">${aplicacoes.length}</div>
                    </div>
                </div>
                <div class="card">
                    <h3>Bem-vindo ao Agro Pro</h3>
                    <p>Sistema de gest√£o agr√≠cola com IA integrada.</p>
                </div>
            `;
        }

        function pageEmpresas() {
            document.getElementById("content").innerHTML = '<div class="card"><h3>Empresas</h3><p>M√≥dulo em desenvolvimento...</p></div>';
        }

        function pageFazendas() {
            document.getElementById("content").innerHTML = '<div class="card"><h3>Fazendas</h3><p>M√≥dulo em desenvolvimento...</p></div>';
        }

        function pageTalhoes() {
            document.getElementById("content").innerHTML = '<div class="card"><h3>Talh√µes</h3><p>M√≥dulo em desenvolvimento...</p></div>';
        }

        function pageProdutos() {
            document.getElementById("content").innerHTML = '<div class="card"><h3>Produtos</h3><p>M√≥dulo em desenvolvimento...</p></div>';
        }

        // ==================== INICIALIZA√á√ÉO ====================
        renderShell();
    </script>
</body>
</html>