var SUPABASE_URL="https://midzgmbjylnbirvwrnvm.supabase.co",SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pZHpnbWJqeWxuYmlydndybnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyODk5MjYsImV4cCI6MjA4Nzg2NTkyNn0.umUWNkDSo7Myj_hW3wQ7b7g-7oT_rddIIJnbeWn0rrU",_supabaseClient=null,_supabaseReady=!1;function initSupabase(){if(_supabaseClient)return!0;if(!SUPABASE_URL||!SUPABASE_ANON)return!1;try{var a="undefined"!=typeof window&&(window.supabase||window.Supabase||window.SupabaseJS)||"undefined"!=typeof globalThis&&(globalThis.supabase||globalThis.Supabase),e=a&&a.createClient||"undefined"!=typeof createClient&&createClient||null;return!!e&&(_supabaseClient=e(SUPABASE_URL,SUPABASE_ANON),_supabaseReady=!0,window._supabaseReady=!0,window._supabaseClient=_supabaseClient,window._cloudConnected=!0,_supabaseClient.auth.onAuthStateChange(function(a,e){"SIGNED_OUT"===a||"USER_DELETED"===a?(["agro_session","agro_role","agro_trial","agro_plano"].forEach(function(a){localStorage.removeItem(a)}),window._cloudConnected=!1,"function"!=typeof pageLogin||window._loggingOut||(window._loggingOut=!0,pageLogin(),setTimeout(function(){window._loggingOut=!1},2e3))):"TOKEN_REFRESHED"===a&&e&&(window._cloudConnected=!0)}),!0)}catch(a){return!1}}function isSupabaseReady(){return _supabaseReady&&null!==_supabaseClient}function getSupabaseClient(){return _supabaseClient}function isUUID(a){return!(!a||"string"!=typeof a)&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a)}var AuthService={async signUp(a,e,r,t,i){if(!isSupabaseReady())return{data:null,error:{message:"Supabase nÃ£o configurado"}};var o=await _supabaseClient.auth.signUp({email:a,password:e,options:{data:{full_name:r,cpf:t||null,phone:i||null}}});return{data:o.data,error:o.error}},async checkCpfExists(a){if(!isSupabaseReady()||!a)return!1;try{return null!==(await _supabaseClient.from("profiles").select("id").eq("cpf",a).maybeSingle()).data}catch(a){return!1}},async checkPhoneExists(a){if(!isSupabaseReady()||!a)return!1;try{return null!==(await _supabaseClient.from("profiles").select("id").eq("phone",a).maybeSingle()).data}catch(a){return!1}},async signIn(a,e){if(!isSupabaseReady())return{data:null,error:{message:"Supabase nÃ£o configurado"}};var r=await _supabaseClient.auth.signInWithPassword({email:a,password:e});return{data:r.data,error:r.error}},signOut:async()=>isSupabaseReady()?(["agro_session","agro_role","agro_trial","agro_plano"].forEach(function(a){localStorage.removeItem(a)}),await _supabaseClient.auth.signOut({scope:"global"})):{error:null},async getSession(){if(!isSupabaseReady())return null;try{return(await _supabaseClient.auth.getSession()).data.session}catch(a){return null}},async getUser(){if(!isSupabaseReady())return null;try{return(await _supabaseClient.auth.getUser()).data.user}catch(a){return null}},async getUserProfile(){var a=await this.getUser();if(!a)return null;for(var e=0;e<3;e++)try{var r=await _supabaseClient.from("profiles").select("*").eq("id",a.id).single();if(!r.error&&r.data)return r.data;if("PGRST116"===r.error?.code&&e<2){await new Promise(function(a){setTimeout(a,700)});continue}return null}catch(a){return null}return null},async updateProfile(a){var e=await this.getUser();if(!e)return{error:{message:"NÃ£o autenticado"}};var r=await _supabaseClient.from("profiles").update(a).eq("id",e.id).select().single();return{data:r.data,error:r.error}}},TABLE_MAP={safras:"safras",fazendas:"fazendas",talhoes:"talhoes",produtos:"produtos",estoque:"estoque",aplicacoes:"aplicacoes",colheitas:"colheitas",combustivel:"combustivel",dieselEntradas:"diesel_entradas",dieselEstoque:"diesel_estoque",clima:"clima",manutencoes:"manutencoes",equipe:"equipe",maquinas:"maquinas",insumosBase:"insumos_base",lembretes:"lembretes",pragas:"pragas",folhaSalarial:"folha_salarial",analiseSolo:"analise_solo"},SYNC_ORDER=["safras","fazendas","talhoes","maquinas","equipe","produtos","estoque","aplicacoes","colheitas","combustivel","dieselEntradas","dieselEstoque","clima","manutencoes","insumosBase","lembretes","pragas","folhaSalarial","analiseSolo"],FIELD_MAP={safraId:"safra_id",fazendaId:"fazenda_id",talhaoId:"talhao_id",maquinaId:"maquina_id",produtoId:"produto_id",operadorId:"operador_id",areaHa:"area_ha",area:"area_ha",dataInicio:"data_inicio",dataFim:"data_fim",nomeCientifico:"nome_cientifico",tempMin:"temp_min",tempMax:"temp_max",umidadeMin:"umidade_min",precoSoja:"preco_soja",produtividadeMinSoja:"produtividade_min_soja",produtividadeMaxSoja:"produtividade_max_soja",precoMilho:"preco_milho",produtividadeMinMilho:"produtividade_min_milho",produtividadeMaxMilho:"produtividade_max_milho",precoSorgo:"preco_sorgo",produtividadeMinSorgo:"produtividade_min_sorgo",produtividadeMaxSorgo:"produtividade_max_sorgo",precoFeijao:"preco_feijao",produtividadeMinFeijao:"produtividade_min_feijao",produtividadeMaxFeijao:"produtividade_max_feijao",precoTrigo:"preco_trigo",produtividadeMinTrigo:"produtividade_min_trigo",produtividadeMaxTrigo:"produtividade_max_trigo",precoArroz:"preco_arroz",produtividadeMinArroz:"produtividade_min_arroz",produtividadeMaxArroz:"produtividade_max_arroz",precoCafe:"preco_cafe",produtividadeMinCafe:"produtividade_min_cafe",produtividadeMaxCafe:"produtividade_max_cafe",precoCanola:"preco_canola",produtividadeMinCanola:"produtividade_min_canola",produtividadeMaxCanola:"produtividade_max_canola",precoGirassol:"preco_girassol",produtividadeMinGirassol:"produtividade_min_girassol",produtividadeMaxGirassol:"produtividade_max_girassol",precoAmendoim:"preco_amendoim",produtividadeMinAmendoim:"produtividade_min_amendoim",produtividadeMaxAmendoim:"produtividade_max_amendoim",pesoPadraoSaca:"peso_padrao_saca",doseHa:"dose_ha",areaAplicada:"area_aplicada",quantidadeTotal:"quantidade_total",quantidade:"quantidade",quantidadeAtual:"quantidade_atual",custoUnitario:"custo_unitario",custoTotal:"custo_total",volumeCalda:"volume_calda",condicaoClima:"condicao_clima",areaColhida:"area_colhida",producaoTotal:"producao_total",pesoLiquido:"peso_liquido",sacasHa:"sacas_ha",umidadePadrao:"umidade_padrao",impureza:"impureza",ardidos:"ardidos",esverdeados:"esverdeados",quebrados:"quebrados",cpo:"cpo",taxaArmazenagem:"taxa_armazenagem",precoBaseSaca:"preco_base_saca",pesoLiquidoEstimado:"peso_liquido_estimado",armazem1:"armazem_1",tonArmazem1:"ton_armazem_1",frete1Ton:"frete_1_ton",armazem2:"armazem_2",tonArmazem2:"ton_armazem_2",frete2Ton:"frete_2_ton",precoVenda:"preco_venda",receitaTotal:"receita_total",precoLitro:"preco_litro",precoVigente:"preco_vigente",notaFiscal:"nota_fiscal",chuvaMm:"chuva_mm",ventoKmh:"vento_kmh",maquinaNome:"maquina_nome",horimetroAtual:"horimetro_atual",tipoManutencao:"tipo_manutencao",intervaloHoras:"intervalo_horas",proximaData:"proxima_data",proximaRevisaoHoras:"proxima_revisao_horas",proximaRevisaoData:"proxima_revisao_data",pecasTrocadas:"pecas_trocadas",servicoRealizado:"servico_realizado",custoPecas:"custo_pecas",custoMaoObra:"custo_mao_obra",outrosCustos:"outros_custos",tempoParada:"tempo_parada",tipoInsumo:"tipo_insumo",kmOuHora:"km_ou_hora",dataAdmissao:"data_admissao",dataEntrada:"data_entrada",tipoProduto:"tipo_produto",obs:"observacoes",funcionarioId:"funcionario_id",funcionarioNome:"funcionario_nome",funcionarioFuncao:"funcionario_funcao",competencia:"competencia",salarioBase:"salario_base",diasTrabalhados:"dias_trabalhados",horasExtras:"horas_extras",valorHoraExtra:"valor_hora_extra",valorHorasExtras:"valor_horas_extras",adiantamento:"adiantamento",valeTransporte:"vale_transporte",valeAlimentacao:"vale_alimentacao",outrosBeneficios:"outros_beneficios",inss:"inss",descontosExtras:"descontos_extras",totalDescontos:"total_descontos",salarioBruto:"salario_bruto",salarioLiquido:"salario_liquido",dataPagamento:"data_pagamento",talhaoNome:"talhao_nome",talhaoArea:"talhao_area",talhaoCultura:"talhao_cultura",fazendaNome:"fazenda_nome",laboratorio:"laboratorio",profundidade:"profundidade",textura:"textura",numeroLaudo:"numero_laudo",mo:"mo",hAl:"h_al",ctc:"ctc",vPct:"v_pct",mPct:"m_pct",areia:"areia",silte:"silte",argila:"argila",recomCalagem:"recom_calagem",recomGessagem:"recom_gessagem",recomAdubacao:"recom_adubacao",criadoEm:"criado_em",userId:"user_id",createdAt:"created_at",updatedAt:"updated_at",areaHaAplicada:"area_ha_aplicada",dataColheita:"data_colheita",carenciaDias:"carencia_dias",reentradaHoras:"reentrada_horas",pragasAlvo:"pragas_alvo",capacidadeL:"capacidade_l",nomeEmpresa:"nome_empresa",cnpjEmpresa:"cnpj_empresa",enderecoEmpresa:"endereco_empresa",telefoneEmpresa:"telefone_empresa",funcionarioId:"funcionario_id"},REF_FIELDS=["safraId","fazendaId","talhaoId","maquinaId","produtoId","operadorId","funcionarioId"],REF_SNAKE=["safra_id","fazenda_id","talhao_id","maquina_id","produto_id","operador_id","funcionario_id"];function toSnakeCase(a){if(!a||"object"!=typeof a)return a;var e={};for(var r in a)a.hasOwnProperty(r)&&(e[FIELD_MAP[r]||r.replace(/([A-Z])/g,"_$1").toLowerCase()]=a[r]);return e}var _reverseMap=null;function _getReverseMap(){if(_reverseMap)return _reverseMap;for(var a in _reverseMap={},FIELD_MAP)FIELD_MAP.hasOwnProperty(a)&&(_reverseMap[FIELD_MAP[a]]=a);return _reverseMap}function toCamelCase(a){if(!a||"object"!=typeof a)return a;var e={},r=_getReverseMap();for(var t in a)a.hasOwnProperty(t)&&(e[r[t]||t.replace(/_([a-z])/g,function(a,e){return e.toUpperCase()})]=a[t]);return e}var _syncTimer=null,_syncPending=!1,_lastSyncedHash=null;function _quickHash(a){var e=JSON.stringify(a);return e.length+"_"+e.slice(0,300)}function cloudSync(){_syncTimer&&clearTimeout(_syncTimer),_syncPending=!0,_syncTimer=setTimeout(function(){_doCloudSync()},3e3)}async function cloudSyncImmediate(){return _syncTimer&&clearTimeout(_syncTimer),await _doCloudSync()}async function _doCloudSync(){try{if(!isSupabaseReady())return _syncPending=!1,!1;var a=await AuthService.getUser();if(!a)return _syncPending=!1,!1;var e,r=localStorage.getItem("agro_pro_v10");if(!r)return _syncPending=!1,!1;try{e=JSON.parse(r)}catch(a){return _syncPending=!1,!1}var t=_quickHash(e);if(t===_lastSyncedHash&&!function(a){for(var e in TABLE_MAP){var r=a[e];if(r&&Array.isArray(r))for(var t=0;t<r.length;t++)if(r[t]&&r[t].id&&!isUUID(r[t].id))return!0}return!1}(e))return _syncPending=!1,!0;var i=await _supabaseClient.from("user_data_backup").upsert({user_id:a.id,data:e,updated_at:(new Date).toISOString()},{onConflict:"user_id"});return i.error&&console.warn("[Sync] backup JSON erro:",i.error.message),await _syncGranular(a.id,e),_lastSyncedHash=t,_syncPending=!1,window._cloudConnected=!0,_updateCloudIndicator(!0),!0}catch(a){return console.warn("[Sync] falha geral:",a.message),_syncPending=!1,_updateCloudIndicator(!1),!1}}function _prepareForInsert(a,e,r){var t=toSnakeCase(a);t.user_id=e,t.updated_at=(new Date).toISOString(),t.id&&!isUUID(t.id)&&delete t.id,delete t.created_at;for(var i=0;i<REF_SNAKE.length;i++){var o=REF_SNAKE[i],n=t[o];n&&(isUUID(n)||(r[n]?t[o]=r[n]:delete t[o]))}for(var s in t)void 0===t[s]&&delete t[s];return t}async function _syncGranular(a,e){if(isSupabaseReady()){for(var r={},t=0;t<SYNC_ORDER.length;t++){var i=SYNC_ORDER[t],o=TABLE_MAP[i];if(o){var n=e[i];if(n&&Array.isArray(n)&&0!==n.length)try{for(var s=await _supabaseClient.from(o).select("id").eq("user_id",a),d=s.error?[]:s.data||[],u=0;u<n.length;u++){var l=n[u];if(l&&l.id)if(isUUID(l.id)){if(d.find(function(a){return a.id===l.id})){var c=_prepareForInsert(l,a,r);c.id=l.id,await _supabaseClient.from(o).upsert(c,{onConflict:"id"}),r[l.id]=l.id;continue}var _=_prepareForInsert(l,a,r);_.id=l.id;var p=await _supabaseClient.from(o).upsert(_,{onConflict:"id"}).select("id").single();!p.error&&p.data&&(r[l.id]=p.data.id)}else{var m=_prepareForInsert(l,a,r),f=await _supabaseClient.from(o).insert(m).select("id").single();f.error?console.warn("[Sync] insert falhou em "+o+":",f.error.message,f.error.details||""):f.data&&(r[l.id]=f.data.id)}}}catch(a){console.warn("[Sync] erro na tabela "+o+":",a.message)}}}if(e.parametros&&"object"==typeof e.parametros)try{var g=toSnakeCase(e.parametros);g.user_id=a,delete g.id,delete g.created_at,delete g.updated_at,await _supabaseClient.from("parametros").upsert(g,{onConflict:"user_id"})}catch(a){}_updateLocalIds(e,r)}}function _updateLocalIds(a,e){var r=!1;for(var t in TABLE_MAP)if(TABLE_MAP.hasOwnProperty(t)){var i=a[t];if(i&&Array.isArray(i))for(var o=0;o<i.length;o++){var n=i[o];if(n&&n.id){e[n.id]&&e[n.id]!==n.id&&(n.id=e[n.id],r=!0);for(var s=0;s<REF_FIELDS.length;s++){var d=REF_FIELDS[s];n[d]&&e[n[d]]&&e[n[d]]!==n[d]&&(n[d]=e[n[d]],r=!0)}}}}a.session&&a.session.safraId&&e[a.session.safraId]&&(a.session.safraId=e[a.session.safraId],r=!0),r&&(a.meta=a.meta||{},a.meta.lastSync=(new Date).toISOString(),localStorage.setItem("agro_pro_v10",JSON.stringify(a)))}async function cloudRestore(){try{if(!isSupabaseReady())return!1;var a=await AuthService.getUser();if(!a)return!1;if(await _restoreFromTables(a.id))return window._cloudConnected=!0,_updateCloudIndicator(!0),!0;var e=await _supabaseClient.from("user_data_backup").select("data").eq("user_id",a.id).single();if(e.error||!e.data||!e.data.data)return!1;var r=localStorage.getItem("agro_pro_v10"),t=r?JSON.parse(r):null,i=e.data.data,o=!t||!t.fazendas||0===t.fazendas.length,n=i.fazendas&&i.fazendas.length>0;return!(!o||!n||(i.meta=i.meta||{},i.meta.lastSync=(new Date).toISOString(),i.meta.source="cloud_backup",localStorage.setItem("agro_pro_v10",JSON.stringify(i)),window._cloudConnected=!0,_updateCloudIndicator(!0),0))}catch(a){return!1}}async function _restoreFromTables(a){if(!isSupabaseReady())return!1;try{var e=await _supabaseClient.from("safras").select("id").eq("user_id",a).limit(1);if(e.error||!e.data||0===e.data.length)return!1;var r=localStorage.getItem("agro_pro_v10"),t=r?JSON.parse(r):null,i=t&&t.talhoes?t.talhoes.length:0,o=(await _supabaseClient.from("talhoes").select("id",{count:"exact",head:!0}).eq("user_id",a)).count||0,n=t&&t.fazendas?t.fazendas.length:0,s=(await _supabaseClient.from("fazendas").select("id",{count:"exact",head:!0}).eq("user_id",a)).count||0,d=(t&&t.fazendas||[]).some(function(a){return a.id&&!isUUID(a.id)})||(t&&t.safras||[]).some(function(a){return a.id&&!isUUID(a.id)});if(n>0&&n>=s&&i>=o&&!d)return"function"==typeof cloudSyncImmediate&&cloudSyncImmediate().catch(function(){}),!1;var u=async function(e){var r=await _supabaseClient.from(e).select("*").eq("user_id",a).order("created_at",{ascending:!1});return r.error?[]:(r.data||[]).map(toCamelCase)},l=await Promise.all([u("safras"),u("fazendas"),u("talhoes"),u("produtos"),u("estoque"),u("aplicacoes"),u("colheitas"),u("combustivel"),u("diesel_entradas"),u("diesel_estoque"),u("clima"),u("manutencoes"),u("equipe"),u("maquinas"),u("insumos_base"),u("lembretes"),u("pragas"),u("folha_salarial"),u("analise_solo")]);if(0===l[0].length)return!1;var c={precoSoja:120,produtividadeMinSoja:65,produtividadeMaxSoja:75,pesoPadraoSaca:60};try{var _=await _supabaseClient.from("parametros").select("*").eq("user_id",a).single();_.data&&(c=toCamelCase(_.data))}catch(a){}var p=l[0].find(function(a){return a.ativa})||l[0][0],m=t||{},f={meta:{createdAt:(new Date).toISOString(),version:11,source:"cloud_tables",lastSync:(new Date).toISOString()},session:m.session||{safraId:p?p.id:null},safras:_mergeByField(l[0],m.safras||[],"id"),fazendas:_mergeByField(l[1],m.fazendas||[],"id"),talhoes:_mergeByField(l[2],m.talhoes||[],"id"),produtos:_mergeByField(l[3],m.produtos||[],"id"),estoque:_mergeByField(l[4],m.estoque||[],"id"),aplicacoes:_mergeByField(l[5],m.aplicacoes||[],"id"),colheitas:_mergeByField(l[6],m.colheitas||[],"id"),combustivel:_mergeByField(l[7],m.combustivel||[],"id"),dieselEntradas:_mergeByField(l[8],m.dieselEntradas||[],"id"),dieselEstoque:_mergeByField(l[9],m.dieselEstoque||[],"id"),clima:_mergeByField(l[10],m.clima||[],"id"),manutencoes:_mergeByField(l[11],m.manutencoes||[],"id"),equipe:_mergeByField(l[12],m.equipe||[],"id"),maquinas:_mergeByField(l[13],m.maquinas||[],"id"),insumosBase:_mergeByField(l[14],m.insumosBase||[],"id"),lembretes:_mergeByField(l[15],m.lembretes||[],"id"),pragas:_mergeByField(l[16],m.pragas||[],"id"),folhaSalarial:_mergeByField(l[17],m.folhaSalarial||[],"id"),analiseSolo:_mergeByField(l[18],m.analiseSolo||[],"id"),parametros:c};return f.session.safraId||(f.session.safraId=p?p.id:null),localStorage.setItem("agro_pro_v10",JSON.stringify(f)),!0}catch(a){return!1}}function _mergeByField(a,e,r){new Set(a.map(function(a){return a[r]}));var t=(e||[]).filter(function(a){return a[r]&&!isUUID(a[r])});return a.concat(t)}var SupaCRUD={async insert(a,e){if(!isSupabaseReady())return null;var r=TABLE_MAP[a];if(!r)return null;var t=await AuthService.getUser();if(!t)return null;var i=toSnakeCase(e);i.user_id=t.id,delete i.created_at,delete i.updated_at,i.id&&!isUUID(i.id)&&delete i.id;try{var o=await _supabaseClient.from(r).insert(i).select().single();return o.error?null:toCamelCase(o.data)}catch(a){return null}},async update(a,e,r){if(!isSupabaseReady())return null;var t=TABLE_MAP[a];if(!t)return null;var i=toSnakeCase(r);delete i.id,delete i.user_id,delete i.created_at,i.updated_at=(new Date).toISOString();try{var o=await _supabaseClient.from(t).update(i).eq("id",e).select().single();return o.error?null:toCamelCase(o.data)}catch(a){return null}},async delete(a,e){if(!isSupabaseReady())return!1;var r=TABLE_MAP[a];if(!r)return!1;try{return!(await _supabaseClient.from(r).delete().eq("id",e)).error}catch(a){return!1}},async upsertParametros(a){if(!isSupabaseReady())return null;var e=await AuthService.getUser();if(!e)return null;var r=toSnakeCase(a);r.user_id=e.id,delete r.id,delete r.created_at,delete r.updated_at;try{var t=await _supabaseClient.from("parametros").upsert(r,{onConflict:"user_id"}).select().single();return t.error?null:toCamelCase(t.data)}catch(a){return null}}};async function seedSupabase(){}function _updateCloudIndicator(a){window._cloudConnected=a;var e=document.getElementById("cloudStatusIndicator");e&&(e.textContent=a?"â˜ï¸ Conectado":"ðŸ“´ Offline",e.style.color=a?"#4ade80":"#f59e0b");var r=document.getElementById("cloudStatusText");r&&(r.textContent=a?"âœ… Conectado ao Supabase":"âš ï¸ Modo Offline")}window.SUPABASE_URL=SUPABASE_URL,window.SUPABASE_ANON=SUPABASE_ANON,window._supabaseReady=_supabaseReady,window._supabaseClient=_supabaseClient,window._cloudConnected=!1,window.initSupabase=initSupabase,window.isSupabaseReady=isSupabaseReady,window.isUUID=isUUID,window.getSupabaseClient=getSupabaseClient,window.AuthService=AuthService,window.TABLE_MAP=TABLE_MAP,window.FIELD_MAP=FIELD_MAP,window.SYNC_ORDER=SYNC_ORDER,window.toSnakeCase=toSnakeCase,window.toCamelCase=toCamelCase,window.cloudSync=cloudSync,window.cloudSyncImmediate=cloudSyncImmediate,window.cloudRestore=cloudRestore,window.SupaCRUD=SupaCRUD,window.seedSupabase=seedSupabase,window._updateCloudIndicator=_updateCloudIndicator;try{Object.getOwnPropertyDescriptor(window,"_lastSyncedHash")||Object.defineProperty(window,"_lastSyncedHash",{get:function(){return _lastSyncedHash},set:function(a){_lastSyncedHash=a},configurable:!0,enumerable:!0})}catch(a){window._lastSyncedHash=_lastSyncedHash}initSupabase(),window._supabaseReady=_supabaseReady,window._supabaseClient=_supabaseClient,window._cloudConnected=_supabaseReady,window._ensureSupabase=function(){return new Promise(function(a){if(isSupabaseReady())a(!0);else if(initSupabase())a(!0);else var e=0,r=setInterval(function(){if(e++,initSupabase()||isSupabaseReady())return clearInterval(r),void a(!0);e>=15&&(clearInterval(r),a(!1))},300)})};