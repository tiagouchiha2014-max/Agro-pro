function formatCPF(e){return e.replace(/\D/g,"").slice(0,11).replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2")}function formatPhone(e){return e.replace(/\D/g,"").slice(0,11).replace(/^(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d{4})$/,"$1-$2")}function validateCPF(e){if(11!==(e=e.replace(/\D/g,"")).length||/^(\d)\1{10}$/.test(e))return!1;let t=0;for(let o=0;o<9;o++)t+=+e[o]*(10-o);let o=10*t%11;if(10!==o&&11!==o||(o=0),o!==+e[9])return!1;t=0;for(let o=0;o<10;o++)t+=+e[o]*(11-o);return o=10*t%11,10!==o&&11!==o||(o=0),o===+e[10]}function pageLogin(){document.getElementById("app").innerHTML='\n    <div style="min-height:100vh; background:linear-gradient(135deg,#0f172a,#1e293b); display:flex; align-items:center; justify-content:center; padding:20px;">\n      <div style="max-width:440px; width:100%; background:white; border-radius:18px; padding:36px 32px; box-shadow:0 24px 64px rgba(0,0,0,.35);">\n\n        <div style="text-align:center; margin-bottom:26px;">\n          <div style="width:52px; height:52px; background:linear-gradient(135deg,#4ade80,#10b981); border-radius:14px; margin:0 auto 14px; display:flex; align-items:center; justify-content:center; font-size:26px; box-shadow:0 4px 14px rgba(16,185,129,.35);">üå±</div>\n          <h1 style="color:#1e293b; margin:0 0 4px; font-size:26px; font-weight:800;">Agro Pro</h1>\n          <p style="color:#64748b; font-size:13px; margin:0;">Gest√£o Agr√≠cola Inteligente</p>\n        </div>\n\n        \x3c!-- TABS --\x3e\n        <div style="display:flex; background:#f1f5f9; border-radius:10px; padding:4px; margin-bottom:24px; gap:4px;">\n          <button id="tabLogin" onclick="window._loginTab(\'login\')" style="flex:1; padding:9px; border:none; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer; background:#10b981; color:white; transition:all .2s;">Entrar</button>\n          <button id="tabCadastro" onclick="window._loginTab(\'cadastro\')" style="flex:1; padding:9px; border:none; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer; background:transparent; color:#64748b; transition:all .2s;">Criar Conta</button>\n        </div>\n\n        \x3c!-- FORM LOGIN --\x3e\n        <div id="loginForm">\n          <div style="margin-bottom:16px;">\n            <label style="display:block; margin-bottom:5px; font-weight:600; font-size:13px; color:#374151;">E-mail</label>\n            <input type="email" id="loginEmail" style="width:100%; padding:11px 13px; border:1.5px solid #cbd5e1; border-radius:8px; font-size:15px; box-sizing:border-box; outline:none;" placeholder="seu@email.com">\n          </div>\n          <div style="margin-bottom:22px;">\n            <label style="display:block; margin-bottom:5px; font-weight:600; font-size:13px; color:#374151;">Senha</label>\n            <input type="password" id="loginPass" style="width:100%; padding:11px 13px; border:1.5px solid #cbd5e1; border-radius:8px; font-size:15px; box-sizing:border-box; outline:none;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">\n          </div>\n          <button id="btnEntrar" style="width:100%; padding:14px; background:#10b981; color:white; border:none; border-radius:9px; font-weight:800; font-size:16px; cursor:pointer; letter-spacing:.3px;">ENTRAR</button>\n          <p style="text-align:center; margin-top:16px; font-size:13px; color:#94a3b8;">N√£o tem conta? <a href="#" onclick="window._loginTab(\'cadastro\')" style="color:#10b981; font-weight:700;">Criar conta gr√°tis</a></p>\n        </div>\n\n        \x3c!-- FORM CADASTRO --\x3e\n        <div id="signupForm" style="display:none;">\n          <div style="background:#fef9c3; border:1px solid #fde047; border-radius:9px; padding:11px 14px; margin-bottom:18px; font-size:12px; color:#713f12; line-height:1.5;">\n            ‚ö†Ô∏è <b>Conta gratuita = Plano Free</b><br>\n            Apenas 1 fazenda, 1 talh√£o e <b>somente visualiza√ß√£o</b>. Para criar e editar dados, assine Pro (R$199) ou Master (R$299).\n          </div>\n\n          <div style="margin-bottom:14px;">\n            <label style="display:block; margin-bottom:5px; font-weight:600; font-size:13px; color:#374151;">Nome Completo <span style="color:#ef4444;">*</span></label>\n            <input type="text" id="signName" style="width:100%; padding:11px 13px; border:1.5px solid #cbd5e1; border-radius:8px; font-size:14px; box-sizing:border-box; outline:none;" placeholder="Seu nome completo">\n          </div>\n          <div style="margin-bottom:14px;">\n            <label style="display:block; margin-bottom:5px; font-weight:600; font-size:13px; color:#374151;">CPF <span style="color:#ef4444;">*</span></label>\n            <input type="text" id="signCPF" maxlength="14" style="width:100%; padding:11px 13px; border:1.5px solid #cbd5e1; border-radius:8px; font-size:14px; box-sizing:border-box; outline:none;" placeholder="000.000.000-00">\n          </div>\n          <div style="margin-bottom:14px;">\n            <label style="display:block; margin-bottom:5px; font-weight:600; font-size:13px; color:#374151;">Telefone / WhatsApp <span style="color:#ef4444;">*</span></label>\n            <input type="tel" id="signPhone" maxlength="16" style="width:100%; padding:11px 13px; border:1.5px solid #cbd5e1; border-radius:8px; font-size:14px; box-sizing:border-box; outline:none;" placeholder="(99) 99999-9999">\n          </div>\n          <div style="margin-bottom:14px;">\n            <label style="display:block; margin-bottom:5px; font-weight:600; font-size:13px; color:#374151;">E-mail <span style="color:#ef4444;">*</span></label>\n            <input type="email" id="signEmail" style="width:100%; padding:11px 13px; border:1.5px solid #cbd5e1; border-radius:8px; font-size:14px; box-sizing:border-box; outline:none;" placeholder="seu@email.com">\n          </div>\n          <div style="margin-bottom:20px;">\n            <label style="display:block; margin-bottom:5px; font-weight:600; font-size:13px; color:#374151;">Senha <span style="color:#ef4444;">*</span> <small style="color:#94a3b8; font-weight:400;">(m√≠n. 8 chars, letras+n√∫meros)</small></label>\n            <input type="password" id="signPass" style="width:100%; padding:11px 13px; border:1.5px solid #cbd5e1; border-radius:8px; font-size:14px; box-sizing:border-box; outline:none;" placeholder="M√≠nimo 8 caracteres">\n          </div>\n          <button id="btnCadastrar" style="width:100%; padding:14px; background:#10b981; color:white; border:none; border-radius:9px; font-weight:800; font-size:15px; cursor:pointer;">CRIAR CONTA (PLANO FREE)</button>\n          <p style="text-align:center; margin-top:14px; font-size:12px; color:#94a3b8;">J√° tem conta? <a href="#" onclick="window._loginTab(\'login\')" style="color:#10b981; font-weight:700;">Fazer login</a></p>\n        </div>\n\n        <p style="text-align:center; margin-top:22px; font-size:11px; color:#cbd5e1;">Tiago Santos ‚Äî Fundador & Desenvolvedor ¬∑ Agro Pro v8.0</p>\n      </div>\n    </div>\n  ',document.getElementById("signCPF").addEventListener("input",function(){this.value=formatCPF(this.value)}),document.getElementById("signPhone").addEventListener("input",function(){this.value=formatPhone(this.value)}),window._loginTab=e=>{const t="login"===e;document.getElementById("loginForm").style.display=t?"block":"none",document.getElementById("signupForm").style.display=t?"none":"block";const o=document.getElementById("tabLogin"),n=document.getElementById("tabCadastro");o.style.background=t?"#10b981":"transparent",o.style.color=t?"white":"#64748b",n.style.background=t?"transparent":"#10b981",n.style.color=t?"#64748b":"white"};let e=0,t=0;document.getElementById("btnEntrar").onclick=async()=>{const o=Date.now();if(o<t){const e=Math.ceil((t-o)/1e3);return toast("Aguarde",`Muitas tentativas. Tente novamente em ${e}s.`)}const n=document.getElementById("loginEmail").value.trim(),a=document.getElementById("loginPass").value;if(!n||!a)return toast("Erro","Preencha e-mail e senha.");if(toast("Aguarde","Conectando ao servidor..."),!("function"==typeof _ensureSupabase?await _ensureSupabase():"function"==typeof isSupabaseReady&&isSupabaseReady()))return toast("Erro de conex√£o","N√£o foi poss√≠vel conectar ao servidor. Verifique sua internet e recarregue a p√°gina.");try{const{data:o,error:r}=await AuthService.signIn(n,a);if(r){if(e++,e>=5)return t=Date.now()+6e4,e=0,toast("Bloqueado","5 tentativas falhadas. Aguarde 60 segundos antes de tentar novamente.");const o=r.message||"";return o.toLowerCase().includes("email not confirmed")||o.toLowerCase().includes("not confirmed")?toast("E-mail n√£o confirmado","Verifique sua caixa de entrada e confirme o e-mail antes de entrar. Verifique tamb√©m o spam."):o.toLowerCase().includes("invalid login")||o.toLowerCase().includes("invalid credentials")?toast("Erro",`E-mail ou senha incorretos. (${e}/5 tentativas)`):toast("Erro","N√£o foi poss√≠vel entrar: "+o)}if(e=0,!o?.user)return toast("Erro","Resposta inv√°lida do servidor. Tente novamente.");toast("Aguarde","Carregando seu perfil...");let i=null;for(let e=0;e<3&&(i=await AuthService.getUserProfile(),!i);e++)await new Promise(e=>setTimeout(e,800));const s=i?.full_name||o.user.user_metadata?.full_name||n.split("@")[0],l=i?.user_role||"admin";if("desativado"===l)return await AuthService.signOut(),void toast("Acesso bloqueado","Sua conta foi desativada pelo administrador. Entre em contato com o respons√°vel.");localStorage.setItem("agro_session",JSON.stringify({user:{id:o.user.id,email:o.user.email,nome:s,role:l}})),localStorage.setItem("agro_role",l);const d={free:"Free",trial:"Free",basico:"Free",pro:"Pro",master:"Master"},c=i?.plan_type?.toLowerCase()||"free";localStorage.setItem("agro_plano",d[c]||"Free"),localStorage.removeItem("agro_trial"),toast("Sincronizando","Carregando dados da nuvem...");try{await cloudRestore()||"function"!=typeof cloudSyncImmediate||await cloudSyncImmediate()}catch(e){}toast("Bem-vindo!",`Ol√°, ${s}!`),setTimeout(()=>location.reload(),600)}catch(e){toast("Erro","Falha no login: "+(e.message||"tente novamente."))}},document.getElementById("btnCadastrar").onclick=async()=>{const e=document.getElementById("signName").value.trim(),t=document.getElementById("signCPF").value.trim(),o=document.getElementById("signPhone").value.trim(),n=document.getElementById("signEmail").value.trim(),a=document.getElementById("signPass").value;if(!(e&&t&&o&&n&&a))return toast("Erro","Preencha todos os campos obrigat√≥rios (*).");if(!validateCPF(t))return toast("Erro","CPF inv√°lido. Verifique o n√∫mero digitado.");if(o.replace(/\D/g,"").length<10)return toast("Erro","Telefone inv√°lido. Informe DDD + n√∫mero (ex: (99) 99999-9999).");if(a.length<8)return toast("Erro","A senha deve ter no m√≠nimo 8 caracteres.");if(!/[A-Za-z]/.test(a)||!/[0-9]/.test(a))return toast("Erro","A senha deve conter letras e n√∫meros.");if(toast("Aguarde","Conectando ao servidor..."),!("function"==typeof _ensureSupabase?await _ensureSupabase():"function"==typeof isSupabaseReady&&isSupabaseReady()))return toast("Erro de conex√£o","N√£o foi poss√≠vel conectar ao servidor. Verifique sua internet e recarregue a p√°gina.");toast("Aguarde","Verificando dados e criando conta...");try{if(await AuthService.checkCpfExists(t.replace(/\D/g,"")))return toast("Erro","Este CPF j√° est√° cadastrado. Fa√ßa login ou recupere o acesso.");if(await AuthService.checkPhoneExists(o.replace(/\D/g,"")))return toast("Erro","Este telefone j√° est√° cadastrado. Fa√ßa login ou use outro n√∫mero.");toast("Aguarde","Criando sua conta...");const{data:r,error:i}=await AuthService.signUp(n,a,e,t.replace(/\D/g,""),o.replace(/\D/g,""));if(i)return i.message.includes("already registered")||i.message.includes("already been registered")?toast("Erro","Este e-mail j√° possui conta. Fa√ßa login."):toast("Erro","Falha ao criar conta: "+i.message);toast("Aguarde","Finalizando acesso...");let s=r?.user?.id,l=!!r?.session;if(!l){const{data:e,error:t}=await AuthService.signIn(n,a);if(!t&&e?.session&&(l=!0,s=e.user?.id||s),!l)return void toast("Conta criada!","Verifique seu e-mail para confirmar o cadastro antes de entrar.",8e3)}iniciarTrial(n,e),localStorage.setItem("agro_session",JSON.stringify({user:{id:s,email:n,nome:e,role:"admin"}})),localStorage.setItem("agro_role","admin"),await new Promise(e=>setTimeout(e,1200));try{"function"==typeof cloudSyncImmediate&&await cloudSyncImmediate()}catch(e){}toast("Conta criada!",`Bem-vindo ao Agro Pro, ${e}! Voc√™ est√° no Plano Free.`),setTimeout(()=>location.reload(),1200)}catch(e){toast("Erro","N√£o foi poss√≠vel criar a conta: "+(e.message||"tente novamente."))}}}