function pageRelatorios(){const t=getDB(),a=getSafraAtual(),e=onlySafra(t.fazendas);let i=onlySafra(t.talhoes);fazendaAtual&&(i=i.filter(t=>t.fazendaId===fazendaAtual));const d=onlySafra(t.aplicacoes),n=onlySafra(t.clima),l=onlySafra(t.combustivel),o=onlySafra(t.colheitas),r=(onlySafra(t.produtos),onlySafra(t.manutencoes||[])),s=onlySafra(t.insumosBase||[]),c=onlySafra(t.maquinas),u=t.parametros||{precoSoja:120,precoMilho:60,precoAlgodao:150,produtividadeMinSoja:65,produtividadeMaxSoja:75,produtividadeMinMilho:100,produtividadeMaxMilho:130,produtividadeMinAlgodao:250,produtividadeMaxAlgodao:300,pesoPadraoSaca:60};setTopActions('\n    <button class="btn" id="btnExportCSV">üì• Exportar CSV</button>\n    <button class="btn" id="btnExportPDF" style="background:var(--brand,#2e7d32);color:white;">üìÑ Gerar PDF</button>\n    <button class="btn primary" id="btnPrint">üñ®Ô∏è Imprimir</button>\n  ');const v=i.reduce((t,a)=>t+Number(a.areaHa||0),0),b=d.reduce((t,a)=>t+Number(a.custoTotal||0),0),h=l.reduce((t,a)=>t+Number(a.litros||0)*Number(a.precoLitro||0),0),p=r.reduce((t,a)=>t+Number(a.custoTotal||0),0),m=s.reduce((t,a)=>t+Number(a.custoTotal||0),0),g=o.reduce((t,a)=>{let e=0;return a.frete1&&(e+=Number(a.frete1.custoFrete||0)),a.frete2&&(e+=Number(a.frete2.custoFrete||0)),t+e},0),$=b+h+p+m+g,k=v>0?$/v:0;let x=0,f=0;const y=new Map;o.forEach(t=>{const a="sc"===t.unidade?Number(t.producaoTotal||0)*u.pesoPadraoSaca:Number(t.producaoTotal||0);x+=a;const e=i.find(a=>a.id===t.talhaoId);if(e){const i=e.cultura?.toLowerCase()||"";let d=u.precoSoja;"milho"===i&&(d=u.precoMilho),"algodao"===i&&(d=u.precoAlgodao);const n=("kg"===t.unidade?Number(t.producaoTotal||0)/u.pesoPadraoSaca:Number(t.producaoTotal||0))*d;f+=n;const l=y.get(t.talhaoId)||{producaoKg:0,receitaReal:0};y.set(t.talhaoId,{producaoKg:l.producaoKg+a,receitaReal:l.receitaReal+n})}});const C={soja:(u.produtividadeMinSoja+u.produtividadeMaxSoja)/2,milho:(u.produtividadeMinMilho+u.produtividadeMaxMilho)/2,algodao:(u.produtividadeMinAlgodao+u.produtividadeMaxAlgodao)/2};let T=0;i.forEach(t=>{const a=t.cultura?.toLowerCase()||"";let e=u.precoSoja,i=C.soja;"milho"===a?(e=u.precoMilho,i=C.milho):"algodao"===a&&(e=u.precoAlgodao,i=C.algodao),T+=(t.areaHa||0)*i*e});const M=T-$,R=f-$,S=n.reduce((t,a)=>t+Number(a.chuvaMm||0),0),A=n.filter(t=>t.chuvaMm>0).length,N=n.length?S/n.length:0,I=n.reduce((t,a)=>t+Number(a.tempMax||0),0)/(n.length||1),E=n.reduce((t,a)=>t+Number(a.tempMin||0),0)/(n.length||1),F=onlySafra(t.dieselEntradas||[]),L=F.reduce((t,a)=>t+Number(a.litros||0),0),O=L,P=l.reduce((t,a)=>t+Number(a.litros||0),0),j=v>0?P/v:0,w=L>0?F.reduce((t,a)=>t+Number(a.precoLitro||0)*Number(a.litros||0),0)/L:0,H=d.length,q=d.reduce((t,a)=>t+Number(a.areaHaAplicada||0),0),z=H?b/H:0,_={};d.forEach(t=>{(t.produtos||[]).forEach(t=>{_[t.produtoNome]=(_[t.produtoNome]||0)+1})});const D=Object.entries(_).sort((t,a)=>a[1]-t[1]).slice(0,5),B=r.length,V=r.filter(t=>"Preventiva"===t.tipoManutencao).length,K=r.filter(t=>"Corretiva"===t.tipoManutencao).length,U=r.filter(t=>"Preditiva"===t.tipoManutencao).length,J=v>0?p/v:0,G=new Map;r.forEach(t=>{const a=G.get(t.maquinaId)||{custo:0,qtd:0};a.custo+=Number(t.custoTotal||0),a.qtd+=1,G.set(t.maquinaId,a)});const W=s.length,Q=v>0?m/v:0,X={};s.forEach(t=>{const a=t.tipoInsumo||"Outros";X[a]=(X[a]||0)+Number(t.custoTotal||0)});const Y=o.reduce((t,a)=>{let e=0;return a.frete1&&(e+=Number(a.frete1.toneladas||0)),a.frete2&&(e+=Number(a.frete2.toneladas||0)),t+e},0),Z=Y>0?g/Y:0,tt=v>0?g/v:0,at=i.map(t=>{const a=d.filter(a=>a.talhaoId===t.id).reduce((t,a)=>t+Number(a.custoTotal||0),0),i=l.filter(a=>a.talhaoId===t.id).reduce((t,a)=>t+Number(a.litros||0)*Number(a.precoLitro||0),0),n=s.filter(a=>a.talhaoId===t.id).reduce((t,a)=>t+Number(a.custoTotal||0),0),r=o.filter(a=>a.talhaoId===t.id).reduce((t,a)=>{let e=0;return a.frete1&&(e+=Number(a.frete1.custoFrete||0)),a.frete2&&(e+=Number(a.frete2.custoFrete||0)),t+e},0),c=v>0?p*(Number(t.areaHa||0)/v):0,b=a+i+n+r+c,h=y.get(t.id),m=h?h.producaoKg:0,g=t.cultura?.toLowerCase()||"";let $=u.precoSoja,k=C.soja;"milho"===g?($=u.precoMilho,k=C.milho):"algodao"===g&&($=u.precoAlgodao,k=C.algodao);const x=(t.areaHa||0)*k*$,f=h?h.receitaReal:0,T=f-b;return{talhao:t.nome,fazenda:findNameById(e,t.fazendaId),cultura:t.cultura||"-",area:t.areaHa||0,custo:b,custoApl:a,custoComb:i,custoInsumo:n,custoFreteT:r,custoManutRateio:c,producaoKg:m,receitaEstimada:x,receitaReal:f,lucroReal:T,temColheita:!!h}}).sort((t,a)=>a.custo-t.custo),et=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],it=new Array(12).fill(0),dt=new Array(12).fill(0),nt=new Array(12).fill(0);n.forEach(t=>{if(t.data){const a=parseInt(t.data.substring(5,7))-1;it[a]+=Number(t.chuvaMm||0)}}),[...d,...l].forEach(t=>{if(t.data){const a=parseInt(t.data.substring(5,7))-1,e=t.custoTotal||t.litros*t.precoLitro||0;dt[a]+=e,t.litros&&(nt[a]+=Number(t.litros))}});const lt=Math.max(...it,1),ot=(Math.max(...dt,1),Math.max(...nt,1)),rt=(t.safras||[]).filter(t=>t.id!==getSafraId()).map(a=>{const e=(t.talhoes||[]).filter(t=>t.safraId===a.id),i=e.reduce((t,a)=>t+Number(a.areaHa||0),0),d=(t.aplicacoes||[]).filter(t=>t.safraId===a.id),n=(t.combustivel||[]).filter(t=>t.safraId===a.id),l=(t.manutencoes||[]).filter(t=>t.safraId===a.id),o=(t.insumosBase||[]).filter(t=>t.safraId===a.id),r=(t.colheitas||[]).filter(t=>t.safraId===a.id),s=d.reduce((t,a)=>t+Number(a.custoTotal||0),0)+n.reduce((t,a)=>t+Number(a.litros||0)*Number(a.precoLitro||0),0)+l.reduce((t,a)=>t+Number(a.custoTotal||0),0)+o.reduce((t,a)=>t+Number(a.custoTotal||0),0)+r.reduce((t,a)=>{let e=0;return a.frete1&&(e+=Number(a.frete1.custoFrete||0)),a.frete2&&(e+=Number(a.frete2.custoFrete||0)),t+e},0),c=r.reduce((t,a)=>{const i=e.find(t=>t.id===a.talhaoId);if(!i)return t;const d=(i.cultura||"").toLowerCase();let n=u.precoSoja;return"milho"===d&&(n=u.precoMilho),"algodao"===d&&(n=u.precoAlgodao),t+("kg"===a.unidade?Number(a.producaoTotal||0)/u.pesoPadraoSaca:Number(a.producaoTotal||0))*n},0);return{nome:a.nome||a.id,custo:s,receita:c,area:i}}).filter(t=>t.area>0||t.custo>0);document.getElementById("content").innerHTML=`\n    <style>\n      .relatorio-kpi-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n        gap: 15px;\n        margin-bottom: 20px;\n      }\n      .relatorio-kpi-card {\n        background: #ffffff;\n        border-radius: 12px;\n        padding: 20px;\n        border-left: 4px solid #3b82f6;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.05);\n      }\n      .relatorio-kpi-card h3 {\n        margin: 0 0 10px 0;\n        color: #3b82f6;\n        font-size: 16px;\n      }\n      .relatorio-kpi-valor {\n        font-size: 28px;\n        font-weight: 700;\n        color: #0f172a;\n      }\n      .relatorio-kpi-label {\n        color: #475569;\n        font-size: 12px;\n        margin-top: 5px;\n      }\n      .destaque-positivo { color: #059669; }\n      .destaque-negativo { color: #b91c1c; }\n      .grafico-barras {\n        display: flex;\n        align-items: flex-end;\n        gap: 8px;\n        height: 150px;\n        margin: 15px 0;\n      }\n      .barra {\n        flex: 1;\n        background: #3b82f6;\n        border-radius: 4px 4px 0 0;\n        min-height: 20px;\n        transition: height 0.3s;\n      }\n      .barra-label {\n        text-align: center;\n        font-size: 10px;\n        color: #475569;\n        margin-top: 5px;\n      }\n      .secao-titulo {\n        margin: 30px 0 15px;\n        font-size: 20px;\n        font-weight: 600;\n        color: #0f172a;\n        border-bottom: 2px solid #3b82f6;\n        padding-bottom: 5px;\n      }\n      .composicao-custo {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 20px;\n        margin-bottom: 20px;\n      }\n      @media (max-width: 768px) {\n        .composicao-custo { grid-template-columns: 1fr; }\n      }\n    </style>\n\n    \x3c!-- ========== CABE√áALHO ========== --\x3e\n    <div style="margin-bottom:20px;">\n      <h2>üìä Relat√≥rio Completo - ${escapeHtml(a?.nome||"Safra Atual")}</h2>\n      <p style="color:#475569;">Per√≠odo: ${a?.dataInicio||"N/A"} a ${a?.dataFim||"N/A"}</p>\n    </div>\n\n    \x3c!-- ========== KPIs PRINCIPAIS ========== --\x3e\n    <div class="relatorio-kpi-grid">\n      <div class="relatorio-kpi-card">\n        <h3>üìè √Årea Total</h3>\n        <div class="relatorio-kpi-valor">${num(v,1)} ha</div>\n      </div>\n      ${canSeeFinanceiro()?`<div class="relatorio-kpi-card">\n        <h3>üí∞ Custo Total</h3>\n        <div class="relatorio-kpi-valor">${kbrl($)}</div>\n        <div class="relatorio-kpi-label">R$ ${num(k,2)}/ha</div>\n      </div>`:""}\n      <div class="relatorio-kpi-card">\n        <h3>üåæ Produ√ß√£o Total</h3>\n        <div class="relatorio-kpi-valor">${num(x,0)} kg</div>\n      </div>\n      ${canSeeFinanceiro()?`<div class="relatorio-kpi-card">\n        <h3>üìä Receita Total</h3>\n        <div class="relatorio-kpi-valor ${f>=0?"destaque-positivo":"destaque-negativo"}">${kbrl(f)}</div>\n        <div class="relatorio-kpi-label">vs estimado ${kbrl(M)}</div>\n      </div>`:""}\n    </div>\n\n    ${canSeeFinanceiro()?'\x3c!-- ========== COMPOSI√á√ÉO DE CUSTOS ========== --\x3e\n    <div class="secao-titulo">üí∞ Composi√ß√£o de Custos da Safra</div>\n    <div class="composicao-custo">':'\x3c!-- Financeiro oculto --\x3e<div style="display:none;">'}\n      <div class="card">\n        <h4>üìä Custos por Categoria</h4>\n        <table style="width:100%;">\n          <tr><td><b>Aplica√ß√µes (defensivos)</b></td><td style="text-align:right">${kbrl(b)}</td><td style="text-align:right; color:#64748b;">${$>0?num(b/$*100,1):0}%</td></tr>\n          <tr><td><b>Insumos Base (aduba√ß√£o)</b></td><td style="text-align:right">${kbrl(m)}</td><td style="text-align:right; color:#64748b;">${$>0?num(m/$*100,1):0}%</td></tr>\n          <tr><td><b>Combust√≠vel</b></td><td style="text-align:right">${kbrl(h)}</td><td style="text-align:right; color:#64748b;">${$>0?num(h/$*100,1):0}%</td></tr>\n          <tr><td><b>Manuten√ß√£o</b></td><td style="text-align:right">${kbrl(p)}</td><td style="text-align:right; color:#64748b;">${$>0?num(p/$*100,1):0}%</td></tr>\n          <tr><td><b>Frete</b></td><td style="text-align:right">${kbrl(g)}</td><td style="text-align:right; color:#64748b;">${$>0?num(g/$*100,1):0}%</td></tr>\n          <tr style="border-top:2px solid #e2e8f0; font-weight:bold;"><td><b>TOTAL</b></td><td style="text-align:right"><b>${kbrl($)}</b></td><td style="text-align:right">100%</td></tr>\n        </table>\n      </div>\n      <div class="card">\n        <h4>üìè Custos por Hectare</h4>\n        <table style="width:100%;">\n          <tr><td>Aplica√ß√µes/ha</td><td style="text-align:right">${kbrl(v>0?b/v:0)}</td></tr>\n          <tr><td>Insumos Base/ha</td><td style="text-align:right">${kbrl(v>0?m/v:0)}</td></tr>\n          <tr><td>Combust√≠vel/ha</td><td style="text-align:right">${kbrl(v>0?h/v:0)}</td></tr>\n          <tr><td>Manuten√ß√£o/ha</td><td style="text-align:right">${kbrl(J)}</td></tr>\n          <tr><td>Frete/ha</td><td style="text-align:right">${kbrl(tt)}</td></tr>\n          <tr style="border-top:2px solid #e2e8f0;"><td><b>TOTAL/ha</b></td><td style="text-align:right"><b>${kbrl(k)}</b></td></tr>\n        </table>\n      </div>\n    </div>\n\n    ${canSeeFinanceiro()?"":"</div>\x3c!-- end hidden block --\x3e"}\n    ${canSeeFinanceiro()?'\x3c!-- ========== COMPARATIVO RECEITA ========== --\x3e\n    <div class="card" style="margin-bottom:20px;">\n      <h3>üìà Comparativo Receita</h3>':'<div style="display:none;">'}\n      <table style="width:100%;">\n        <tr>\n          <td><b>Receita estimada:</b></td>\n          <td style="text-align:right">${kbrl(T)}</td>\n        </tr>\n        <tr>\n          <td><b>Receita real:</b></td>\n          <td style="text-align:right">${kbrl(f)}</td>\n        </tr>\n        <tr>\n          <td><b>Custo total (com manuten√ß√£o + insumos + frete):</b></td>\n          <td style="text-align:right">${kbrl($)}</td>\n        </tr>\n        <tr style="border-top:2px solid #e2e8f0;">\n          <td><b>Lucro real:</b></td>\n          <td style="text-align:right"><b class="${R>=0?"destaque-positivo":"destaque-negativo"}">${kbrl(R)}</b></td>\n        </tr>\n        <tr>\n          <td><b>Diferen√ßa (real vs estimado):</b></td>\n          <td style="text-align:right">\n            <span class="${R-M>=0?"destaque-positivo":"destaque-negativo"}">\n              ${kbrl(R-M)}\n            </span>\n          </td>\n        </tr>\n      </table>\n    </div>\n    ${canSeeFinanceiro()?"":"</div>"}\n\n    \x3c!-- ========== GR√ÅFICOS MENSAIS ========== --\x3e\n    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">\n      <div class="card">\n        <h4>üåßÔ∏è Chuva Mensal (mm)</h4>\n        <div class="grafico-barras">\n          ${et.map((t,a)=>`\n              <div style="flex:1; text-align:center;">\n                <div class="barra" style="height: ${it[a]/lt*130}px;"></div>\n                <div class="barra-label">${t}</div>\n                <div style="font-size:9px; color:#475569;">${num(it[a],1)}</div>\n              </div>\n            `).join("")}\n        </div>\n      </div>\n      <div class="card">\n        <h4>‚õΩ Consumo Diesel Mensal (L)</h4>\n        <div class="grafico-barras">\n          ${et.map((t,a)=>`\n              <div style="flex:1; text-align:center;">\n                <div class="barra" style="height: ${nt[a]/ot*130}px; background:#f97316;"></div>\n                <div class="barra-label">${t}</div>\n                <div style="font-size:9px; color:#475569;">${num(nt[a],0)}</div>\n              </div>\n            `).join("")}\n        </div>\n      </div>\n    </div>\n\n    \x3c!-- ========== SE√á√ÉO CLIMA ========== --\x3e\n    <div class="secao-titulo">üå§Ô∏è Resumo Clim√°tico</div>\n    <div class="relatorio-kpi-grid" style="margin-bottom:20px;">\n      <div class="relatorio-kpi-card">\n        <h3>üåßÔ∏è Total de Chuvas</h3>\n        <div class="relatorio-kpi-valor">${num(S,1)} mm</div>\n        <div class="relatorio-kpi-label">${A} dias com chuva</div>\n      </div>\n      <div class="relatorio-kpi-card">\n        <h3>üìä M√©dia por Registro</h3>\n        <div class="relatorio-kpi-valor">${num(N,1)} mm</div>\n      </div>\n      <div class="relatorio-kpi-card">\n        <h3>üå°Ô∏è Temperatura M√©dia</h3>\n        <div class="relatorio-kpi-valor">${num((I+E)/2,1)}¬∞C</div>\n        <div class="relatorio-kpi-label">M√≠n ${num(E,1)}¬∞C / M√°x ${num(I,1)}¬∞C</div>\n      </div>\n    </div>\n\n    \x3c!-- ========== SE√á√ÉO COMBUST√çVEL ========== --\x3e\n    <div class="secao-titulo">‚õΩ Resumo de Combust√≠vel</div>\n    <div class="relatorio-kpi-grid" style="margin-bottom:20px;">\n      <div class="relatorio-kpi-card">\n        <h3>üõ¢Ô∏è Diesel Comprado</h3>\n        <div class="relatorio-kpi-valor">${num(O,0)} L</div>\n      </div>\n      <div class="relatorio-kpi-card">\n        <h3>üöú Diesel Consumido</h3>\n        <div class="relatorio-kpi-valor">${num(P,0)} L</div>\n        <div class="relatorio-kpi-label">${num(j,1)} L/ha</div>\n      </div>\n      <div class="relatorio-kpi-card">\n        <h3>üí∞ Pre√ßo M√©dio</h3>\n        <div class="relatorio-kpi-valor">${kbrl(w)}/L</div>\n      </div>\n    </div>\n\n    \x3c!-- ========== SE√á√ÉO MANUTEN√á√ÉO (NOVO) ========== --\x3e\n    <div class="secao-titulo">üîß Resumo de Manuten√ß√£o</div>\n    <div class="relatorio-kpi-grid" style="margin-bottom:20px;">\n      <div class="relatorio-kpi-card">\n        <h3>üîß Total Manuten√ß√µes</h3>\n        <div class="relatorio-kpi-valor">${B}</div>\n        <div class="relatorio-kpi-label">P: ${V} | C: ${K} | Pd: ${U}</div>\n      </div>\n      <div class="relatorio-kpi-card">\n        <h3>üí∞ Custo Total</h3>\n        <div class="relatorio-kpi-valor">${kbrl(p)}</div>\n        <div class="relatorio-kpi-label">${kbrl(J)}/ha</div>\n      </div>\n    </div>\n    ${c.length>0?`\n    <div class="card" style="margin-bottom:20px;">\n      <h4>üöú Custo de Manuten√ß√£o por M√°quina</h4>\n      <table style="width:100%;">\n        <thead><tr><th>M√°quina</th><th>Manuten√ß√µes</th><th>Custo Total</th></tr></thead>\n        <tbody>\n          ${c.map(t=>{const a=G.get(t.id)||{custo:0,qtd:0};return`<tr><td><b>${escapeHtml(t.nome)}</b></td><td>${a.qtd}</td><td>${kbrl(a.custo)}</td></tr>`}).join("")}\n        </tbody>\n      </table>\n    </div>\n    `:""}\n\n    \x3c!-- ========== SE√á√ÉO INSUMOS BASE (NOVO) ========== --\x3e\n    <div class="secao-titulo">üå± Resumo de Insumos Base</div>\n    <div class="relatorio-kpi-grid" style="margin-bottom:20px;">\n      <div class="relatorio-kpi-card">\n        <h3>üå± Total Lan√ßamentos</h3>\n        <div class="relatorio-kpi-valor">${W}</div>\n      </div>\n      <div class="relatorio-kpi-card">\n        <h3>üí∞ Custo Total</h3>\n        <div class="relatorio-kpi-valor">${kbrl(m)}</div>\n        <div class="relatorio-kpi-label">${kbrl(Q)}/ha</div>\n      </div>\n    </div>\n    ${Object.keys(X).length>0?`\n    <div class="card" style="margin-bottom:20px;">\n      <h4>üìä Custo por Tipo de Insumo</h4>\n      <table style="width:100%;">\n        <thead><tr><th>Tipo</th><th>Custo Total</th><th>%</th></tr></thead>\n        <tbody>\n          ${Object.entries(X).sort((t,a)=>a[1]-t[1]).map(([t,a])=>`\n            <tr><td><b>${escapeHtml(t)}</b></td><td>${kbrl(a)}</td><td>${m>0?num(a/m*100,1):0}%</td></tr>\n          `).join("")}\n        </tbody>\n      </table>\n    </div>\n    `:""}\n\n    \x3c!-- ========== SE√á√ÉO FRETE (NOVO) ========== --\x3e\n    <div class="secao-titulo">üöõ Resumo de Frete</div>\n    <div class="relatorio-kpi-grid" style="margin-bottom:20px;">\n      <div class="relatorio-kpi-card">\n        <h3>üöõ Custo Total Frete</h3>\n        <div class="relatorio-kpi-valor">${kbrl(g)}</div>\n        <div class="relatorio-kpi-label">${kbrl(tt)}/ha</div>\n      </div>\n      <div class="relatorio-kpi-card">\n        <h3>üì¶ Total Entregue</h3>\n        <div class="relatorio-kpi-valor">${num(Y,2)} ton</div>\n        <div class="relatorio-kpi-label">${kbrl(Z)}/ton</div>\n      </div>\n    </div>\n\n    \x3c!-- ========== SE√á√ÉO APLICA√á√ïES ========== --\x3e\n    <div class="secao-titulo">üß™ Resumo de Aplica√ß√µes</div>\n    <div class="relatorio-kpi-grid" style="margin-bottom:20px;">\n      <div class="relatorio-kpi-card">\n        <h3>üìã Total de Aplica√ß√µes</h3>\n        <div class="relatorio-kpi-valor">${H}</div>\n      </div>\n      <div class="relatorio-kpi-card">\n        <h3>üìè √Årea Total Aplicada</h3>\n        <div class="relatorio-kpi-valor">${num(q,1)} ha</div>\n      </div>\n      <div class="relatorio-kpi-card">\n        <h3>üí∞ Custo M√©dio/Aplica√ß√£o</h3>\n        <div class="relatorio-kpi-valor">${kbrl(z)}</div>\n      </div>\n    </div>\n\n    \x3c!-- Top 5 produtos mais usados --\x3e\n    ${D.length>0?`\n    <div class="card" style="margin-bottom:20px;">\n      <h4>üß™ Top 5 Produtos Mais Utilizados</h4>\n      <table style="width:100%;">\n        <thead>\n          <tr><th>Produto</th><th>Vezes</th><th>%</th></tr>\n        </thead>\n        <tbody>\n          ${D.map(([t,a])=>`\n            <tr>\n              <td><b>${escapeHtml(t)}</b></td>\n              <td>${a}</td>\n              <td>${(a/H*100).toFixed(1)}%</td>\n            </tr>\n          `).join("")}\n        </tbody>\n      </table>\n    </div>\n    `:""}\n\n    \x3c!-- ========== DETALHAMENTO POR TALH√ÉO ========== --\x3e\n    <div class="secao-titulo">üå± Detalhamento por Talh√£o (Custo Completo)</div>\n    <div class="tableWrap" style="margin-bottom:30px;">\n      <table>\n        <thead>\n          <tr>\n            <th>Talh√£o</th>\n            <th>Fazenda</th>\n            <th>Cultura</th>\n            <th>√Årea (ha)</th>\n            <th>Apl.</th>\n            <th>Insumos</th>\n            <th>Comb.</th>\n            <th>Manut.</th>\n            <th>Frete</th>\n            <th>Custo Total</th>\n            <th>Prod. (kg)</th>\n            <th>Rec. Est.</th>\n            <th>Rec. Real</th>\n            <th>Receita L√≠quida</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${at.map(t=>{const a=t.lucroReal>=0?"destaque-positivo":"destaque-negativo";return`<tr>\n              <td><b>${escapeHtml(t.talhao)}</b></td>\n              <td>${escapeHtml(t.fazenda)}</td>\n              <td>${escapeHtml(t.cultura)}</td>\n              <td>${num(t.area,1)}</td>\n              <td>${kbrl(t.custoApl)}</td>\n              <td>${kbrl(t.custoInsumo)}</td>\n              <td>${kbrl(t.custoComb)}</td>\n              <td>${kbrl(t.custoManutRateio)}</td>\n              <td>${kbrl(t.custoFreteT)}</td>\n              <td><b>${kbrl(t.custo)}</b></td>\n              <td>${t.temColheita?num(t.producaoKg,0):"-"}</td>\n              <td>${kbrl(t.receitaEstimada)}</td>\n              <td>${t.temColheita?kbrl(t.receitaReal):"-"}</td>\n              <td class="${a}">${t.temColheita?kbrl(t.lucroReal):"-"}</td>\n            </tr>`}).join("")}\n        </tbody>\n      </table>\n    </div>\n\n    \x3c!-- ========== COMPARATIVO COM SAFRAS PASSADAS ========== --\x3e\n    <div class="secao-titulo">üìà Comparativo com Safras Anteriores</div>\n    <div class="tableWrap">\n      <table>\n        <thead>\n          <tr>\n            <th>Safra</th>\n            <th>√Årea (ha)</th>\n            <th>Custo Total</th>\n            <th>Receita</th>\n            <th>Lucro</th>\n            <th>Varia√ß√£o (custo/ha)</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${rt.map(t=>{const a=t.area>0?t.custo/t.area:0,e=a>0?(k-a)/a*100:0;return`<tr>\n              <td><b>${t.nome}</b></td>\n              <td>${num(t.area,0)} ha</td>\n              <td>${kbrl(t.custo)}</td>\n              <td>${kbrl(t.receita)}</td>\n              <td>${kbrl(t.receita-t.custo)}</td>\n              <td><span class="${e>0?"destaque-negativo":"destaque-positivo"}">${e>0?"‚ñ≤":"‚ñº"} ${Math.abs(e).toFixed(1)}%</span></td>\n            </tr>`}).join("")}\n          <tr style="border-top:2px solid #e2e8f0;">\n            <td><b>${a?.nome||"Atual"}</b></td>\n            <td>${num(v,0)} ha</td>\n            <td>${kbrl($)}</td>\n            <td>${kbrl(f)}</td>\n            <td>${kbrl(R)}</td>\n            <td>‚Äî</td>\n          </tr>\n        </tbody>\n      </table>\n    </div>\n  `,document.getElementById("btnPrint").addEventListener("click",()=>window.print()),document.getElementById("btnExportCSV").addEventListener("click",()=>{const t=at.map(t=>({"Talh√£o":t.talhao,Fazenda:t.fazenda,Cultura:t.cultura,"√Årea_ha":t.area,"Custo_Aplica√ß√µes_R$":t.custoApl,Custo_Insumos_Base_R$:t.custoInsumo,"Custo_Combust√≠vel_R$":t.custoComb,"Custo_Manuten√ß√£o_R$":t.custoManutRateio,Custo_Frete_R$:t.custoFreteT,Custo_Total_R$:t.custo,"Produ√ß√£o_kg":t.producaoKg,Receita_Estimada_R$:t.receitaEstimada,Receita_Real_R$:t.receitaReal,Lucro_Real_R$:t.lucroReal}));downloadText(`relatorio-completo-${nowISO()}.csv`,toCSV(t)),toast("Exportado","CSV baixado.")}),document.getElementById("btnExportPDF").addEventListener("click",()=>{const t=`\n      \n    <div class="pdf-kpi-grid">\n      <div class="pdf-kpi" style="border-left-color:#3b82f6;"><div class="label">Area Total</div><div class="value">${num(v,1)} ha</div></div>\n      ${canSeeFinanceiro()?`\n      <div class="pdf-kpi" style="border-left-color:#ef4444;"><div class="label">Custo Total</div><div class="value">${kbrl($)}</div><div class="sub">${kbrl(k)}/ha</div></div>\n      <div class="pdf-kpi" style="border-left-color:#16a34a;"><div class="label">Receita Real</div><div class="value">${kbrl(f)}</div></div>\n      <div class="pdf-kpi" style="border-left-color:${R>=0?"#16a34a":"#ef4444"};"><div class="label">Lucro Real</div><div class="value">${kbrl(R)}</div></div>\n      `:""}\n      <div class="pdf-kpi" style="border-left-color:#f59e0b;"><div class="label">Producao Total</div><div class="value">${num(x,0)} kg</div><div class="sub">${num(x/1e3,2)} t</div></div>\n    </div>\n      ${canSeeFinanceiro()?`\n    <div class="pdf-section-title">Composicao de Custos da Safra</div>\n    <table>\n      <thead><tr><th>Categoria</th><th>Valor (R$)</th><th>% do Total</th><th>R$/ha</th></tr></thead>\n      <tbody>\n        <tr><td><b>Aplicacoes (defensivos)</b></td><td style="text-align:right;">${kbrl(b)}</td><td style="text-align:right;">${$>0?num(b/$*100,1):0}%</td><td style="text-align:right;">${kbrl(v>0?b/v:0)}</td></tr>\n        <tr><td><b>Insumos Base (adubacao)</b></td><td style="text-align:right;">${kbrl(m)}</td><td style="text-align:right;">${$>0?num(m/$*100,1):0}%</td><td style="text-align:right;">${kbrl(v>0?m/v:0)}</td></tr>\n        <tr><td><b>Combustivel</b></td><td style="text-align:right;">${kbrl(h)}</td><td style="text-align:right;">${$>0?num(h/$*100,1):0}%</td><td style="text-align:right;">${kbrl(v>0?h/v:0)}</td></tr>\n        <tr><td><b>Manutencao</b></td><td style="text-align:right;">${kbrl(p)}</td><td style="text-align:right;">${$>0?num(p/$*100,1):0}%</td><td style="text-align:right;">${kbrl(J)}</td></tr>\n        <tr><td><b>Frete</b></td><td style="text-align:right;">${kbrl(g)}</td><td style="text-align:right;">${$>0?num(g/$*100,1):0}%</td><td style="text-align:right;">${kbrl(tt)}</td></tr>\n        <tr class="total-row"><td><b>TOTAL</b></td><td style="text-align:right;"><b>${kbrl($)}</b></td><td style="text-align:right;">100%</td><td style="text-align:right;"><b>${kbrl(k)}</b></td></tr>\n      </tbody>\n    </table>`:""}\n      ${canSeeFinanceiro()?`\n    <div class="pdf-section-title">Comparativo de Receita</div>\n    <table>\n      <tbody>\n        <tr><td><b>Receita estimada</b></td><td style="text-align:right;">${kbrl(T)}</td></tr>\n        <tr><td><b>Receita real</b></td><td style="text-align:right;">${kbrl(f)}</td></tr>\n        <tr><td><b>Custo total</b></td><td style="text-align:right;">${kbrl($)}</td></tr>\n        <tr class="total-row"><td><b>Lucro real</b></td><td style="text-align:right;" class="${R>=0?"text-green":"text-red"}"><b>${kbrl(R)}</b></td></tr>\n        <tr><td><b>Diferenca (real vs estimado)</b></td><td style="text-align:right;" class="${R-M>=0?"text-green":"text-red"}">${kbrl(R-M)}</td></tr>\n      </tbody>\n    </table>`:""}\n      \n    <div class="pdf-section-title">Resumo Climatico</div>\n    <div class="pdf-kpi-grid">\n      <div class="pdf-kpi"><div class="label">Total de Chuvas</div><div class="value">${num(S,1)} mm</div><div class="sub">${A} dias com chuva</div></div>\n      <div class="pdf-kpi"><div class="label">Media por Registro</div><div class="value">${num(N,1)} mm</div></div>\n      <div class="pdf-kpi"><div class="label">Temperatura Media</div><div class="value">${num((I+E)/2,1)}¬∞C</div><div class="sub">Min ${num(E,1)}¬∞C / Max ${num(I,1)}¬∞C</div></div>\n    </div>\n      \n    <div class="pdf-section-title">Resumo de Combustivel</div>\n    <div class="pdf-kpi-grid">\n      <div class="pdf-kpi"><div class="label">Diesel Comprado</div><div class="value">${num(O,0)} L</div></div>\n      <div class="pdf-kpi"><div class="label">Diesel Consumido</div><div class="value">${num(P,0)} L</div><div class="sub">${num(j,1)} L/ha</div></div>\n      <div class="pdf-kpi"><div class="label">Preco Medio</div><div class="value">${kbrl(w)}/L</div></div>\n    </div>\n      \n    <div class="pdf-section-title">Resumo de Manutencao</div>\n    <div class="pdf-kpi-grid">\n      <div class="pdf-kpi"><div class="label">Total Manutencoes</div><div class="value">${B}</div><div class="sub">P: ${V} | C: ${K} | Pd: ${U}</div></div>\n      <div class="pdf-kpi"><div class="label">Custo Total</div><div class="value">${kbrl(p)}</div><div class="sub">${kbrl(J)}/ha</div></div>\n    </div>\n    ${c.length>0?`\n    <table>\n      <thead><tr><th>Maquina</th><th>Manutencoes</th><th>Custo Total</th></tr></thead>\n      <tbody>\n        ${c.map(t=>{const a=G.get(t.id)||{custo:0,qtd:0};return`<tr><td><b>${escapeHtml(t.nome)}</b></td><td style="text-align:center;">${a.qtd}</td><td style="text-align:right;">${kbrl(a.custo)}</td></tr>`}).join("")}\n      </tbody>\n    </table>`:""}\n      \n    <div class="pdf-section-title">Resumo de Insumos Base</div>\n    <div class="pdf-kpi-grid">\n      <div class="pdf-kpi"><div class="label">Total Lancamentos</div><div class="value">${W}</div></div>\n      <div class="pdf-kpi"><div class="label">Custo Total</div><div class="value">${kbrl(m)}</div><div class="sub">${kbrl(Q)}/ha</div></div>\n    </div>\n    ${Object.keys(X).length>0?`\n    <table>\n      <thead><tr><th>Tipo de Insumo</th><th>Custo Total</th><th>%</th></tr></thead>\n      <tbody>\n        ${Object.entries(X).sort((t,a)=>a[1]-t[1]).map(([t,a])=>`\n          <tr><td><b>${escapeHtml(t)}</b></td><td style="text-align:right;">${kbrl(a)}</td><td style="text-align:right;">${m>0?num(a/m*100,1):0}%</td></tr>\n        `).join("")}\n      </tbody>\n    </table>`:""}\n      \n    <div class="pdf-section-title">Resumo de Frete</div>\n    <div class="pdf-kpi-grid">\n      <div class="pdf-kpi"><div class="label">Custo Total Frete</div><div class="value">${kbrl(g)}</div><div class="sub">${kbrl(tt)}/ha</div></div>\n      <div class="pdf-kpi"><div class="label">Total Entregue</div><div class="value">${num(Y,2)} ton</div><div class="sub">${kbrl(Z)}/ton</div></div>\n    </div>\n      \n    <div class="pdf-section-title">Resumo de Aplicacoes</div>\n    <div class="pdf-kpi-grid">\n      <div class="pdf-kpi"><div class="label">Total de Aplicacoes</div><div class="value">${H}</div></div>\n      <div class="pdf-kpi"><div class="label">Area Total Aplicada</div><div class="value">${num(q,1)} ha</div></div>\n      <div class="pdf-kpi"><div class="label">Custo Medio/Aplicacao</div><div class="value">${kbrl(z)}</div></div>\n    </div>\n    ${D.length>0?`\n    <table>\n      <thead><tr><th>Produto</th><th>Vezes Utilizado</th><th>% das Aplicacoes</th></tr></thead>\n      <tbody>\n        ${D.map(([t,a])=>`\n          <tr><td><b>${escapeHtml(t)}</b></td><td style="text-align:center;">${a}</td><td style="text-align:right;">${(a/H*100).toFixed(1)}%</td></tr>\n        `).join("")}\n      </tbody>\n    </table>`:""}\n      \n    <div class="pdf-section-title" style="page-break-before:always;">Detalhamento por Talhao</div>\n    <table>\n      <thead><tr>\n        <th>Talhao</th><th>Fazenda</th><th>Cultura</th><th>Area (ha)</th>\n        ${canSeeFinanceiro()?"<th>Apl.</th><th>Insumos</th><th>Comb.</th><th>Manut.</th><th>Frete</th><th>Custo Total</th>":""}\n        <th>Prod. (kg)</th>\n        ${canSeeFinanceiro()?"<th>Rec. Est.</th><th>Rec. Real</th><th>Lucro</th>":""}\n      </tr></thead>\n      <tbody>\n        ${at.map(t=>{const a=t.lucroReal>=0?"text-green":"text-red";return`<tr>\n            <td><b>${escapeHtml(t.talhao)}</b></td>\n            <td>${escapeHtml(t.fazenda)}</td>\n            <td>${escapeHtml(t.cultura)}</td>\n            <td style="text-align:right;">${num(t.area,1)}</td>\n            ${canSeeFinanceiro()?`\n            <td style="text-align:right;">${kbrl(t.custoApl)}</td>\n            <td style="text-align:right;">${kbrl(t.custoInsumo)}</td>\n            <td style="text-align:right;">${kbrl(t.custoComb)}</td>\n            <td style="text-align:right;">${kbrl(t.custoManutRateio)}</td>\n            <td style="text-align:right;">${kbrl(t.custoFreteT)}</td>\n            <td style="text-align:right;"><b>${kbrl(t.custo)}</b></td>\n            `:""}\n            <td style="text-align:right;">${t.temColheita?num(t.producaoKg,0):"-"}</td>\n            ${canSeeFinanceiro()?`\n            <td style="text-align:right;">${kbrl(t.receitaEstimada)}</td>\n            <td style="text-align:right;">${t.temColheita?kbrl(t.receitaReal):"-"}</td>\n            <td style="text-align:right;" class="${a}"><b>${t.temColheita?kbrl(t.lucroReal):"-"}</b></td>\n            `:""}\n          </tr>`}).join("")}\n      </tbody>\n    </table>\n      ${rt.length>0?`\n    <div class="pdf-section-title">Comparativo com Safras Anteriores</div>\n    <table>\n      <thead><tr><th>Safra</th><th>Area (ha)</th><th>Custo Total</th><th>Receita</th><th>Lucro</th><th>Variacao (custo/ha)</th></tr></thead>\n      <tbody>\n        ${rt.map(t=>{const a=t.area>0?t.custo/t.area:0,e=a>0?(k-a)/a*100:0;return`<tr>\n            <td><b>${escapeHtml(t.nome)}</b></td>\n            <td style="text-align:right;">${num(t.area,0)} ha</td>\n            <td style="text-align:right;">${kbrl(t.custo)}</td>\n            <td style="text-align:right;">${kbrl(t.receita)}</td>\n            <td style="text-align:right;">${kbrl(t.receita-t.custo)}</td>\n            <td style="text-align:right;" class="${e>0?"text-red":"text-green"}">${e>0?"‚ñ≤":"‚ñº"} ${Math.abs(e).toFixed(1)}%</td>\n          </tr>`}).join("")}\n        <tr class="total-row">\n          <td><b>${escapeHtml(a?.nome||"Atual")}</b></td>\n          <td style="text-align:right;">${num(v,0)} ha</td>\n          <td style="text-align:right;">${kbrl($)}</td>\n          <td style="text-align:right;">${kbrl(f)}</td>\n          <td style="text-align:right;">${kbrl(R)}</td>\n          <td>‚Äî</td>\n        </tr>\n      </tbody>\n    </table>`:""}\n    `;gerarPDF({titulo:"Relatorio Completo da Safra",subtitulo:escapeHtml(a?.nome||"Safra Atual")+" ‚Äî Custos, Producao, Receita e Analises",conteudoHTML:t,orientacao:"landscape"})})}