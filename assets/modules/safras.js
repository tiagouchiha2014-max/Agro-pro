function pageSafras(){function a(){const a=getDB();document.getElementById("tbody").innerHTML=a.safras.slice().reverse().map(a=>`\n      <tr>\n        <td><b>${escapeHtml(a.nome)}</b></td>\n        <td>${a.dataInicio||"-"}</td>\n        <td>${a.dataFim||"-"}</td>\n        <td><span class="pill ${a.ativa?"ok":""}">${a.ativa?"Ativa":"Inativa"}</span></td>\n        <td class="noPrint">\n          <button class="btn" onclick="window.__usar('${a.id}')">Usar</button>\n          <button class="btn danger" onclick="window.__delSafra('${a.id}')">Excluir</button>\n        </td>\n      </tr>\n    `).join("")||'<tr><td colspan="5">Sem safras cadastradas.</td></tr>'}getDB(),setTopActions('<button class="btn" id="btnExportCSV">Exportar CSV</button>'),document.getElementById("content").innerHTML=`\n    <div class="section">\n      <div class="card">\n        <h3>Cadastrar nova safra</h3>\n        <div class="help">Cada safra tem seus próprios talhões, estoque e aplicações.</div>\n        <div class="hr"></div>\n        <form id="frm" class="formGrid">\n          <div><small>Nome da safra</small><input class="input" name="nome" required placeholder="Ex: Safra 2026/27"></div>\n          <div><small>Data início</small><input class="input" name="dataInicio" type="date" value="${nowISO()}"></div>\n          <div><small>Data fim</small><input class="input" name="dataFim" type="date"></div>\n          <div class="full"><small>Observações</small><textarea class="textarea" name="observacoes"></textarea></div>\n          <div class="full row" style="justify-content:flex-end">\n            <button class="btn primary" type="submit">Salvar safra</button>\n          </div>\n        </form>\n      </div>\n\n      <div class="tableWrap">\n        <table>\n          <thead>\n            <tr>\n              <th>Safra</th>\n              <th>Início</th>\n              <th>Fim</th>\n              <th>Status</th>\n              <th class="noPrint">Ações</th>\n            </tr>\n          </thead>\n          <tbody id="tbody"></tbody>\n        </table>\n      </div>\n    </div>\n  `,window.__usar=a=>{setSafraId(a),toast("Safra ativa","Mudando para a safra selecionada…"),setTimeout(()=>location.reload(),200)},window.__delSafra=a=>{const t=getDB();t.safras.length<=1?alert("Você precisa ter pelo menos 1 safra."):confirm("Excluir safra e TODOS os dados dela? (fazendas, talhões, aplicações)")&&(t.safras=t.safras.filter(t=>t.id!==a),["fazendas","talhoes","produtos","estoque","equipe","maquinas","clima","aplicacoes","combustivel","dieselEntradas","dieselEstoque","lembretes","pragas","colheitas"].forEach(s=>t[s]=(t[s]||[]).filter(t=>t.safraId!==a)),getSafraId()===a&&(t.session.safraId=t.safras[0].id),setDB(t),toast("Excluída","Safra removida com dados associados."),setTimeout(()=>location.reload(),200))},document.getElementById("frm").addEventListener("submit",t=>{t.preventDefault();const s=new FormData(t.target),e={id:uid("saf"),nome:s.get("nome"),dataInicio:s.get("dataInicio")||nowISO(),dataFim:s.get("dataFim")||"",ativa:!0,observacoes:s.get("observacoes")||""},n=getDB();n.safras.push(e),setDB(n),setSafraId(e.id),t.target.reset(),toast("Salvo","Safra adicionada."),a()}),document.getElementById("btnExportCSV").addEventListener("click",()=>{const a=getDB();downloadText(`safras-${nowISO()}.csv`,toCSV(a.safras)),toast("Exportado","CSV baixado.")}),a()}