function pageInsumos(e){renderShell("insumos","üß™ Insumos","Produtos e estoque em um s√≥ lugar");const t=document.getElementById("content"),n=e||localStorage.getItem("insumos_tab")||"produtos",a=[{key:"produtos",icon:"üß™",label:"Produtos"},{key:"estoque",icon:"üì¶",label:"Estoque"}].map(e=>`\n    <button\n      class="prop-tab ${e.key===n?"active":""}"\n      data-tab="${e.key}"\n    >${e.icon} <span class="tab-label">${e.label}</span></button>\n  `).join("");t.innerHTML=`\n    <div class="section page-enter">\n      <div class="prop-tab-bar">${a}</div>\n      <div id="insumosContent"></div>\n    </div>\n  `,document.querySelectorAll(".prop-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;localStorage.setItem("insumos_tab",t),pageInsumos(t)})}),"produtos"===n?_renderProdutosTab():"estoque"===n&&_renderEstoqueTab()}function _renderProdutosTab(){const e=document.getElementById("insumosContent");if(!e)return;const t=getDB(),n=(onlySafra(t.produtos||[]),canCreateOnPage("produtos"));function a(){const e=getDB(),t=(document.getElementById("filtroProduto")?.value||"").toLowerCase();let a=onlySafra(e.produtos||[]);t&&(a=a.filter(e=>(e.nome||"").toLowerCase().includes(t)||(e.tipo||"").toLowerCase().includes(t)||(e.ingrediente||"").toLowerCase().includes(t)));const o=document.getElementById("produtosGrid");if(!a.length)return void(o.innerHTML=emptyState("üß™","Nenhum produto cadastrado",n?"Cadastre o primeiro produto usando o formul√°rio ao lado.":"Nenhum produto dispon√≠vel para esta safra."));const s={};a.forEach(e=>{const t=e.tipo||"Sem tipo";s[t]||(s[t]=[]),s[t].push(e)}),o.innerHTML=Object.entries(s).map(([e,t])=>`\n      <div style="margin-bottom:var(--space-5);">\n        <div style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase;\n          letter-spacing:.6px; margin-bottom:var(--space-3); display:flex; align-items:center; gap:8px;">\n          üß™ ${escapeHtml(e)}\n          <span class="tag tag-neutral">${t.length}</span>\n        </div>\n        <div class="tableWrap" style="margin:0;">\n          <table>\n            <thead>\n              <tr>\n                <th>Nome</th>\n                <th>Ingrediente</th>\n                <th>Pre√ßo</th>\n                <th>Unid.</th>\n                <th>Car√™ncia</th>\n                <th class="noPrint">A√ß√µes</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${t.map(e=>`\n                <tr>\n                  <td>\n                    <b>${escapeHtml(e.nome||"‚Äî")}</b>\n                    ${e.fabricante?`<br><span style="font-size:11px; color:var(--text-muted);">${escapeHtml(e.fabricante)}</span>`:""}\n                  </td>\n                  <td>${escapeHtml(e.ingrediente||"‚Äî")}</td>\n                  <td class="highlight-value">${e.preco?kbrl(e.preco):"‚Äî"}</td>\n                  <td>${escapeHtml(e.unidade||"‚Äî")}</td>\n                  <td>${e.carenciaDias?`${e.carenciaDias}d`:"‚Äî"}</td>\n                  <td class="noPrint" style="white-space:nowrap;">\n                    <button class="btn" style="font-size:11.5px; padding:5px 10px;"\n                      onclick="localStorage.setItem('insumos_tab','estoque'); pageInsumos('estoque')">\n                      üì¶ Estoque\n                    </button>\n                    ${canDeleteOnPage("produtos")?`\n                      <button class="btn danger" onclick="window.__delProd('${e.id}')">Excluir</button>\n                    `:""}\n                  </td>\n                </tr>\n              `).join("")}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    `).join("")}e.innerHTML=`\n    <div style="display:grid; grid-template-columns:360px 1fr; gap:var(--space-5); align-items:start;">\n\n      \x3c!-- Formul√°rio --\x3e\n      <div class="card ${n?"":"card--disabled"}" id="formProdCard">\n        <h3>üß™ Novo Produto</h3>\n        <div class="help">Defensivos, sementes, fertilizantes e outros insumos da safra.</div>\n        <form id="frmProduto" class="formGrid" style="margin-top:var(--space-4);">\n          <div class="form-group">\n            <small>Tipo *</small>\n            <input class="input" name="tipo" required placeholder="Herbicida / Fungicida...">\n          </div>\n          <div class="form-group">\n            <small>Nome comercial *</small>\n            <input class="input" name="nome" required placeholder="Ex: Roundup WG">\n          </div>\n          <div class="form-group">\n            <small>Ingrediente ativo</small>\n            <input class="input" name="ingrediente" placeholder="Ex: Glifosato">\n          </div>\n          <div class="form-group">\n            <small>Fabricante</small>\n            <input class="input" name="fabricante" placeholder="Ex: Bayer">\n          </div>\n          <div class="form-group">\n            <small>Registro/MAPA</small>\n            <input class="input" name="registro" placeholder="Ex: 01234">\n          </div>\n          <div class="form-group">\n            <small>Pre√ßo por unidade (R$)</small>\n            <input class="input" name="preco" type="number" step="0.01" placeholder="0,00">\n          </div>\n          <div class="form-group">\n            <small>Unidade padr√£o</small>\n            <input class="input" name="unidade" placeholder="L / kg / sc">\n          </div>\n          <div class="form-group">\n            <small>Car√™ncia (dias)</small>\n            <input class="input" name="carenciaDias" type="number" placeholder="0">\n          </div>\n          <div class="form-group">\n            <small>Reentrada (horas)</small>\n            <input class="input" name="reentradaHoras" type="number" placeholder="0">\n          </div>\n          <div class="form-group full">\n            <small>Pragas alvo (separadas por v√≠rgula)</small>\n            <input class="input" name="pragasAlvo" placeholder="ferrugem, lagarta, broca...">\n          </div>\n          <div class="form-group full">\n            <small>Observa√ß√µes</small>\n            <textarea class="textarea" name="obs" rows="2"></textarea>\n          </div>\n          <div class="full" style="display:flex; justify-content:flex-end;">\n            <button class="btn primary" type="submit" ${n?"":"disabled"}>+ Adicionar produto</button>\n          </div>\n        </form>\n      </div>\n\n      \x3c!-- Lista de produtos --\x3e\n      <div>\n        <div style="display:flex; align-items:center; gap:var(--space-3); margin-bottom:var(--space-4); flex-wrap:wrap;">\n          <h3 style="font-size:14px; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:.6px; margin:0;">\n            Produtos cadastrados\n          </h3>\n          <input class="input" id="filtroProduto" placeholder="üîç Filtrar por nome ou tipo..." style="max-width:220px; margin-left:auto; font-size:13px;">\n          <button class="btn" id="btnExportProdCSV" style="font-size:12px; padding:7px 14px;">üì• CSV</button>\n        </div>\n        <div id="produtosGrid"></div>\n      </div>\n    </div>\n  `,window.__delProd=e=>{if(!confirm("Excluir este produto? O estoque vinculado tamb√©m ser√° removido."))return;const t=getDB();t.produtos=(t.produtos||[]).filter(t=>t.id!==e),t.estoque=(t.estoque||[]).filter(t=>t.produtoId!==e),setDB(t),toast("Produto exclu√≠do","Estoque vinculado tamb√©m removido."),a()},document.getElementById("filtroProduto")?.addEventListener("input",a),n&&document.getElementById("frmProduto").addEventListener("submit",e=>{e.preventDefault();const t=new FormData(e.target),n=getDB(),o={id:uid("prd"),safraId:getSafraId(),tipo:t.get("tipo").trim(),nome:t.get("nome").trim(),ingrediente:t.get("ingrediente")||"",fabricante:t.get("fabricante")||"",registro:t.get("registro")||"",preco:Number(t.get("preco")||0),unidade:t.get("unidade")||"",carenciaDias:Number(t.get("carenciaDias")||0),reentradaHoras:Number(t.get("reentradaHoras")||0),pragasAlvo:(t.get("pragasAlvo")||"").split(",").map(e=>e.trim()).filter(Boolean),obs:t.get("obs")||""};n.produtos=n.produtos||[],n.produtos.push(o),setDB(n),e.target.reset(),toast("üß™ Produto cadastrado",`"${o.nome}" adicionado.`),a()}),document.getElementById("btnExportProdCSV")?.addEventListener("click",()=>{downloadText(`produtos-${nowISO()}.csv`,toCSV(onlySafra(getDB().produtos||[]))),toast("Exportado","CSV de produtos baixado.")}),a()}function _renderEstoqueTab(){const e=document.getElementById("insumosContent");if(!e)return;const t=getDB(),n=onlySafra(t.produtos||[]),a=canCreateOnPage("estoque"),o=n.length?n.map(e=>`<option value="${e.id}">${escapeHtml(e.nome)} ‚Äî ${escapeHtml(e.tipo)}</option>`).join(""):'<option value="" disabled>‚Äî Cadastre produtos primeiro ‚Äî</option>';function s(){const e=getDB(),t=(document.getElementById("filtroEstoque")?.value||"").toLowerCase();let a=onlySafra(e.estoque||[]);t&&(a=a.filter(e=>{const a=n.find(t=>t.id===e.produtoId);return(a?.nome||"").toLowerCase().includes(t)||(e.deposito||"").toLowerCase().includes(t)}));const o=document.getElementById("estoqueContent");if(!a.length)return o.innerHTML=emptyState("üì¶","Estoque vazio","Adicione produtos ao estoque usando o formul√°rio ao lado."),void(document.getElementById("estoqueKpis").innerHTML="");const s=new Date,d=a.filter(e=>{if(!e.validade)return!1;const t=(new Date(e.validade)-s)/864e5;return t<=30&&t>=0});o.innerHTML=`\n      ${d.length?`\n        <div class="free-banner" style="margin-bottom:var(--space-4);">\n          ‚ö†Ô∏è <strong>${d.length} item(ns)</strong> com validade vencendo nos pr√≥ximos 30 dias.\n        </div>`:""}\n      <div class="tableWrap" style="margin:0;">\n        <table>\n          <thead>\n            <tr>\n              <th>Produto</th>\n              <th>Dep√≥sito</th>\n              <th>Lote</th>\n              <th>Validade</th>\n              <th>Qtd</th>\n              <th>Unid.</th>\n              <th>Obs</th>\n              <th class="noPrint">A√ß√µes</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${a.map(e=>{const t=n.find(t=>t.id===e.produtoId),a=t?`${t.nome} (${t.tipo})`:"(produto removido)",o=e.validade?(new Date(e.validade)-s)/864e5:null,d=null!==o&&o<=30&&o>=0,i=Number(e.quantidade_atual||0);return`\n                <tr ${d?'style="background:var(--warning-bg);"':""}>\n                  <td><b>${escapeHtml(a)}</b></td>\n                  <td>${escapeHtml(e.deposito||"Central")}</td>\n                  <td>${escapeHtml(e.lote||"‚Äî")}</td>\n                  <td ${d?'style="color:var(--warning); font-weight:700;"':""}>\n                    ${e.validade||"‚Äî"}\n                  </td>\n                  <td><b>${num(i,2)}</b></td>\n                  <td>${escapeHtml(e.unidade||"‚Äî")}</td>\n                  <td>${escapeHtml(e.obs||"‚Äî")}</td>\n                  <td class="noPrint" style="white-space:nowrap;">\n                    <button class="btn" style="font-size:11.5px; padding:5px 10px;"\n                      onclick="window.__reabRapido('${e.id}')">‚ûï</button>\n                    ${canDeleteOnPage("estoque")?`\n                      <button class="btn danger" onclick="window.__delEst('${e.id}')">Excluir</button>\n                    `:""}\n                  </td>\n                </tr>\n              `}).join("")}\n          </tbody>\n        </table>\n      </div>\n    `;const i=a.length,r=new Set(a.map(e=>e.produtoId)).size;document.getElementById("estoqueKpis").innerHTML=`\n      <div class="kpiCard">\n        <div class="kpiLabel">Itens no estoque</div>\n        <div class="kpiValue">${i}</div>\n      </div>\n      <div class="kpiCard">\n        <div class="kpiLabel">Produtos distintos</div>\n        <div class="kpiValue">${r}</div>\n      </div>\n      ${d.length?`\n        <div class="kpiCard">\n          <div class="kpiLabel">Vencendo em 30 dias</div>\n          <div class="kpiValue" style="color:var(--warning);">${d.length}</div>\n        </div>`:""}\n    `;const l=a.slice(0,5),u=document.getElementById("reabList");u&&(u.innerHTML=l.map(e=>{const t=n.find(t=>t.id===e.produtoId);return`\n          <div style="display:flex; align-items:center; justify-content:space-between;\n            gap:var(--space-2); padding:var(--space-2) var(--space-3);\n            background:var(--bg-subtle); border-radius:var(--radius-sm);">\n            <span style="font-size:12.5px; color:var(--text); min-width:0; overflow:hidden;\n              text-overflow:ellipsis; white-space:nowrap; flex:1;">\n              ${escapeHtml(t?.nome||"‚Äî")}\n            </span>\n            <span class="tag tag-neutral" style="flex-shrink:0;">${num(Number(e.quantidade_atual||0),1)} ${e.unidade||""}</span>\n            <button class="btn" style="font-size:11.5px; padding:4px 10px; flex-shrink:0;"\n              onclick="window.__reabRapido('${e.id}')">+</button>\n          </div>\n        `}).join("")+(a.length>5?`<p style="font-size:11.5px; color:var(--text-muted); text-align:center; margin-top:6px;">e mais ${a.length-5} itens na tabela ‚Üí</p>`:""))}e.innerHTML=`\n    <div style="display:grid; grid-template-columns:360px 1fr; gap:var(--space-5); align-items:start;">\n\n      \x3c!-- Formul√°rio de entrada --\x3e\n      <div class="card">\n        <h3>üì¶ Entrada de Estoque</h3>\n        <div class="help">Se o produto j√° existir no mesmo dep√≥sito, a quantidade ser√° somada.</div>\n        <form id="frmEstoque" class="formGrid" style="margin-top:var(--space-4);">\n          <div class="form-group full">\n            <small>Produto *</small>\n            <select class="select" name="produtoId" id="selProduto" required>\n              <option value="">Selecione...</option>\n              ${o}\n            </select>\n          </div>\n          <div class="form-group">\n            <small>Dep√≥sito</small>\n            <input class="input" name="deposito" placeholder="Central" value="Central">\n          </div>\n          <div class="form-group">\n            <small>Lote</small>\n            <input class="input" name="lote" placeholder="Opcional">\n          </div>\n          <div class="form-group">\n            <small>Validade</small>\n            <input class="input" name="validade" type="date">\n          </div>\n          <div class="form-group">\n            <small>Quantidade *</small>\n            <input class="input" name="qtd" type="number" step="0.01" required placeholder="0">\n          </div>\n          <div class="form-group">\n            <small>Unidade</small>\n            <input class="input" name="unidade" placeholder="Autom√°tico" id="unidadeAuto" readonly\n              style="background:var(--bg-subtle); color:var(--text-muted);">\n          </div>\n          <div class="form-group full">\n            <small>Observa√ß√µes</small>\n            <textarea class="textarea" name="obs" rows="2"></textarea>\n          </div>\n          <div class="full" style="display:flex; justify-content:flex-end;">\n            <button class="btn primary" type="submit" ${a?"":"disabled"}>+ Adicionar ao estoque</button>\n          </div>\n        </form>\n\n        \x3c!-- Separador --\x3e\n        <div style="border-top:1px solid var(--border); margin:var(--space-4) 0;"></div>\n\n        \x3c!-- Reabastecer r√°pido --\x3e\n        <h3 style="font-size:13.5px; margin-bottom:var(--space-3);">‚ö° Reabastecimento R√°pido</h3>\n        <div class="help">Adicione quantidade a um item j√° registrado.</div>\n        <div style="display:flex; flex-direction:column; gap:var(--space-2); margin-top:var(--space-3);" id="reabList"></div>\n      </div>\n\n      \x3c!-- Tabela de estoque --\x3e\n      <div>\n        <div style="display:flex; align-items:center; gap:var(--space-3); margin-bottom:var(--space-4); flex-wrap:wrap;">\n          <h3 style="font-size:14px; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:.6px; margin:0;">\n            Itens em estoque\n          </h3>\n          <input class="input" id="filtroEstoque" placeholder="üîç Filtrar..." style="max-width:200px; margin-left:auto; font-size:13px;">\n          <button class="btn" id="btnExportEstCSV" style="font-size:12px; padding:7px 14px;">üì• CSV</button>\n        </div>\n        <div id="estoqueContent"></div>\n\n        \x3c!-- KPIs de estoque --\x3e\n        <div class="kpi" style="margin-top:var(--space-5);" id="estoqueKpis"></div>\n      </div>\n    </div>\n  `,document.getElementById("selProduto")?.addEventListener("change",e=>{const t=n.find(t=>t.id===e.target.value);document.getElementById("unidadeAuto").value=t?.unidade||""}),window.__reabRapido=e=>{const t=getDB(),a=t.estoque.find(t=>t.id===e);if(!a)return;const o=n.find(e=>e.id===a.produtoId),d=prompt(`Quantidade a adicionar para "${o?.nome||"item"}":`,"");if(null===d||""===d)return;const i=parseFloat(d);isNaN(i)||i<=0?toast("Quantidade inv√°lida","Informe um n√∫mero positivo."):(a.quantidade_atual=Number(a.quantidade_atual||0)+i,setDB(t),toast("Reabastecido",`+${num(i,2)} ${a.unidade||""} adicionados.`),s())},window.__delEst=e=>{if(!confirm("Excluir este item do estoque?"))return;const t=getDB();t.estoque=t.estoque.filter(t=>t.id!==e),setDB(t),toast("Exclu√≠do","Item removido do estoque."),s()},document.getElementById("filtroEstoque")?.addEventListener("input",s),a&&document.getElementById("frmEstoque").addEventListener("submit",e=>{e.preventDefault();const t=new FormData(e.target),a=t.get("produtoId"),o=t.get("deposito")||"Central",d=Number(t.get("qtd")||0),i=t.get("lote")||"",r=t.get("validade")||"",l=t.get("obs")||"";if(!a||d<=0)return void toast("Aten√ß√£o","Selecione um produto e informe quantidade > 0.");const u=getDB(),p=n.find(e=>e.id===a);if(!p)return;const c=u.estoque.find(e=>e.safraId===getSafraId()&&e.produtoId===a&&(e.deposito||"Central")===o);c?(c.quantidade_atual=Number(c.quantidade_atual||0)+d,c.obs=l||c.obs,i&&(c.lote=i),r&&(c.validade=r),toast("Estoque atualizado",`${p.nome} ‚Äî ${num(c.quantidade_atual,2)} ${p.unidade}`)):(u.estoque.push({id:uid("stk"),safraId:getSafraId(),produtoId:a,deposito:o,lote:i,validade:r,quantidade_atual:d,unidade:p.unidade||"",obs:l}),toast("üì¶ Produto adicionado",`${p.nome} registrado no estoque.`)),setDB(u),e.target.reset(),document.getElementById("unidadeAuto").value="",s()}),document.getElementById("btnExportEstCSV")?.addEventListener("click",()=>{const e=getDB(),t=onlySafra(e.estoque||[]).map(e=>{const t=n.find(t=>t.id===e.produtoId);return{Produto:t?t.nome:"Desconhecido",Tipo:t?t.tipo:"","Dep√≥sito":e.deposito||"Central",Lote:e.lote||"",Validade:e.validade||"",Quantidade:e.quantidade_atual||0,Unidade:e.unidade||"","Observa√ß√µes":e.obs||""}});downloadText(`estoque-${nowISO()}.csv`,toCSV(t)),toast("Exportado","CSV de estoque baixado.")}),s()}function pageProdutos(){pageInsumos("produtos")}function pageEstoque(){pageInsumos("estoque")}