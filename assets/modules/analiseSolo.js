function pageAnaliseSolo(){const a=getDB(),e=getSafraId();let n=onlySafra(a.talhoes||[]);fazendaAtual&&(n=n.filter(a=>a.fazendaId===fazendaAtual));const o=onlySafra(a.fazendas||[]),t=(onlySafra(a.insumosBase||[]),onlySafra(a.analiseSolo||[]).sort((a,e)=>(e.data||"").localeCompare(a.data||"")));setTopActions('\n    <button class="btn" id="btnExportAnaliseSoloCSV">ğŸ“¥ CSV</button>\n    <button class="btn primary noPrint" id="btnImprimirAnalise">ğŸ–¨ï¸ Imprimir</button>\n  ');const i=new Set(t.map(a=>a.talhaoId)).size,l=t.length,s=t.length?(t.reduce((a,e)=>a+Number(e.ph||0),0)/t.length).toFixed(1):"â€”",d=t[0];function r(){const a=document.getElementById("asHistoricoFiltroTalhao")?.value||"",e=getDB();let n=onlySafra(e.analiseSolo||[]).sort((a,e)=>(e.data||"").localeCompare(a.data||""));a&&(n=n.filter(e=>e.talhaoId===a));const o=document.getElementById("asHistoricoContainer");n.length?o.innerHTML=`\n      <div class="as-table-wrap">\n        <table class="as-table">\n          <thead>\n            <tr>\n              <th>Data</th>\n              <th>TalhÃ£o</th>\n              <th>Fazenda</th>\n              <th>pH</th>\n              <th>M.O.</th>\n              <th>P</th>\n              <th>K</th>\n              <th>V%</th>\n              <th>Textura</th>\n              <th>Lab</th>\n              <th>Rec. Calagem</th>\n              <th>AÃ§Ãµes</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${n.map(a=>`\n              <tr>\n                <td>${_fmtData(a.data)}</td>\n                <td><b>${escapeHtml(a.talhaoNome||"â€”")}</b></td>\n                <td>${escapeHtml(a.fazendaNome||"â€”")}</td>\n                <td>${_phBadge(a.ph)}</td>\n                <td>${null!=a.mo?a.mo:"â€”"}</td>\n                <td>${null!=a.p?a.p:"â€”"}</td>\n                <td>${null!=a.k?a.k:"â€”"}</td>\n                <td>${null!=a.vPct?`<b>${a.vPct}%</b>`:"â€”"}</td>\n                <td style="text-transform:capitalize;">${a.textura?.replace("_"," ")||"â€”"}</td>\n                <td style="font-size:11px;">${escapeHtml(a.laboratorio||"â€”")}</td>\n                <td>${a.recomCalagem?`<b>${a.recomCalagem} t/ha</b>`:"â€”"}</td>\n                <td style="white-space:nowrap;">\n                  <button class="btn" style="padding:3px 8px; font-size:11px;" onclick="_asVerDetalhes('${a.id}')">ğŸ”</button>\n                  <button class="btn" style="padding:3px 8px; font-size:11px; color:#ef4444;" onclick="_asDeleteAnalise('${a.id}')">ğŸ—‘ï¸</button>\n                </td>\n              </tr>\n            `).join("")}\n          </tbody>\n        </table>\n      </div>\n    `:o.innerHTML='<div style="text-align:center; padding:30px; color:#94a3b8;">Nenhuma anÃ¡lise registrada.</div>'}document.getElementById("content").innerHTML=`\n    <style>\n      .as-kpi-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));\n        gap: 14px;\n        margin-bottom: 24px;\n      }\n      .as-kpi {\n        background: white;\n        border-radius: 12px;\n        padding: 16px 18px;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.07);\n        border-left: 4px solid #10b981;\n      }\n      .as-kpi.azul    { border-color: #3b82f6; }\n      .as-kpi.amarelo { border-color: #f59e0b; }\n      .as-kpi.vermelho{ border-color: #ef4444; }\n      .as-kpi.roxo    { border-color: #8b5cf6; }\n      .as-kpi .label  { font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }\n      .as-kpi .value  { font-size: 24px; font-weight: 800; color: #0f172a; }\n      .as-kpi .sub    { font-size: 11px; color: #94a3b8; margin-top: 3px; }\n\n      .as-section { margin-bottom: 28px; }\n      .as-form-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n        gap: 12px;\n      }\n      .as-form-grid .full { grid-column: 1/-1; }\n\n      .param-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n        gap: 10px;\n        margin-bottom: 16px;\n      }\n      .param-item { display: flex; flex-direction: column; gap: 4px; }\n      .param-item small { font-weight: 600; font-size: 11px; color: #64748b; }\n\n      .as-table-wrap { overflow-x: auto; }\n      .as-table { width: 100%; border-collapse: collapse; font-size: 13px; }\n      .as-table th {\n        background: #f1f5f9;\n        padding: 9px 12px;\n        text-align: left;\n        font-weight: 600;\n        color: #475569;\n        border-bottom: 2px solid #e2e8f0;\n        white-space: nowrap;\n      }\n      .as-table td {\n        padding: 9px 12px;\n        border-bottom: 1px solid #f1f5f9;\n        color: #334155;\n        vertical-align: middle;\n      }\n      .as-table tr:hover td { background: #f8fafc; }\n\n      .ph-badge {\n        display: inline-block;\n        padding: 2px 9px;\n        border-radius: 20px;\n        font-size: 11px;\n        font-weight: 700;\n      }\n      .ph-acido   { background: #fee2e2; color: #991b1b; }\n      .ph-neutro  { background: #dcfce7; color: #166534; }\n      .ph-alcalino{ background: #dbeafe; color: #1e40af; }\n\n      .recom-box {\n        background: linear-gradient(135deg, #0f172a, #1e3a2f);\n        border-radius: 12px;\n        padding: 20px;\n        color: white;\n        margin-top: 8px;\n      }\n      .recom-box h4 { margin: 0 0 12px; color: #4ade80; font-size: 15px; }\n      .recom-item {\n        display: flex;\n        align-items: flex-start;\n        gap: 10px;\n        padding: 8px 0;\n        border-bottom: 1px solid rgba(255,255,255,0.08);\n        font-size: 13px;\n        line-height: 1.5;\n      }\n      .recom-item:last-child { border-bottom: none; }\n      .recom-icon { font-size: 20px; flex-shrink: 0; }\n      .recom-text b { color: #a3e635; }\n\n      .integracao-card {\n        background: #f0fdf4;\n        border: 1px solid #86efac;\n        border-radius: 10px;\n        padding: 16px;\n        margin-bottom: 12px;\n      }\n      .integracao-card h4 { margin: 0 0 10px; color: #166534; font-size: 14px; }\n      .integracao-card .row {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        font-size: 13px;\n        color: #374151;\n        padding: 4px 0;\n        border-bottom: 1px solid #d1fae5;\n      }\n      .integracao-card .row:last-child { border-bottom: none; }\n\n      .ai-recom-box {\n        background: linear-gradient(135deg, #1e1b4b, #0f172a);\n        border-radius: 12px;\n        padding: 20px 24px;\n        color: white;\n        border: 1px solid #4338ca;\n      }\n      .ai-recom-box h4 { margin: 0 0 12px; color: #a78bfa; }\n      .ai-recom-text { font-size: 13px; line-height: 1.8; color: #e2e8f0; white-space: pre-wrap; }\n\n      .tabs { display: flex; gap: 4px; margin-bottom: 20px; flex-wrap: wrap; }\n      .tab-btn {\n        padding: 8px 16px;\n        border: 1px solid #e2e8f0;\n        border-radius: 8px;\n        background: white;\n        font-size: 13px;\n        cursor: pointer;\n        font-weight: 500;\n        color: #64748b;\n        transition: all 0.2s;\n      }\n      .tab-btn.active {\n        background: var(--primary, #2e7d32);\n        color: white;\n        border-color: var(--primary, #2e7d32);\n        font-weight: 700;\n      }\n\n      @media print {\n        .noPrint, button { display: none !important; }\n        .card { box-shadow: none !important; border: 1px solid #ddd !important; }\n      }\n    </style>\n\n    \x3c!-- KPIs --\x3e\n    <div class="as-kpi-grid">\n      <div class="as-kpi">\n        <div class="label">ğŸ”¬ AnÃ¡lises Registradas</div>\n        <div class="value">${l}</div>\n        <div class="sub">na safra atual</div>\n      </div>\n      <div class="as-kpi azul">\n        <div class="label">ğŸ§­ TalhÃµes Analisados</div>\n        <div class="value">${i} / ${n.length}</div>\n        <div class="sub">${n.length-i>0?`âš ï¸ ${n.length-i} sem anÃ¡lise`:"âœ… todos analisados"}</div>\n      </div>\n      <div class="as-kpi amarelo">\n        <div class="label">âš—ï¸ pH MÃ©dio</div>\n        <div class="value">${s}</div>\n        <div class="sub">${_phInterpret(parseFloat(s))}</div>\n      </div>\n      <div class="as-kpi roxo">\n        <div class="label">ğŸ“… Ãšltima AnÃ¡lise</div>\n        <div class="value" style="font-size:16px;">${d?_fmtData(d.data):"â€”"}</div>\n        <div class="sub">${d?escapeHtml(d.talhaoNome||"â€”"):"Nenhuma ainda"}</div>\n      </div>\n    </div>\n\n    \x3c!-- TABS --\x3e\n    <div class="tabs noPrint">\n      <button class="tab-btn active" onclick="_asTab('form')">ğŸ“ Nova AnÃ¡lise</button>\n      <button class="tab-btn" onclick="_asTab('historico')">ğŸ“‹ HistÃ³rico</button>\n      <button class="tab-btn" onclick="_asTab('integracao')">ğŸŒ± IntegraÃ§Ã£o Insumos</button>\n      <button class="tab-btn" onclick="_asTab('recomendacoes')">ğŸ¤– RecomendaÃ§Ãµes IA</button>\n    </div>\n\n    \x3c!-- TAB: FORMULÃRIO --\x3e\n    <div id="tabForm" class="card as-section">\n      <h3 style="margin:0 0 18px; font-size:16px; color:#0f172a;">ğŸ”¬ Registrar AnÃ¡lise de Solo</h3>\n\n      <div class="as-form-grid" style="margin-bottom:14px;">\n        <div>\n          <small class="form-label">TalhÃ£o *</small>\n          <select class="select" id="asTalhao" onchange="_asPreencheTalhao()">\n            <option value="">â€” Selecione â€”</option>\n            ${n.map(a=>{const e=o.find(e=>e.id===a.fazendaId);return`<option value="${a.id}" data-area="${a.areaHa}" data-cultura="${a.cultura||""}" data-fazenda="${e?.nome||""}">${escapeHtml(a.nome)} â€” ${escapeHtml(e?.nome||"")} (${num(a.areaHa||0,1)} ha)</option>`}).join("")}\n          </select>\n        </div>\n        <div>\n          <small class="form-label">Data da Coleta *</small>\n          <input class="input" type="date" id="asData" value="${nowISO()}" />\n        </div>\n        <div>\n          <small class="form-label">LaboratÃ³rio</small>\n          <input class="input" type="text" id="asLaboratorio" placeholder="Ex: Embrapa, LabSolo..." />\n        </div>\n        <div>\n          <small class="form-label">Profundidade (cm)</small>\n          <select class="select" id="asProfundidade">\n            <option value="0-20">0 â€“ 20 cm</option>\n            <option value="20-40">20 â€“ 40 cm</option>\n            <option value="0-10">0 â€“ 10 cm</option>\n            <option value="0-40">0 â€“ 40 cm</option>\n            <option value="0-60">0 â€“ 60 cm</option>\n          </select>\n        </div>\n        <div>\n          <small class="form-label">Textura do Solo</small>\n          <select class="select" id="asTextura">\n            <option value="">â€” NÃ£o informado â€”</option>\n            <option value="argiloso">Argiloso</option>\n            <option value="muito_argiloso">Muito Argiloso</option>\n            <option value="areno_argiloso">Argilo-Arenoso</option>\n            <option value="medio">Textura MÃ©dia</option>\n            <option value="arenoso">Arenoso</option>\n            <option value="franco">Franco</option>\n          </select>\n        </div>\n        <div>\n          <small class="form-label">NÂº do Laudo</small>\n          <input class="input" type="text" id="asNumeroLaudo" placeholder="Ex: LAB-2025-001" />\n        </div>\n      </div>\n\n      <h4 style="font-size:14px; color:#334155; margin:16px 0 12px;">âš—ï¸ ParÃ¢metros QuÃ­micos</h4>\n      <div class="param-grid">\n        <div class="param-item">\n          <small>pH (Hâ‚‚O) *</small>\n          <input class="input" type="number" id="asPH" placeholder="Ex: 6.2" min="0" max="14" step="0.1" oninput="_asInterpretPH()" />\n          <span id="asPhStatus" style="font-size:11px; color:#64748b;"></span>\n        </div>\n        <div class="param-item">\n          <small>M.O. (g/dmÂ³)</small>\n          <input class="input" type="number" id="asMO" placeholder="Ex: 28" min="0" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>P (mg/dmÂ³)</small>\n          <input class="input" type="number" id="asP" placeholder="Ex: 12" min="0" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>K (mmolc/dmÂ³)</small>\n          <input class="input" type="number" id="asK" placeholder="Ex: 2.8" min="0" step="0.01" />\n        </div>\n        <div class="param-item">\n          <small>Ca (mmolc/dmÂ³)</small>\n          <input class="input" type="number" id="asCa" placeholder="Ex: 30" min="0" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>Mg (mmolc/dmÂ³)</small>\n          <input class="input" type="number" id="asMg" placeholder="Ex: 12" min="0" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>Al (mmolc/dmÂ³)</small>\n          <input class="input" type="number" id="asAl" placeholder="Ex: 0" min="0" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>H+Al (mmolc/dmÂ³)</small>\n          <input class="input" type="number" id="asHAl" placeholder="Ex: 40" min="0" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>S â€“ Enxofre (mg/dmÂ³)</small>\n          <input class="input" type="number" id="asS" placeholder="Ex: 5" min="0" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>B â€“ Boro (mg/dmÂ³)</small>\n          <input class="input" type="number" id="asB" placeholder="Ex: 0.3" min="0" step="0.01" />\n        </div>\n        <div class="param-item">\n          <small>Cu (mg/dmÂ³)</small>\n          <input class="input" type="number" id="asCu" placeholder="Ex: 1.2" min="0" step="0.01" />\n        </div>\n        <div class="param-item">\n          <small>Fe (mg/dmÂ³)</small>\n          <input class="input" type="number" id="asFe" placeholder="Ex: 28" min="0" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>Mn (mg/dmÂ³)</small>\n          <input class="input" type="number" id="asMn" placeholder="Ex: 5" min="0" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>Zn (mg/dmÂ³)</small>\n          <input class="input" type="number" id="asZn" placeholder="Ex: 1.5" min="0" step="0.01" />\n        </div>\n      </div>\n\n      <h4 style="font-size:14px; color:#334155; margin:16px 0 12px;">ğŸ“ ParÃ¢metros Calculados / FÃ­sicos</h4>\n      <div class="param-grid">\n        <div class="param-item">\n          <small>CTC (mmolc/dmÂ³)</small>\n          <input class="input" type="number" id="asCTC" placeholder="Calculado ou manual" min="0" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>V% â€“ SaturaÃ§Ã£o de Bases</small>\n          <input class="input" type="number" id="asV" placeholder="Ex: 70" min="0" max="100" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>m% â€“ Sat. por AlumÃ­nio</small>\n          <input class="input" type="number" id="asM" placeholder="Ex: 5" min="0" max="100" step="0.1" />\n        </div>\n        <div class="param-item">\n          <small>Areia (%)</small>\n          <input class="input" type="number" id="asAreia" placeholder="Ex: 45" min="0" max="100" step="1" />\n        </div>\n        <div class="param-item">\n          <small>Silte (%)</small>\n          <input class="input" type="number" id="asSilte" placeholder="Ex: 20" min="0" max="100" step="1" />\n        </div>\n        <div class="param-item">\n          <small>Argila (%)</small>\n          <input class="input" type="number" id="asArgila" placeholder="Ex: 35" min="0" max="100" step="1" />\n        </div>\n      </div>\n\n      <h4 style="font-size:14px; color:#334155; margin:16px 0 12px;">ğŸ“‹ RecomendaÃ§Ã£o do LaboratÃ³rio</h4>\n      <div class="as-form-grid" style="margin-bottom:14px;">\n        <div class="full">\n          <small class="form-label">RecomendaÃ§Ã£o de Calagem (t/ha)</small>\n          <input class="input" type="number" id="asRecomCalagem" placeholder="Ex: 2.5 t/ha" min="0" step="0.1" />\n        </div>\n        <div class="full">\n          <small class="form-label">RecomendaÃ§Ã£o de Gessagem (t/ha)</small>\n          <input class="input" type="number" id="asRecomGessagem" placeholder="Ex: 1.0 t/ha" min="0" step="0.1" />\n        </div>\n        <div class="full">\n          <small class="form-label">AdubaÃ§Ã£o Recomendada pelo Lab (livre)</small>\n          <textarea class="input" id="asRecomAdubacao" rows="3" placeholder="Ex: 300 kg/ha 08-28-16 na semeadura + 150 kg/ha ureia em cobertura..."></textarea>\n        </div>\n        <div class="full">\n          <small class="form-label">ObservaÃ§Ãµes do Laudo</small>\n          <textarea class="input" id="asObs" rows="2" placeholder="InformaÃ§Ãµes adicionais do laudo..."></textarea>\n        </div>\n      </div>\n\n      \x3c!-- BotÃ£o calcular V% --\x3e\n      <div style="margin-bottom:16px;">\n        <button class="btn" id="btnCalcVpct" style="font-size:12px;">ğŸ§® Calcular V% e CTC automaticamente</button>\n        <span id="asCalcResult" style="font-size:12px; color:#64748b; margin-left:10px;"></span>\n      </div>\n\n      <div style="display:flex; gap:10px; flex-wrap:wrap;">\n        <button class="btn primary" id="btnSalvarAnalise" style="min-width:160px;">ğŸ’¾ Salvar AnÃ¡lise</button>\n        <button class="btn" id="btnLimparAnalise">ğŸ”„ Limpar</button>\n      </div>\n    </div>\n\n    \x3c!-- TAB: HISTÃ“RICO --\x3e\n    <div id="tabHistorico" class="card as-section" style="display:none;">\n      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:10px;">\n        <h3 style="margin:0; font-size:16px; color:#0f172a;">ğŸ“‹ HistÃ³rico de AnÃ¡lises</h3>\n        <select class="select" id="asHistoricoFiltroTalhao" style="width:200px;">\n          <option value="">Todos os talhÃµes</option>\n          ${n.map(a=>`<option value="${a.id}">${escapeHtml(a.nome)}</option>`).join("")}\n        </select>\n      </div>\n      <div id="asHistoricoContainer"></div>\n    </div>\n\n    \x3c!-- TAB: INTEGRAÃ‡ÃƒO COM INSUMOS BASE --\x3e\n    <div id="tabIntegracao" class="card as-section" style="display:none;">\n      <h3 style="margin:0 0 6px; font-size:16px; color:#0f172a;">ğŸŒ± IntegraÃ§Ã£o: AnÃ¡lise de Solo + Insumos Base</h3>\n      <p style="color:#64748b; font-size:13px; margin:0 0 20px;">Visualize a correlaÃ§Ã£o entre o laudo de solo e os insumos de base aplicados em cada talhÃ£o.</p>\n      <div id="asIntegracaoContainer"></div>\n    </div>\n\n    \x3c!-- TAB: RECOMENDAÃ‡Ã•ES IA --\x3e\n    <div id="tabRecomendacoes" class="card as-section" style="display:none;">\n      <h3 style="margin:0 0 6px; font-size:16px; color:#0f172a;">ğŸ¤– RecomendaÃ§Ãµes da IA por TalhÃ£o</h3>\n      <p style="color:#64748b; font-size:13px; margin:0 0 16px;">Baseadas nas anÃ¡lises de solo registradas e nos insumos aplicados.</p>\n\n      <div style="margin-bottom:16px;">\n        <label style="font-size:13px; font-weight:600; margin-bottom:6px; display:block;">Selecione o talhÃ£o para anÃ¡lise:</label>\n        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">\n          <select class="select" id="asRecomTalhao" style="min-width:220px;">\n            <option value="">â€” Selecione um talhÃ£o â€”</option>\n            ${n.map(a=>`<option value="${a.id}">${escapeHtml(a.nome)}</option>`).join("")}\n          </select>\n          <button class="btn primary" id="btnGerarRecomIA" style="min-width:160px;">ğŸ¤– Gerar RecomendaÃ§Ãµes</button>\n          <button class="btn" id="btnAbrirCopilot" style="min-width:160px;">ğŸ’¬ Aprofundar no Copilot</button>\n        </div>\n      </div>\n\n      <div id="asRecomContainer">\n        <div style="text-align:center; padding:40px; color:#94a3b8;">\n          <div style="font-size:40px; margin-bottom:10px;">ğŸ”¬</div>\n          <p>Selecione um talhÃ£o e clique em "Gerar RecomendaÃ§Ãµes" para obter anÃ¡lise completa da IA.</p>\n        </div>\n      </div>\n    </div>\n  `,window._asTab=function(a){["tabForm","tabHistorico","tabIntegracao","tabRecomendacoes"].forEach(a=>{document.getElementById(a).style.display="none"}),document.querySelectorAll(".tab-btn").forEach((e,n)=>{e.classList.toggle("active",e.textContent.toLowerCase().includes("form"===a?"nova":"historico"===a?"histÃ³rico":"integracao"===a?"integr":"recom"))}),document.getElementById("tab"+a.charAt(0).toUpperCase()+a.slice(1)).style.display="block","historico"===a&&r(),"integracao"===a&&function(){const a=document.getElementById("asIntegracaoContainer"),e=getDB(),t=onlySafra(e.analiseSolo||[]),i=onlySafra(e.insumosBase||[]);if(!n.length)return void(a.innerHTML='<div style="text-align:center; padding:30px; color:#94a3b8;">Nenhum talhÃ£o cadastrado.</div>');let l="";n.forEach(a=>{const e=t.filter(e=>e.talhaoId===a.id).sort((a,e)=>e.data.localeCompare(a.data))[0],n=i.filter(e=>e.talhaoId===a.id),s=n.reduce((a,e)=>a+Number(e.custoTotal||0),0),d=o.find(e=>e.id===a.fazendaId);l+=`\n        <div class="integracao-card">\n          <h4>ğŸ§­ ${escapeHtml(a.nome)} â€” ${escapeHtml(d?.nome||"â€”")} (${num(a.areaHa||0,1)} ha)</h4>\n          <div class="row">\n            <span>ğŸ“… Ãšltima anÃ¡lise de solo:</span>\n            <span><b>${e?_fmtData(e.data):"âš ï¸ Sem anÃ¡lise"}</b></span>\n          </div>\n          ${e?`\n          <div class="row">\n            <span>âš—ï¸ pH / V% / M.O.:</span>\n            <span>${_phBadge(e.ph)} &nbsp; V%: <b>${e.vPct??"â€”"}%</b> &nbsp; M.O.: <b>${e.mo??"â€”"} g/dmÂ³</b></span>\n          </div>\n          <div class="row">\n            <span>ğŸ“Œ Rec. Calagem:</span>\n            <span><b>${e.recomCalagem?e.recomCalagem+" t/ha":"â€”"}</b></span>\n          </div>\n          `:""}\n          <div class="row">\n            <span>ğŸŒ± Insumos base aplicados:</span>\n            <span><b>${n.length} lanÃ§amento(s)</b> â€” ${brl(s)}</span>\n          </div>\n          ${_asAlertaIntegracao(e,n,a)}\n          <div style="margin-top:10px;">\n            <button class="btn" style="font-size:11px; padding:4px 10px;" onclick="_asTab('recomendacoes'); document.getElementById('asRecomTalhao').value='${a.id}'">ğŸ¤– Gerar RecomendaÃ§Ã£o IA</button>\n            ${e?"":`<button class="btn primary" style="font-size:11px; padding:4px 10px; margin-left:6px;" onclick="_asTab('form'); document.getElementById('asTalhao').value='${a.id}'">+ Registrar AnÃ¡lise</button>`}\n          </div>\n        </div>\n      `}),a.innerHTML=l}()},window._asInterpretPH=function(){const a=parseFloat(document.getElementById("asPH")?.value||0),e=document.getElementById("asPhStatus");e&&(e.textContent=a?_phInterpret(a):"",e.style.color=a<5.5?"#ef4444":a<=7?"#10b981":"#3b82f6")},document.getElementById("btnCalcVpct")?.addEventListener("click",()=>{const a=parseFloat(document.getElementById("asCa")?.value||0),e=parseFloat(document.getElementById("asMg")?.value||0),n=parseFloat(document.getElementById("asK")?.value||0),o=parseFloat(document.getElementById("asAl")?.value||0),t=a+e+n,i=t+parseFloat(document.getElementById("asHAl")?.value||0),l=i>0?t/i*100:0,s=t+o>0?o/(t+o)*100:0;document.getElementById("asCTC").value=i.toFixed(1),document.getElementById("asV").value=l.toFixed(1),document.getElementById("asM").value=s.toFixed(1),document.getElementById("asCalcResult").textContent=`âœ… CTC: ${i.toFixed(1)} | V%: ${l.toFixed(1)}% | m%: ${s.toFixed(1)}%`}),window._asPreencheTalhao=function(){const a=document.getElementById("asTalhao");a?.options[a.selectedIndex]},document.getElementById("btnSalvarAnalise")?.addEventListener("click",()=>{const a=document.getElementById("asTalhao").value,t=document.getElementById("asData").value,i=document.getElementById("asPH").value;if(!a)return toast("âŒ Erro","Selecione um talhÃ£o");if(!t)return toast("âŒ Erro","Informe a data da coleta");if(!i)return toast("âŒ Erro","Informe o pH do solo");const l=n.find(e=>e.id===a),s=o.find(a=>a.id===l?.fazendaId),d=a=>parseFloat(document.getElementById(a)?.value||"")||null,r=a=>document.getElementById(a)?.value?.trim()||"",c={id:"as_"+Date.now(),safraId:e,talhaoId:a,talhaoNome:l?.nome||"",talhaoArea:l?.areaHa||0,talhaoCultura:l?.cultura||"",fazendaNome:s?.nome||"",data:t,laboratorio:r("asLaboratorio"),profundidade:r("asProfundidade"),textura:r("asTextura"),numeroLaudo:r("asNumeroLaudo"),ph:d("asPH"),mo:d("asMO"),p:d("asP"),k:d("asK"),ca:d("asCa"),mg:d("asMg"),al:d("asAl"),hAl:d("asHAl"),s:d("asS"),b:d("asB"),cu:d("asCu"),fe:d("asFe"),mn:d("asMn"),zn:d("asZn"),ctc:d("asCTC"),vPct:d("asV"),mPct:d("asM"),areia:d("asAreia"),silte:d("asSilte"),argila:d("asArgila"),recomCalagem:d("asRecomCalagem"),recomGessagem:d("asRecomGessagem"),recomAdubacao:r("asRecomAdubacao"),obs:r("asObs"),criadoEm:(new Date).toISOString()},m=getDB();m.analiseSolo=m.analiseSolo||[],m.analiseSolo.push(c),setDB(m),toast("Agro Pro",`âœ… AnÃ¡lise do talhÃ£o "${l?.nome}" salva com sucesso!`,"success"),pageAnaliseSolo()}),document.getElementById("btnLimparAnalise")?.addEventListener("click",()=>{["asTalhao","asLaboratorio","asProfundidade","asTextura","asNumeroLaudo","asPH","asMO","asP","asK","asCa","asMg","asAl","asHAl","asS","asB","asCu","asFe","asMn","asZn","asCTC","asV","asM","asAreia","asSilte","asArgila","asRecomCalagem","asRecomGessagem","asRecomAdubacao","asObs"].forEach(a=>{const e=document.getElementById(a);e&&(e.value="SELECT"===e.tagName&&e.options[0]?.value||"")}),document.getElementById("asData").value=nowISO(),document.getElementById("asPhStatus").textContent="",document.getElementById("asCalcResult").textContent=""}),document.getElementById("asHistoricoFiltroTalhao")?.addEventListener("change",r),document.getElementById("btnGerarRecomIA")?.addEventListener("click",()=>{const a=document.getElementById("asRecomTalhao")?.value;if(!a)return toast("âŒ Erro","Selecione um talhÃ£o");const e=n.find(e=>e.id===a),o=getDB(),t=onlySafra(o.analiseSolo||[]).filter(e=>e.talhaoId===a).sort((a,e)=>e.data.localeCompare(a.data)),i=onlySafra(o.insumosBase||[]).filter(e=>e.talhaoId===a),l=document.getElementById("asRecomContainer");if(!t.length)return void(l.innerHTML=`\n        <div style="text-align:center; padding:30px; color:#94a3b8;">\n          <div style="font-size:36px; margin-bottom:8px;">âš ï¸</div>\n          <p>Nenhuma anÃ¡lise de solo registrada para o talhÃ£o <b>${escapeHtml(e?.nome||"")}</b>.</p>\n          <button class="btn primary" onclick="_asTab('form'); document.getElementById('asTalhao').value='${a}'">+ Registrar AnÃ¡lise Agora</button>\n        </div>\n      `);const s=t[0],d=_asGerarRecomLocal(s,e,i);l.innerHTML=`\n      <div style="margin-bottom:16px; padding:12px 14px; background:#f1f5f9; border-radius:8px; font-size:12px; color:#64748b;">\n        ğŸ”¬ <b>TalhÃ£o:</b> ${escapeHtml(e?.nome||"")} &nbsp;|&nbsp;\n        ğŸ“… <b>Coleta:</b> ${_fmtData(s.data)} &nbsp;|&nbsp;\n        âš—ï¸ <b>pH:</b> ${s.ph??"â€”"} &nbsp;|&nbsp;\n        ğŸ“Š <b>V%:</b> ${s.vPct??"â€”"}%\n      </div>\n\n      <div class="recom-box">\n        <h4>ğŸ“‹ DiagnÃ³stico e RecomendaÃ§Ãµes TÃ©cnicas</h4>\n        ${d.map(a=>`\n          <div class="recom-item">\n            <span class="recom-icon">${a.icon}</span>\n            <div class="recom-text">\n              <b>${a.titulo}</b><br>\n              ${a.texto}\n            </div>\n          </div>\n        `).join("")}\n      </div>\n\n      <div style="margin-top:16px;" id="asIaBox">\n        <div style="text-align:center; padding:20px; color:#94a3b8;">\n          <div style="font-size:24px;">ğŸ¤–</div>\n          <p style="font-size:13px;">Consultando IA para recomendaÃ§Ãµes avanÃ§adas...</p>\n        </div>\n      </div>\n    `,_asConsultarIAParaTalhao(s,e,i)}),document.getElementById("btnAbrirCopilot")?.addEventListener("click",()=>{const a=document.getElementById("asRecomTalhao")?.value;n.find(e=>e.id===a)&&"function"==typeof pageAnaliseSoloNoCopilot?pageAnaliseSoloNoCopilot(a):window.location.href="copilot.html"}),document.getElementById("btnExportAnaliseSoloCSV")?.addEventListener("click",()=>{const a=getDB(),e=onlySafra(a.analiseSolo||[]);if(!e.length)return toast("âŒ Erro","Nenhum dado para exportar");const n=e.map(a=>[a.data,a.talhaoNome,a.fazendaNome,a.talhaoArea,a.talhaoCultura,a.ph,a.mo,a.p,a.k,a.ca,a.mg,a.al,a.hAl,a.s,a.b,a.cu,a.fe,a.mn,a.zn,a.ctc,a.vPct,a.mPct,a.areia,a.silte,a.argila,a.textura,a.profundidade,a.recomCalagem,a.recomGessagem,a.recomAdubacao,a.laboratorio,a.numeroLaudo,a.obs]),o=[["Data","TalhÃ£o","Fazenda","Ãrea(ha)","Cultura","pH","M.O.","P","K","Ca","Mg","Al","H+Al","S","B","Cu","Fe","Mn","Zn","CTC","V%","m%","Areia%","Silte%","Argila%","Textura","Profundidade","Rec.Calagem(t/ha)","Rec.Gessagem(t/ha)","Rec.AdubaÃ§Ã£o","Lab","Laudo","Obs"],...n].map(a=>a.map(a=>`"${String(a??"").replace(/"/g,'""')}"`).join(",")).join("\n"),t=document.createElement("a");t.href="data:text/csv;charset=utf-8,\ufeff"+encodeURIComponent(o),t.download=`analise-solo-${getSafraAtual()?.nome||"safra"}.csv`,t.click()}),document.getElementById("btnImprimirAnalise")?.addEventListener("click",()=>window.print()),window._asDeleteAnalise=function(a){if(!confirm("Excluir esta anÃ¡lise de solo?"))return;const e=getDB();e.analiseSolo=(e.analiseSolo||[]).filter(e=>e.id!==a),setDB(e),toast("â„¹ï¸ Info","AnÃ¡lise excluÃ­da."),r()},window._asVerDetalhes=function(a){const e=(getDB().analiseSolo||[]).find(e=>e.id===a);if(!e)return;const n=`ğŸ”¬ AnÃ¡lise: ${escapeHtml(e.talhaoNome)} â€” ${_fmtData(e.data)}\n\npH: ${e.ph} (${_phInterpret(e.ph)})\nM.O.: ${e.mo??"â€”"} g/dmÂ³\nP: ${e.p??"â€”"} | K: ${e.k??"â€”"} | Ca: ${e.ca??"â€”"} | Mg: ${e.mg??"â€”"}\nV%: ${e.vPct??"â€”"}% | CTC: ${e.ctc??"â€”"}\nTextura: ${e.textura||"â€”"}\nCalagem Recomendada: ${e.recomCalagem?e.recomCalagem+" t/ha":"â€”"}\nAdubaÃ§Ã£o: ${e.recomAdubacao||"â€”"}`;alert(n)}}function _phInterpret(a){return!a||isNaN(a)?"":a<4.5?"âš ï¸ Extremamente Ã¡cido":a<5?"ğŸ”´ Muito Ã¡cido":a<5.5?"ğŸŸ  Ãcido":a<6?"ğŸŸ¡ Moderadamente Ã¡cido":a<6.5?"ğŸŸ¢ Levemente Ã¡cido":a<=7?"âœ… Neutro / Ideal":a<=7.5?"ğŸ”µ Alcalino":"âš ï¸ Muito Alcalino"}function _phBadge(a){return null==a?"â€”":`<span class="ph-badge ${a<5.5?"ph-acido":a<=7?"ph-neutro":"ph-alcalino"}">${a}</span>`}function _fmtData(a){if(!a)return"â€”";const[e,n,o]=a.split("-");return`${o}/${n}/${e}`}function _asAlertaIntegracao(a,e,n){if(!a)return"";const o=[];return a.ph<5.5&&a.recomCalagem>0&&(e.some(a=>"CalcÃ¡rio"===a.tipoInsumo)||o.push(`<div style="background:#fee2e2; color:#991b1b; padding:6px 10px; border-radius:6px; font-size:12px; margin-top:6px;">âš ï¸ pH ${a.ph} â€” Calagem recomendada (${a.recomCalagem} t/ha) mas <b>nenhum calcÃ¡rio registrado</b> em Insumos Base.</div>`)),a.vPct<50&&o.push(`<div style="background:#fef3c7; color:#92400e; padding:6px 10px; border-radius:6px; font-size:12px; margin-top:6px;">âš ï¸ V% = ${a.vPct}% â€” saturaÃ§Ã£o de bases baixa. Pode limitar absorÃ§Ã£o de nutrientes.</div>`),o.join("")}function _asGerarRecomLocal(a,e,n){const o=[],t=Number(a.ph||0),i=Number(a.vPct||0),l=Number(a.mo||0),s=Number(a.p||0),d=Number(a.k||0),r=Number(a.al||0);if((e?.cultura||"").toLowerCase(),t<5.5?o.push({icon:"ğŸ”´",titulo:"CorreÃ§Ã£o de pH urgente",texto:`pH ${t} estÃ¡ <b>abaixo do ideal</b> para a maioria das culturas (ideal 5.8â€“6.5). `+(a.recomCalagem?`RecomendaÃ§Ã£o do laboratÃ³rio: <b>${a.recomCalagem} t/ha</b> de calcÃ¡rio.`:"Realize calagem conforme recomendaÃ§Ã£o de laboratÃ³rio.")+` Cultura do talhÃ£o: ${e?.cultura||"nÃ£o informado"}.`}):t>=5.5&&t<=6.5?o.push({icon:"âœ…",titulo:"pH adequado",texto:`pH ${t} estÃ¡ na faixa ideal para a maioria das culturas tropicais. Manter monitoramento anual.`}):t>7&&o.push({icon:"ğŸ”µ",titulo:"Solo Alcalino",texto:`pH ${t} pode limitar absorÃ§Ã£o de micronutrientes (Fe, Mn, Zn, B). Verificar necessidade de acidificaÃ§Ã£o.`}),i>0&&(i<50?o.push({icon:"âš ï¸",titulo:"SaturaÃ§Ã£o de bases baixa",texto:`V% = ${i}%. Ideal â‰¥ 60â€“70% para culturas comerciais. Aplicar calcÃ¡rio e verificar fontes de Ca e Mg.`}):i>=60&&i<=80?o.push({icon:"âœ…",titulo:"SaturaÃ§Ã£o de bases ideal",texto:`V% = ${i}% â€” faixa excelente para produtividade. Manter com calagem de manutenÃ§Ã£o.`}):i>80&&o.push({icon:"ğŸ”µ",titulo:"SaturaÃ§Ã£o de bases elevada",texto:`V% = ${i}% â€” pode indicar excesso de calcÃ¡rio. Monitorar absorÃ§Ã£o de micronutrientes.`})),l>0&&(l<15?o.push({icon:"ğŸŸ¡",titulo:"MatÃ©ria orgÃ¢nica baixa",texto:`M.O. = ${l} g/dmÂ³ â€” abaixo do ideal (>20). Incorporar palhada, adubo verde ou esterco para melhorar estrutura e retenÃ§Ã£o hÃ­drica.`}):l>=15&&l<30?o.push({icon:"ğŸŸ¢",titulo:"MatÃ©ria orgÃ¢nica adequada",texto:`M.O. = ${l} g/dmÂ³ â€” manter com rotaÃ§Ã£o de culturas e preservaÃ§Ã£o de cobertura vegetal.`}):o.push({icon:"âœ…",titulo:"MatÃ©ria orgÃ¢nica alta",texto:`M.O. = ${l} g/dmÂ³ â€” excelente! Solo com boa estrutura, retenÃ§Ã£o hÃ­drica e biologia ativa.`})),s>0){const a=s>40;s<12?o.push({icon:"ğŸŸ ",titulo:"FÃ³sforo baixo",texto:`P = ${s} mg/dmÂ³ â€” deficiÃªncia pode limitar desenvolvimento radicular e produÃ§Ã£o. Aplicar adubaÃ§Ã£o fosfatada (superfosfato simples, MAP, DAP ou termofosfato).`}):a?o.push({icon:"ğŸ”µ",titulo:"FÃ³sforo elevado",texto:`P = ${s} mg/dmÂ³ â€” nÃ­veis altos. Reduzir aplicaÃ§Ã£o de fÃ³sforo por 1â€“2 safras para evitar fixaÃ§Ã£o e desequilÃ­brio.`}):o.push({icon:"âœ…",titulo:"FÃ³sforo adequado",texto:`P = ${s} mg/dmÂ³ â€” dentro da faixa ideal. Manter adubaÃ§Ã£o de manutenÃ§Ã£o conforme produtividade esperada.`})}if(d>0&&(d<1.5?o.push({icon:"ğŸŸ ",titulo:"PotÃ¡ssio baixo",texto:`K = ${d} mmolc/dmÂ³ â€” deficiÃªncia pode reduzir qualidade dos grÃ£os e resistÃªncia a doenÃ§as. Aplicar KCl ou Kâ‚‚SOâ‚„ conforme recomendaÃ§Ã£o.`}):d>5&&o.push({icon:"ğŸ”µ",titulo:"PotÃ¡ssio elevado",texto:`K = ${d} mmolc/dmÂ³ â€” nÃ­vel alto. Reduzir aplicaÃ§Ã£o de K e monitorar relaÃ§Ã£o Ca:Mg:K no solo.`})),r>0&&r>3&&o.push({icon:"ğŸ”´",titulo:"AlumÃ­nio tÃ³xico elevado",texto:`Al = ${r} mmolc/dmÂ³ â€” toxidez pode inibir crescimento radicular. Aplicar calcÃ¡rio para neutralizar AlÂ³âº (pH â‰¥ 5.5 geralmente neutraliza).`}),n.length>0){const a=[...new Set(n.map(a=>a.tipoInsumo))];o.push({icon:"ğŸ“¦",titulo:"Insumos base jÃ¡ aplicados neste talhÃ£o",texto:`Registros: ${n.length} lanÃ§amento(s) â€” tipos: ${a.join(", ")}. Verifique se as doses aplicadas estÃ£o compatÃ­veis com as recomendaÃ§Ãµes do laudo.`})}return a.recomAdubacao&&o.push({icon:"ğŸ§ª",titulo:"RecomendaÃ§Ã£o do LaboratÃ³rio",texto:escapeHtml(a.recomAdubacao)}),0===o.length&&o.push({icon:"âœ…",titulo:"Solo em boas condiÃ§Ãµes",texto:"Com base nos dados disponÃ­veis, o solo apresenta boas condiÃ§Ãµes. Continue monitorando anualmente."}),o}async function _asConsultarIAParaTalhao(a,e,n){const o=document.getElementById("asIaBox");o&&(o.innerHTML='\n    <div style="background:linear-gradient(135deg, #0f172a, #1e3a5f); border-radius:12px; padding:24px; text-align:center; color:white;">\n      <div style="display:inline-flex; align-items:center; gap:6px; background:rgba(251,191,36,0.2); padding:4px 12px; border-radius:20px; font-size:11px; font-weight:700; color:#fbbf24; margin-bottom:12px;">\n        <span style="display:inline-block; width:6px; height:6px; background:#fbbf24; border-radius:50%; animation:pulse 2s infinite;"></span>\n        EM DESENVOLVIMENTO\n      </div>\n      <h3 style="margin:0 0 8px; font-size:16px;">ğŸ¤– RecomendaÃ§Ã£o IA â€” Em Breve</h3>\n      <p style="margin:0; opacity:0.8; font-size:13px; line-height:1.5;">A anÃ¡lise de solo com IA estÃ¡ sendo aprimorada. Em breve vocÃª receberÃ¡ recomendaÃ§Ãµes de calagem e adubaÃ§Ã£o personalizadas por talhÃ£o.</p>\n    </div>\n  ')}function pageAnaliseSoloNoCopilot(a){const e=getDB(),n=(e.talhoes||[]).find(e=>e.id===a),o=onlySafra(e.analiseSolo||[]).filter(e=>e.talhaoId===a).sort((a,e)=>e.data.localeCompare(a.data))[0];let t=n?`Analise o solo do talhÃ£o "${n.nome}" (cultura: ${n.cultura||"N/A"}, Ã¡rea: ${n.areaHa} ha).`:"AnÃ¡lise de solo do talhÃ£o selecionado.";o&&(t+=` Ãšltimos resultados do laudo: pH=${o.ph}, V%=${o.vPct}%, M.O.=${o.mo} g/dmÂ³, P=${o.p} mg/dmÂ³, K=${o.k} mmolc/dmÂ³. `,o.recomCalagem&&(t+=`Calagem recomendada: ${o.recomCalagem} t/ha. `),t+="Quais as principais aÃ§Ãµes a tomar e qual o impacto esperado na produtividade?"),sessionStorage.setItem("_copilotAutoQuery",t),window.location.href="copilot.html"}