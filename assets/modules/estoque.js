function pageEstoque(){const e=getDB(),t=onlySafra(e.produtos);setTopActions('\n    <button class="btn" id="btnExportCSV">Exportar CSV</button>\n    <button class="btn primary" id="btnReabastecer">+ Reabastecer produto</button>\n  ');const a=document.getElementById("content"),d=`\n    <div class="card">\n      <h3>Adicionar produto ao estoque</h3>\n      <div class="help">Se o produto já existir no mesmo depósito, a quantidade será somada.</div>\n      <div class="hr"></div>\n      <form id="frm" class="formGrid">\n        <div>\n          <small>Produto</small>\n          <select class="select" name="produtoId" required>\n            <option value="">Selecione...</option>\n            ${t.map(e=>`<option value="${e.id}">${escapeHtml(e.nome)} — ${escapeHtml(e.tipo)}</option>`).join("")}\n          </select>\n        </div>\n        <div><small>Depósito</small><input class="input" name="deposito" placeholder="Central" value="Central" /></div>\n        <div><small>Lote</small><input class="input" name="lote" placeholder="Opcional" /></div>\n        <div><small>Validade</small><input class="input" name="validade" placeholder="YYYY-MM-DD" /></div>\n        <div><small>Quantidade</small><input class="input" name="qtd" type="number" step="0.01" required /></div>\n        <div><small>Unidade</small><input class="input" name="unidade" placeholder="L / kg" readonly /></div>\n        <div class="full"><small>Observações</small><textarea class="textarea" name="obs"></textarea></div>\n        <div class="full row" style="justify-content:flex-end">\n          <button class="btn primary" type="submit">Adicionar ao estoque</button>\n        </div>\n      </form>\n    </div>\n  `,n=`\n    <div class="tableWrap">\n      <table>\n        <thead>\n          <tr>\n            <th>Produto</th>\n            <th>Depósito</th>\n            <th>Lote</th>\n            <th>Validade</th>\n            <th>Qtd</th>\n            <th>Unid.</th>\n            <th>Obs</th>\n            <th class="noPrint">Ações</th>\n          </tr>\n        </thead>\n        <tbody id="tbody"></tbody>\n      </table>\n    </div>\n    \n    <div id="modalReabastecer" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">\n      <div style="background:#1a1a1f; padding:20px; border-radius:12px; width:400px;">\n        <h3>Reabastecer produto</h3>\n        <div class="hr"></div>\n        <select class="select" id="reabastecerProduto" style="width:100%; margin-bottom:10px;">\n          <option value="">Selecione um produto...</option>\n          ${t.map(e=>`<option value="${e.id}">${escapeHtml(e.nome)}</option>`).join("")}\n        </select>\n        <input class="input" id="reabastecerDeposito" placeholder="Depósito" value="Central" style="width:100%; margin-bottom:10px;" />\n        <input class="input" id="reabastecerQtd" type="number" step="0.01" placeholder="Quantidade a adicionar" style="width:100%; margin-bottom:10px;" />\n        <input class="input" id="reabastecerLote" placeholder="Lote (opcional)" style="width:100%; margin-bottom:10px;" />\n        <input class="input" id="reabastecerValidade" placeholder="Validade (opcional)" style="width:100%; margin-bottom:10px;" />\n        <textarea class="textarea" id="reabastecerObs" placeholder="Observações" style="width:100%; margin-bottom:10px;"></textarea>\n        <div class="row" style="justify-content:flex-end; gap:10px;">\n          <button class="btn" onclick="fecharModalReabastecer()">Cancelar</button>\n          <button class="btn primary" onclick="confirmarReabastecer()">Reabastecer</button>\n        </div>\n      </div>\n    </div>\n  \n  `;function o(){const e=getDB(),a=onlySafra(e.estoque||[]);document.getElementById("tbody").innerHTML=a.map(e=>{const a=t.find(t=>t.id===e.produtoId),d=a?`${a.nome} (${a.tipo})`:"(sem produto)";return`\n        <tr>\n          <td><b>${escapeHtml(d)}</b></td>\n          <td>${escapeHtml(e.deposito||"Central")}</td>\n          <td>${escapeHtml(e.lote||"")}</td>\n          <td>${escapeHtml(e.validade||"")}</td>\n          <td><b>${num(e.quantidade_atual||0,2)}</b></td>\n          <td>${escapeHtml(e.unidade||"")}</td>\n          <td>${escapeHtml(e.obs||"")}</td>\n          <td class="noPrint">\n            <button class="btn" onclick="reabastecerRapido('${e.id}')" style="margin-right:5px;">➕</button>\n            <button class="btn danger" onclick="window.__del('${e.id}')">Excluir</button>\n          </td>\n        </tr>\n      `}).join("")||'<tr><td colspan="8">Nenhum item no estoque.</td></tr>'}a.innerHTML=`<div class="section">${d}${n}</div>`,window.fecharModalReabastecer=()=>{document.getElementById("modalReabastecer").classList.add("hidden")},window.confirmarReabastecer=()=>{const e=document.getElementById("reabastecerProduto").value,a=document.getElementById("reabastecerDeposito").value||"Central",d=parseFloat(document.getElementById("reabastecerQtd").value),n=document.getElementById("reabastecerLote").value,i=document.getElementById("reabastecerValidade").value,s=document.getElementById("reabastecerObs").value;if(!e||!d||d<=0)return void alert("Selecione um produto e informe uma quantidade válida");const l=getDB(),r=t.find(t=>t.id===e);if(!r)return;const u=l.estoque.find(t=>t.safraId===getSafraId()&&t.produtoId===e&&t.deposito===a);u?(u.quantidade_atual=Number(u.quantidade_atual||0)+d,u.obs=s||u.obs,n&&(u.lote=n),i&&(u.validade=i),toast("Reabastecido",`${r.nome} agora tem ${u.quantidade_atual} ${u.unidade}`)):(l.estoque.push({id:uid("stk"),safra_id:getSafraId(),produto_id:e,deposito:a,lote:n||"",validade:i||"",quantidade_atual:d,unidade:r.unidade,obs:s||""}),toast("Novo produto",`${r.nome} adicionado ao estoque`)),setDB(l),fecharModalReabastecer(),o()},document.getElementById("btnReabastecer").addEventListener("click",()=>{document.getElementById("modalReabastecer").classList.remove("hidden"),document.getElementById("modalReabastecer").classList.add("flex")}),document.querySelector('select[name="produtoId"]').addEventListener("change",e=>{const a=t.find(t=>t.id===e.target.value);a&&(document.querySelector('input[name="unidade"]').value=a.unidade)}),window.reabastecerRapido=e=>{const t=getDB(),a=t.estoque.find(t=>t.id===e);if(!a)return;const d=prompt(`Quantidade adicional para ${a.produtoNome||"este produto"}:`,"0");if(!d)return;const n=parseFloat(d);isNaN(n)||n<=0?alert("Quantidade inválida"):(a.quantidade_atual=Number(a.quantidade_atual||0)+n,setDB(t),toast("Reabastecido",`+${n} ${a.unidade} adicionados`),o())},window.__del=e=>{if(!confirm("Excluir este item do estoque?"))return;const t=getDB();t.estoque=t.estoque.filter(t=>t.id!==e),setDB(t),toast("Excluído","Item removido do estoque."),o()},document.getElementById("frm").addEventListener("submit",e=>{e.preventDefault();const a=new FormData(e.target),d=a.get("produtoId"),n=a.get("deposito")||"Central",i=Number(a.get("qtd")||0),s=a.get("lote")||"",l=a.get("validade")||"",r=(a.get("unidade"),a.get("obs")||"");if(!d||i<=0)return void alert("Selecione um produto e informe quantidade > 0");const u=getDB(),c=t.find(e=>e.id===d);if(!c)return;const m=u.estoque.find(e=>e.safraId===getSafraId()&&e.produtoId===d&&e.deposito===n);m?(m.quantidade_atual=Number(m.quantidade_atual||0)+i,m.obs=r||m.obs,s&&(m.lote=s),l&&(m.validade=l),toast("Estoque atualizado",`${c.nome} agora tem ${m.quantidade_atual} ${m.unidade}`)):(u.estoque.push({id:uid("stk"),safra_id:getSafraId(),produto_id:d,deposito:n,lote:s,validade:l,quantidade_atual:i,unidade:c.unidade,obs:r}),toast("Produto adicionado",`${c.nome} adicionado ao estoque`)),setDB(u),e.target.reset(),document.querySelector('input[name="unidade"]').value="",o()}),document.getElementById("btnExportCSV").addEventListener("click",()=>{const e=getDB(),a=onlySafra(e.estoque||[]).map(e=>{const a=t.find(t=>t.id===e.produtoId);return{Produto:a?a.nome:"Desconhecido","Depósito":e.deposito,Lote:e.lote,Validade:e.validade,Quantidade:e.qtd,Unidade:e.unidade,"Observações":e.obs}});downloadText(`estoque-${nowISO()}.csv`,toCSV(a)),toast("Exportado","CSV baixado.")}),o()}