function pageDashboard(){const a=getDB(),e=getSafraAtual();onlySafra(a.fazendas);let n=onlySafra(a.talhoes);fazendaAtual&&(n=n.filter(a=>a.fazendaId===fazendaAtual)),onlySafra(a.produtos);const t=onlySafra(a.aplicacoes),i=onlySafra(a.clima),r=onlySafra(a.lembretes).filter(a=>!a.concluido).slice(0,5),s=gerarAlertasPragas(a).slice(0,3),o=onlySafra(a.colheitas),d=nowISO(),l=t.filter(a=>a.data===d).length,c=i.filter(a=>a.data===d).reduce((a,e)=>a+Number(e.chuvaMm||0),0),p=n.reduce((a,e)=>a+Number(e.areaHa||0),0),v=o.reduce((a,e)=>a+Number(e.producaoTotal||0),0),g=t.slice().reverse().slice(0,5),m=document.getElementById("content"),h=`\n    <div class="card" style="background: linear-gradient(135deg, var(--brand-dark) 0%, var(--brand) 100%); color:#fff; border:none; overflow:hidden; position:relative;">\n      <div style="position:absolute; right:-20px; top:-20px; font-size:90px; opacity:.07; pointer-events:none;">ğŸŒ¾</div>\n      <h3 style="color:rgba(255,255,255,.55); border:none; padding:0; margin-bottom:8px; font-size:11px; text-transform:uppercase; letter-spacing:.6px;">Safra Atual</h3>\n      <div class="big" style="color:#fff; font-size:22px;">${escapeHtml(e?.nome||"Nenhuma safra")}</div>\n      <div class="sub" style="color:rgba(255,255,255,.6); margin-top:6px;">\n        ${e?e.dataInicio?e.dataInicio+" â†’ "+(e.dataFim||"em andamento"):"Datas nÃ£o definidas":"Crie uma safra para comeÃ§ar"}\n      </div>\n    </div>`,f=`\n    <div class="card">\n      <h3>ğŸ§­ TalhÃµes</h3>\n      <div class="big">${n.length>0?num(n.length,0):"â€”"}</div>\n      <div class="sub">${p>0?`Ãrea total: ${num(p,1)} ha`:"Nenhum talhÃ£o cadastrado"}</div>\n    </div>`,u=`\n    <div class="card">\n      <h3>ğŸŒ¾ ProduÃ§Ã£o Colhida</h3>\n      <div class="big">\n        ${v>0?`${num(v/1e3,1)} <span style="font-size:16px; font-weight:400;">t</span>`:'<span class="text-muted" style="font-size:15px; font-weight:500;">Aguardando colheita</span>'}\n      </div>\n      <div class="sub">${o.length>0?`${o.length} registro${o.length>1?"s":""} de colheita`:"Nenhuma colheita registrada"}</div>\n    </div>`,b=`\n    <div class="card">\n      <h3>ğŸŒ§ï¸ Chuva Hoje</h3>\n      <div class="big">\n        ${c>0?`${num(c,1)} <span style="font-size:16px; font-weight:400;">mm</span>`:'<span class="text-muted" style="font-size:15px; font-weight:500;">Sem registro hoje</span>'}\n      </div>\n      <div class="sub">${l>0?`${l} aplicaÃ§Ã£o(Ãµes) hoje`:"Nenhuma aplicaÃ§Ã£o hoje"}</div>\n    </div>`,x=s.length?s.map(a=>`\n        <div style="\n          padding: var(--space-4);\n          background: var(--warning-bg);\n          border-left: 3px solid var(--warning);\n          border-radius: 0 var(--radius-sm) var(--radius-sm) 0;\n          margin-bottom: var(--space-3);\n          display: flex;\n          gap: var(--space-3);\n          align-items: flex-start;\n        ">\n          <span style="font-size:18px; flex-shrink:0;">âš ï¸</span>\n          <div>\n            <div style="font-weight:700; font-size:13.5px; color:var(--warning);">${escapeHtml(a.mensagem)}</div>\n            <div style="font-size:12.5px; color:var(--text-muted); margin-top:2px;">${escapeHtml(a.detalhe||"")}</div>\n          </div>\n        </div>\n      `).join(""):emptyState("ğŸŒ¿","Nenhum alerta de praga","CondiÃ§Ãµes climÃ¡ticas e aplicaÃ§Ãµes estÃ£o dentro do esperado.",""),y=r.length?r.map(a=>`\n        <div style="\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          gap: var(--space-4);\n          padding: var(--space-3) var(--space-4);\n          border: 1px solid var(--border);\n          border-radius: var(--radius-sm);\n          margin-bottom: var(--space-2);\n          background: var(--surface);\n          transition: background var(--t-fast);\n        " onmouseover="this.style.background='var(--brand-subtle)'" onmouseout="this.style.background='var(--surface)'">\n          <div>\n            <div style="font-weight:600; font-size:13.5px; color:var(--text);">${escapeHtml(a.mensagem)}</div>\n            <div style="font-size:12px; color:var(--text-muted); margin-top:2px;">ğŸ“… ${a.data||"Sem data"}</div>\n          </div>\n          <button class="btn" style="font-size:12px; padding:6px 14px; flex-shrink:0; background:var(--brand); color:#fff; border:none;" onclick="concluirLembrete('${a.id}')">âœ“ Concluir</button>\n        </div>\n      `).join(""):emptyState("ğŸ“‹","Tudo em dia!","VocÃª nÃ£o tem lembretes pendentes no momento."),$=g.length?g.map(a=>{const e=findNameById(n,a.talhaoId),t=a.produtos?.[0]?.produtoNome||"â€”";return`<tr>\n          <td>${a.data}</td>\n          <td>${escapeHtml(e)}</td>\n          <td>${num(a.areaHaAplicada,1)} ha</td>\n          <td>${escapeHtml(t)}</td>\n          ${canSeeFinanceiro()?`<td class="highlight-value">${kbrl(a.custoTotal)}</td>`:""}\n        </tr>`}).join(""):`<tr><td colspan="${canSeeFinanceiro()?5:4}" style="text-align:center; padding:32px;">\n        <div class="empty-state" style="padding:var(--space-6);">\n          <div class="empty-icon">ğŸšœ</div>\n          <h3>Nenhuma aplicaÃ§Ã£o registrada</h3>\n          <p>Registre a primeira aplicaÃ§Ã£o da safra para acompanhar aqui.</p>\n          ${canCreateOnPage("aplicacoes")?'<a href="aplicacoes.html" class="btn primary">+ Registrar AplicaÃ§Ã£o</a>':""}\n        </div>\n      </td></tr>`;m.innerHTML=`\n    <div class="section page-enter">\n      \x3c!-- KPIs --\x3e\n      <div class="kpi">\n        ${h}\n        ${f}\n        ${u}\n        ${b}\n      </div>\n\n      \x3c!-- Alerts + Reminders --\x3e\n      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px,1fr)); gap:var(--space-5);">\n        <div class="card">\n          <h3>âš ï¸ Alertas de Pragas</h3>\n          ${x}\n        </div>\n        <div class="card">\n          <h3>ğŸ“‹ Lembretes Pendentes</h3>\n          ${y}\n        </div>\n      </div>\n\n      \x3c!-- Ãšltimas aplicaÃ§Ãµes --\x3e\n      <div class="card">\n        <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; padding-bottom:var(--space-4); border-bottom:1px solid var(--border); margin-bottom:var(--space-4);">\n          <h3 style="margin:0; border:none; padding:0; font-size:14px; font-weight:700;">ğŸšœ Ãšltimas AplicaÃ§Ãµes</h3>\n          ${canCreateOnPage("aplicacoes")?'<a href="aplicacoes.html" class="btn" style="font-size:12px; padding:6px 14px;">Ver todas â†’</a>':""}\n        </div>\n        <div class="tableWrap" style="margin:0; border:none; box-shadow:none;">\n          <table>\n            <thead>\n              <tr>\n                <th>Data</th>\n                <th>TalhÃ£o</th>\n                <th>Ãrea</th>\n                <th>Produto</th>\n                ${canSeeFinanceiro()?"<th>Custo</th>":""}\n              </tr>\n            </thead>\n            <tbody>${$}</tbody>\n          </table>\n        </div>\n      </div>\n\n      ${isSimplifiedDashboard()?`\n        <div class="card" style="background:var(--accent-subtle); border-left:3px solid var(--accent); padding: var(--space-4) var(--space-5);">\n          <p style="margin:0; font-size:13.5px; color:var(--warning);">\n            ğŸ”’ <b>Dashboard simplificado</b> â€” Perfil <b>${getRoleLabel()}</b>. Para acesso completo, fale com o administrador.\n          </p>\n        </div>\n      `:""}\n\n      \x3c!-- Copilot & WhatsApp Alerts Banner --\x3e\n      ${"Free"!==planoAtual?'\n      <div class="card" style="background:linear-gradient(135deg,#1e3a5f,#2d6a4f); color:white; border:none; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:16px;">\n        <div style="display:flex; align-items:center; gap:14px;">\n          <div style="width:44px; height:44px; background:rgba(255,255,255,.15); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px; flex-shrink:0;">ğŸ¤–</div>\n          <div>\n            <div style="font-weight:700; font-size:15px;">Agro-Copilot estÃ¡ ativo!</div>\n            <div style="opacity:.75; font-size:12px; margin-top:2px;">Converse com seus dados, receba insights e alertas inteligentes.</div>\n          </div>\n        </div>\n        <div style="display:flex; gap:10px; flex-wrap:wrap;">\n          <a href="copilot.html" style="background:rgba(255,255,255,.2); color:white; padding:9px 18px; border-radius:8px; font-size:13px; font-weight:700; text-decoration:none; border:1px solid rgba(255,255,255,.3);">\n            ğŸ’¬ Abrir Copilot\n          </a>\n          <button onclick="enviarTodosAlertasWhatsApp()" style="background:#25d366; color:white; padding:9px 18px; border-radius:8px; font-size:13px; font-weight:700; border:none; cursor:pointer;">\n            ğŸ“± Alertas WhatsApp\n          </button>\n        </div>\n      </div>':'\n      <div class="card" style="text-align:center; padding:18px; border:1px dashed var(--border);">\n        <span style="font-size:13px; color:var(--text-muted);">ğŸ”’ Plano Free â€” <a href="configuracoes.html" style="color:var(--brand); font-weight:600;">FaÃ§a upgrade</a> para acessar o Agro-Copilot (IA) e alertas automÃ¡ticos.</span>\n      </div>'}\n    </div>\n  `,window.concluirLembrete=a=>{const e=getDB(),n=e.lembretes.find(e=>e.id===a);n&&(n.concluido=!0),setDB(e),toast("âœ“ ConcluÃ­do","Lembrete marcado como concluÃ­do."),pageDashboard()}}