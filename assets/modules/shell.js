function renderShell(e,a,t){const n=getDB(),o=getSafraId(),s=getSafraAtual(),r=PAGES.filter(e=>canAccessPage(e.key)).map(a=>{const t=a.key===e?"active":"",n=a.key===e?' aria-current="page"':"";return`<a class="${t}" href="${a.href}" role="menuitem"${n}><span class="ico" aria-hidden="true">${a.icon}</span> ${escapeHtml(a.label)}${a.badge?` <span style="background:#fbbf24; color:#0f172a; font-size:9px; padding:1px 6px; border-radius:8px; font-weight:800; vertical-align:middle; margin-left:4px;" aria-label="${a.badge}">${a.badge}</span>`:""}</a>`}).join(""),l=n.safras.length>0?n.safras.map(e=>{const a=e.id===o?"selected":"";return`<option value="${e.id}" ${a}>${escapeHtml(e.nome)} ${e.ativa?"‚úÖ":""}</option>`}).join(""):'<option value="" disabled selected>‚Äî Nenhuma safra cadastrada ‚Äî</option>';document.getElementById("app").innerHTML=`\n    <a class="skip-link" href="#content" id="skipLink">Pular para conte√∫do principal</a>\n    <div class="app" role="application">\n      <button class="menu-toggle noPrint" id="menuToggle" aria-label="Abrir menu lateral" aria-expanded="false" aria-controls="sidebar">‚ò∞</button>\n      <aside class="sidebar" id="sidebar" role="navigation" aria-label="Menu principal">\n        <div class="brand">\n          <div class="logo" role="img" aria-label="Logo Agro Pro"></div>\n          <div>\n            <h1>Agro Pro <span class="plan-badge plan-${planoAtual.toLowerCase()}" aria-label="Plano ${planoAtual}">${planoAtual}</span></h1>\n            <p>Gest√£o Agr√≠cola Inteligente</p>\n            ${"admin"!==userRole?`<span style="${getRoleBadgeColor()} font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: bold;" role="status" aria-label="Perfil ${getRoleLabel()}">${getRoleLabel()}</span>`:""}\n          </div>\n        </div>\n\n        <div class="tenant" role="region" aria-label="Filtros de safra e fazenda">\n          <div class="row">\n            <span class="badge" aria-label="Plano ativo: ${planoAtual}"><span class="dot" aria-hidden="true"></span> ${planoAtual}</span>\n            <button class="btn noPrint" id="btnBackup" aria-label="Fazer backup dos dados">Backup</button>\n          </div>\n          <div class="hr" aria-hidden="true"></div>\n          \n          <label for="safraSelect" class="sr-only">Safra ativa</label>\n          <small aria-hidden="true">üå± Safra ativa</small>\n          <select class="select" id="safraSelect" aria-label="Selecionar safra ativa" ${0===n.safras.length?'disabled aria-disabled="true" style="opacity:0.5"':""}>${l}</select>\n          \n          <label for="fazendaSelect" class="sr-only">Filtrar por fazenda</label>\n          <small style="margin-top:10px; display:block;" aria-hidden="true">üè° Filtrar por Fazenda</small>\n          <select class="select" id="fazendaSelect" aria-label="Filtrar por fazenda">\n            <option value="">Todas as Fazendas</option>\n            ${n.fazendas.filter(e=>e.safraId===o).map(e=>`<option value="${e.id}" ${fazendaAtual===e.id?"selected":""}>${escapeHtml(e.nome)}</option>`).join("")}\n          </select>\n          \n          <div style="margin-top:10px" class="row">\n            <button class="btn primary" id="btnNovaSafra" aria-label="Criar nova safra">+ Nova safra</button>\n          </div>\n        </div>\n\n        <nav class="nav" aria-label="Navega√ß√£o do sistema">${r}</nav>\n\n        <div style="margin: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 12px;" role="complementary" aria-label="Informa√ß√µes do plano">\n           <b>Plano ${planoAtual}</b>\n           ${"admin"!==userRole?`<br><span style="color: #fbbf24;">Perfil: ${getRoleLabel()}</span>`:""}<br>\n           ${"Free"===planoAtual||"Trial"===planoAtual?'<span style="color: rgba(251,191,36,0.85); font-size: 11px;">Acesso limitado ‚Äî s√≥ visualiza√ß√£o</span><br>':""}\n           ${"admin"===userRole?`<a href="configuracoes.html" style="color: #4ade80; text-decoration: none;" aria-label="${"Free"===planoAtual||"Trial"===planoAtual?"Assinar plano":"Gerenciar plano"}">${"Free"===planoAtual||"Trial"===planoAtual?"Assinar plano":"Gerenciar plano"} ‚Üí</a>`:'<span style="color: #94a3b8;">Conta vinculada ao admin</span>'}\n           \n           <button id="btnSairSidebar" aria-label="Sair da conta" style="width: 100%; margin-top: 15px; padding: 8px; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.55); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">üö™ Sair da conta</button>\n           <div style="margin-top:8px; text-align:center;">\n             <button id="btnShortcutsHelp" style="background:none; border:none; color:rgba(255,255,255,0.35); font-size:10px; cursor:pointer; padding:2px;" aria-label="Ver atalhos de teclado" title="Atalhos de teclado (?)">\n               ‚å® Atalhos <kbd class="kbd" style="font-size:9px; background:rgba(255,255,255,0.08); border-color:rgba(255,255,255,0.15); color:rgba(255,255,255,0.5);">?</kbd>\n             </button>\n           </div>\n        </div>\n      </aside>\n\n      <main class="main" role="main">\n        <div class="topbar" role="banner">\n          <div style="display:flex; align-items:center; gap:15px;">\n            <button class="menu-toggle noPrint" id="menuToggleMain" aria-label="Abrir menu lateral" aria-expanded="false" aria-controls="sidebar">‚ò∞</button>\n            <div class="title">\n              <h2>${escapeHtml(a)}</h2>\n              <p>${escapeHtml(t||(s?`Safra: ${s.nome}`:"Selecione uma safra"))}</p>\n            </div>\n          </div>\n          <div class="actions noPrint" id="topActions">\n            <button class="theme-toggle noPrint" id="btnThemeToggle" title="Alternar modo escuro/claro (Ctrl+D)" aria-label="Alternar tema claro e escuro">üåô</button>\n          </div>\n        </div>\n\n        <div id="content" class="content" role="region" aria-label="Conte√∫do principal" tabindex="-1"></div>\n      </main>\n    </div>\n  `;const i=()=>{document.getElementById("sidebar").classList.toggle("active"),m()};document.getElementById("menuToggleMain")?.addEventListener("click",i),document.getElementById("menuToggle")&&document.getElementById("menuToggle").addEventListener("click",i);const d=e=>{document.documentElement.setAttribute("data-theme",e?"dark":"light");const a=document.getElementById("btnThemeToggle");a&&(a.textContent=e?"‚òÄÔ∏è":"üåô",a.setAttribute("aria-label",e?"Ativar modo claro":"Ativar modo escuro")),localStorage.setItem("agro_theme",e?"dark":"light")},c=localStorage.getItem("agro_theme")||"light";function p(){if(document.getElementById("shortcutsOverlay"))return;const e=document.createElement("div");e.id="shortcutsOverlay",e.className="shortcuts-overlay",e.setAttribute("role","dialog"),e.setAttribute("aria-label","Atalhos de teclado"),e.innerHTML='\n      <div class="shortcuts-panel">\n        <h2>‚å® Atalhos de Teclado</h2>\n        <div class="shortcut-row"><span>Dashboard</span><span class="shortcut-keys"><kbd class="kbd">Alt</kbd>+<kbd class="kbd">1</kbd></span></div>\n        <div class="shortcut-row"><span>Propriedade</span><span class="shortcut-keys"><kbd class="kbd">Alt</kbd>+<kbd class="kbd">2</kbd></span></div>\n        <div class="shortcut-row"><span>Aplica√ß√µes</span><span class="shortcut-keys"><kbd class="kbd">Alt</kbd>+<kbd class="kbd">3</kbd></span></div>\n        <div class="shortcut-row"><span>Colheitas</span><span class="shortcut-keys"><kbd class="kbd">Alt</kbd>+<kbd class="kbd">4</kbd></span></div>\n        <div class="shortcut-row"><span>Relat√≥rios</span><span class="shortcut-keys"><kbd class="kbd">Alt</kbd>+<kbd class="kbd">5</kbd></span></div>\n        <div class="shortcut-row"><span>Copilot IA</span><span class="shortcut-keys"><kbd class="kbd">Alt</kbd>+<kbd class="kbd">6</kbd></span></div>\n        <div class="shortcut-row"><span>Configura√ß√µes</span><span class="shortcut-keys"><kbd class="kbd">Alt</kbd>+<kbd class="kbd">7</kbd></span></div>\n        <div class="shortcut-row"><span>Alternar tema</span><span class="shortcut-keys"><kbd class="kbd">Ctrl</kbd>+<kbd class="kbd">D</kbd></span></div>\n        <div class="shortcut-row"><span>Abrir/fechar menu</span><span class="shortcut-keys"><kbd class="kbd">Ctrl</kbd>+<kbd class="kbd">M</kbd></span></div>\n        <div class="shortcut-row"><span>Busca r√°pida (foco na safra)</span><span class="shortcut-keys"><kbd class="kbd">Ctrl</kbd>+<kbd class="kbd">K</kbd></span></div>\n        <div class="shortcut-row"><span>Mostrar atalhos</span><span class="shortcut-keys"><kbd class="kbd">?</kbd></span></div>\n        <div style="margin-top:var(--space-5); text-align:right;">\n          <button class="btn primary" id="closeShortcuts" aria-label="Fechar atalhos">Fechar</button>\n        </div>\n      </div>\n    ',document.body.appendChild(e),e.addEventListener("click",a=>{a.target===e&&e.remove()}),document.getElementById("closeShortcuts")?.addEventListener("click",()=>e.remove()),document.getElementById("closeShortcuts")?.focus()}d("dark"===c),document.getElementById("btnThemeToggle")?.addEventListener("click",()=>{const e="dark"===document.documentElement.getAttribute("data-theme");d(!e)});const u={1:"index.html",2:"propriedade.html",3:"aplicacoes.html",4:"colheitas.html",5:"relatorios.html",6:"copilot.html",7:"configuracoes.html"};document.addEventListener("keydown",e=>{const a=(e.target.tagName||"").toLowerCase(),t="input"===a||"textarea"===a||"select"===a||e.target.isContentEditable;if("?"===e.key&&!t)return e.preventDefault(),void p();if("Escape"===e.key){const e=document.getElementById("shortcutsOverlay");if(e)return void e.remove();const a=document.getElementById("sidebar");if(a&&a.classList.contains("active"))return void a.classList.remove("active")}if(e.altKey&&u[e.key])return e.preventDefault(),void(window.location.href=u[e.key]);if(e.ctrlKey&&"d"===e.key){e.preventDefault();const a="dark"===document.documentElement.getAttribute("data-theme");return void d(!a)}return e.ctrlKey&&"m"===e.key?(e.preventDefault(),void document.getElementById("sidebar")?.classList.toggle("active")):e.ctrlKey&&"k"===e.key?(e.preventDefault(),void document.getElementById("safraSelect")?.focus()):void 0}),document.getElementById("btnShortcutsHelp")?.addEventListener("click",p);const m=()=>{const e=document.getElementById("sidebar"),a=e?.classList.contains("active")||!1;document.getElementById("menuToggle")?.setAttribute("aria-expanded",String(a)),document.getElementById("menuToggleMain")?.setAttribute("aria-expanded",String(a))};document.getElementById("safraSelect").addEventListener("change",e=>{setSafraId(e.target.value),toast("Safra alterada","Filtrando dados..."),setTimeout(()=>location.reload(),200)}),document.getElementById("fazendaSelect").addEventListener("change",e=>{fazendaAtual=e.target.value||null,fazendaAtual?localStorage.setItem("agro_fazenda_filtro",fazendaAtual):localStorage.removeItem("agro_fazenda_filtro"),toast("Fazenda filtrada","Recarregando..."),setTimeout(()=>location.reload(),300)}),document.getElementById("btnNovaSafra").addEventListener("click",()=>{const e=prompt("Nome da nova safra (ex: 2026/27):");if(!e)return;const a=getDB();a.safras||(a.safras=[]);const t=uid("saf");a.safras.push({id:t,nome:e,dataInicio:nowISO(),dataFim:"",ativa:!0,observacoes:""}),setDB(a),setSafraId(t),toast("Safra criada","Nova safra ativada!"),setTimeout(()=>location.reload(),200)}),document.getElementById("btnSairSidebar")?.addEventListener("click",async()=>{if(confirm("Deseja realmente sair da conta?")){toast("Saindo...","Salvando dados na nuvem...");try{"function"==typeof cloudSyncImmediate&&await cloudSyncImmediate()}catch(e){}try{"undefined"!=typeof AuthService&&isSupabaseReady()&&await AuthService.signOut()}catch(e){}["agro_session","agro_role","agro_trial","agro_plano","agro_pro_v10"].forEach(e=>localStorage.removeItem(e)),sessionStorage.clear(),toast("Saindo...","At√© logo!"),setTimeout(()=>{window.location.href="index.html"},800)}})}function onlySafra(e){const a=getSafraId();return a?(e||[]).filter(e=>e.safra_id===a||e.safraId===a):e||[]}function findNameById(e,a,t="-"){const n=(e||[]).find(e=>e.id===a);return n?n.nome??t:t}const FMT_BRL=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});function brl(e){return FMT_BRL.format(Number(e||0))}function num(e,a=2){return new Intl.NumberFormat("pt-BR",{minimumFractionDigits:a,maximumFractionDigits:a}).format(Number(e||0))}function kbrl(e){return brl(e)}function setTopActions(e){const a=document.getElementById("topActions");a&&(a.innerHTML=e||"")}function clampStr(e,a=60){return(e=String(e??"")).length>a?e.slice(0,a-1)+"‚Ä¶":e}function ensureStockRow(e,a,t="Central",n=""){e.estoque=e.estoque||[];let o=e.estoque.find(e=>e.safraId===getSafraId()&&e.produtoId===a&&(e.deposito||"Central")===t);if(!o){const s=e.produtos.find(e=>e.id===a);o={id:uid("stk"),safraId:getSafraId(),produtoId:a,deposito:t,lote:"",validade:"",qtd:0,unidade:n||(s?s.unidade:""),obs:"(auto)"},e.estoque.push(o)}return o}function baixaEstoqueProdutoPorId(e,a,t,n=""){if(!a||!t)return{ok:!1,msg:"Sem produto/quantidade"};const o=onlySafra(e.produtos).find(e=>e.id===a);if(!o)return{ok:!1,msg:"Produto n√£o encontrado"};const s=ensureStockRow(e,a,"Central",n||o.unidade);return s.qtd=Number(s.qtd||0)-Number(t||0),{ok:!0,msg:`Baixa estoque: ${o.nome} -${num(t,2)} ${s.unidade}`}}function registrarEntradaDiesel(e,a,t,n,o,s=""){const r={id:uid("de"),safraId:getSafraId(),data:o||nowISO(),litros:t,precoLitro:n,deposito:a,obs:s};e.dieselEntradas=e.dieselEntradas||[],e.dieselEntradas.push(r);let l=e.dieselEstoque.find(e=>e.safraId===getSafraId()&&e.deposito===a);return l||(l={id:uid("dsl"),safraId:getSafraId(),deposito:a,litros:0,precoVigente:0,obs:""},e.dieselEstoque.push(l)),l.litros=Number(l.litros||0)+t,l.precoVigente=n,l}function baixaDiesel(e,a,t){const n=e.dieselEstoque.find(e=>e.safraId===getSafraId()&&e.deposito===a);if(!n)return{ok:!1,msg:"Tanque n√£o encontrado"};const o=n.precoVigente||0;return n.litros=Number(n.litros||0)-Number(t||0),{ok:!0,precoLitro:o}}function calcCustosPorTalhao(e){let a=onlySafra(e.talhoes);fazendaAtual&&(a=a.filter(e=>e.fazendaId===fazendaAtual));const t=onlySafra(e.fazendas),n=onlySafra(e.aplicacoes||[]),o=onlySafra(e.combustivel||[]),s=onlySafra(e.insumosBase||[]),r=onlySafra(e.colheitas||[]),l=onlySafra(e.manutencoes||[]),i=a.reduce((e,a)=>e+Number(a.areaHa||0),0),d=l.reduce((e,a)=>e+Number(a.custoTotal||0),0),c=new Map;for(const e of a)c.set(e.id,{custo:0,last:"",ops:0});for(const e of n){if(!e.talhaoId)continue;const a=c.get(e.talhaoId)||{custo:0,last:"",ops:0};a.custo+=Number(e.custoTotal||0),a.ops+=1,(e.data||"")>(a.last||"")&&(a.last=e.data||""),c.set(e.talhaoId,a)}for(const e of o){if(!e.talhaoId)continue;const a=c.get(e.talhaoId)||{custo:0,last:"",ops:0};a.custo+=Number(e.litros||0)*Number(e.precoLitro||0),a.ops+=1,(e.data||"")>(a.last||"")&&(a.last=e.data||""),c.set(e.talhaoId,a)}for(const e of s){if(!e.talhaoId)continue;const a=c.get(e.talhaoId)||{custo:0,last:"",ops:0};a.custo+=Number(e.custoTotal||0),a.ops+=1,(e.data||"")>(a.last||"")&&(a.last=e.data||""),c.set(e.talhaoId,a)}for(const e of r){if(!e.talhaoId)continue;let a=0;if(e.frete1&&(a+=Number(e.frete1.custoFrete||0)),e.frete2&&(a+=Number(e.frete2.custoFrete||0)),a>0){const t=c.get(e.talhaoId)||{custo:0,last:"",ops:0};t.custo+=a,c.set(e.talhaoId,t)}}for(const e of a)if(i>0&&d>0){const a=c.get(e.id)||{custo:0,last:"",ops:0};a.custo+=d*(Number(e.areaHa||0)/i),c.set(e.id,a)}return a.map(e=>{const a=c.get(e.id)||{custo:0,last:"",ops:0},n=Number(e.areaHa||0)||0,o=n>0?a.custo/n:0;return{talhaoId:e.id,talhao:e.nome,fazenda:findNameById(t,e.fazendaId),areaHa:n,custoTotal:a.custo,custoHa:o,last:a.last||"-",ops:a.ops||0}}).sort((e,a)=>a.custoTotal-e.custoTotal)}function gerarAlertasPragas(e){const a=[],t=onlySafra(e.clima||[]).sort((e,a)=>a.data.localeCompare(e.data)).slice(0,3);let n=onlySafra(e.talhoes);fazendaAtual&&(n=n.filter(e=>e.fazendaId===fazendaAtual));const o=onlySafra(e.pragas||[]);for(const e of n){const n=t.filter(a=>a.talhaoId===e.id||""===a.talhaoId);if(0===n.length)continue;const s=(n[0].tempMax+n[0].tempMin)/2,r=n[0].umidade;for(const t of o){if(!t.culturas.includes(e.cultura?.toLowerCase()))continue;const n=s>=t.tempMin&&s<=t.tempMax,o=r>=t.umidadeMin;n&&o&&a.push({tipo:"praga",mensagem:`‚ö†Ô∏è Risco de ${t.nome} no talh√£o ${e.nome}`,detalhe:`Temperatura ${s.toFixed(1)}¬∞C, Umidade ${r}%`,data:nowISO(),talhaoId:e.id,pragaId:t.id})}}return a}function crudPage({entityKey:e,subtitle:a,fields:t,columns:n,helpers:o}){getDB();const s=getSafraId(),r={equipe:"equipe",maquinas:"maquinas",safras:"safras",fazendas:"fazendas",talhoes:"talhoes",produtos:"produtos",estoque:"estoque",insumosbase:"insumosbase",aplicacoes:"aplicacoes",combustivel:"combustivel",clima:"clima",colheitas:"colheitas",manutencao:"manutencao"}[e]||e,l=canCreateOnPage(r),i=canDeleteOnPage(r);setTopActions('<button class="btn" id="btnExportCSV">Exportar CSV</button>');const d=document.getElementById("content"),c=l?`\n      <div class="card">\n      <h3>Novo registro</h3>\n      <div class="help">${escapeHtml(a||"")}</div>\n      <div class="hr"></div>\n      <form id="frm" class="formGrid">\n        ${t.map(e=>{const a=e.full?"full":"";if("select"===e.type){const t=("function"==typeof e.options?e.options(getDB()):e.options||[]).map(e=>`<option value="${escapeHtml(e.value)}">${escapeHtml(e.label)}</option>`).join("");return`\n              <div class="${a}">\n                <small>${escapeHtml(e.label)}</small>\n                <select class="select" name="${escapeHtml(e.key)}">${t}</select>\n              </div>\n            `}return"textarea"===e.type?`\n              <div class="${a}">\n                <small>${escapeHtml(e.label)}</small>\n                <textarea class="textarea" name="${escapeHtml(e.key)}" placeholder="${escapeHtml(e.placeholder||"")}"></textarea>\n              </div>\n            `:`\n            <div class="${a}">\n              <small>${escapeHtml(e.label)}</small>\n              <input class="input" name="${escapeHtml(e.key)}" type="${escapeHtml(e.type||"text")}" placeholder="${escapeHtml(e.placeholder||"")}" />\n            </div>\n          `}).join("")}\n        <div class="full row" style="justify-content:flex-end; margin-top:6px;">\n          <button class="btn primary" type="submit">Salvar</button>\n        </div>\n      </form>\n    </div>\n  `:`<div class="card" style="background:#f8fafc; border: 1px dashed #cbd5e1; text-align:center; padding:15px;"><p style="color:#64748b; margin:0;">üîí Modo visualiza√ß√£o ‚Äî Seu perfil de <b>${getRoleLabel()}</b> n√£o permite criar registros nesta p√°gina.</p></div>`;let p=15;const u=`\n    <div class="tableWrap">\n      <table>\n        <thead>\n          <tr>\n            ${n.map(e=>`<th>${escapeHtml(e.label)}</th>`).join("")}\n            <th class="noPrint">A√ß√µes</th>\n          </tr>\n        </thead>\n        <tbody id="tbody"></tbody>\n      </table>\n    </div>\n    <div id="pagination" class="row" style="justify-content:center; margin-top:15px; display:none;">\n      <button class="btn" id="btnCarregarMais">Carregar Mais</button>\n    </div>\n  `;function m(){const a=getDB(),t=onlySafra(a[e]||[]),s=o?.filter?o.filter(t,a):t,r=s.length,l=s.slice().reverse().slice(0,p);document.getElementById("tbody").innerHTML=l.map(e=>`\n        <tr>\n          ${n.map(t=>{const n=t.render?t.render(e,a):e[t.key];return`<td data-label="${escapeHtml(t.label)}">${escapeHtml(n??"")}</td>`}).join("")}\n          <td class="noPrint" data-label="A√ß√µes">\n            ${i?`<button class="btn danger" onclick="window.__del('${e.id}')">Excluir</button>`:'<span style="color:#94a3b8; font-size:12px;">‚Äî</span>'}\n          </td>\n        </tr>\n      `).join("")||`<tr><td colspan="${n.length+1}">Sem registros.</td></tr>`;const d=document.getElementById("pagination");r>p?(d.style.display="flex",document.getElementById("btnCarregarMais").innerHTML=`Carregar Mais (${p} de ${r})`,document.getElementById("btnCarregarMais").onclick=()=>{p+=15,m()}):d.style.display="none"}d.innerHTML=`<div class="section">${c}${u}</div>`,window.__del=a=>{if(!i)return void toast("Sem permiss√£o","Seu perfil n√£o permite excluir registros.");if(!confirm("Excluir este registro?"))return;const t=getDB();t[e]=(t[e]||[]).filter(e=>e.id!==a),o?.onDelete&&o.onDelete(a,t),setDB(t),toast("Exclu√≠do","Registro removido."),m()},l&&document.getElementById("frm")&&document.getElementById("frm").addEventListener("submit",a=>{a.preventDefault();const n=new FormData(a.target),r={id:uid(e.slice(0,3)),safraId:s};t.forEach(e=>{let a=n.get(e.key);"number"===e.type&&(a=Number(a||0)),r[e.key]=a});const l=getDB();o?.beforeSave&&o.beforeSave(r,l),l[e]=l[e]||[];const i=getPlanLimits();"fazendas"===e&&l.fazendas.length>=i.fazendas?toast("Limite atingido",`Seu plano ${planoAtual} permite no m√°ximo ${i.fazendas} fazenda(s). Fa√ßa upgrade para adicionar mais.`):"maquinas"===e&&onlySafra(l.maquinas||[]).length>=i.maquinas?toast("Limite atingido",`Seu plano ${planoAtual} permite no m√°ximo ${i.maquinas} m√°quina(s). Fa√ßa upgrade para adicionar mais.`):"equipe"===e&&onlySafra(l.equipe||[]).length>=i.funcionarios?toast("Limite atingido",`Seu plano ${planoAtual} permite no m√°ximo ${i.funcionarios} funcion√°rio(s). Fa√ßa upgrade para adicionar mais.`):(l[e].push(r),setDB(l),a.target.reset(),toast("Salvo","Registro adicionado com sucesso."),m())}),document.getElementById("btnExportCSV").addEventListener("click",()=>{const a=onlySafra(getDB()[e]||[]);downloadText(`${e}-${nowISO()}.csv`,toCSV(a)),toast("Exportado","CSV baixado.")}),m()}function gerarPDF({titulo:e,subtitulo:a,conteudoHTML:t,orientacao:n}){const o=getDB().parametros||{},s=o.nomeEmpresa||"Agro Pro",r=o.cnpjEmpresa||"",l=o.enderecoEmpresa||"",i=o.telefoneEmpresa||"",d=getSafraAtual(),c=(new Date).toLocaleString("pt-BR"),p=`<!DOCTYPE html>\n<html lang="pt-BR">\n<head>\n<meta charset="utf-8">\n<title>${e} ‚Äî ${s}</title>\n<style>\n  @page { size: ${"landscape"===n?"A4 landscape":"A4"}; margin: 15mm 12mm; }\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: 'Segoe UI', Arial, Helvetica, sans-serif; font-size: 11px; color: #1e293b; line-height: 1.5; }\n\n  /* ‚îÄ‚îÄ Cabe√ßalho Premium ‚îÄ‚îÄ */\n  .pdf-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: flex-start;\n    border-bottom: 3px solid #0f2847;\n    padding-bottom: 12px;\n    margin-bottom: 16px;\n  }\n  .pdf-header-left h1 {\n    font-size: 20px;\n    font-weight: 800;\n    color: #0f2847;\n    letter-spacing: -0.3px;\n  }\n  .pdf-header-left .empresa-info {\n    font-size: 10px;\n    color: #475569;\n    margin-top: 4px;\n    line-height: 1.4;\n  }\n  .pdf-header-right {\n    text-align: right;\n    font-size: 10px;\n    color: #64748b;\n  }\n  .pdf-header-right .safra-tag {\n    display: inline-block;\n    background: #0f2847;\n    color: #fff;\n    padding: 3px 10px;\n    border-radius: 4px;\n    font-weight: 700;\n    font-size: 11px;\n    margin-bottom: 4px;\n  }\n\n  /* ‚îÄ‚îÄ Subt√≠tulo ‚îÄ‚îÄ */\n  .pdf-subtitle {\n    font-size: 15px;\n    font-weight: 700;\n    color: #0f2847;\n    border-left: 4px solid #3b82f6;\n    padding-left: 10px;\n    margin-bottom: 14px;\n  }\n\n  /* ‚îÄ‚îÄ Tabelas ‚îÄ‚îÄ */\n  table { width: 100%; border-collapse: collapse; margin-bottom: 14px; font-size: 10px; }\n  th {\n    background: #0f2847;\n    color: white;\n    padding: 6px 8px;\n    text-align: left;\n    font-size: 9px;\n    font-weight: 700;\n    text-transform: uppercase;\n    letter-spacing: 0.3px;\n  }\n  td { padding: 5px 8px; border-bottom: 1px solid #e2e8f0; vertical-align: top; }\n  tr:nth-child(even) { background: #f8fafc; }\n  tr:hover { background: #eef2ff; }\n  .total-row { background: #f0f9ff !important; font-weight: 700; border-top: 2px solid #0f2847; }\n\n  /* ‚îÄ‚îÄ KPI cards ‚îÄ‚îÄ */\n  .pdf-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; margin-bottom: 14px; }\n  .pdf-kpi {\n    border: 1px solid #e2e8f0;\n    border-radius: 6px;\n    padding: 8px 10px;\n    border-left: 3px solid #3b82f6;\n  }\n  .pdf-kpi .label { font-size: 9px; color: #64748b; text-transform: uppercase; font-weight: 600; letter-spacing: 0.3px; }\n  .pdf-kpi .value { font-size: 16px; font-weight: 800; color: #0f172a; }\n  .pdf-kpi .sub { font-size: 9px; color: #94a3b8; }\n\n  /* ‚îÄ‚îÄ Se√ß√µes ‚îÄ‚îÄ */\n  .pdf-section-title {\n    font-size: 13px;\n    font-weight: 700;\n    color: #0f2847;\n    margin: 16px 0 8px;\n    padding-bottom: 4px;\n    border-bottom: 1px solid #cbd5e1;\n  }\n\n  /* ‚îÄ‚îÄ Cores ‚îÄ‚îÄ */\n  .text-green { color: #16a34a; }\n  .text-red { color: #dc2626; }\n  .text-blue { color: #2563eb; }\n  .text-bold { font-weight: 700; }\n\n  /* ‚îÄ‚îÄ Rodap√© ‚îÄ‚îÄ */\n  .pdf-footer {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 6px 12mm;\n    border-top: 1px solid #e2e8f0;\n    font-size: 8px;\n    color: #94a3b8;\n    display: flex;\n    justify-content: space-between;\n  }\n\n  @media print {\n    .no-print { display: none !important; }\n  }\n</style>\n</head>\n<body>\n  \x3c!-- Cabe√ßalho --\x3e\n  <div class="pdf-header">\n    <div class="pdf-header-left">\n      <h1>üåæ ${s}</h1>\n      <div class="empresa-info">\n        ${r?"CNPJ: "+r+"<br>":""}${l?l+"<br>":""}${i?"Tel: "+i:""}\n      </div>\n    </div>\n    <div class="pdf-header-right">\n      <div class="safra-tag">${d?.nome||"Safra Atual"}</div><br>\n      ${d?.dataInicio?"Per√≠odo: "+d.dataInicio+" a "+(d.dataFim||"atual")+"<br>":""}\n      Gerado em: ${c}\n    </div>\n  </div>\n\n  \x3c!-- T√≠tulo do relat√≥rio --\x3e\n  <div class="pdf-subtitle">${e}${a?" ‚Äî "+a:""}</div>\n\n  \x3c!-- Conte√∫do din√¢mico --\x3e\n  ${t}\n\n  \x3c!-- Rodap√© --\x3e\n  <div class="pdf-footer">\n    <span>${s} ‚Äî Agro Pro v10.9</span>\n    <span>${c}</span>\n  </div>\n\n  <script>\n    window.onload = function() { setTimeout(function() { window.print(); }, 500); };\n  <\/script>\n</body>\n</html>`,u=window.open("","_blank");u?(u.document.write(p),u.document.close()):toast("Erro","Popup bloqueado. Permita popups para gerar o PDF.")}