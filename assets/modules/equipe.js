function pageEquipe(){crudPage({entityKey:"equipe",subtitle:"Equipe de campo da safra atual.",fields:[{key:"nome",label:"Nome",type:"text"},{key:"funcao",label:"Fun√ß√£o",type:"text",placeholder:"Tratorista / Encarregado / Agr√¥nomo..."},{key:"telefone",label:"Telefone",type:"text"},{key:"nr",label:"NR/Certifica√ß√µes",type:"text",placeholder:"NR-31 / Treinamentos..."},{key:"obs",label:"Observa√ß√µes",type:"textarea",full:!0}],columns:[{key:"nome",label:"Nome"},{key:"funcao",label:"Fun√ß√£o"},{key:"telefone",label:"Telefone"},{key:"nr",label:"NR/Cert."},{key:"obs",label:"Obs."}]}),"admin"===getUserRole()&&renderGerenciamentoAcessos()}async function _carregarContasVinculadas(){if("undefined"==typeof AuthService||!isSupabaseReady())return[];try{const e=await AuthService.getSession();if(!e?.user?.id)return[];const{data:a}=await _supabaseClient.from("profiles").select("id, full_name, email, user_role, phone, created_at").eq("owner_id",e.user.id).order("created_at",{ascending:!1});return a||[]}catch(e){return[]}}async function _criarContaAcesso(e,a,t,n){if("undefined"==typeof AuthService||!isSupabaseReady())return toast("Erro","Supabase n√£o est√° conectado. Verifique sua conex√£o."),!1;const o=await AuthService.getSession();if(!o?.user?.id)return toast("Erro","Sess√£o inv√°lida. Fa√ßa login novamente."),!1;const r=getPlanLimits();if((await _carregarContasVinculadas()).length>=r.funcionarios)return toast("Limite atingido",`Seu plano ${planoAtual} permite no m√°ximo ${r.funcionarios} conta(s) de acesso.`),!1;try{const{data:r,error:i}=await _supabaseClient.auth.signUp({email:a,password:n,options:{data:{full_name:e,user_role:t}}});if(i)return i.message.includes("already registered")?toast("Erro","Este e-mail j√° est√° cadastrado no sistema."):toast("Erro","Falha ao criar conta: "+i.message),!1;const s=r?.user?.id;if(!s)return toast("Erro","Conta criada mas ID n√£o retornado. O usu√°rio precisa confirmar o e-mail."),!0;for(let a=0;a<3;a++){const{error:a}=await _supabaseClient.from("profiles").update({user_role:t,owner_id:o.user.id,full_name:e}).eq("id",s);if(!a)break;await new Promise(e=>setTimeout(e,500))}return toast("Conta criada",`${e} pode acessar como ${"gerente"===t?"Gerente":"Funcion√°rio"}. Um e-mail de confirma√ß√£o foi enviado.`),!0}catch(e){return toast("Erro","Exce√ß√£o ao criar conta: "+(e.message||e)),!1}}async function _alterarRoleAcesso(e,a){if("undefined"==typeof _supabaseClient)return!1;try{const{error:t}=await _supabaseClient.from("profiles").update({user_role:a}).eq("id",e);return t?(toast("Erro","Falha ao alterar perfil."),!1):(toast("Perfil alterado",`Perfil atualizado para ${"gerente"===a?"Gerente":"Funcion√°rio"}.`),!0)}catch(e){return!1}}async function _removerAcesso(e,a){if(confirm(`Remover o acesso de ${a}? O usu√°rio n√£o poder√° mais fazer login.`)&&"undefined"!=typeof _supabaseClient)try{await _supabaseClient.from("profiles").update({user_role:"desativado"}).eq("id",e),toast("Acesso removido",`${a} foi desativado.`),pageEquipe()}catch(e){toast("Erro","Falha ao remover acesso.")}}async function renderGerenciamentoAcessos(){document.getElementById("content").insertAdjacentHTML("beforeend",'\n    <div id="acessosSection" class="card" style="margin-top:25px; border: 2px solid #3b82f6;">\n      <div style="text-align:center; padding:30px; color:#64748b;">\n        <div style="font-size:24px; margin-bottom:8px;">‚è≥</div>\n        Carregando contas de acesso...\n      </div>\n    </div>\n  ');const e=await _carregarContasVinculadas(),a=document.getElementById("acessosSection");if(!a)return;const t=e.filter(e=>"desativado"!==e.user_role&&"admin"!==e.user_role);a.innerHTML=`\n    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">\n      <div>\n        <h3 style="margin:0; color:#3b82f6;">üîê Gerenciamento de Acessos</h3>\n        <p style="color:#64748b; font-size:13px; margin:5px 0 0;">Crie contas para sua equipe acessar o sistema com permiss√µes limitadas.</p>\n      </div>\n      <span style="background:#dbeafe; color:#1e40af; padding:4px 12px; border-radius:20px; font-size:11px; font-weight:600;">\n        ${t.length} / ${getPlanLimits().funcionarios} contas\n      </span>\n    </div>\n    <div class="hr"></div>\n\n    \x3c!-- Resumo de perfis --\x3e\n    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:15px 0;">\n      <div style="background:#ecfdf5; border:1px solid #a7f3d0; border-radius:10px; padding:12px;">\n        <div style="font-size:12px; color:#065f46;">\n          <b>üëî Gerente</b><br>\n          V√™ tudo (exceto financeiro) ‚Ä¢ Pode criar e editar registros ‚Ä¢ Sem acesso a folha salarial e relat√≥rios financeiros\n        </div>\n      </div>\n      <div style="background:#fef3c7; border:1px solid #fcd34d; border-radius:10px; padding:12px;">\n        <div style="font-size:12px; color:#92400e;">\n          <b>üë∑ Funcion√°rio</b><br>\n          Dashboard simplificado ‚Ä¢ Registra aplica√ß√µes, manuten√ß√£o, combust√≠vel ‚Ä¢ Sem acesso a dados financeiros\n        </div>\n      </div>\n    </div>\n\n    \x3c!-- Formul√°rio de cria√ß√£o --\x3e\n    <div style="background:var(--bg-card-alt, #f8fafc); border-radius:10px; padding:18px; margin:15px 0; border:1px solid var(--border, #e2e8f0);">\n      <h4 style="margin:0 0 12px;">‚ûï Criar nova conta de acesso</h4>\n      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">\n        <div>\n          <small style="display:block; margin-bottom:4px; font-weight:600;">Nome completo</small>\n          <input class="input" id="teamName" placeholder="Nome do colaborador" />\n        </div>\n        <div>\n          <small style="display:block; margin-bottom:4px; font-weight:600;">E-mail (login)</small>\n          <input class="input" id="teamEmail" type="email" placeholder="email@exemplo.com" />\n        </div>\n        <div>\n          <small style="display:block; margin-bottom:4px; font-weight:600;">Perfil de Acesso</small>\n          <select class="select" id="teamRole">\n            <option value="gerente">üëî Gerente</option>\n            <option value="funcionario">üë∑ Funcion√°rio</option>\n          </select>\n        </div>\n        <div>\n          <small style="display:block; margin-bottom:4px; font-weight:600;">Senha (m√≠n. 6 caracteres)</small>\n          <input class="input" id="teamPass" type="password" placeholder="Senha inicial" />\n        </div>\n      </div>\n      <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">\n        <button class="btn primary" id="btnCriarAcesso" style="padding:10px 24px;">üîë Criar Conta</button>\n        <span style="font-size:11px; color:#94a3b8;">O colaborador receber√° um e-mail de confirma√ß√£o.</span>\n      </div>\n    </div>\n\n    \x3c!-- Tabela de contas --\x3e\n    <div style="margin-top:15px;">\n      <h4>Contas de acesso ativas (${t.length})</h4>\n      <div style="overflow-x:auto;">\n        <table style="width:100%; border-collapse:collapse;">\n          <thead>\n            <tr style="background:var(--bg-card-alt, #f1f5f9);">\n              <th style="text-align:left; padding:10px;">Nome</th>\n              <th style="text-align:left; padding:10px;">E-mail</th>\n              <th style="text-align:left; padding:10px;">Perfil</th>\n              <th style="text-align:left; padding:10px;">Desde</th>\n              <th style="text-align:center; padding:10px;">A√ß√µes</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${0===t.length?'<tr><td colspan="5" style="text-align:center; color:#94a3b8; padding:30px;">Nenhuma conta de acesso criada. Use o formul√°rio acima para convidar sua equipe.</td></tr>':t.map(e=>{const a="gerente"===e.user_role,t=a?"background:#dbeafe; color:#1e40af;":"background:#fef3c7; color:#92400e;",n=a?"üëî Gerente":"üë∑ Funcion√°rio",o=e.created_at?new Date(e.created_at).toLocaleDateString("pt-BR"):"-";return`\n                  <tr style="border-bottom:1px solid var(--border, #e2e8f0);">\n                    <td style="padding:10px;"><b>${escapeHtml(e.full_name||"-")}</b></td>\n                    <td style="padding:10px; font-size:13px;">${escapeHtml(e.email||"-")}</td>\n                    <td style="padding:10px;">\n                      <span style="${t} padding:3px 10px; border-radius:6px; font-size:12px; font-weight:bold;">${n}</span>\n                    </td>\n                    <td style="padding:10px; color:#64748b; font-size:13px;">${o}</td>\n                    <td style="padding:10px; text-align:center;">\n                      <button class="btn" style="padding:4px 10px; font-size:11px; margin-right:4px;" onclick="window.__toggleRole('${e.id}','${e.user_role}')">\n                        ${a?"‚Üì Funcion√°rio":"‚Üë Gerente"}\n                      </button>\n                      <button class="btn danger" style="padding:4px 10px; font-size:11px;" onclick="window.__delAcesso('${e.id}','${escapeHtml(e.full_name||"")}')">Desativar</button>\n                    </td>\n                  </tr>\n                `}).join("")}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  `,document.getElementById("btnCriarAcesso")?.addEventListener("click",async()=>{const e=document.getElementById("teamName").value.trim(),a=document.getElementById("teamEmail").value.trim(),t=document.getElementById("teamRole").value,n=document.getElementById("teamPass").value;if(!e||!a||!n)return void toast("Erro","Preencha todos os campos.");if(n.length<6)return void toast("Erro","Senha deve ter no m√≠nimo 6 caracteres.");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))return void toast("Erro","E-mail inv√°lido.");const o=document.getElementById("btnCriarAcesso");o.disabled=!0,o.textContent="Criando...",await _criarContaAcesso(e,a,t,n)?pageEquipe():(o.disabled=!1,o.textContent="üîë Criar Conta")}),window.__toggleRole=async(e,a)=>{const t="gerente"===a?"funcionario":"gerente";await _alterarRoleAcesso(e,t)&&pageEquipe()},window.__delAcesso=(e,a)=>_removerAcesso(e,a)}