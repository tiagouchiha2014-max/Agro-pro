function pageColheitas(){const e=getDB();let t=onlySafra(e.talhoes);fazendaAtual&&(t=t.filter(e=>e.fazendaId===fazendaAtual));const a=onlySafra(e.fazendas),n=onlySafra(e.maquinas),o=onlySafra(e.colheitas||[]).sort((e,t)=>(t.dataColheita||"").localeCompare(e.dataColheita||""));setTopActions('\n    <button class="btn" id="btnExportCSV">ğŸ“¥ Exportar CSV</button>\n    <button class="btn" id="btnExportRelatorio" style="background:var(--brand,#2e7d32);color:white;">ğŸ“„ RelatÃ³rio</button>\n  ');const i=e.parametros||{},d=Number(i.pesoPadraoSaca||60),r=o.reduce((e,t)=>{const a=Number(t.producaoTotal||0);return e+("sc"===t.unidade?a*d:a)},0),s=o.reduce((e,t)=>{let a=0;return(t.fretes||[]).forEach(e=>{a+=Number(e.custoFrete||0)}),t.frete1&&(a+=Number(t.frete1.custoFrete||0)),t.frete2&&(a+=Number(t.frete2.custoFrete||0)),e+a},0),l=o.reduce((e,t)=>{let a=0;return(t.fretes||[]).forEach(e=>{a+=Number(e.toneladas||0)}),t.frete1&&(a+=Number(t.frete1.toneladas||0)),t.frete2&&(a+=Number(t.frete2.toneladas||0)),e+a},0),c=l>0?l:r/1e3,p=c>0?s/c:0,u=o.reduce((e,t)=>e+((t.fretes||[]).length+(t.frete1?1:0)+(t.frete2?1:0)),0),m=o.filter(e=>e.umidade).length>0?(o.reduce((e,t)=>e+Number(t.umidade||0),0)/o.filter(e=>e.umidade).length).toFixed(1):"-",h=o.reduce((e,t)=>e+Number(t.pesoLiquidoEstimado||0),0),f=new Map;o.forEach(e=>{let t=0;(e.fretes||[]).forEach(e=>{t+=Number(e.custoFrete||0)}),e.frete1&&(t+=Number(e.frete1.custoFrete||0)),e.frete2&&(t+=Number(e.frete2.custoFrete||0)),f.set(e.talhaoId,(f.get(e.talhaoId)||0)+t)}),document.getElementById("content").innerHTML=`\n  <style>\n    /* â”€â”€ Premium Harvest Page Styles â”€â”€ */\n    .ch-kpi-grid {\n      display: grid;\n      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));\n      gap: 14px;\n      margin-bottom: 24px;\n    }\n    .ch-kpi-card {\n      background: var(--card-bg, #fff);\n      border-radius: 14px;\n      padding: 18px 16px;\n      border: 1px solid var(--border, #e2e8f0);\n      box-shadow: 0 2px 10px rgba(0,0,0,.06);\n      position: relative;\n      overflow: hidden;\n    }\n    .ch-kpi-card::before {\n      content: '';\n      position: absolute;\n      top: 0; left: 0; right: 0;\n      height: 4px;\n      background: var(--kpi-color, #f59e0b);\n    }\n    .ch-kpi-icon  { font-size: 26px; margin-bottom: 6px; }\n    .ch-kpi-val   { font-size: 26px; font-weight: 800; color: var(--text, #0f172a); line-height: 1.1; }\n    .ch-kpi-sub   { font-size: 11px; color: var(--text-muted, #64748b); margin-top: 4px; }\n    .ch-kpi-label { font-size: 12px; font-weight: 600; color: var(--text-muted, #475569); margin-bottom: 2px; text-transform: uppercase; letter-spacing: .4px; }\n\n    /* â”€â”€ Form card â”€â”€ */\n    .ch-form-card {\n      background: var(--card-bg, #fff);\n      border-radius: 14px;\n      border: 1px solid var(--border, #e2e8f0);\n      box-shadow: 0 2px 10px rgba(0,0,0,.06);\n      margin-bottom: 24px;\n      overflow: hidden;\n    }\n    .ch-form-header {\n      background: linear-gradient(135deg, #1e3a5f, #2d6a4f);\n      color: white;\n      padding: 18px 22px;\n      display: flex;\n      align-items: center;\n      gap: 12px;\n    }\n    .ch-form-header h3 { margin: 0; font-size: 16px; font-weight: 700; }\n    .ch-form-header p  { margin: 2px 0 0; font-size: 12px; opacity: .75; }\n    .ch-form-body { padding: 22px; }\n\n    /* â”€â”€ Section headers inside form â”€â”€ */\n    .ch-section-title {\n      font-size: 13px;\n      font-weight: 700;\n      text-transform: uppercase;\n      letter-spacing: .5px;\n      color: var(--text-muted, #475569);\n      border-bottom: 2px solid var(--border, #e2e8f0);\n      padding-bottom: 6px;\n      margin: 18px 0 12px;\n    }\n\n    /* â”€â”€ Machine rows â”€â”€ */\n    .ch-maquina-linha {\n      display: grid;\n      grid-template-columns: 2fr 1fr auto;\n      gap: 10px;\n      margin-bottom: 8px;\n      align-items: center;\n    }\n\n    /* â”€â”€ Frete premium â”€â”€ */\n    .ch-frete-grid {\n      display: grid;\n      grid-template-columns: 1fr 1fr;\n      gap: 16px;\n      margin-top: 12px;\n    }\n    @media (max-width: 700px) { .ch-frete-grid { grid-template-columns: 1fr; } }\n\n    .ch-frete-box {\n      background: var(--bg, #f8fafc);\n      border: 1px solid var(--border, #e2e8f0);\n      border-radius: 12px;\n      overflow: hidden;\n    }\n    .ch-frete-box-header {\n      padding: 12px 16px;\n      font-size: 13px;\n      font-weight: 700;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n    .ch-frete-box-header.f1 { background: linear-gradient(135deg,#1d4ed8,#2563eb); color:white; }\n    .ch-frete-box-header.f2 { background: linear-gradient(135deg,#7c3aed,#8b5cf6); color:white; }\n    .ch-frete-box-body { padding: 14px; display: grid; gap: 8px; }\n    .ch-frete-cost {\n      background: white;\n      border-radius: 8px;\n      padding: 10px 14px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      border: 1px solid var(--border, #e2e8f0);\n      margin-top: 6px;\n    }\n    .ch-frete-cost .val { font-size: 18px; font-weight: 800; color: #1d4ed8; }\n    .ch-frete-cost.f2 .val { color: #7c3aed; }\n\n    /* â”€â”€ Frete total bar â”€â”€ */\n    .ch-frete-total {\n      background: linear-gradient(135deg, #0f172a, #1e293b);\n      border-radius: 12px;\n      padding: 18px 22px;\n      margin-top: 16px;\n      color: white;\n      display: flex;\n      flex-wrap: wrap;\n      gap: 20px;\n      justify-content: space-between;\n      align-items: center;\n    }\n    .ch-frete-total .big { font-size: 28px; font-weight: 900; color: #fbbf24; }\n    .ch-frete-total .lbl { font-size: 11px; opacity: .65; text-transform: uppercase; letter-spacing: .5px; }\n    .ch-frete-total .detail { font-size: 12px; opacity: .8; margin-top: 4px; }\n\n    /* â”€â”€ Truck badge â”€â”€ */\n    .truck-badge {\n      display: inline-flex;\n      align-items: center;\n      gap: 4px;\n      background: #eff6ff;\n      color: #1d4ed8;\n      border: 1px solid #bfdbfe;\n      border-radius: 20px;\n      padding: 3px 10px;\n      font-size: 11px;\n      font-weight: 600;\n    }\n\n    /* â”€â”€ Table premium â”€â”€ */\n    .ch-table-card {\n      background: var(--card-bg, #fff);\n      border-radius: 14px;\n      border: 1px solid var(--border, #e2e8f0);\n      box-shadow: 0 2px 10px rgba(0,0,0,.06);\n      overflow: hidden;\n      margin-bottom: 24px;\n    }\n    .ch-table-header {\n      padding: 16px 20px;\n      border-bottom: 1px solid var(--border, #e2e8f0);\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      background: var(--bg, #f8fafc);\n    }\n    .ch-table-header h3 { margin: 0; font-size: 15px; }\n    .ch-tag {\n      display: inline-block;\n      background: #dcfce7;\n      color: #166534;\n      border-radius: 6px;\n      padding: 2px 8px;\n      font-size: 11px;\n      font-weight: 700;\n    }\n\n    /* â”€â”€ Frete summary table â”€â”€ */\n    .ch-frete-summary-card {\n      background: var(--card-bg, #fff);\n      border-radius: 14px;\n      border: 1px solid var(--border, #e2e8f0);\n      box-shadow: 0 2px 10px rgba(0,0,0,.06);\n      overflow: hidden;\n      margin-bottom: 24px;\n    }\n    .maquina-linha { display: grid; grid-template-columns: 2fr 1fr 0.5fr; gap: 10px; margin-bottom: 8px; align-items: center; }\n    .btn-remove { background:#ef4444; color:white; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; font-size:13px; }\n    .colheita-form { background:var(--card-bg,#fff); border-radius:var(--radius); padding:20px; margin-bottom:30px; border:1px solid #e2e8f0; }\n  </style>\n\n  \x3c!-- â•â•â•â•â•â•â•â•â•â• KPIs â•â•â•â•â•â•â•â•â•â• --\x3e\n  <div class="ch-kpi-grid">\n    <div class="ch-kpi-card" style="--kpi-color:#16a34a;">\n      <div class="ch-kpi-icon">ğŸŒ¾</div>\n      <div class="ch-kpi-label">ProduÃ§Ã£o Total</div>\n      <div class="ch-kpi-val">${num(r/1e3,2)} t</div>\n      <div class="ch-kpi-sub">${num(r,0)} kg colhidos</div>\n    </div>\n    <div class="ch-kpi-card" style="--kpi-color:#f59e0b;">\n      <div class="ch-kpi-icon">ğŸ“‹</div>\n      <div class="ch-kpi-label">Colheitas</div>\n      <div class="ch-kpi-val">${o.length}</div>\n      <div class="ch-kpi-sub">${t.length} talhÃµes</div>\n    </div>\n    <div class="ch-kpi-card" style="--kpi-color:#3b82f6;">\n      <div class="ch-kpi-icon">ğŸš›</div>\n      <div class="ch-kpi-label">Custo Total Frete</div>\n      <div class="ch-kpi-val">${kbrl(s)}</div>\n      <div class="ch-kpi-sub">${kbrl(p)}/ton | ${u} viagens</div>\n    </div>\n    <div class="ch-kpi-card" style="--kpi-color:#8b5cf6;">\n      <div class="ch-kpi-icon">ğŸ¢</div>\n      <div class="ch-kpi-label">Entregue</div>\n      <div class="ch-kpi-val">${num(c,2)} t</div>\n      <div class="ch-kpi-sub">em ${o.filter(e=>(e.fretes||[]).length>0||e.frete1||e.frete2).length} colheitas</div>\n    </div>\n    <div class="ch-kpi-card" style="--kpi-color:#ec4899;">\n      <div class="ch-kpi-icon">ğŸ’§</div>\n      <div class="ch-kpi-label">Umidade MÃ©dia</div>\n      <div class="ch-kpi-val">${m}${"-"!==m?"%":""}</div>\n      <div class="ch-kpi-sub">na colheita</div>\n    </div>\n    <div class="ch-kpi-card" style="--kpi-color:#16a34a;">\n      <div class="ch-kpi-icon">âš–ï¸</div>\n      <div class="ch-kpi-label">Peso LÃ­quido Total</div>\n      <div class="ch-kpi-val">${h>0?num(h/1e3,2)+" t":"â€”"}</div>\n      <div class="ch-kpi-sub">apÃ³s descontos silo</div>\n    </div>\n  </div>\n\n  \x3c!-- â•â•â•â•â•â•â•â•â•â• FORMULÃRIO DE COLHEITA â•â•â•â•â•â•â•â•â•â• --\x3e\n  <div class="ch-form-card">\n    <div class="ch-form-header">\n      <div style="font-size:28px;">ğŸŒ¾</div>\n      <div>\n        <h3>Registrar Nova Colheita</h3>\n        <p>Preencha produÃ§Ã£o, umidade, mÃ¡quinas utilizadas e dados de transporte</p>\n      </div>\n    </div>\n    <div class="ch-form-body">\n      <form id="frmColheita" class="formGrid">\n\n        \x3c!-- â”€â”€ Dados bÃ¡sicos â”€â”€ --\x3e\n        <div class="ch-section-title full">ğŸ“‹ Dados da Colheita</div>\n\n        <div><small>ğŸ“… Data da Colheita *</small><input class="input" name="dataColheita" type="date" value="${nowISO()}" required></div>\n        <div><small>ğŸ§­ TalhÃ£o *</small>\n          <select class="select" name="talhaoId" required>\n            <option value="">Selecione...</option>\n            ${t.map(e=>`<option value="${e.id}">${escapeHtml(e.nome)} (${e.cultura||"Sem cultura"}) â€” ${num(e.areaHa,1)} ha</option>`).join("")}\n          </select>\n        </div>\n        <div><small>ğŸ“¦ ProduÃ§Ã£o Total *</small><input class="input" name="producaoTotal" type="number" step="0.01" required placeholder="Quantidade colhida"></div>\n        <div><small>ğŸ“ Unidade *</small>\n          <select class="select" name="unidade">\n            <option value="kg">kg</option>\n            <option value="sc">sacas (60kg)</option>\n            <option value="t">toneladas</option>\n          </select>\n        </div>\n        <div><small>ğŸ’§ Umidade (%)</small><input class="input" name="umidade" type="number" step="0.1" min="0" max="100" placeholder="Ex: 13.5" oninput="window.__calcularDescontosSilo()"></div>\n        <div><small>ğŸŒ¡ Temperatura (Â°C)</small><input class="input" name="temperatura" type="number" step="0.1" placeholder="Temperatura na colheita"></div>\n        <div><small>ğŸ“„ NÂº Romaneio / NF</small><input class="input" name="romaneio" placeholder="Ex: ROM-001 ou NF-12345"></div>\n        <div><small>ğŸ“ ObservaÃ§Ãµes</small><input class="input" name="obs" placeholder="CondiÃ§Ãµes da lavoura, notas gerais..."></div>\n\n        \x3c!-- â”€â”€ ClassificaÃ§Ã£o / Descontos no Silo â”€â”€ --\x3e\n        <div class="ch-section-title full">ğŸ­ ClassificaÃ§Ã£o e Descontos no Silo</div>\n        <div style="grid-column:1/-1; background:#fefce8; border:1px solid #fde68a; border-radius:10px; padding:12px 16px; font-size:12px; color:#78350f; margin-bottom:4px;">\n          ğŸ’¡ <b>Descontos de recebimento</b> aplicados pelo armazÃ©m/silo. O sistema calcula o peso lÃ­quido apÃ³s os descontos e o impacto financeiro estimado.\n        </div>\n        <div>\n          <small>ğŸ’§ Umidade PadrÃ£o (%)</small>\n          <input class="input" name="umidadePadrao" type="number" step="0.1" min="0" max="30" placeholder="Ex: 13.0 (padrÃ£o soja)" value="13.0" oninput="window.__calcularDescontosSilo()">\n        </div>\n        <div>\n          <small>ğŸŒ¾ Impureza / MatÃ©ria Estranha (%)</small>\n          <input class="input" name="impureza" type="number" step="0.01" min="0" max="20" placeholder="Ex: 1.0" oninput="window.__calcularDescontosSilo()">\n        </div>\n        <div>\n          <small>ğŸ”¥ Ardidos / Queimados (%)</small>\n          <input class="input" name="ardidos" type="number" step="0.01" min="0" max="10" placeholder="Ex: 0.5" oninput="window.__calcularDescontosSilo()">\n        </div>\n        <div>\n          <small>ğŸŒ¿ Esverdeados / Imaturos (%)</small>\n          <input class="input" name="esverdeados" type="number" step="0.01" min="0" max="20" placeholder="Ex: 2.0" oninput="window.__calcularDescontosSilo()">\n        </div>\n        <div>\n          <small>ğŸ’” Quebrados / Avariados (%)</small>\n          <input class="input" name="quebrados" type="number" step="0.01" min="0" max="20" placeholder="Ex: 3.0" oninput="window.__calcularDescontosSilo()">\n        </div>\n        <div>\n          <small>ğŸ«™ CPO / Ã“leo / GrÃ£o Duro (%)</small>\n          <input class="input" name="cpo" type="number" step="0.01" min="0" max="10" placeholder="Ex: 0.5" oninput="window.__calcularDescontosSilo()">\n        </div>\n        <div>\n          <small>ğŸ’° PreÃ§o base (R$/saca 60kg)</small>\n          <input class="input" name="precoBaseSaca" type="number" step="0.01" min="0" placeholder="Ex: 120.00" oninput="window.__calcularDescontosSilo()">\n        </div>\n        <div>\n          <small>ğŸ¦ Taxa Armazenagem (%/mÃªs)</small>\n          <input class="input" name="taxaArmazenagem" type="number" step="0.01" min="0" max="5" placeholder="Ex: 0.35" oninput="window.__calcularDescontosSilo()">\n        </div>\n\n        \x3c!-- Painel de resultado dos descontos --\x3e\n        <div class="full" id="siloDescontoResultado" style="display:none;">\n          <div style="background:linear-gradient(135deg,#1e3a5f,#2d6a4f); border-radius:12px; padding:16px 20px; color:white;">\n            <div style="font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; opacity:.8; margin-bottom:12px;">ğŸ“Š Resultado da ClassificaÃ§Ã£o</div>\n            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px;">\n              <div><div style="font-size:11px;opacity:.7;">Desc. Umidade</div><div id="siloDescUmidade" style="font-size:18px;font-weight:800;color:#fbbf24;">â€”</div></div>\n              <div><div style="font-size:11px;opacity:.7;">Desc. Impurezas</div><div id="siloDescImpureza" style="font-size:18px;font-weight:800;color:#fb923c;">â€”</div></div>\n              <div><div style="font-size:11px;opacity:.7;">Desc. Avarias</div><div id="siloDescAvaria" style="font-size:18px;font-weight:800;color:#f87171;">â€”</div></div>\n              <div><div style="font-size:11px;opacity:.7;">Peso Bruto</div><div id="siloPesoBruto" style="font-size:18px;font-weight:800;color:#86efac;">â€”</div></div>\n              <div><div style="font-size:11px;opacity:.7;">Peso LÃ­quido</div><div id="siloPesoLiquido" style="font-size:18px;font-weight:800;color:#4ade80;">â€”</div></div>\n              <div><div style="font-size:11px;opacity:.7;">Perda Financeira</div><div id="siloPerdaFinanceira" style="font-size:18px;font-weight:800;color:#fca5a5;">â€”</div></div>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- â”€â”€ MÃ¡quinas â”€â”€ --\x3e\n        <div class="full">\n          <div class="ch-section-title">ğŸšœ MÃ¡quinas Utilizadas</div>\n          <div id="maquinas-container">\n            <div class="maquina-linha">\n              <select class="select" name="maquinaId[]">\n                <option value="">â€” MÃ¡quina (opcional) â€”</option>\n                ${n.map(e=>`<option value="${e.id}">${escapeHtml(e.nome)}</option>`).join("")}\n              </select>\n              <input class="input" name="horas[]" type="number" step="0.5" placeholder="Horas trabalhadas">\n              <button type="button" class="btn-remove" onclick="window.__removerMaquina(this)" title="Remover">âœ•</button>\n            </div>\n          </div>\n          <button type="button" class="btn" id="btnAdicionarMaquina" style="margin-top:8px; font-size:12px;">+ Adicionar mÃ¡quina</button>\n        </div>\n\n        \x3c!-- â•â•â•â•â•â•â•â• SEÃ‡ÃƒO DE FRETE / TRANSPORTE â•â•â•â•â•â•â•â• --\x3e\n        <div class="full">\n          <div class="ch-section-title">ğŸš› Transporte e Frete</div>\n          <p style="font-size:12px; color:var(--text-muted,#64748b); margin:0 0 12px;">\n            Registre atÃ© 2 destinos (armazÃ©ns) com dados completos do caminhÃ£o, motorista e nota fiscal de transporte.\n          </p>\n\n          <div class="ch-frete-grid">\n            \x3c!-- â”€â”€ FRETE 1 â”€â”€ --\x3e\n            <div class="ch-frete-box">\n              <div class="ch-frete-box-header f1">ğŸš› Frete 1 â€” Destino Principal</div>\n              <div class="ch-frete-box-body">\n                <small style="font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:.4px; color:#1d4ed8;">ğŸ¢ ArmazÃ©m / Destino</small>\n                <input class="input" name="frete1_armazem" placeholder="Ex: ArmazÃ©m Cargill Sorriso">\n                <input class="input" name="frete1_cidade" placeholder="ğŸ“ Cidade â€” Ex: Sorriso - MT">\n\n                <small style="font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:.4px; color:#1d4ed8; margin-top:6px; display:block;">ğŸš› Dados do CaminhÃ£o</small>\n                <input class="input" name="frete1_placa" placeholder="ğŸš› Placa do CaminhÃ£o â€” Ex: ABC-1234">\n                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">\n                  <input class="input" name="frete1_tipo_caminhao" placeholder="Tipo â€” Ex: Bitrem, Carreta">\n                  <input class="input" name="frete1_capacidade" type="number" step="0.1" placeholder="Capacidade (ton)">\n                </div>\n                <input class="input" name="frete1_motorista" placeholder="ğŸ‘¤ Nome do Motorista">\n                <input class="input" name="frete1_cnh" placeholder="ğŸªª CNH do Motorista">\n\n                <small style="font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:.4px; color:#1d4ed8; margin-top:6px; display:block;">ğŸ¢ Transportadora</small>\n                <input class="input" name="frete1_transportadora" placeholder="RazÃ£o social ou nome">\n                <input class="input" name="frete1_cnpj_transp" placeholder="CNPJ (opcional)">\n\n                <small style="font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:.4px; color:#1d4ed8; margin-top:6px; display:block;">ğŸ’° Valores e NF</small>\n                <input class="input" name="frete1_nf_transp" placeholder="ğŸ“„ NÂº NF de Transporte">\n                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">\n                  <div>\n                    <small>Toneladas entregues</small>\n                    <input class="input" name="frete1_toneladas" type="number" step="0.01" placeholder="0.00" oninput="window.__calcularFretes()">\n                  </div>\n                  <div>\n                    <small>PreÃ§o/ton (R$)</small>\n                    <input class="input" name="frete1_precoTon" type="number" step="0.01" placeholder="0.00" oninput="window.__calcularFretes()">\n                  </div>\n                </div>\n                <input class="input" name="frete1_distancia" type="number" step="1" placeholder="ğŸ“ DistÃ¢ncia (km)">\n                <input class="input" name="frete1_data_entrega" type="date" title="Data da entrega no armazÃ©m">\n                <div class="ch-frete-cost">\n                  <div>\n                    <div style="font-size:11px; color:var(--text-muted,#64748b); font-weight:600;">CUSTO FRETE 1</div>\n                    <div class="val" id="custoFrete1">R$ 0,00</div>\n                  </div>\n                  <div style="font-size:22px;">ğŸš›</div>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- â”€â”€ FRETE 2 â”€â”€ --\x3e\n            <div class="ch-frete-box">\n              <div class="ch-frete-box-header f2">ğŸšš Frete 2 â€” Destino SecundÃ¡rio</div>\n              <div class="ch-frete-box-body">\n                <small style="font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:.4px; color:#7c3aed;">ğŸ¢ ArmazÃ©m / Destino</small>\n                <input class="input" name="frete2_armazem" placeholder="Ex: ArmazÃ©m Bunge Lucas">\n                <input class="input" name="frete2_cidade" placeholder="ğŸ“ Cidade â€” Ex: Lucas do Rio Verde - MT">\n\n                <small style="font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:.4px; color:#7c3aed; margin-top:6px; display:block;">ğŸšš Dados do CaminhÃ£o</small>\n                <input class="input" name="frete2_placa" placeholder="ğŸšš Placa do CaminhÃ£o â€” Ex: XYZ-5678">\n                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">\n                  <input class="input" name="frete2_tipo_caminhao" placeholder="Tipo â€” Ex: Graneleiro, Truck">\n                  <input class="input" name="frete2_capacidade" type="number" step="0.1" placeholder="Capacidade (ton)">\n                </div>\n                <input class="input" name="frete2_motorista" placeholder="ğŸ‘¤ Nome do Motorista">\n                <input class="input" name="frete2_cnh" placeholder="ğŸªª CNH do Motorista">\n\n                <small style="font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:.4px; color:#7c3aed; margin-top:6px; display:block;">ğŸ¢ Transportadora</small>\n                <input class="input" name="frete2_transportadora" placeholder="RazÃ£o social ou nome">\n                <input class="input" name="frete2_cnpj_transp" placeholder="CNPJ (opcional)">\n\n                <small style="font-weight:700; font-size:11px; text-transform:uppercase; letter-spacing:.4px; color:#7c3aed; margin-top:6px; display:block;">ğŸ’° Valores e NF</small>\n                <input class="input" name="frete2_nf_transp" placeholder="ğŸ“„ NÂº NF de Transporte">\n                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">\n                  <div>\n                    <small>Toneladas entregues</small>\n                    <input class="input" name="frete2_toneladas" type="number" step="0.01" placeholder="0.00" oninput="window.__calcularFretes()">\n                  </div>\n                  <div>\n                    <small>PreÃ§o/ton (R$)</small>\n                    <input class="input" name="frete2_precoTon" type="number" step="0.01" placeholder="0.00" oninput="window.__calcularFretes()">\n                  </div>\n                </div>\n                <input class="input" name="frete2_distancia" type="number" step="1" placeholder="ğŸ“ DistÃ¢ncia (km)">\n                <input class="input" name="frete2_data_entrega" type="date" title="Data da entrega no armazÃ©m">\n                <div class="ch-frete-cost f2">\n                  <div>\n                    <div style="font-size:11px; color:var(--text-muted,#64748b); font-weight:600;">CUSTO FRETE 2</div>\n                    <div class="val" id="custoFrete2">R$ 0,00</div>\n                  </div>\n                  <div style="font-size:22px;">ğŸšš</div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- â”€â”€ TOTAL FRETE â”€â”€ --\x3e\n          <div class="ch-frete-total">\n            <div>\n              <div class="lbl">Custo Total de Frete</div>\n              <div class="big" id="custoFreteTotalForm">R$ 0,00</div>\n              <div class="detail" id="detalheFretes">Preencha os dados de frete acima</div>\n            </div>\n            <div style="text-align:right;">\n              <div class="lbl">Total Entregue</div>\n              <div class="big" id="totalEntregueForm" style="color:#86efac;">0,00 t</div>\n              <div class="detail" id="detalheViagens">â€”</div>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- â”€â”€ Submit â”€â”€ --\x3e\n        <div class="full row" style="justify-content:flex-end; margin-top:16px; gap:10px;">\n          <button type="reset" class="btn" style="font-size:14px;">ğŸ”„ Limpar</button>\n          <button class="btn primary" type="submit" style="font-size:15px; padding:12px 28px; background:var(--brand,#2e7d32); color:white; font-weight:700;">\n            âœ… Salvar Colheita\n          </button>\n        </div>\n      </form>\n    </div>\n  </div>\n\n  \x3c!-- â•â•â•â•â•â•â•â•â•â• RESUMO FRETES POR TALHÃƒO â•â•â•â•â•â•â•â•â•â• --\x3e\n  <div class="ch-frete-summary-card">\n    <div class="ch-table-header">\n      <span style="font-size:20px;">ğŸ—ºï¸</span>\n      <h3>Custo de Frete por TalhÃ£o</h3>\n      <span class="ch-tag">${t.length} talhÃµes</span>\n    </div>\n    <div class="tableWrap">\n      <table>\n        <thead>\n          <tr>\n            <th>TalhÃ£o</th>\n            <th>Fazenda</th>\n            <th>Cultura</th>\n            <th>Ãrea (ha)</th>\n            <th>Prod. Total</th>\n            <th>Custo Frete</th>\n            <th>Frete / ha</th>\n            <th>Frete / ton</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${t.map(e=>{const t=f.get(e.id)||0,n=Number(e.areaHa||0),i=o.filter(t=>t.talhaoId===e.id).reduce((e,t)=>{const a=Number(t.producaoTotal||0);return e+("sc"===t.unidade?a*d:"t"===t.unidade?1e3*a:a)},0)/1e3;return`<tr>\n              <td><b>${escapeHtml(e.nome)}</b></td>\n              <td>${escapeHtml(findNameById(a,e.fazendaId))}</td>\n              <td>${escapeHtml(e.cultura||"â€”")}</td>\n              <td>${num(n,1)}</td>\n              <td>${num(i,2)} t</td>\n              <td><b>${kbrl(t)}</b></td>\n              <td>${n>0?kbrl(t/n):"â€”"}</td>\n              <td>${i>0?kbrl(t/i):"â€”"}</td>\n            </tr>`}).join("")||'<tr><td colspan="8" style="text-align:center;color:#94a3b8;">Nenhum talhÃ£o cadastrado</td></tr>'}\n        </tbody>\n      </table>\n    </div>\n  </div>\n\n  \x3c!-- â•â•â•â•â•â•â•â•â•â• TABELA DE COLHEITAS â•â•â•â•â•â•â•â•â•â• --\x3e\n  <div class="ch-table-card">\n    <div class="ch-table-header">\n      <span style="font-size:20px;">ğŸ“‹</span>\n      <h3>Colheitas Registradas</h3>\n      <span class="ch-tag">${o.length} registros</span>\n    </div>\n    <div class="tableWrap">\n      <table id="tabelaColheitas">\n        <thead>\n          <tr>\n            <th>Data</th>\n            <th>TalhÃ£o</th>\n            <th>ProduÃ§Ã£o</th>\n            <th>Umidade</th>\n            <th>Classif./Romaneio</th>\n            <th>Frete 1</th>\n            <th>Frete 2</th>\n            <th>Custo Frete</th>\n            <th class="noPrint">AÃ§Ãµes</th>\n          </tr>\n        </thead>\n        <tbody id="tbodyColheitas"></tbody>\n      </table>\n    </div>\n  </div>\n  `,window.__calcularDescontosSilo=()=>{const e=e=>{const t=document.querySelector(`[name="${e}"]`);return t&&Number(t.value)||0},t=e("producaoTotal"),a=(()=>{const e=document.querySelector('select[name="unidade"]');return e?e.value:"kg"})();let n=t;if("sc"===a&&(n=60*t),"t"===a&&(n=1e3*t),n<=0)return void(document.getElementById("siloDescontoResultado").style.display="none");const o=e("umidade"),i=e("umidadePadrao")||13,d=e("impureza"),r=e("ardidos"),s=e("esverdeados"),l=e("quebrados"),c=e("cpo"),p=e("precoBaseSaca"),u=o>i?(o-i)/(100-i):0,m=n*u,h=n*(d/100),f=Math.min(r+s+l+c,100),v=n*(f/100)*.5,b=m+h+v,g=Math.max(n-b,0),x=p>0?(n-g)/60*p:0,y=e=>(e/1e3).toFixed(2)+" t";document.getElementById("siloDescontoResultado").style.display="block",document.getElementById("siloPesoBruto").textContent=y(n),document.getElementById("siloDescUmidade").textContent=y(m)+` (${(100*u).toFixed(2)}%)`,document.getElementById("siloDescImpureza").textContent=y(h)+` (${d.toFixed(2)}%)`,document.getElementById("siloDescAvaria").textContent=y(v)+` (${f.toFixed(2)}% Ã— 50%)`,document.getElementById("siloPesoLiquido").textContent=y(g),document.getElementById("siloPerdaFinanceira").textContent=x>0?x.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"â€”"},window.__calcularFretes=()=>{const e=e=>{const t=document.querySelector(`input[name="${e}"]`);return t&&Number(t.value)||0},t=e=>{const t=document.querySelector(`input[name="${e}"]`);return t&&t.value||""},a=e("frete1_toneladas"),n=e("frete1_precoTon"),o=a*n,i=e("frete2_toneladas"),d=e("frete2_precoTon"),r=i*d,s=o+r,l=a+i,c=e=>e.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});document.getElementById("custoFrete1").textContent=c(o),document.getElementById("custoFrete2").textContent=c(r),document.getElementById("custoFreteTotalForm").textContent=c(s),document.getElementById("totalEntregueForm").textContent=num(l,2)+" t";const p=[];if(a>0){const i=t("frete1_armazem")||"Frete 1",d=e("frete1_distancia");p.push(`ğŸš› ${i}: ${num(a,2)}t Ã— ${c(n)}/t = ${c(o)}${d?` (${d}km)`:""}`)}if(i>0){const a=t("frete2_armazem")||"Frete 2",n=e("frete2_distancia");p.push(`ğŸšš ${a}: ${num(i,2)}t Ã— ${c(d)}/t = ${c(r)}${n?` (${n}km)`:""}`)}document.getElementById("detalheFretes").innerHTML=p.length?p.join("<br>"):"Preencha os dados de frete acima",document.getElementById("detalheViagens").textContent=l>0?l>0?num(l,2)+" toneladas transportadas":"":"â€”"},document.getElementById("btnAdicionarMaquina").addEventListener("click",()=>{const e=document.getElementById("maquinas-container"),t=document.createElement("div");t.className="maquina-linha",t.innerHTML=`\n      <select class="select" name="maquinaId[]">\n        <option value="">â€” MÃ¡quina â€”</option>\n        ${n.map(e=>`<option value="${e.id}">${escapeHtml(e.nome)}</option>`).join("")}\n      </select>\n      <input class="input" name="horas[]" type="number" step="0.5" placeholder="Horas trabalhadas">\n      <button type="button" class="btn-remove" onclick="window.__removerMaquina(this)" title="Remover">âœ•</button>`,e.appendChild(t)}),window.__removerMaquina=e=>{document.querySelectorAll(".maquina-linha").length<=1?toast("Aviso","Mantenha ao menos uma linha de mÃ¡quina."):e.closest(".maquina-linha").remove()},window.__delColheita=e=>{if(!confirm("Excluir este registro de colheita?"))return;const t=getDB();t.colheitas=(t.colheitas||[]).filter(t=>t.id!==e),setDB(t),toast("ExcluÃ­do","Registro de colheita removido"),pageColheitas()},document.getElementById("frmColheita").addEventListener("submit",e=>{e.preventDefault();const t=new FormData(e.target),a=t.get("talhaoId");if(!a)return void toast("Erro","Selecione um talhÃ£o");const n=Number(t.get("producaoTotal")||0);if(n<=0)return void toast("Erro","ProduÃ§Ã£o deve ser maior que 0");const o=t.getAll("maquinaId[]").filter(Boolean),i=t.getAll("horas[]").map(e=>Number(e)||0),d=o.map((e,t)=>({maquinaId:e,horas:i[t]})).filter(e=>e.maquinaId),r=e=>{const a=t.get(`${e}_armazem`)?.trim()||"",n=t.get(`${e}_cidade`)?.trim()||"",o=t.get(`${e}_placa`)?.trim()||"",i=t.get(`${e}_tipo_caminhao`)?.trim()||"",d=Number(t.get(`${e}_capacidade`)||0),r=t.get(`${e}_motorista`)?.trim()||"",s=t.get(`${e}_cnh`)?.trim()||"",l=t.get(`${e}_transportadora`)?.trim()||"",c=t.get(`${e}_cnpj_transp`)?.trim()||"",p=t.get(`${e}_nf_transp`)?.trim()||"",u=Number(t.get(`${e}_toneladas`)||0),m=Number(t.get(`${e}_precoTon`)||0),h=Number(t.get(`${e}_distancia`)||0),f=t.get(`${e}_data_entrega`)||"";return a||0!==u?{armazem:a,cidade:n,placa:o,tipoCaminhao:i,capacidade:d,motorista:r,cnh:s,transportadora:l,cnpjTransp:c,nfTransp:p,toneladas:u,precoTon:m,custoFrete:u*m,distancia:h,dataEntrega:f}:null},s=r("frete1"),l=r("frete2"),c=e=>t.get(e)?Number(t.get(e)):null,p=c("umidade"),u=c("umidadePadrao")||13,m=c("impureza"),h=c("ardidos"),f=c("esverdeados"),v=c("quebrados"),b=c("cpo"),g=c("taxaArmazenagem"),x=c("precoBaseSaca");let y=n;"sc"===t.get("unidade")&&(y=60*n),"t"===t.get("unidade")&&(y=1e3*n);const $=p&&p>u?(p-u)/(100-u):0,_=(h||0)+(f||0)+(v||0)+(b||0),k=Math.max(y*(1-$)-y*((m||0)/100)-y*(_/100)*.5,0),z={id:uid("col"),safraId:getSafraId(),dataColheita:t.get("dataColheita")||nowISO(),talhaoId:a,producaoTotal:n,unidade:t.get("unidade")||"kg",umidade:p,temperatura:c("temperatura"),romaneio:t.get("romaneio")?.trim()||"",observacoes:t.get("obs")?.trim()||"",maquinas:d,umidadePadrao:u,impureza:m,ardidos:h,esverdeados:f,quebrados:v,cpo:b,taxaArmazenagem:g,precoBaseSaca:x,pesoLiquidoEstimado:Math.round(k),frete1:s,frete2:l,fretes:[s,l].filter(Boolean)},F=getDB();F.colheitas=F.colheitas||[],F.colheitas.push(z),setDB(F);const E=(s?.custoFrete||0)+(l?.custoFrete||0);toast("âœ… Colheita registrada",`${num(n,0)} ${z.unidade}${E>0?` | Frete: ${kbrl(E)}`:""}`),pageColheitas()}),document.getElementById("btnExportCSV").addEventListener("click",()=>{const e=o.map(e=>{const a=[...e.fretes||[]];e.frete1&&!a.includes(e.frete1)&&a.push(e.frete1),e.frete2&&!a.includes(e.frete2)&&a.push(e.frete2);const n=a[0]||{},o=a[1]||{};return{Data:e.dataColheita||"","TalhÃ£o":findNameById(t,e.talhaoId),"ProduÃ§Ã£o":e.producaoTotal,Unidade:e.unidade,Umidade_pct:e.umidade||"",Umidade_Padrao_pct:e.umidadePadrao||"",Temperatura_C:e.temperatura||"",Impureza_pct:e.impureza||"",Ardidos_pct:e.ardidos||"",Esverdeados_pct:e.esverdeados||"",Quebrados_pct:e.quebrados||"",CPO_pct:e.cpo||"",Taxa_Armazenagem_pct:e.taxaArmazenagem||"",Preco_Base_Saca:e.precoBaseSaca||"",Peso_Liquido_Estimado_kg:e.pesoLiquidoEstimado||"",Romaneio_NF:e.romaneio||"",Frete1_Armazem:n.armazem||"",Frete1_Cidade:n.cidade||"",Frete1_Placa:n.placa||"",Frete1_Motorista:n.motorista||"",Frete1_Transportadora:n.transportadora||"",Frete1_NF_Transp:n.nfTransp||"",Frete1_Toneladas:n.toneladas||0,Frete1_Preco_Ton:n.precoTon||0,Frete1_Custo:n.custoFrete||0,Frete1_Distancia_km:n.distancia||"",Frete1_Data_Entrega:n.dataEntrega||"",Frete2_Armazem:o.armazem||"",Frete2_Cidade:o.cidade||"",Frete2_Placa:o.placa||"",Frete2_Motorista:o.motorista||"",Frete2_Transportadora:o.transportadora||"",Frete2_NF_Transp:o.nfTransp||"",Frete2_Toneladas:o.toneladas||0,Frete2_Preco_Ton:o.precoTon||0,Frete2_Custo:o.custoFrete||0,Frete2_Distancia_km:o.distancia||"",Frete2_Data_Entrega:o.dataEntrega||"",Custo_Frete_Total:(n.custoFrete||0)+(o.custoFrete||0),"ObservaÃ§Ãµes":e.observacoes||""}});downloadText(`colheitas-${nowISO()}.csv`,toCSV(e)),toast("ğŸ“¥ Exportado","CSV de colheitas baixado")}),document.getElementById("btnExportRelatorio").addEventListener("click",()=>{const i=e.parametros||{},d=Number(i.pesoPadraoSaca||60),l=`\n    <div class="pdf-kpi-grid">\n      <div class="pdf-kpi" style="border-left-color:#16a34a;"><div class="label">Producao Total</div><div class="value">${num(r/1e3,2)} t</div><div class="sub">${num(r,0)} kg colhidos</div></div>\n      <div class="pdf-kpi" style="border-left-color:#f59e0b;"><div class="label">Colheitas</div><div class="value">${o.length}</div><div class="sub">${t.length} talhoes ativos</div></div>\n      <div class="pdf-kpi" style="border-left-color:#3b82f6;"><div class="label">Frete Total</div><div class="value">${kbrl(s)}</div><div class="sub">${kbrl(p)}/ton | ${u} viagens</div></div>\n      <div class="pdf-kpi" style="border-left-color:#8b5cf6;"><div class="label">Toneladas Entregues</div><div class="value">${num(c,2)} t</div><div class="sub">em ${o.filter(e=>(e.fretes||[]).length>0||e.frete1||e.frete2).length} entregas</div></div>\n      <div class="pdf-kpi" style="border-left-color:#ec4899;"><div class="label">Umidade Media</div><div class="value">${m}${"-"!==m?"%":""}</div><div class="sub">media na colheita</div></div>\n      ${h>0?`<div class="pdf-kpi" style="border-left-color:#16a34a;"><div class="label">Peso Liquido Total</div><div class="value">${num(h/1e3,2)} t</div><div class="sub">apos descontos silo</div></div>`:""}\n    </div>`,v={};o.forEach(e=>{const a=t.find(t=>t.id===e.talhaoId),n=a?.cultura||"Sem cultura",o=Number(e.producaoTotal||0),i="sc"===e.unidade?o*d:"t"===e.unidade?1e3*o:o;v[n]||(v[n]={kg:0,colheitas:0,area:0}),v[n].kg+=i,v[n].colheitas++,a&&(v[n].area=Number(a.areaHa||0))});const b=Object.keys(v).length>0?`\n      <div class="pdf-section-title">Producao por Cultura</div>\n      <table>\n        <thead><tr><th>Cultura</th><th>Producao (t)</th><th>Producao (kg)</th><th>Colheitas</th><th>Produtividade (kg/ha)</th></tr></thead>\n        <tbody>\n          ${Object.entries(v).map(([e,t])=>`<tr>\n            <td><b>${escapeHtml(e)}</b></td>\n            <td style="text-align:right;">${num(t.kg/1e3,2)}</td>\n            <td style="text-align:right;">${num(t.kg,0)}</td>\n            <td style="text-align:center;">${t.colheitas}</td>\n            <td style="text-align:right;">${t.area>0?num(t.kg/t.area,0):"â€”"}</td>\n          </tr>`).join("")}\n        </tbody>\n      </table>`:"",g=o.map((e,a)=>{const o=[...e.fretes||[]];e.frete1&&!o.includes(e.frete1)&&o.push(e.frete1),e.frete2&&!o.includes(e.frete2)&&o.push(e.frete2);const i=o.reduce((e,t)=>e+Number(t.custoFrete||0),0),d=[e.impureza>0?`Imp:${e.impureza}%`:"",e.ardidos>0?`Ard:${e.ardidos}%`:"",e.esverdeados>0?`Esv:${e.esverdeados}%`:"",e.quebrados>0?`Qbr:${e.quebrados}%`:"",e.cpo>0?`CPO:${e.cpo}%`:""].filter(Boolean).join(", ")||"â€”",r=e.pesoLiquidoEstimado>0?`${(e.pesoLiquidoEstimado/1e3).toFixed(2)}t`:"â€”",s=(e.maquinas||[]).map(e=>{const t=n.find(t=>t.id===e.maquinaId);return t?`${t.nome}${e.horas?" ("+e.horas+"h)":""}`:""}).filter(Boolean).join(", "),l=o.map(e=>e.armazem?`${e.armazem} (${num(e.toneladas||0,2)}t)`:"").filter(Boolean).join(" / ")||"â€”";return`<tr>\n        <td style="text-align:center;">${a+1}</td>\n        <td>${e.dataColheita||"â€”"}</td>\n        <td><b>${escapeHtml(findNameById(t,e.talhaoId))}</b></td>\n        <td style="text-align:right;"><b>${num(e.producaoTotal||0,0)}</b> ${e.unidade||"kg"}</td>\n        <td>${e.umidade?e.umidade+"%":"â€”"}${e.umidadePadrao&&e.umidade>e.umidadePadrao?" (pad."+e.umidadePadrao+"%)":""}</td>\n        <td style="font-size:9px;">${d}</td>\n        <td class="text-green text-bold">${r}</td>\n        <td>${e.romaneio||"â€”"}</td>\n        <td style="font-size:9px;">${s||"â€”"}</td>\n        <td style="font-size:9px;">${l}</td>\n        <td style="text-align:right;" class="text-blue text-bold">${kbrl(i)}</td>\n        <td style="font-size:9px;">${e.observacoes||"â€”"}</td>\n      </tr>`}).join(""),x=o.map((e,o)=>{const i=t.find(t=>t.id===e.talhaoId),d=i?.nome||"â€”",r=i?findNameById(a,i.fazendaId):"â€”",s=[...e.fretes||[]];e.frete1&&!s.includes(e.frete1)&&s.push(e.frete1),e.frete2&&!s.includes(e.frete2)&&s.push(e.frete2);const l=s.reduce((e,t)=>e+Number(t.custoFrete||0),0),c=(e.maquinas||[]).map(e=>{const t=n.find(t=>t.id===e.maquinaId);return t?`${t.nome}${e.horas?" ("+e.horas+"h)":""}`:""}).filter(Boolean).join(", ")||"Nenhuma",p=s.length>0?s.map((e,t)=>`\n        <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:8px 10px; margin-top:6px;">\n          <div style="font-size:10px; font-weight:700; color:#1d4ed8; margin-bottom:4px;">Frete ${t+1}: ${escapeHtml(e.armazem||"â€”")}</div>\n          <div style="font-size:9px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:4px;">\n            <span>Cidade: ${escapeHtml(e.cidade||"â€”")}</span>\n            <span>Placa: ${e.placa||"â€”"}</span>\n            <span>Motorista: ${escapeHtml(e.motorista||"â€”")}</span>\n            <span>Transportadora: ${escapeHtml(e.transportadora||"â€”")}</span>\n            <span>Toneladas: ${num(e.toneladas||0,2)}</span>\n            <span>Preco/ton: ${kbrl(e.precoTon||0)}</span>\n            <span>Distancia: ${e.distancia?e.distancia+" km":"â€”"}</span>\n            <span>NF: ${e.nfTransp||"â€”"}</span>\n            <span style="font-weight:700; color:#1d4ed8;">Custo: ${kbrl(e.custoFrete||0)}</span>\n          </div>\n        </div>\n      `).join(""):'<div style="font-size:9px; color:#94a3b8;">Nenhum frete registrado</div>',u=e.impureza>0||e.ardidos>0||e.esverdeados>0||e.quebrados>0||e.cpo>0?`\n        <div style="margin-top:6px; font-size:9px; background:#fffbeb; border:1px solid #fde68a; border-radius:6px; padding:6px 8px;">\n          <b>Classificacao Silo:</b>\n          ${e.impureza>0?" Impureza: "+e.impureza+"%":""}\n          ${e.ardidos>0?" | Ardidos: "+e.ardidos+"%":""}\n          ${e.esverdeados>0?" | Esverdeados: "+e.esverdeados+"%":""}\n          ${e.quebrados>0?" | Quebrados: "+e.quebrados+"%":""}\n          ${e.cpo>0?" | CPO: "+e.cpo+"%":""}\n          ${e.pesoLiquidoEstimado>0?' | <b style="color:#16a34a;">Peso Liquido: '+num(e.pesoLiquidoEstimado/1e3,2)+"t</b>":""}\n        </div>`:"";return`\n      <div style="border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px; overflow:hidden; page-break-inside:avoid;">\n        <div style="background:linear-gradient(135deg,#0f2847,#1e3a5f); color:white; padding:8px 12px; display:flex; justify-content:space-between; align-items:center;">\n          <div><b>#${o+1}</b> â€” ${escapeHtml(d)} (${escapeHtml(i?.cultura||"â€”")})</div>\n          <div style="font-size:10px; opacity:.8;">${e.dataColheita||"â€”"} | ${escapeHtml(r)}</div>\n        </div>\n        <div style="padding:10px 12px; font-size:10px;">\n          <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:8px;">\n            <div><span style="color:#64748b;">Producao:</span><br><b>${num(e.producaoTotal||0,2)} ${e.unidade||"kg"}</b></div>\n            <div><span style="color:#64748b;">Umidade:</span><br><b>${e.umidade?e.umidade+"%":"â€”"}</b>${e.umidadePadrao?" (pad. "+e.umidadePadrao+"%)":""}</div>\n            <div><span style="color:#64748b;">Romaneio/NF:</span><br><b>${e.romaneio||"â€”"}</b></div>\n            <div><span style="color:#64748b;">Maquinas:</span><br>${c}</div>\n          </div>\n          ${u}\n          <div style="margin-top:6px;">\n            <div style="font-size:10px; font-weight:700; color:#475569; margin-bottom:4px;">Transporte / Frete (Custo: <span style="color:#1d4ed8;">${kbrl(l)}</span>)</div>\n            ${p}\n          </div>\n          ${e.observacoes?'<div style="margin-top:6px; font-size:9px; color:#64748b;"><i>Obs: '+escapeHtml(e.observacoes)+"</i></div>":""}\n        </div>\n      </div>`}).join(""),y=t.map(e=>{const t=f.get(e.id)||0,n=Number(e.areaHa||0),i=o.filter(t=>t.talhaoId===e.id).reduce((e,t)=>{const a=Number(t.producaoTotal||0);return e+("sc"===t.unidade?a*d:"t"===t.unidade?1e3*a:a)},0),r=i/1e3;return`<tr>\n        <td><b>${escapeHtml(e.nome)}</b></td>\n        <td>${escapeHtml(findNameById(a,e.fazendaId))}</td>\n        <td>${escapeHtml(e.cultura||"â€”")}</td>\n        <td style="text-align:right;">${num(n,1)}</td>\n        <td style="text-align:right;">${num(r,2)} t</td>\n        <td style="text-align:right;">${n>0?num(i/n,0)+" kg/ha":"â€”"}</td>\n        <td style="text-align:right;" class="text-bold">${kbrl(t)}</td>\n        <td style="text-align:right;">${n>0?kbrl(t/n):"â€”"}</td>\n        <td style="text-align:right;">${r>0?kbrl(t/r):"â€”"}</td>\n      </tr>`}).join(""),$=`\n      ${l}\n\n      ${b}\n\n      <div class="pdf-section-title">Detalhamento das Colheitas</div>\n      <table>\n        <thead><tr>\n          <th>#</th><th>Data</th><th>Talhao</th><th>Producao</th><th>Umid.</th><th>Classificacao</th><th>Peso Liq.</th><th>Romaneio</th><th>Maquinas</th><th>Armazens</th><th>Frete</th><th>Obs.</th>\n        </tr></thead>\n        <tbody>${g||'<tr><td colspan="12">Nenhuma colheita registrada</td></tr>'}</tbody>\n        <tr class="total-row">\n          <td colspan="3"><b>TOTAL</b></td>\n          <td style="text-align:right;"><b>${num(r/1e3,2)} t</b></td>\n          <td>${"-"!==m?m+"%":"â€”"}</td>\n          <td colspan="2">${h>0?"Liq: "+num(h/1e3,2)+"t":""}</td>\n          <td colspan="3"></td>\n          <td style="text-align:right;" class="text-blue"><b>${kbrl(s)}</b></td>\n          <td></td>\n        </tr>\n      </table>\n\n      <div class="pdf-section-title" style="page-break-before:always;">Fichas Detalhadas por Colheita</div>\n      ${x||'<p style="color:#94a3b8;">Nenhuma colheita registrada nesta safra.</p>'}\n\n      <div class="pdf-section-title" style="page-break-before:always;">Custo de Frete por Talhao</div>\n      <table>\n        <thead><tr><th>Talhao</th><th>Fazenda</th><th>Cultura</th><th>Area (ha)</th><th>Producao</th><th>Produtividade</th><th>Frete</th><th>Frete/ha</th><th>Frete/ton</th></tr></thead>\n        <tbody>${y}</tbody>\n        <tr class="total-row">\n          <td colspan="4"><b>TOTAL</b></td>\n          <td style="text-align:right;"><b>${num(r/1e3,2)} t</b></td>\n          <td></td>\n          <td style="text-align:right;" class="text-blue"><b>${kbrl(s)}</b></td>\n          <td colspan="2"></td>\n        </tr>\n      </table>\n    `;gerarPDF({titulo:"Relatorio de Colheitas",subtitulo:"Detalhado â€” Classificacao, Frete, Armazens e Fichas Individuais",conteudoHTML:$,orientacao:"landscape"})}),function(){const e=getDB();let a=onlySafra(e.colheitas||[]).sort((e,t)=>(t.dataColheita||"").localeCompare(e.dataColheita||""));if(fazendaAtual){const t=onlySafra(e.talhoes||[]).filter(e=>e.fazendaId===fazendaAtual).map(e=>e.id);a=a.filter(e=>t.includes(e.talhaoId))}const o=document.getElementById("tbodyColheitas");o&&(o.innerHTML=a.map(e=>{const a=findNameById(t,e.talhaoId),o=[...e.fretes||[]];e.frete1&&o.push(e.frete1),e.frete2&&o.push(e.frete2);const i=o.reduce((e,t)=>e+Number(t.custoFrete||0),0),d=e=>{if(!e||!e.armazem)return"â€”";const t=e.placa?`<span class="truck-badge">ğŸš› ${e.placa}</span><br>`:"",a=e.motorista?`ğŸ‘¤ ${escapeHtml(e.motorista)}<br>`:"",n=e.nfTransp?`ğŸ“„ NF: ${e.nfTransp}<br>`:"";return`<b>${escapeHtml(e.armazem)}</b><br>\n          ${escapeHtml(e.cidade||"")}<br>\n          ${t}${a}${n}\n          ${num(e.toneladas||0,2)} t Ã— ${kbrl(e.precoTon||0)}/t<br>\n          <b style="color:#1d4ed8;">${kbrl(e.custoFrete||0)}</b>`},r=d(o[0]),s=o[1]?d(o[1]):"â€”",l=(e.maquinas||[]).map(e=>{const t=n.find(t=>t.id===e.maquinaId);return t?`${t.nome}${e.horas?` (${e.horas}h)`:""}`:""}).filter(Boolean).join(", ");return`<tr>\n        <td>${e.dataColheita||"â€”"}</td>\n        <td><b>${escapeHtml(a)}</b>${l?`<br><span style="font-size:11px;color:#64748b;">${escapeHtml(l)}</span>`:""}</td>\n        <td><b>${num(e.producaoTotal||0,0)}</b> ${e.unidade||"kg"}${e.temperatura?`<br><span style='font-size:11px;'>ğŸŒ¡ ${e.temperatura}Â°C</span>`:""}${e.pesoLiquidoEstimado>0?`<br><span style='font-size:11px;color:#16a34a;'>ğŸ’§ Liq: ${(e.pesoLiquidoEstimado/1e3).toFixed(2)}t</span>`:""}</td>\n        <td>${e.umidade?`<b>${e.umidade}%</b>${e.umidadePadrao&&e.umidade>e.umidadePadrao?`<br><span style="font-size:10px;color:#ef4444;">â–² pad. ${e.umidadePadrao}%</span>`:""}`:"â€”"}</td>\n        <td style="font-size:11px;">${[e.impureza>0?`Imp: ${e.impureza}%`:"",e.ardidos>0?`Ard: ${e.ardidos}%`:"",e.esverdeados>0?`Esv: ${e.esverdeados}%`:"",e.quebrados>0?`Qbr: ${e.quebrados}%`:"",e.cpo>0?`CPO: ${e.cpo}%`:""].filter(Boolean).join(" | ")||(e.romaneio?`ğŸ“„ ${escapeHtml(e.romaneio)}`:"â€”")}</td>\n        <td style="font-size:12px;">${r}</td>\n        <td style="font-size:12px;">${s}</td>\n        <td><b style="color:#b45309;font-size:15px;">${kbrl(i)}</b></td>\n        <td class="noPrint">\n          <button class="btn danger" style="font-size:12px; padding:5px 10px;" onclick="window.__delColheita('${e.id}')">Excluir</button>\n        </td>\n      </tr>`}).join("")||'<tr><td colspan="9" style="text-align:center; padding:30px; color:#94a3b8;">Nenhuma colheita registrada nesta safra</td></tr>')}()}