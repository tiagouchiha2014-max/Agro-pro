function pageInsumosBase(){const n=getDB();let t=onlySafra(n.talhoes);fazendaAtual&&(t=t.filter(n=>n.fazendaId===fazendaAtual));const o=onlySafra(n.fazendas),e=onlySafra(n.produtos),a=onlySafra(n.insumosBase||[]).sort((n,t)=>(t.data||"").localeCompare(n.data||""));setTopActions('\n    <button class="btn" id="btnExportCSV">üì• Exportar CSV</button>\n  ');const s=t.reduce((n,t)=>n+Number(t.areaHa||0),0),i=a.reduce((n,t)=>n+Number(t.custoTotal||0),0),d=s>0?i/s:0,l=new Map;a.forEach(n=>{const t=l.get(n.talhaoId)||{custo:0,qtd:0};t.custo+=Number(n.custoTotal||0),t.qtd+=1,l.set(n.talhaoId,t)});const u={};function r(){return e.map(n=>`<option value="${n.id}" data-preco="${n.preco||0}" data-unidade="${n.unidade}">${escapeHtml(n.nome)} ‚Äî ${escapeHtml(n.tipo)} (R$ ${n.preco||0}/${n.unidade})</option>`).join("")}a.forEach(n=>{const t=n.tipoInsumo||"Outros";u[t]=(u[t]||0)+Number(n.custoTotal||0)}),document.getElementById("content").innerHTML=`\n    <style>\n      .insumo-kpi-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n        gap: 15px;\n        margin-bottom: 20px;\n      }\n      .insumo-kpi-card {\n        background: #ffffff;\n        border-radius: 12px;\n        padding: 20px;\n        border-left: 4px solid #10b981;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.05);\n      }\n      .insumo-kpi-card h3 {\n        margin: 0 0 10px 0;\n        color: #10b981;\n        font-size: 16px;\n      }\n      .insumo-kpi-valor {\n        font-size: 32px;\n        font-weight: 700;\n        color: #0f172a;\n      }\n      .insumo-kpi-label {\n        color: #475569;\n        font-size: 12px;\n        margin-top: 5px;\n      }\n      .insumo-linha {\n        display: grid;\n        grid-template-columns: 3fr 1fr 1fr 1fr 0.3fr;\n        gap: 10px;\n        margin-bottom: 8px;\n        align-items: center;\n      }\n    </style>\n\n    \x3c!-- KPIs --\x3e\n    <div class="insumo-kpi-grid">\n      <div class="insumo-kpi-card">\n        <h3>üå± Total Lan√ßamentos</h3>\n        <div class="insumo-kpi-valor">${a.length}</div>\n        <div class="insumo-kpi-label">registros de insumos base</div>\n      </div>\n      <div class="insumo-kpi-card">\n        <h3>üí∞ Custo Total</h3>\n        <div class="insumo-kpi-valor">${kbrl(i)}</div>\n        <div class="insumo-kpi-label">em insumos base</div>\n      </div>\n      <div class="insumo-kpi-card">\n        <h3>üìè Custo/ha</h3>\n        <div class="insumo-kpi-valor">${kbrl(d)}</div>\n        <div class="insumo-kpi-label">sobre ${num(s,1)} ha</div>\n      </div>\n      <div class="insumo-kpi-card">\n        <h3>üß≠ Talh√µes Atendidos</h3>\n        <div class="insumo-kpi-valor">${l.size}</div>\n        <div class="insumo-kpi-label">de ${t.length} talh√µes</div>\n      </div>\n    </div>\n\n    \x3c!-- Formul√°rio --\x3e\n    <div class="card" style="margin-bottom:20px;">\n      <h3>üå± Lan√ßar Insumo Base por Talh√£o</h3>\n      <div class="help">Registre aduba√ß√£o, calc√°rio, gesso, sementes e outros insumos de base aplicados por talh√£o. O custo ser√° somado ao custo total do talh√£o.</div>\n      <div class="hr"></div>\n      <form id="frmInsumoBase" class="formGrid">\n        <div><small>üìÖ Data</small><input class="input" name="data" type="date" value="${nowISO()}" required></div>\n        <div><small>üß≠ Talh√£o</small>\n          <select class="select" name="talhaoId" required>\n            <option value="">Selecione...</option>\n            ${t.map(n=>`<option value="${n.id}">${escapeHtml(n.nome)} (${n.cultura||"-"}) ‚Äî ${num(n.areaHa,1)} ha</option>`).join("")}\n          </select>\n        </div>\n        <div><small>üì¶ Tipo de Insumo</small>\n          <select class="select" name="tipoInsumo" required>\n            <option value="Adubo">Adubo</option>\n            <option value="Calc√°rio">Calc√°rio</option>\n            <option value="Gesso">Gesso</option>\n            <option value="Semente">Semente</option>\n            <option value="Tratamento de Semente">Tratamento de Semente</option>\n            <option value="Inoculante">Inoculante</option>\n            <option value="Outro">Outro</option>\n          </select>\n        </div>\n        <div><small>üìã Opera√ß√£o</small><input class="input" name="operacao" placeholder="Ex: Aduba√ß√£o de base, Calagem..."></div>\n\n        <div class="full">\n          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">\n            <h4 style="margin:0;">üß™ Produtos/Insumos Utilizados</h4>\n            <button type="button" class="btn primary" id="btnAdicionarInsumo" style="font-size:12px;">+ Adicionar produto</button>\n          </div>\n          <div class="help">Selecione o produto do cadastro ou digite manualmente. Informe a dose por hectare.</div>\n          <div class="hr"></div>\n          <div id="insumos-container">\n            <div class="insumo-linha">\n              <select class="select" name="produtoId[]" onchange="window.__atualizarInsumo(this, 0)">\n                <option value="">Selecione um produto...</option>\n                <option value="__manual">Digitar manualmente...</option>\n                ${r()}\n              </select>\n              <input class="input" name="doseHa[]" type="number" step="0.01" placeholder="Dose/ha" onchange="window.__calcularCustoInsumos()">\n              <input class="input" name="precoManual[]" type="number" step="0.01" placeholder="Pre√ßo unit." onchange="window.__calcularCustoInsumos()">\n              <span class="badge" id="custoInsumo-0" style="background:#2a2a30; color:#10b981; padding:8px; text-align:center; font-weight:bold;">R$ 0,00</span>\n              <button type="button" class="btn danger" style="padding:6px;" onclick="window.__removerInsumo(this)">‚úï</button>\n            </div>\n          </div>\n        </div>\n\n        <div class="full"><small>üìù Observa√ß√µes</small><textarea class="textarea" name="obs"></textarea></div>\n\n        <div class="full" style="margin-top:15px;">\n          <div style="background: linear-gradient(135deg, #064e3b, #0f1a24); padding:20px; border-radius:8px;">\n            <div style="display:flex; justify-content:space-between; align-items:center;">\n              <div>\n                <h4 style="margin:0; color:#888;">üíµ CUSTO TOTAL DO LAN√áAMENTO</h4>\n                <div style="font-size:32px; font-weight:bold; color:#10b981;" id="custoInsumoDisplay">R$ 0,00</div>\n                <div style="font-size:12px; color:#888; margin-top:5px;" id="detalheInsumo">Nenhum produto selecionado</div>\n              </div>\n              <button class="btn primary" type="submit" style="font-size:16px; padding:12px 24px;">‚úÖ Salvar Lan√ßamento</button>\n            </div>\n          </div>\n        </div>\n      </form>\n    </div>\n\n    \x3c!-- Custo por talh√£o --\x3e\n    <div class="card" style="margin-bottom:20px;">\n      <h3>üß≠ Custo de Insumos Base por Talh√£o</h3>\n      <div class="tableWrap">\n        <table>\n          <thead><tr><th>Talh√£o</th><th>Fazenda</th><th>Cultura</th><th>√Årea (ha)</th><th>Lan√ßamentos</th><th>Custo Total</th><th>Custo/ha</th></tr></thead>\n          <tbody>\n            ${t.map(n=>{const t=l.get(n.id)||{custo:0,qtd:0},e=Number(n.areaHa||0)>0?t.custo/n.areaHa:0;return`<tr>\n                <td><b>${escapeHtml(n.nome)}</b></td>\n                <td>${escapeHtml(findNameById(o,n.fazendaId))}</td>\n                <td>${escapeHtml(n.cultura||"-")}</td>\n                <td>${num(n.areaHa,1)}</td>\n                <td>${t.qtd}</td>\n                <td><b>${kbrl(t.custo)}</b></td>\n                <td>${kbrl(e)}</td>\n              </tr>`}).join("")}\n          </tbody>\n        </table>\n      </div>\n    </div>\n\n    \x3c!-- Custo por tipo --\x3e\n    <div class="card" style="margin-bottom:20px;">\n      <h3>üìä Custo por Tipo de Insumo</h3>\n      <div class="tableWrap">\n        <table>\n          <thead><tr><th>Tipo</th><th>Custo Total</th><th>% do Total</th></tr></thead>\n          <tbody>\n            ${Object.entries(u).sort((n,t)=>t[1]-n[1]).map(([n,t])=>`\n              <tr>\n                <td><b>${escapeHtml(n)}</b></td>\n                <td>${kbrl(t)}</td>\n                <td>${i>0?num(t/i*100,1):0}%</td>\n              </tr>\n            `).join("")}\n          </tbody>\n        </table>\n      </div>\n    </div>\n\n    \x3c!-- Hist√≥rico --\x3e\n    <div class="card">\n      <h3>üìã Hist√≥rico de Lan√ßamentos</h3>\n      <div class="tableWrap">\n        <table>\n          <thead>\n            <tr>\n              <th>Data</th>\n              <th>Talh√£o</th>\n              <th>Tipo</th>\n              <th>Produtos</th>\n              <th>Custo Total</th>\n              <th class="noPrint">A√ß√µes</th>\n            </tr>\n          </thead>\n          <tbody id="tbodyInsumos"></tbody>\n        </table>\n      </div>\n    </div>\n  `;let c=1;document.getElementById("btnAdicionarInsumo").addEventListener("click",()=>{const n=document.getElementById("insumos-container"),t=document.createElement("div");t.className="insumo-linha",t.innerHTML=`\n      <select class="select" name="produtoId[]" onchange="window.__atualizarInsumo(this, ${c})">\n        <option value="">Selecione um produto...</option>\n        <option value="__manual">Digitar manualmente...</option>\n        ${r()}\n      </select>\n      <input class="input" name="doseHa[]" type="number" step="0.01" placeholder="Dose/ha" onchange="window.__calcularCustoInsumos()">\n      <input class="input" name="precoManual[]" type="number" step="0.01" placeholder="Pre√ßo unit." onchange="window.__calcularCustoInsumos()">\n      <span class="badge" id="custoInsumo-${c}" style="background:#2a2a30; color:#10b981; padding:8px; text-align:center; font-weight:bold;">R$ 0,00</span>\n      <button type="button" class="btn danger" style="padding:6px;" onclick="window.__removerInsumo(this)">‚úï</button>\n    `,n.appendChild(t),c++}),window.__removerInsumo=n=>{document.querySelectorAll(".insumo-linha").length<=1||(n.closest(".insumo-linha").remove(),window.__calcularCustoInsumos())},window.__atualizarInsumo=(n,t)=>{const o=n.options[n.selectedIndex],e=n.closest(".insumo-linha").querySelector('input[name="precoManual[]"]');n.value&&"__manual"!==n.value?e.value=o.dataset.preco||0:e.value="",window.__calcularCustoInsumos()},window.__calcularCustoInsumos=()=>{const n=document.querySelector('select[name="talhaoId"]').value,o=t.find(t=>t.id===n),e=o?Number(o.areaHa||0):0;let a=0,s=[];return document.querySelectorAll(".insumo-linha").forEach((n,t)=>{const o=n.querySelector('select[name="produtoId[]"]'),i=Number(n.querySelector('input[name="doseHa[]"]').value)||0,d=Number(n.querySelector('input[name="precoManual[]"]').value)||0;if(i>0&&d>0&&e>0){const l=d*i*e;a+=l;const u=n.querySelector(`#custoInsumo-${t}`);u&&(u.innerText=kbrl(l));const r="__manual"===o.value?"Manual":o.options[o.selectedIndex]?.text?.split(" ‚Äî ")[0]||"Produto";s.push(`${r}: ${num(i,2)} √ó ${num(e,1)} ha = ${kbrl(l)}`)}}),document.getElementById("custoInsumoDisplay").innerText=kbrl(a),document.getElementById("detalheInsumo").innerHTML=s.length>0?s.join("<br>"):"Nenhum produto selecionado",a},document.querySelector('select[name="talhaoId"]').addEventListener("change",window.__calcularCustoInsumos),window.__delInsumoBase=n=>{if(!confirm("Excluir este lan√ßamento?"))return;const t=getDB();t.insumosBase=(t.insumosBase||[]).filter(t=>t.id!==n),setDB(t),toast("Exclu√≠do","Lan√ßamento removido."),pageInsumosBase()},document.getElementById("frmInsumoBase").addEventListener("submit",n=>{n.preventDefault();const o=new FormData(n.target),a=o.get("talhaoId");if(!a)return void alert("Selecione um talh√£o");const s=t.find(n=>n.id===a),i=s?Number(s.areaHa||0):0,d=o.getAll("produtoId[]"),l=o.getAll("doseHa[]"),u=o.getAll("precoManual[]"),r=[];let c=0;for(let n=0;n<d.length;n++){const t=Number(l[n])||0,o=Number(u[n])||0;if(t>0&&o>0){let a="Manual",s="un";if(d[n]&&"__manual"!==d[n]){const t=e.find(t=>t.id===d[n]);t&&(a=t.nome,s=t.unidade)}const l=o*t*i;c+=l,r.push({produtoId:"__manual"!==d[n]?d[n]:"",nome:a,doseHa:t,preco:o,unidade:s,custoLinha:l})}}if(0===r.length)return void alert("Adicione pelo menos um produto com dose e pre√ßo v√°lidos");const m={id:uid("inb"),safraId:getSafraId(),data:o.get("data")||nowISO(),talhaoId:a,tipoInsumo:o.get("tipoInsumo"),operacao:o.get("operacao")||"",produtos:r,custoTotal:c,areaHa:i,obs:o.get("obs")||""},p=getDB();p.insumosBase=p.insumosBase||[],p.insumosBase.push(m);for(const n of r)if(n.produtoId){const t=n.doseHa*i;baixaEstoqueProdutoPorId(p,n.produtoId,t,n.unidade)}setDB(p),toast("Insumo Base registrado",`Custo: ${kbrl(c)}`),pageInsumosBase()}),document.getElementById("btnExportCSV").addEventListener("click",()=>{const n=a.map(n=>{const o=findNameById(t,n.talhaoId);return{Data:n.data,"Talh√£o":o,Tipo:n.tipoInsumo,"Opera√ß√£o":n.operacao,Produtos:(n.produtos||[]).map(n=>n.nome).join("; "),"√Årea_ha":n.areaHa,Custo_Total:n.custoTotal,"Observa√ß√µes":n.obs}});downloadText(`insumos-base-${nowISO()}.csv`,toCSV(n)),toast("Exportado","CSV baixado.")}),function(){const n=getDB();let o=onlySafra(n.insumosBase||[]).sort((n,t)=>(t.data||"").localeCompare(n.data||""));if(fazendaAtual){const t=onlySafra(n.talhoes||[]).filter(n=>n.fazendaId===fazendaAtual).map(n=>n.id);o=o.filter(n=>t.includes(n.talhaoId))}document.getElementById("tbodyInsumos").innerHTML=o.map(n=>{const o=findNameById(t,n.talhaoId),e=(n.produtos||[]).map(n=>n.nome).join(", ");return`<tr>\n        <td>${n.data}</td>\n        <td><b>${escapeHtml(o)}</b></td>\n        <td>${escapeHtml(n.tipoInsumo)}</td>\n        <td>${escapeHtml(clampStr(e||"-",50))}</td>\n        <td><b>${kbrl(n.custoTotal)}</b></td>\n        <td class="noPrint"><button class="btn danger" onclick="window.__delInsumoBase('${n.id}')">Excluir</button></td>\n      </tr>`}).join("")||'<tr><td colspan="6">Nenhum lan√ßamento registrado.</td></tr>'}()}