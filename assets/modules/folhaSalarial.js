function pageFolhaSalarial(){const e=getDB(),a=getSafraId();let n=onlySafra(e.equipe||[]);fazendaAtual&&(n=n.filter(e=>!e.fazendaId||e.fazendaId===fazendaAtual));const t=onlySafra(e.folhaSalarial||[]).sort((e,a)=>(a.competencia||"").localeCompare(e.competencia||""));setTopActions('\n    <button class="btn" id="btnExportFolhaCSV">üì• CSV</button>\n    <button class="btn primary noPrint" id="btnImprimirFolha">üñ®Ô∏è Imprimir</button>\n  ');const o=t[0]?.competencia?.substring(0,7)||"",s=o?t.filter(e=>(e.competencia||"").startsWith(o)):t,l=s.reduce((e,a)=>e+Number(a.salarioBruto||0),0),i=s.reduce((e,a)=>e+Number(a.totalDescontos||0),0),r=s.reduce((e,a)=>e+Number(a.salarioLiquido||0),0),d=s.reduce((e,a)=>e+Number(a.horasExtras||0),0),c=new Set(s.map(e=>e.funcionarioId)).size;document.getElementById("content").innerHTML=`\n    <style>\n      .fs-kpi-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n        gap: 14px;\n        margin-bottom: 24px;\n      }\n      .fs-kpi {\n        background: white;\n        border-radius: 12px;\n        padding: 18px 20px;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.07);\n        border-left: 4px solid #10b981;\n      }\n      .fs-kpi.vermelho { border-color: #ef4444; }\n      .fs-kpi.azul    { border-color: #3b82f6; }\n      .fs-kpi.amarelo { border-color: #f59e0b; }\n      .fs-kpi.roxo    { border-color: #8b5cf6; }\n      .fs-kpi .label  { font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600; margin-bottom: 6px; }\n      .fs-kpi .value  { font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1.1; }\n      .fs-kpi .sub    { font-size: 11px; color: #94a3b8; margin-top: 4px; }\n\n      .fs-section { margin-bottom: 28px; }\n\n      .fs-form-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n        gap: 12px;\n      }\n      .fs-form-grid .full { grid-column: 1 / -1; }\n\n      .fs-table-wrap { overflow-x: auto; }\n      .fs-table { width: 100%; border-collapse: collapse; font-size: 13px; }\n      .fs-table th {\n        background: #f1f5f9;\n        padding: 10px 12px;\n        text-align: left;\n        font-weight: 600;\n        color: #475569;\n        border-bottom: 2px solid #e2e8f0;\n        white-space: nowrap;\n      }\n      .fs-table td {\n        padding: 10px 12px;\n        border-bottom: 1px solid #f1f5f9;\n        color: #334155;\n        vertical-align: middle;\n      }\n      .fs-table tr:hover td { background: #f8fafc; }\n      .fs-badge {\n        display: inline-block;\n        padding: 2px 8px;\n        border-radius: 20px;\n        font-size: 11px;\n        font-weight: 600;\n      }\n      .badge-pago    { background: #dcfce7; color: #166534; }\n      .badge-pendente{ background: #fef3c7; color: #92400e; }\n      .badge-adiantamento { background: #dbeafe; color: #1e40af; }\n\n      .desconto-line {\n        display: grid;\n        grid-template-columns: 2fr 2fr 1fr 0.3fr;\n        gap: 10px;\n        margin-bottom: 8px;\n        align-items: center;\n      }\n      .valor-destaque { font-weight: 700; color: #10b981; }\n      .valor-desconto { font-weight: 700; color: #ef4444; }\n\n      .comp-group { margin-bottom: 20px; }\n      .comp-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        background: #f1f5f9;\n        padding: 10px 16px;\n        border-radius: 8px;\n        margin-bottom: 8px;\n        font-weight: 600;\n        color: #334155;\n        font-size: 13px;\n      }\n      @media print {\n        .noPrint, button, .noPrint * { display: none !important; }\n        .card { box-shadow: none !important; border: 1px solid #ddd !important; }\n        body { font-size: 12px; }\n        .fs-kpi .value { font-size: 20px; }\n      }\n    </style>\n\n    \x3c!-- KPIs --\x3e\n    <div class="fs-kpi-grid">\n      <div class="fs-kpi">\n        <div class="label">üë∑ Funcion√°rios</div>\n        <div class="value">${c||n.length}</div>\n        <div class="sub">na safra atual</div>\n      </div>\n      <div class="fs-kpi azul">\n        <div class="label">üí∞ Total Bruto</div>\n        <div class="value">${brl(l)}</div>\n        <div class="sub">${o?"m√™s "+_formatCompetencia(o):"geral"}</div>\n      </div>\n      <div class="fs-kpi vermelho">\n        <div class="label">‚ûñ Descontos</div>\n        <div class="value">${brl(i)}</div>\n        <div class="sub">INSS + outros</div>\n      </div>\n      <div class="fs-kpi">\n        <div class="label">‚úÖ Total L√≠quido</div>\n        <div class="value">${brl(r)}</div>\n        <div class="sub">a pagar</div>\n      </div>\n      <div class="fs-kpi amarelo">\n        <div class="label">‚è±Ô∏è Horas Extras</div>\n        <div class="value">${num(d)} h</div>\n        <div class="sub">no per√≠odo</div>\n      </div>\n    </div>\n\n    \x3c!-- FORMUL√ÅRIO --\x3e\n    <div class="card fs-section noPrint">\n      <h3 style="margin:0 0 18px; font-size:16px; color:#0f172a;">üìù Lan√ßar Folha Salarial</h3>\n\n      <div class="fs-form-grid" style="margin-bottom:12px;">\n        <div>\n          <small class="form-label">Funcion√°rio *</small>\n          <select class="select" id="fsFuncionario">\n            <option value="">‚Äî Selecione ‚Äî</option>\n            ${n.map(e=>`<option value="${e.id}">${escapeHtml(e.nome)} ‚Äî ${escapeHtml(e.funcao||"Sem fun√ß√£o")}</option>`).join("")}\n          </select>\n        </div>\n        <div>\n          <small class="form-label">Compet√™ncia (M√™s/Ano) *</small>\n          <input class="input" type="month" id="fsCompetencia" value="${_getMesAtual()}" />\n        </div>\n        <div>\n          <small class="form-label">Sal√°rio Base (R$) *</small>\n          <input class="input" type="number" id="fsSalarioBase" placeholder="1412.00" min="0" step="0.01" />\n        </div>\n        <div>\n          <small class="form-label">Dias Trabalhados</small>\n          <input class="input" type="number" id="fsDiasTrabalhados" placeholder="30" min="0" max="31" value="30" />\n        </div>\n        <div>\n          <small class="form-label">Horas Extras (h)</small>\n          <input class="input" type="number" id="fsHorasExtras" placeholder="0" min="0" step="0.5" value="0" />\n        </div>\n        <div>\n          <small class="form-label">Valor Hora Extra (R$)</small>\n          <input class="input" type="number" id="fsValorHoraExtra" placeholder="0.00" min="0" step="0.01" value="0" />\n        </div>\n        <div>\n          <small class="form-label">Adiantamento (R$)</small>\n          <input class="input" type="number" id="fsAdiantamento" placeholder="0.00" min="0" step="0.01" value="0" />\n        </div>\n        <div>\n          <small class="form-label">Vale Transporte (R$)</small>\n          <input class="input" type="number" id="fsValeTransporte" placeholder="0.00" min="0" step="0.01" value="0" />\n        </div>\n        <div>\n          <small class="form-label">Vale Alimenta√ß√£o (R$)</small>\n          <input class="input" type="number" id="fsValeAlimentacao" placeholder="0.00" min="0" step="0.01" value="0" />\n        </div>\n        <div>\n          <small class="form-label">Outros Benef√≠cios (R$)</small>\n          <input class="input" type="number" id="fsOutrosBeneficios" placeholder="0.00" min="0" step="0.01" value="0" />\n        </div>\n        <div>\n          <small class="form-label">Status de Pagamento</small>\n          <select class="select" id="fsStatus">\n            <option value="pendente">Pendente</option>\n            <option value="pago">Pago</option>\n            <option value="adiantamento">Adiantamento</option>\n          </select>\n        </div>\n        <div>\n          <small class="form-label">Data de Pagamento</small>\n          <input class="input" type="date" id="fsDataPagamento" />\n        </div>\n      </div>\n\n      \x3c!-- Descontos Extras --\x3e\n      <div style="margin-bottom:16px;">\n        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">\n          <small class="form-label" style="margin:0; font-size:13px; font-weight:700;">‚ûñ Descontos Extras (INSS calculado automaticamente)</small>\n          <button class="btn" style="padding:4px 10px; font-size:12px;" id="btnAddDesconto">+ Adicionar</button>\n        </div>\n        <div id="descontosContainer"></div>\n      </div>\n\n      \x3c!-- Observa√ß√µes --\x3e\n      <div style="margin-bottom:16px;">\n        <small class="form-label">Observa√ß√µes</small>\n        <textarea class="input" id="fsObs" rows="2" placeholder="Ex: pagamento em conta, pix, dinheiro..."></textarea>\n      </div>\n\n      \x3c!-- Resumo ao vivo --\x3e\n      <div id="fsResumoLive" style="background:#f0fdf4; border:1px solid #86efac; border-radius:8px; padding:14px; margin-bottom:16px; display:none;">\n        <strong style="font-size:13px; color:#166534;">üìä Resumo calculado:</strong>\n        <div id="fsResumoTexto" style="font-size:13px; color:#334155; margin-top:8px;"></div>\n      </div>\n\n      <div style="display:flex; gap:10px; flex-wrap:wrap;">\n        <button class="btn primary" id="btnSalvarFolha" style="min-width:160px;">üíæ Salvar Folha</button>\n        <button class="btn" id="btnLimparFolha">üîÑ Limpar</button>\n        <button class="btn" id="btnCalcularFolha">üßÆ Calcular</button>\n      </div>\n    </div>\n\n    \x3c!-- TABELA POR COMPET√äNCIA --\x3e\n    <div class="card fs-section">\n      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:10px;">\n        <h3 style="margin:0; font-size:16px; color:#0f172a;">üìã Hist√≥rico de Folhas</h3>\n        <div style="display:flex; gap:8px; flex-wrap:wrap;">\n          <input class="input" type="month" id="fsFiltroMes" style="width:160px;" placeholder="Filtrar m√™s" />\n          <select class="select" id="fsFiltroFuncionario" style="width:180px;">\n            <option value="">Todos os funcion√°rios</option>\n            ${n.map(e=>`<option value="${e.id}">${escapeHtml(e.nome)}</option>`).join("")}\n          </select>\n        </div>\n      </div>\n      <div id="fsHistoricoContainer"></div>\n    </div>\n\n    \x3c!-- RESUMO POR FUNCION√ÅRIO --\x3e\n    <div class="card fs-section">\n      <h3 style="margin:0 0 16px; font-size:16px; color:#0f172a;">üë∑ Resumo por Funcion√°rio (safra atual)</h3>\n      <div id="fsResumoPorFuncionario"></div>\n    </div>\n  `;let p=0;const u=document.getElementById("descontosContainer");function m(){const e=document.getElementById("fsFiltroMes")?.value||"",a=document.getElementById("fsFiltroFuncionario")?.value||"",n=getDB();let t=onlySafra(n.folhaSalarial||[]).sort((e,a)=>(a.competencia||"").localeCompare(e.competencia||""));e&&(t=t.filter(a=>(a.competencia||"").startsWith(e))),a&&(t=t.filter(e=>e.funcionarioId===a));const o=document.getElementById("fsHistoricoContainer");if(!t.length)return void(o.innerHTML='<div style="text-align:center; padding:30px; color:#94a3b8;">Nenhum registro encontrado.</div>');const s={};t.forEach(e=>{const a=(e.competencia||"").substring(0,7);s[a]=s[a]||[],s[a].push(e)});let l="";Object.keys(s).sort((e,a)=>a.localeCompare(e)).forEach(e=>{const a=s[e],n=a.reduce((e,a)=>e+Number(a.salarioLiquido||0),0),t=a.reduce((e,a)=>e+Number(a.salarioBruto||0),0);l+=`\n        <div class="comp-group">\n          <div class="comp-header">\n            <span>üìÖ ${_formatCompetencia(e)} ‚Äî ${a.length} funcion√°rio(s)</span>\n            <span>Bruto: ${brl(t)} | L√≠quido: <b style="color:#10b981;">${brl(n)}</b></span>\n          </div>\n          <div class="fs-table-wrap">\n            <table class="fs-table">\n              <thead>\n                <tr>\n                  <th>Funcion√°rio</th>\n                  <th>Fun√ß√£o</th>\n                  <th>Dias</th>\n                  <th>H. Extras</th>\n                  <th>Bruto</th>\n                  <th>INSS</th>\n                  <th>Descontos</th>\n                  <th>L√≠quido</th>\n                  <th>Status</th>\n                  <th>A√ß√µes</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${a.map(e=>`\n                  <tr>\n                    <td data-label="Funcion√°rio"><b>${escapeHtml(e.funcionarioNome||"‚Äî")}</b></td>\n                    <td data-label="Fun√ß√£o">${escapeHtml(e.funcionarioFuncao||"‚Äî")}</td>\n                    <td data-label="Dias" style="text-align:center;">${e.diasTrabalhados||30}</td>\n                    <td data-label="H. Extras" style="text-align:center;">${num(e.horasExtras||0)}h</td>\n                    <td data-label="Bruto"><b style="color:#2563eb;">${brl(e.salarioBruto)}</b></td>\n                    <td data-label="INSS"><span style="color:#ef4444;">${brl(e.inss||0)}</span></td>\n                    <td data-label="Descontos"><span style="color:#ef4444;">${brl(e.totalDescontos||0)}</span></td>\n                    <td data-label="L√≠quido"><b class="valor-destaque">${brl(e.salarioLiquido)}</b></td>\n                    <td data-label="Status"><span class="fs-badge badge-${e.status||"pendente"}">${_statusLabel(e.status)}</span></td>\n                    <td data-label="A√ß√µes" style="white-space:nowrap;">\n                      <button class="btn" style="padding:3px 8px; font-size:11px;" onclick="_fsPagarFolha('${e.id}')">‚úÖ Pagar</button>\n                      <button class="btn" style="padding:3px 8px; font-size:11px; color:#ef4444;" onclick="_fsDeleteFolha('${e.id}')">üóëÔ∏è</button>\n                    </td>\n                  </tr>\n                `).join("")}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      `}),o.innerHTML=l}function f(){const e=getDB(),a=onlySafra(e.folhaSalarial||[]),t=document.getElementById("fsResumoPorFuncionario");if(!n.length)return void(t.innerHTML='<div style="text-align:center; padding:20px; color:#94a3b8;">Nenhum funcion√°rio cadastrado na safra.</div>');const o=n.map(e=>{const n=a.filter(a=>a.funcionarioId===e.id),t=n.reduce((e,a)=>e+Number(a.salarioBruto||0),0),o=n.reduce((e,a)=>e+Number(a.salarioLiquido||0),0),s=n.reduce((e,a)=>e+Number(a.horasExtras||0),0),l=n.filter(e=>"pago"!==e.status).reduce((e,a)=>e+Number(a.salarioLiquido||0),0);return{e:e,minhas:n,totalBruto:t,totalLiquido:o,totalHorasExtras:s,pendentes:l}});t.innerHTML=`\n      <div class="fs-table-wrap">\n        <table class="fs-table">\n          <thead>\n            <tr>\n              <th>Funcion√°rio</th>\n              <th>Fun√ß√£o</th>\n              <th>Meses</th>\n              <th>Total Bruto</th>\n              <th>Total L√≠quido</th>\n              <th>H. Extras</th>\n              <th>A Pagar</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${o.map(e=>`\n              <tr>\n                <td><b>${escapeHtml(e.e.nome)}</b></td>\n                <td>${escapeHtml(e.e.funcao||"‚Äî")}</td>\n                <td style="text-align:center;">${e.minhas.length}</td>\n                <td><b style="color:#2563eb;">${brl(e.totalBruto)}</b></td>\n                <td><b class="valor-destaque">${brl(e.totalLiquido)}</b></td>\n                <td style="text-align:center;">${num(e.totalHorasExtras)}h</td>\n                <td><b style="color:${e.pendentes>0?"#f59e0b":"#10b981"};">${e.pendentes>0?brl(e.pendentes):"‚úÖ Em dia"}</b></td>\n              </tr>\n            `).join("")}\n          </tbody>\n        </table>\n      </div>\n    `}document.getElementById("btnAddDesconto").addEventListener("click",()=>function(e="",a=""){const n=p++,t=document.createElement("div");t.className="desconto-line",t.id=`descLine${n}`,t.innerHTML=`\n      <select class="select" id="dTipo${n}" onchange="_fsCalcLive()">\n        <option value="falta"${"falta"===e?" selected":""}>Falta/Atraso</option>\n        <option value="outros"${"outros"===e?" selected":""}>Outros Descontos</option>\n        <option value="emprestimo"${"emprestimo"===e?" selected":""}>Empr√©stimo</option>\n        <option value="multa"${"multa"===e?" selected":""}>Multa/Penalidade</option>\n      </select>\n      <input class="input" type="text" id="dDesc${n}" placeholder="Descri√ß√£o" style="font-size:12px;" />\n      <input class="input" type="number" id="dValor${n}" placeholder="R$" value="${a}" min="0" step="0.01" oninput="_fsCalcLive()" style="font-size:12px;" />\n      <button class="btn" style="padding:4px 8px; font-size:14px; color:#ef4444;" onclick="document.getElementById('descLine${n}').remove(); _fsCalcLive();">‚úï</button>\n    `,u.appendChild(t)}()),window._fsCalcLive=function(){const e=parseFloat(document.getElementById("fsSalarioBase")?.value||0);if(!e)return void(document.getElementById("fsResumoLive").style.display="none");const a=parseInt(document.getElementById("fsDiasTrabalhados")?.value||30),n=parseFloat(document.getElementById("fsHorasExtras")?.value||0),t=parseFloat(document.getElementById("fsValorHoraExtra")?.value||0),o=parseFloat(document.getElementById("fsAdiantamento")?.value||0),s=parseFloat(document.getElementById("fsValeTransporte")?.value||0),l=parseFloat(document.getElementById("fsValeAlimentacao")?.value||0),i=parseFloat(document.getElementById("fsOutrosBeneficios")?.value||0),r=e/30*a,d=n*t,c=_calcINSS(r+d);let p=0;document.querySelectorAll('[id^="dValor"]').forEach(e=>{p+=parseFloat(e.value||0)});const u=r+d+s+l+i,m=c+o+p,f=u-m;document.getElementById("fsResumoLive").style.display="block",document.getElementById("fsResumoTexto").innerHTML=`\n      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; font-size:12px;">\n        <div><b>Sal√°rio Proporcional:</b><br>${brl(r)}</div>\n        <div><b>Horas Extras:</b><br>${brl(d)} (${num(n)}h)</div>\n        <div><b>INSS (desconto):</b><br><span class="valor-desconto">${brl(c)}</span></div>\n        <div><b>VT + VA + Outros:</b><br>${brl(s+l+i)}</div>\n        <div><b>Adiantamento:</b><br><span class="valor-desconto">${brl(o)}</span></div>\n        <div><b>Outros Descontos:</b><br><span class="valor-desconto">${brl(p)}</span></div>\n      </div>\n      <div style="margin-top:10px; padding-top:10px; border-top:1px solid #86efac; display:flex; gap:20px;">\n        <div><b>Sal√°rio Bruto:</b> <span style="font-size:16px; font-weight:800; color:#2563eb;">${brl(u)}</span></div>\n        <div><b>Total Descontos:</b> <span style="font-size:16px; font-weight:800; color:#ef4444;">${brl(m)}</span></div>\n        <div><b>Sal√°rio L√≠quido:</b> <span style="font-size:16px; font-weight:800; color:#10b981;">${brl(f)}</span></div>\n      </div>\n    `},["fsSalarioBase","fsDiasTrabalhados","fsHorasExtras","fsValorHoraExtra","fsAdiantamento","fsValeTransporte","fsValeAlimentacao","fsOutrosBeneficios"].forEach(e=>{document.getElementById(e)?.addEventListener("input",_fsCalcLive)}),document.getElementById("btnCalcularFolha").addEventListener("click",_fsCalcLive),document.getElementById("btnSalvarFolha").addEventListener("click",()=>{const e=document.getElementById("fsFuncionario").value,t=document.getElementById("fsCompetencia").value,o=parseFloat(document.getElementById("fsSalarioBase").value||0);if(!e)return toast("‚ùå Erro","Selecione um funcion√°rio");if(!t)return toast("Agro Pro","Informe a compet√™ncia (m√™s/ano)","error");if(!o||o<=0)return toast("‚ùå Erro","Informe o sal√°rio base");const s=n.find(a=>a.id===e),l=parseInt(document.getElementById("fsDiasTrabalhados").value||30),i=parseFloat(document.getElementById("fsHorasExtras").value||0),r=parseFloat(document.getElementById("fsValorHoraExtra").value||0),d=parseFloat(document.getElementById("fsAdiantamento").value||0),c=parseFloat(document.getElementById("fsValeTransporte").value||0),p=parseFloat(document.getElementById("fsValeAlimentacao").value||0),u=parseFloat(document.getElementById("fsOutrosBeneficios").value||0),m=document.getElementById("fsStatus").value,f=document.getElementById("fsDataPagamento").value,b=document.getElementById("fsObs").value.trim(),v=o/30*l,g=i*r,h=_calcINSS(v+g),x=[];let y=0;document.querySelectorAll('[id^="dValor"]').forEach((e,a)=>{const n=parseFloat(e.value||0);if(n>0){const a=document.querySelector('[id^="dTipo"]'),t=document.getElementById(e.id.replace("dValor","dDesc"));x.push({tipo:a?.value||"outros",descricao:t?.value||"",valor:n}),y+=n}});const E=v+g+c+p+u,B=h+d+y,S=E-B,I={id:"fs_"+Date.now(),safraId:a,funcionarioId:e,funcionarioNome:s?.nome||"",funcionarioFuncao:s?.funcao||"",competencia:t+"-01",salarioBase:o,diasTrabalhados:l,horasExtras:i,valorHoraExtra:r,valorHorasExtras:g,adiantamento:d,valeTransporte:c,valeAlimentacao:p,outrosBeneficios:u,inss:h,descontosExtras:x,totalDescontos:B,salarioBruto:E,salarioLiquido:S,status:m,dataPagamento:f,obs:b,criadoEm:(new Date).toISOString()},$=getDB();$.folhaSalarial=$.folhaSalarial||[],$.folhaSalarial.push(I),setDB($),toast("Agro Pro",`‚úÖ Folha de ${s?.nome} salva! L√≠quido: ${brl(S)}`,"success"),pageFolhaSalarial()}),document.getElementById("btnLimparFolha").addEventListener("click",()=>{["fsFuncionario","fsSalarioBase","fsHorasExtras","fsValorHoraExtra","fsAdiantamento","fsValeTransporte","fsValeAlimentacao","fsOutrosBeneficios","fsObs","fsDataPagamento"].forEach(e=>{const a=document.getElementById(e);a&&(a.value="SELECT"===a.tagName&&a.options[0]?.value||"")});const e=document.getElementById("fsDiasTrabalhados");e&&(e.value="30");const a=document.getElementById("fsStatus");a&&(a.value="pendente"),u.innerHTML="",document.getElementById("fsResumoLive").style.display="none"}),document.getElementById("fsFiltroMes")?.addEventListener("change",m),document.getElementById("fsFiltroFuncionario")?.addEventListener("change",m),window._fsPagarFolha=function(e){const a=getDB(),n=(a.folhaSalarial||[]).findIndex(a=>a.id===e);n<0||(a.folhaSalarial[n].status="pago",a.folhaSalarial[n].dataPagamento=(new Date).toISOString().split("T")[0],setDB(a),toast("‚úÖ Sucesso","‚úÖ Marcado como pago!"),m(),f())},window._fsDeleteFolha=function(e){if(!confirm("Excluir este registro de folha?"))return;const a=getDB();a.folhaSalarial=(a.folhaSalarial||[]).filter(a=>a.id!==e),setDB(a),toast("‚ÑπÔ∏è Info","Registro exclu√≠do."),pageFolhaSalarial()},document.getElementById("btnExportFolhaCSV")?.addEventListener("click",()=>{const e=getDB(),a=onlySafra(e.folhaSalarial||[]);if(!a.length)return toast("‚ùå Erro","Nenhum dado para exportar");const n=[["Funcion√°rio","Fun√ß√£o","Compet√™ncia","Dias Trab.","H. Extras","Sal√°rio Base","Bruto","INSS","Total Descontos","L√≠quido","VT","VA","Adiantamento","Status","Data Pagamento","Obs"],...a.map(e=>[e.funcionarioNome,e.funcionarioFuncao,_formatCompetencia((e.competencia||"").substring(0,7)),e.diasTrabalhados,e.horasExtras,e.salarioBase,e.salarioBruto,e.inss,e.totalDescontos,e.salarioLiquido,e.valeTransporte,e.valeAlimentacao,e.adiantamento,e.status,e.dataPagamento,e.obs])].map(e=>e.map(e=>`"${String(e||"").replace(/"/g,'""')}"`).join(",")).join("\n"),t=document.createElement("a");t.href="data:text/csv;charset=utf-8,\ufeff"+encodeURIComponent(n),t.download=`folha-salarial-${getSafraAtual()?.nome||"safra"}.csv`,t.click()}),document.getElementById("btnImprimirFolha")?.addEventListener("click",()=>window.print()),m(),f()}function _getMesAtual(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}function _formatCompetencia(e){if(!e||e.length<7)return e||"‚Äî";const[a,n]=e.split("-");return`${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][parseInt(n)-1]||n}/${a}`}function _statusLabel(e){return"pago"===e?"‚úÖ Pago":"adiantamento"===e?"üí≥ Adiantamento":"‚è≥ Pendente"}function _calcINSS(e){if(!e||e<=0)return 0;const a=[{limite:1518,aliq:.075},{limite:2793.88,aliq:.09},{limite:4190.83,aliq:.12},{limite:8157.41,aliq:.14}];let n=0,t=Math.min(e,8157.41),o=0;for(const e of a){if(t<=o)break;const a=Math.min(t,e.limite)-o;a>0&&(n+=a*e.aliq),o=e.limite}return Math.round(100*n)/100}