async function buscarClimaOpenMeteo(o,a){const e=`https://api.open-meteo.com/v1/forecast?latitude=${o}&longitude=${a}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,relative_humidity_2m_mean,wind_speed_10m_max&timezone=America/Sao_Paulo&past_days=7&forecast_days=7`;try{const o=await fetch(e);if(!o.ok)throw new Error("Erro na API Open-Meteo");return await o.json()}catch(o){return null}}async function importarClimaAutomatico(o){const a=getDB().fazendas.find(a=>a.id===o);if(!a||!a.latitude||!a.longitude)return toast("Erro","Cadastre latitude e longitude na fazenda primeiro."),{ok:!1,msg:"Sem coordenadas"};const e=parseFloat(a.latitude),t=parseFloat(a.longitude);if(isNaN(e)||isNaN(t))return toast("Erro","Latitude ou longitude inv√°lida."),{ok:!1,msg:"Coordenadas inv√°lidas"};toast("Buscando...","Consultando dados clim√°ticos via Open-Meteo...");const i=await buscarClimaOpenMeteo(e,t);if(!i||!i.daily)return toast("Erro","N√£o foi poss√≠vel obter dados clim√°ticos."),{ok:!1,msg:"API indispon√≠vel"};const n=i.daily,r=getDB();let s=0;const l=new Set((r.clima||[]).map(o=>`${o.fazendaId}_${o.data}`));for(let a=0;a<n.time.length;a++){const e=n.time[a],t=`${o}_${e}`;l.has(t)||new Date(e)>new Date||(r.clima=r.clima||[],r.clima.push({id:uid("cli"),safraId:getSafraId(),data:e,fazendaId:o,talhaoId:"",chuvaMm:Number(n.precipitation_sum[a]||0),tempMin:Number(n.temperature_2m_min[a]||0),tempMax:Number(n.temperature_2m_max[a]||0),umidade:Number(n.relative_humidity_2m_mean?.[a]||0),vento:Number(n.wind_speed_10m_max?.[a]||0),obs:"Importado automaticamente via Open-Meteo"}),s++)}return setDB(r),{ok:!0,importados:s,previsao:n}}async function buscarPrevisaoClima(o){const a=getDB().fazendas.find(a=>a.id===o);if(!a||!a.latitude||!a.longitude)return null;const e=parseFloat(a.latitude),t=parseFloat(a.longitude);if(isNaN(e)||isNaN(t))return null;const i=await buscarClimaOpenMeteo(e,t);if(!i||!i.daily)return null;const n=i.daily,r=(new Date).toISOString().substring(0,10),s=[];for(let o=0;o<n.time.length;o++)n.time[o]>=r&&s.push({data:n.time[o],tempMin:n.temperature_2m_min[o],tempMax:n.temperature_2m_max[o],chuva:n.precipitation_sum[o],umidade:n.relative_humidity_2m_mean?.[o]||0,vento:n.wind_speed_10m_max?.[o]||0});return s}async function gerarRecomendacaoIA(o){return{ok:!1,msg:"Recurso de sugest√£o de manejo desativado temporariamente."}}const defensivosDB={fungicidas:[{nome:"Fox",tipo:"Fungicida",alvo:"Ferrugem Asi√°tica",dose:"0.75-1.0 L/ha","est√°gio":["V4-V8"]},{nome:"Opera",tipo:"Fungicida",alvo:"Ferrugem Asi√°tica",dose:"0.5-0.75 L/ha","est√°gio":["V4-V8"]},{nome:"Viovan",tipo:"Fungicida",alvo:"Ferrugem Asi√°tica",dose:"0.5-0.75 L/ha","est√°gio":["V4-V8"]}],inseticidas:[{nome:"Engeo Pleno",tipo:"Inseticida",alvo:"Lagarta-da-soja",dose:"0.5-1.0 L/ha","est√°gio":["V4-V8"]},{nome:"Ampligo",tipo:"Inseticida",alvo:"Lagarta-da-soja",dose:"0.4-0.8 L/ha","est√°gio":["V4-V8"]},{nome:"Orthene",tipo:"Inseticida",alvo:"Percevejos",dose:"0.75-1.5 kg/ha","est√°gio":["V6-R2"]}]};async function buscarPrecoGraos(a,o,e){const t=[{lat:-12.55,lon:-55.73,nome:"Sorriso-MT",soja:121,milho:59,algodao:93,sorgo:42,trigo:86,cafe:1798,arroz:56,feijao:285},{lat:-13.55,lon:-54.72,nome:"Lucas do Rio Verde-MT",soja:120.5,milho:58.5,algodao:92.5,sorgo:41.5,trigo:85.5,cafe:1785,arroz:55.5,feijao:282},{lat:-15.89,lon:-54.37,nome:"Rondon√≥polis-MT",soja:122,milho:60,algodao:94,sorgo:43,trigo:87,cafe:1800,arroz:56.5,feijao:287},{lat:-17.88,lon:-51.72,nome:"Rio Verde-GO",soja:122.5,milho:60.5,algodao:94.5,sorgo:43.5,trigo:87.5,cafe:1810,arroz:57,feijao:289},{lat:-15.6,lon:-46.65,nome:"Una√≠-MG",soja:121.5,milho:59.2,algodao:93.2,sorgo:42.5,trigo:86.5,cafe:1795,arroz:56.2,feijao:286},{lat:-12.14,lon:-44.99,nome:"Barreiras-BA",soja:119,milho:57,algodao:91.5,sorgo:41,trigo:84,cafe:1770,arroz:54.5,feijao:278},{lat:-28.26,lon:-52.41,nome:"Passo Fundo-RS",soja:125,milho:63,algodao:96,sorgo:45,trigo:92,cafe:1830,arroz:58,feijao:298},{lat:-24.96,lon:-53.46,nome:"Cascavel-PR",soja:124.5,milho:62.5,algodao:95.5,sorgo:44.5,trigo:91.5,cafe:1825,arroz:57.5,feijao:296},{lat:-22.23,lon:-49.94,nome:"Mar√≠lia-SP",soja:123.5,milho:61.5,algodao:95,sorgo:44,trigo:90.5,cafe:1820,arroz:57,feijao:293},{lat:-16.68,lon:-49.26,nome:"Goi√¢nia-GO",soja:122,milho:60,algodao:94,sorgo:43,trigo:87,cafe:1808,arroz:56.5,feijao:288},{lat:-20.44,lon:-54.65,nome:"Campo Grande-MS",soja:121.5,milho:59.5,algodao:93.5,sorgo:42.5,trigo:86.5,cafe:1800,arroz:56,feijao:286},{lat:-23.55,lon:-46.63,nome:"S√£o Paulo-SP",soja:124.5,milho:62.5,algodao:96,sorgo:44.5,trigo:91.5,cafe:1835,arroz:57.5,feijao:297},{lat:-25.43,lon:-49.27,nome:"Curitiba-PR",soja:124,milho:62,algodao:95.2,sorgo:44.2,trigo:91,cafe:1822,arroz:57.2,feijao:295},{lat:-7.53,lon:-46.04,nome:"Balsas-MA",soja:117,milho:55.5,algodao:90,sorgo:40,trigo:82.5,cafe:1750,arroz:53,feijao:273},{lat:-5.09,lon:-42.8,nome:"Teresina-PI",soja:116,milho:54.5,algodao:89,sorgo:39.5,trigo:81.5,cafe:1740,arroz:52,feijao:270}];function i(a,o,e,t){const i=(e-a)*Math.PI/180,n=(t-o)*Math.PI/180,r=Math.sin(i/2)**2+Math.cos(a*Math.PI/180)*Math.cos(e*Math.PI/180)*Math.sin(n/2)**2;return 12742*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))}let n=t[0],r=1/0;for(const a of t){const t=i(a.lat,a.lon,o,e);t<r&&(r=t,n=a)}const s=(a||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");let l=null,c="",dataRef="";try{if("undefined"!=typeof isSupabaseReady&&isSupabaseReady()){const o=getSupabaseClient();if(o){const e=await o.from("cotacoes_diarias").select("preco,unidade,fonte,data").eq("commodity",s).order("data",{ascending:!1}).limit(1).single();if(e.data&&e.data.preco>0){l=Number(e.data.preco);c=e.data.fonte||"CEPEA/Esalq";dataRef=e.data.data;const f=new Date(),g=new Date(dataRef),diff=Math.floor((f-g)/(1e3*60*60*24));if(diff>3)c+=" ("+diff+" dias atr√°s)"}}}if(!l){try{if("undefined"!=typeof isSupabaseReady&&isSupabaseReady()){const o=getSupabaseClient();if(o){const e=await o.from("user_data_backup").select("data").not("data","is",null).limit(10);if(e.data&&e.data.length>0){for(const row of e.data){const cd=row.data?.cotacoes_diarias;if(cd&&cd.commodities){const found=cd.commodities.find(x=>x.commodity===s);if(found&&found.preco>0){l=Number(found.preco);c=found.fonte||"CEPEA/Esalq";dataRef=cd.data||"";break}}}}}}}catch(x){}}if(!l){const o="undefined"!=typeof AuthService?await AuthService.getSession():null;if(o?.access_token&&"undefined"!=typeof SUPABASE_URL){const e=await Promise.race([fetch(SUPABASE_URL+"/functions/v1/commodities-proxy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+o.access_token,apikey:"undefined"!=typeof SUPABASE_ANON?SUPABASE_ANON:""},body:JSON.stringify({cultura:a,action:"get"})}),new Promise((a,o)=>setTimeout(()=>o(new Error("timeout")),8e3))]);if(e.ok){const a=await e.json();a.ok&&a.preco>0&&(l=a.preco,c=a.fonte+(a.cached?" (cache)":""),dataRef=a.data||"")}}}}catch(a){}const m=n[s]||n.soja,d=l||m,u=l?c:"CEPEA/Esalq ‚Äî ref. regional",g=l?"tempo_real":"referencia";return{ok:!0,cultura:a,regiao:n.nome,distanciaKm:Math.round(r),preco:d,moeda:"R$/sc",fonte:u,tipoPreco:g,dataRef:dataRef||(new Date).toISOString().slice(0,10)}}
function enviarAlertaWhatsApp(o,a){let e=a||"";if(!e)try{const o=JSON.parse(localStorage.getItem("agro_session")||"{}");e=(o?.user?.phone||"").replace(/\D/g,"")}catch(o){}if(!e)try{const o=getDB();e=(o?.meta?.whatsappAlertas||"").replace(/\D/g,"")}catch(o){}(!e||e.length<10)&&(e="5599991360547"),e.startsWith("55")||(e="55"+e);const t=`üåæ *Agro Pro ‚Äî Alerta*\n\n${o}\n\nüìÖ ${(new Date).toLocaleDateString("pt-BR")} √†s ${(new Date).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}`,i=`https://wa.me/${e}?text=${encodeURIComponent(t)}`;window.open(i,"_blank"),"function"==typeof toast&&toast("üì± WhatsApp","Abrindo WhatsApp com o alerta...",4e3)}function verificarAlertasAutomaticos(){const o=getDB(),a="function"==typeof getSafraId?getSafraId():o?.session?.safraId,e=o=>(o||[]).filter(o=>!a||o.safraId===a||!o.safraId),t=[],i=e(o.estoque),n=o.produtos||[];i.forEach(o=>{const a=Number(o.qtd||0),e=Number(o.qtdMinima||0);if(e>0&&a<=e){const i=n.find(a=>a.id===o.produtoId);t.push({tipo:"estoque_baixo",nivel:"aviso",icone:"üì¶",titulo:"Estoque Baixo",mensagem:`${i?.nome||o.produtoNome||"Produto"} com ${a} ${o.unidade||"un"} (m√≠nimo configurado: ${e}).`,pagina:"insumos"})}});const r=e(o.manutencoes).filter(o=>"pendente"===o.status||"atrasado"===o.status);r.length>0&&t.push({tipo:"manutencao_pendente",nivel:"atencao",icone:"üîß",titulo:"Manuten√ß√£o Pendente",mensagem:`${r.length} servi√ßo(s) pendente(s): ${r.slice(0,3).map(o=>o.tipo||o.descricao||"N/I").join(", ")}.`,pagina:"manutencao"});const s=e(o.clima).sort((o,a)=>(a.data||"").localeCompare(o.data||"")).slice(0,7);if(s.length>=3){const o=s.reduce((o,a)=>o+Number(a.umidade||0),0)/s.length,a=s.reduce((o,a)=>o+Number(a.chuvaMm||0),0),e=s.reduce((o,a)=>o+Number(a.tempMax||0),0)/s.length;o>75&&e>=20&&e<=30&&t.push({tipo:"risco_ferrugem",nivel:"critico",icone:"üçÑ",titulo:"Risco de Ferrugem Asi√°tica",mensagem:`Umidade m√©dia de ${o.toFixed(0)}% e ${a.toFixed(1)}mm nos √∫ltimos ${s.length} dias. Temperatura ${e.toFixed(0)}¬∞C ‚Äî condi√ß√µes favor√°veis para Ferrugem Asi√°tica. Avalie aplica√ß√£o preventiva de fungicida (Fox, Elatus, Opera).`,pagina:"clima"}),o>85&&t.push({tipo:"risco_mofo_branco",nivel:"aviso",icone:"üå´",titulo:"Risco de Mofo-branco",mensagem:"Umidade acima de 85% ‚Äî condi√ß√µes favor√°veis para Sclerotinia. Avalie fungicidas com a√ß√£o no solo.",pagina:"clima"})}const l=e(o.aplicacoes),c="undefined"!=typeof defensivosDBExpandida?defensivosDBExpandida.fungicidas.map(o=>o.nome.toLowerCase()):[],m="undefined"!=typeof defensivosDBExpandida?defensivosDBExpandida.inseticidas.map(o=>o.nome.toLowerCase()):[],d=["lagarta","percevejo","mosca-branca","√°caro","acaro","tripes","pulg√£o","pulgao"],u=["ferrugem","mancha-alvo","antracnose","o√≠dio","oidio","cercospora","mofo"];l.slice(-30).forEach(o=>{(o.produtos||[]).forEach(a=>{const e=(a.produtoNome||"").toLowerCase(),i=(o.alvo||"").toLowerCase(),n=c.includes(e),r=m.includes(e),s=d.some(o=>i.includes(o)),l=u.some(o=>i.includes(o));n&&s&&t.push({tipo:"aplicacao_errada",nivel:"critico",icone:"‚ùå",titulo:"Aplica√ß√£o Incorreta",mensagem:`Fungicida "${a.produtoNome}" foi usado para "${o.alvo}" em ${o.data||"N/I"}. Fungicidas n√£o controlam pragas. Use um inseticida adequado.`,pagina:"aplicacoes"}),r&&l&&t.push({tipo:"aplicacao_errada",nivel:"critico",icone:"‚ùå",titulo:"Aplica√ß√£o Incorreta",mensagem:`Inseticida "${a.produtoNome}" foi usado para "${o.alvo}" em ${o.data||"N/I"}. Inseticidas n√£o controlam doen√ßas f√∫ngicas. Use um fungicida adequado.`,pagina:"aplicacoes"})})});const g=e(o.colheitas),p=new Date;return g.forEach(a=>{if(!a.dataPrevistaColheita)return;const e=Math.floor((new Date(a.dataPrevistaColheita)-p)/864e5);if(e>=0&&e<=14){const i=(o.talhoes||[]).find(o=>o.id===a.talhaoId);t.push({tipo:"colheita_proxima",nivel:"info",icone:"üåæ",titulo:"Colheita Pr√≥xima",mensagem:`Talh√£o "${i?.nome||a.talhaoId}" com colheita prevista em ${a.dataPrevistaColheita} (${e} dias). Verifique disponibilidade de colhedoras e log√≠stica.`,pagina:"colheitas"})}}),(o.dieselEstoque||[]).forEach(o=>{Number(o.litros||0)<500&&t.push({tipo:"diesel_baixo",nivel:"aviso",icone:"‚õΩ",titulo:"Diesel Baixo",mensagem:`Estoque de diesel com apenas ${o.litros||0} litros (dep√≥sito: ${o.deposito||"N/I"}). Reabastecimento recomendado.`,pagina:"combustivel"})}),t}function formatarAlertasWhatsApp(o){if(!o||0===o.length)return"‚úÖ Nenhum alerta pendente.";const a=o.filter(o=>"critico"===o.nivel),e=o.filter(o=>"atencao"===o.nivel),t=o.filter(o=>"aviso"===o.nivel||"info"===o.nivel);let i=`üåæ *Agro Pro ‚Äî Relat√≥rio de Alertas*\nüìÖ ${(new Date).toLocaleDateString("pt-BR")}\n\n`;return a.length>0&&(i+=`üî¥ *CR√çTICOS (${a.length}):*\n`,a.forEach(o=>{i+=`${o.icone} *${o.titulo}*: ${o.mensagem}\n`}),i+="\n"),e.length>0&&(i+=`üü° *ATEN√á√ÉO (${e.length}):*\n`,e.forEach(o=>{i+=`${o.icone} *${o.titulo}*: ${o.mensagem}\n`}),i+="\n"),t.length>0&&(i+=`üü¢ *AVISOS (${t.length}):*\n`,t.forEach(o=>{i+=`${o.icone} *${o.titulo}*: ${o.mensagem}\n`}),i+="\n"),i+="_Agro Pro ¬∑ Verifique o aplicativo para detalhes_",i}function enviarTodosAlertasWhatsApp(o){const a=verificarAlertasAutomaticos();0!==a.length?enviarAlertaWhatsApp(formatarAlertasWhatsApp(a),o):"function"==typeof toast&&toast("‚úÖ Sem alertas","Nenhum alerta pendente no momento.",3e3)}function iniciarMonitoramentoAlertas(){function o(){try{const o=verificarAlertasAutomaticos(),a=o.filter(o=>"critico"===o.nivel);a.length>0&&"function"==typeof toast&&toast(`‚ö° ${a.length} alerta(s) cr√≠tico(s)`,a[0].mensagem+(a.length>1?` (+${a.length-1} mais)`:""),6e3),localStorage.setItem("agro_last_alert_check",(new Date).toISOString()),localStorage.setItem("agro_alert_count",String(o.length))}catch(o){}}setTimeout(o,3e3);const a=setInterval(o,18e5);return window._alertaIntervalId=a,a}"undefined"!=typeof window&&"login"!==(document.body?.getAttribute?.("data-page")||"")&&("complete"===document.readyState?iniciarMonitoramentoAlertas():window.addEventListener("load",iniciarMonitoramentoAlertas));