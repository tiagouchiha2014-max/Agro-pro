function pageClima(){const a=getDB(),t=onlySafra(a.fazendas);let e=onlySafra(a.talhoes);fazendaAtual&&(e=e.filter(a=>a.fazendaId===fazendaAtual));const n=onlySafra(a.clima||[]).sort((a,t)=>t.data.localeCompare(a.data));setTopActions('\n    <button class="btn primary" id="btnImportClima">ğŸŒ¤ï¸ Ver PrevisÃ£o do Tempo</button>\n    <button class="btn" id="btnExportCSV">ğŸ“¥ Exportar CSV</button>\n  ');const d=n.reduce((a,t)=>a+Number(t.chuvaMm||0),0),i=n.filter(a=>a.chuvaMm>0).length,l=n.length?d/n.length:0,s=n.reduce((a,t)=>a+Number(t.tempMax||0),0)/(n.length||1),o=n.reduce((a,t)=>a+Number(t.tempMin||0),0)/(n.length||1),m=(s+o)/2,r=n.reduce((a,t)=>a+Number(t.umidade||0),0)/(n.length||1),p=n.reduce((a,t)=>a+Number(t.vento||0),0)/(n.length||1),c=e.map(a=>{const e=n.filter(t=>t.talhaoId===a.id),d=e.reduce((a,t)=>a+Number(t.chuvaMm||0),0),i=e.sort((a,t)=>t.data.localeCompare(a.data))[0];return{talhao:a.nome,fazenda:findNameById(t,a.fazendaId),totalChuva:d,media:e.length?d/e.length:0,ultimaData:i?.data||"-",ultimaChuva:i?.chuvaMm||0,registros:e.length}}).sort((a,t)=>t.totalChuva-a.totalChuva),u=t.map(a=>{const t=e.filter(t=>t.fazendaId===a.id);let d=0,i=0;t.forEach(a=>{const t=n.filter(t=>t.talhaoId===a.id);d+=t.reduce((a,t)=>a+Number(t.chuvaMm||0),0),i+=t.length});const l=n.filter(t=>t.fazendaId===a.id&&!t.talhaoId);return d+=l.reduce((a,t)=>a+Number(t.chuvaMm||0),0),i+=l.length,{fazenda:a.nome,totalChuva:d,media:i?d/i:0,registros:i}}).sort((a,t)=>t.totalChuva-a.totalChuva),h=new Array(12).fill(0);n.forEach(a=>{if(a.data){const t=parseInt(a.data.substring(5,7))-1;h[t]+=Number(a.chuvaMm||0)}});const v=Math.max(...h,1);document.getElementById("content").innerHTML=`\n    <style>\n      .clima-kpi-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n        gap: 15px;\n        margin-bottom: 20px;\n      }\n      .clima-kpi-card {\n        background: #ffffff;\n        border-radius: 12px;\n        padding: 20px;\n        border-left: 4px solid #3b82f6;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.05);\n      }\n      .clima-kpi-card h3 {\n        margin: 0 0 10px 0;\n        color: #3b82f6;\n        font-size: 16px;\n      }\n      .clima-kpi-valor {\n        font-size: 36px;\n        font-weight: 700;\n        color: #0f172a;\n      }\n      .clima-kpi-unidade {\n        font-size: 16px;\n        color: #64748b;\n        margin-left: 5px;\n      }\n      .clima-kpi-label {\n        color: #475569;\n        font-size: 13px;\n        margin-top: 8px;\n      }\n      .form-clima {\n        background: #ffffff;\n        border-radius: 12px;\n        padding: 20px;\n        margin-bottom: 30px;\n        border: 1px solid #e2e8f0;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.05);\n      }\n      .form-clima h3 { color: #3b82f6; }\n      .grafico-barras {\n        display: flex; align-items: flex-end; gap: 8px; height: 200px; margin: 20px 0;\n      }\n      .barra {\n        flex: 1; background: #3b82f6; border-radius: 4px 4px 0 0; min-height: 20px;\n        transition: height 0.3s;\n      }\n      .barra-label { text-align: center; font-size: 11px; margin-top: 5px; color: #475569; }\n    </style>\n\n    <div class="clima-kpi-grid">\n      <div class="clima-kpi-card">\n        <h3>ğŸŒ§ï¸ Total de Chuvas</h3>\n        <div><span class="clima-kpi-valor">${num(d,1)}</span><span class="clima-kpi-unidade">mm</span></div>\n        <div class="clima-kpi-label">${i} dia(s) com chuva</div>\n      </div>\n      <div class="clima-kpi-card">\n        <h3>ğŸ“Š MÃ©dia por Registro</h3>\n        <div><span class="clima-kpi-valor">${num(l,1)}</span><span class="clima-kpi-unidade">mm</span></div>\n        <div class="clima-kpi-label">${n.length} registro(s)</div>\n      </div>\n      <div class="clima-kpi-card">\n        <h3>ğŸŒ¡ï¸ Temperatura MÃ©dia</h3>\n        <div><span class="clima-kpi-valor">${num(m,1)}</span><span class="clima-kpi-unidade">Â°C</span></div>\n        <div class="clima-kpi-label">MÃ­n ${num(o,1)}Â°C / MÃ¡x ${num(s,1)}Â°C</div>\n      </div>\n      <div class="clima-kpi-card">\n        <h3>ğŸ’§ Umidade MÃ©dia</h3>\n        <div><span class="clima-kpi-valor">${r?num(r,0):"-"}</span><span class="clima-kpi-unidade">%</span></div>\n        <div class="clima-kpi-label">Vento mÃ©dio: ${p?num(p,1)+" km/h":"-"}</div>\n      </div>\n    </div>\n\n    <div class="form-clima">\n      <h3>ğŸ“ Novo Registro ClimÃ¡tico</h3>\n      <form id="frmClima" class="formGrid">\n        <div><small>Data</small><input class="input" name="data" type="date" value="${nowISO()}" required></div>\n        <div><small>Fazenda</small><select class="select" name="fazendaId" required><option value="">Selecione...</option>${t.map(a=>`<option value="${a.id}">${escapeHtml(a.nome)}</option>`).join("")}</select></div>\n        <div><small>TalhÃ£o (opcional)</small><select class="select" name="talhaoId"><option value="">Geral</option>${e.map(a=>`<option value="${a.id}">${escapeHtml(a.nome)}</option>`).join("")}</select></div>\n        <div><small>Chuva (mm)</small><input class="input" name="chuvaMm" type="number" step="0.1" placeholder="0"></div>\n        <div><small>Temp MÃ¡x (Â°C)</small><input class="input" name="tempMax" type="number" step="0.1"></div>\n        <div><small>Temp MÃ­n (Â°C)</small><input class="input" name="tempMin" type="number" step="0.1"></div>\n        <div><small>Umidade (%)</small><input class="input" name="umidade" type="number" step="1"></div>\n        <div><small>Vento (km/h)</small><input class="input" name="vento" type="number" step="0.1"></div>\n        <div class="full"><small>ObservaÃ§Ãµes</small><textarea class="textarea" name="obs"></textarea></div>\n        <div class="full row" style="justify-content:flex-end">\n          <button class="btn primary" type="submit">Salvar Registro</button>\n        </div>\n      </form>\n    </div>\n\n    <div class="card">\n      <h4>ğŸ“ˆ DistribuiÃ§Ã£o Mensal de Chuvas</h4>\n      <div class="grafico-barras">\n        ${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"].map((a,t)=>`<div style="flex:1;text-align:center;"><div class="barra" style="height:${h[t]/v*180}px;"></div><div class="barra-label">${a}</div><div style="font-size:10px;color:#475569;">${num(h[t],1)} mm</div></div>`).join("")}\n      </div>\n    </div>\n\n    <div class="secao-tabela">\n      <div class="card">\n        <h4>ğŸ“‹ Ãšltimos 10 Registros</h4>\n        <div class="tableWrap">\n          <table>\n            <thead><tr><th>Data</th><th>Fazenda</th><th>TalhÃ£o</th><th>Chuva (mm)</th><th>Temp (Â°C)</th><th>Umidade (%)</th><th>AÃ§Ãµes</th></tr></thead>\n            <tbody>${n.slice(0,10).map(a=>{const n=findNameById(t,a.fazendaId),d=a.talhaoId?findNameById(e,a.talhaoId):"Geral";return`<tr><td>${a.data}</td><td>${escapeHtml(n)}</td><td>${escapeHtml(d)}</td><td><span class="valor-com-unidade">${num(a.chuvaMm||0,1)}</span><span class="unidade-tabela">mm</span></td><td>${a.tempMax?num(a.tempMax,1)+"Â°C":"-"}</td><td>${a.umidade?num(a.umidade,0)+"%":"-"}</td><td class="noPrint"><button class="btn danger" style="padding:4px 8px;" onclick="window.__delClima('${a.id}')">Excluir</button></td></tr>`}).join("")}</tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n\n    <div class="secao-tabela">\n      <div class="card">\n        <h4>ğŸŒ± Acumulado por TalhÃ£o</h4>\n        <div class="tableWrap">\n          <table>\n            <thead><tr><th>TalhÃ£o</th><th>Fazenda</th><th>Total Chuva (mm)</th><th>MÃ©dia (mm)</th><th>Ãšltima Chuva (mm)</th><th>Registros</th></tr></thead>\n            <tbody>${c.map(a=>`<tr><td><b>${escapeHtml(a.talhao)}</b></td><td>${escapeHtml(a.fazenda)}</td><td><span class="valor-com-unidade">${num(a.totalChuva,1)}</span><span class="unidade-tabela">mm</span></td><td>${num(a.media,1)} mm</td><td>${a.ultimaChuva>0?num(a.ultimaChuva,1)+" mm":"-"}</td><td>${a.registros}</td></tr>`).join("")}</tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n\n    <div class="secao-tabela">\n      <div class="card">\n        <h4>ğŸ¢ Acumulado por Fazenda</h4>\n        <div class="tableWrap">\n          <table>\n            <thead><tr><th>Fazenda</th><th>Total Chuva (mm)</th><th>MÃ©dia (mm)</th><th>Registros</th></tr></thead>\n            <tbody>${u.map(a=>`<tr><td><b>${escapeHtml(a.fazenda)}</b></td><td><span class="valor-com-unidade">${num(a.totalChuva,1)}</span><span class="unidade-tabela">mm</span></td><td>${num(a.media,1)} mm</td><td>${a.registros}</td></tr>`).join("")}</tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n  `,document.getElementById("frmClima").addEventListener("submit",a=>{a.preventDefault();const t=new FormData(a.target),e=t.get("data"),n=t.get("fazendaId");if(!n)return void alert("Selecione uma fazenda");const d={id:uid("cli"),safraId:getSafraId(),data:e,fazendaId:n,talhaoId:t.get("talhaoId")||"",chuvaMm:Number(t.get("chuvaMm")||0),tempMax:t.get("tempMax")?Number(t.get("tempMax")):null,tempMin:t.get("tempMin")?Number(t.get("tempMin")):null,umidade:t.get("umidade")?Number(t.get("umidade")):null,vento:t.get("vento")?Number(t.get("vento")):null,obs:t.get("obs")||""},i=getDB();i.clima=i.clima||[],i.clima.push(d),setDB(i),toast("Registro salvo","Dados climÃ¡ticos adicionados"),pageClima()}),window.__delClima=a=>{if(!confirm("Excluir este registro climÃ¡tico?"))return;const t=getDB();t.clima=(t.clima||[]).filter(t=>t.id!==a),setDB(t),toast("ExcluÃ­do","Registro removido"),pageClima()},document.getElementById("btnExportCSV").addEventListener("click",()=>{const a=n.map(a=>({Data:a.data,Fazenda:findNameById(t,a.fazendaId),"TalhÃ£o":a.talhaoId?findNameById(e,a.talhaoId):"Geral",Chuva_mm:a.chuvaMm||0,Temp_Max:a.tempMax||"",Temp_Min:a.tempMin||"",Umidade:a.umidade||"",Vento_kmh:a.vento||"",Observacoes:a.obs||""}));downloadText(`clima-${nowISO()}.csv`,toCSV(a)),toast("Exportado","CSV baixado")}),document.getElementById("btnImportClima").addEventListener("click",async()=>{const a=getDB(),t=onlySafra(a.fazendas);if(0===t.length)return void toast("Erro","Cadastre pelo menos uma fazenda primeiro.");toast("Carregando...","Buscando previsÃ£o do tempo...");let e="";for(const a of t){if(!a.latitude||!a.longitude)continue;const t=await buscarPrevisaoClima(a.id);t&&t.length>0&&(e+=`<div style="background:#f0f9ff; border:1px solid #0284c7; border-radius:8px; padding:15px; margin-top:15px;">\n          <h4 style="margin:0 0 10px 0; color:#0284c7;">ğŸŒ¤ï¸ PrevisÃ£o do Tempo â€” ${escapeHtml(a.nome)}</h4>\n          <p style="font-size:11px; color:#64748b; margin:0 0 10px 0;">ğŸ“ Lat: ${a.latitude} | Lon: ${a.longitude} â€” Dados: Open-Meteo (apenas consulta)</p>\n          <table style="width:100%; font-size:12px; border-collapse:collapse;">\n            <tr style="background:#e0f2fe;">\n              <th style="padding:8px; text-align:left;">Data</th>\n              <th style="padding:8px; text-align:center;">Temp Min</th>\n              <th style="padding:8px; text-align:center;">Temp Max</th>\n              <th style="padding:8px; text-align:center;">Chuva</th>\n              <th style="padding:8px; text-align:center;">Umidade</th>\n              <th style="padding:8px; text-align:center;">Vento</th>\n            </tr>`,t.slice(0,7).forEach(a=>{e+=`<tr style="border-bottom:1px solid #e0f2fe;">\n            <td style="padding:6px 8px;">${a.data}</td>\n            <td style="padding:6px 8px; text-align:center;">${a.tempMin?.toFixed(1)||"-"}Â°C</td>\n            <td style="padding:6px 8px; text-align:center;">${a.tempMax?.toFixed(1)||"-"}Â°C</td>\n            <td style="padding:6px 8px; text-align:center;">${a.chuva?.toFixed(1)||"0"}mm</td>\n            <td style="padding:6px 8px; text-align:center;">${a.umidade?.toFixed(0)||"-"}%</td>\n            <td style="padding:6px 8px; text-align:center;">${a.vento?.toFixed(1)||"-"}km/h</td>\n          </tr>`}),e+='</table>\n          <p style="font-size:11px; color:#b45309; margin:10px 0 0 0; background:#fef3c7; padding:6px 10px; border-radius:4px;">âš ï¸ Dados apenas para consulta. Registre a chuva e temperatura observadas manualmente em cada talhÃ£o.</p>\n        </div>')}if(e){const a=document.createElement("div");a.id="previsaoContainer",a.innerHTML=`<div class="card" style="margin-top:15px;">\n        <div style="display:flex; justify-content:space-between; align-items:center;">\n          <h3 style="margin:0;">ğŸŒ¤ï¸ PrevisÃ£o do Tempo (PrÃ³ximos 7 dias)</h3>\n          <button class="btn" onclick="document.getElementById('previsaoContainer').remove()" style="font-size:12px;">âœ• Fechar</button>\n        </div>\n        ${e}\n      </div>`;const t=document.getElementById("previsaoContainer");t&&t.remove(),document.getElementById("content").prepend(a),toast("PrevisÃ£o carregada","Dados apenas para consulta. Registre manualmente.")}else toast("Aviso","Nenhuma fazenda com coordenadas cadastradas.")})}