let _copilotMessages=[],_copilotTyping=!1;function _buildFullContext(){const e=getDB(),a=new Date,o=getSafraId?getSafraId():e.session?.safraId||null,t=e.safras?.find(e=>e.id===o),n=e=>(e||[]).filter(e=>!o||e.safraId===o||!e.safraId),s=(e,a=2)=>isNaN(Number(e))?"N/I":Number(e).toFixed(a),i=n(e.fazendas),r=n(e.talhoes),d=n(e.aplicacoes),l=n(e.estoque),c=n(e.colheitas),u=n(e.clima).sort((e,a)=>a.data?.localeCompare(e.data)),p=n(e.combustivel||e.dieselEntradas||[]),m=n(e.manutencoes),g=n(e.equipe),h=n(e.maquinas),$=(n(e.insumosBase),e.produtos||[]),f=e.parametros||{};let A=0,I=0;const N=r.map(e=>{const a=i.find(a=>a.id===e.fazendaId),o=(e=>{const a=Number(e.areaHa||0);return d.filter(a=>a.talhaoId===e.id).reduce((e,o)=>e+(o.produtos||[]).reduce((e,o)=>e+Number(o.quantidade||0)*Number(o.precoPorUnidade||0)*a,0),0)})(e);A+=o;const t=c.find(a=>a.talhaoId===e.id),n=Number(e.areaHa||0),s=(e.cultura||"").toLowerCase();let r=0,l=0,u=0;"soja"===s?(r=f.precoSoja||120,l=f.produtividadeMinSoja||65,u=f.produtividadeMaxSoja||75):"milho"===s?(r=f.precoMilho||60,l=f.produtividadeMinMilho||100,u=f.produtividadeMaxMilho||130):"sorgo"===s?(r=f.precoSorgo||42,l=f.produtividadeMinSorgo||70,u=f.produtividadeMaxSorgo||100):"feij√£o"===s||"feijao"===s?(r=f.precoFeijao||280,l=f.produtividadeMinFeijao||25,u=f.produtividadeMaxFeijao||40):"trigo"===s?(r=f.precoTrigo||85,l=f.produtividadeMinTrigo||40,u=f.produtividadeMaxTrigo||60):"arroz"===s?(r=f.precoArroz||60,l=f.produtividadeMinArroz||60,u=f.produtividadeMaxArroz||80):"caf√©"===s||"cafe"===s?(r=f.precoCafe||1200,l=f.produtividadeMinCafe||20,u=f.produtividadeMaxCafe||40):"algod√£o"!==s&&"algodao"!==s||(r=150,l=250,u=300);const p=n*l*r,m=n*u*r;return I+=(p+m)/2,{nome:e.nome,fazenda:a?.nome||"N/I",area:n,cultura:e.cultura,solo:e.solo,custo:o,receitaMin:p,receitaMax:m,colheita:t?`${t.producaoTotal} ${t.unidade} em ${t.dataColheita}`:null,ultimasAplicacoes:d.filter(a=>a.talhaoId===e.id).slice(-5).map(e=>`${e.data}: ${e.operacao||"Aplica√ß√£o"} ‚Äî ${(e.produtos||[]).map(e=>e.produtoNome).join(", ")} (alvo: ${e.alvo||"N/I"})`)}}),S=u.slice(0,7),v=S.length>0?S.map(e=>`${e.data}: üåß ${s(e.chuvaMm,1)}mm  üå° ${e.tempMin}-${e.tempMax}¬∞C  üíß ${e.umidade}%  üí® ${e.vento}km/h`).join("\n"):"Nenhum dado clim√°tico registrado",b=l.length>0?l.map(e=>{const a=$.find(a=>a.id===e.produtoId);return`${a?.nome||e.produtoNome||"Produto"}: ${e.qtd} ${e.unidade} (dep√≥sito: ${e.deposito||"N/I"})`}).join("\n"):"Estoque n√£o cadastrado",x=l.filter(e=>Number(e.qtd||0)<=Number(e.qtdMinima||0)&&Number(e.qtdMinima||0)>0),M=h.length>0?h.map(e=>`${e.nome} (${e.tipo||"N/I"}): ${e.horasUso||0}h, pr√≥x. manuten√ß√£o: ${e.proximaManutencao||"N/A"}`).join("\n"):"Nenhuma m√°quina cadastrada",C=m.filter(e=>"pendente"===e.status||"atrasado"===e.status),E=p.reduce((e,a)=>e+Number(a.litros||0),0),R=n(e.analiseSolo||[]).sort((e,a)=>(a.data||"").localeCompare(e.data||"")),T=R.length>0?R.slice(0,10).map(e=>{const a=r.find(a=>a.id===e.talhaoId);return`  Talh√£o: ${e.talhaoNome||a?.nome||"N/I"} | Data: ${e.data} | pH: ${e.ph??"N/I"} | V%: ${e.vPct??"N/I"} | M.O.: ${e.mo??"N/I"} g/dm¬≥ | P: ${e.p??"N/I"} | K: ${e.k??"N/I"} | Ca: ${e.ca??"N/I"} | Mg: ${e.mg??"N/I"} | CTC: ${e.ctc??"N/I"} | Textura: ${e.textura||"N/I"} | Calagem: ${e.recomCalagem?e.recomCalagem+" t/ha":"N/I"} | Rec: ${e.recomAdubacao||"N/I"}`}).join("\n"):"  Nenhuma an√°lise de solo registrada ainda.",y=n(e.folhaSalarial||[]),L=(()=>{const e=(new Date).toISOString().substring(0,7),a=y.filter(a=>(a.competencia||"").startsWith(e));return{bruto:a.reduce((e,a)=>e+Number(a.salarioBruto||0),0),liquido:a.reduce((e,a)=>e+Number(a.salarioLiquido||0),0),pendentes:a.filter(e=>"pago"!==e.status).reduce((e,a)=>e+Number(a.salarioLiquido||0),0),n:a.length}})(),O=g.length>0?g.map(e=>`${e.nome} (${e.cargo||e.funcao||"N/I"})`).join(", "):"Sem equipe cadastrada",_=planoAtual||localStorage.getItem("agro_plano")||"Free",q=(()=>{try{return JSON.parse(localStorage.getItem("agro_session")||"{}")}catch(e){return{}}})();return`Voc√™ √© o **Agro-Copilot**, assistente de intelig√™ncia artificial especializado em agronomia tropical brasileira, integrado ao sistema Agro Pro.\n\nSeu objetivo √© ajudar o produtor rural **${q?.user?.nome||q?.user?.email||"Produtor"}** a tomar decis√µes melhores com base nos dados reais da propriedade.\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìã DADOS COMPLETOS DA PROPRIEDADE ‚Äî SAFRA ATUAL\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüåæ SAFRA ATIVA:\n  ${t?`Nome: ${t.nome} | In√≠cio: ${t.dataInicio||"N/I"} | Fim: ${t.dataFim||"N/I"} | Obs: ${t.obs||""}`:"Nenhuma safra ativa selecionada"}\n\nüè° FAZENDAS (${i.length}):\n${i.map(e=>`  ‚Ä¢ ${e.nome} ‚Äî ${e.cidade||""}-${e.uf||""}, ${e.areaTotal||e.area||"?"}ha, lat/lon: ${e.latitude||"N/I"}/${e.longitude||"N/I"}`).join("\n")||"  Nenhuma fazenda cadastrada"}\n\nüå± TALH√ïES E CUSTOS (${r.length} talh√µes):\n${N.map((e,a)=>`  Talh√£o ${a+1}: "${e.nome}" | Fazenda: ${e.fazenda} | √Årea: ${e.area}ha | Cultura: ${e.cultura||"N/I"} | Solo: ${e.solo||"N/I"}\n    Custo acumulado: R$${s(e.custo)} | Receita est.: R$${s(e.receitaMin)}‚ÄìR$${s(e.receitaMax)}\n    ${e.colheita?`Colheita: ${e.colheita}`:"Sem colheita registrada"}\n    √öltimas aplica√ß√µes:\n${e.ultimasAplicacoes.length?e.ultimasAplicacoes.map(e=>`      - ${e}`).join("\n"):"      Nenhuma aplica√ß√£o"}`).join("\n\n")||"  Nenhum talh√£o cadastrado"}\n\nüìä RESUMO FINANCEIRO:\n  Custo total safra: R$${s(A)}\n  Receita estimada m√©dia: R$${s(I)}\n  Lucro projetado: R$${s(I-A)}\n\nüå¶ CLIMA RECENTE (√∫ltimos 7 dias):\n${v}\n\nüß™ ESTOQUE DE INSUMOS:\n${b}\n${x.length>0?`  ‚ö†Ô∏è ESTOQUE BAIXO: ${x.map(e=>e.produtoNome||e.produtoId).join(", ")}`:"  ‚úÖ Todos os estoques OK"}\n\nüöú M√ÅQUINAS E MANUTEN√á√ïES:\n${M}\n${C.length>0?`  ‚ö†Ô∏è MANUTEN√á√ïES PENDENTES: ${C.map(e=>e.descricao||e.tipo).join(", ")}`:"  ‚úÖ Nenhuma manuten√ß√£o pendente"}\n\n‚õΩ COMBUST√çVEL:\n  Total abastecido nesta safra: ${s(E,1)} litros\n\nüë• EQUIPE:\n  ${O}\n\nüí∞ FOLHA SALARIAL (m√™s atual):\n  Registros: ${L.n} | Bruto: R$${s(L.bruto)} | L√≠quido: R$${s(L.liquido)} | A pagar: R$${s(L.pendentes)}\n\nüî¨ AN√ÅLISE DE SOLO (${R.length} laudo(s) registrado(s)):\n${T}\n\nüí∞ PAR√ÇMETROS DE MERCADO:\n  Soja: R$${f.precoSoja||120}/sc | Prod: ${f.produtividadeMinSoja||65}‚Äì${f.produtividadeMaxSoja||75} sc/ha\n  Milho: R$${f.precoMilho||60}/sc | Prod: ${f.produtividadeMinMilho||100}‚Äì${f.produtividadeMaxMilho||130} sc/ha\n  Sorgo: R$${f.precoSorgo||42}/sc | Feij√£o: R$${f.precoFeijao||280}/sc | Trigo: R$${f.precoTrigo||85}/sc\n  Arroz: R$${f.precoArroz||60}/sc | Caf√©: R$${f.precoCafe||1200}/sc\n\nüì¶ PRODUTOS CADASTRADOS (${$.length}):\n${$.slice(0,20).map(e=>`  ‚Ä¢ ${e.nome} (${e.tipo||"N/I"}) ‚Äî R$${e.preco||"N/I"}/u ‚Äî Car√™ncia: ${e.carenciaDias||"?"}d`).join("\n")||"  Nenhum produto cadastrado"}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüß† BASE DE CONHECIMENTO AGRON√îMICO\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nFUNGICIDAS SOJA: Fox 0.75-1.0L/ha (Ferrugem, Nufarm R$86), Opera 0.5-0.75L/ha (Ferrugem, BASF R$121), Elatus 0.5-0.75L/ha (Ferrugem, Syngenta R$110), Tessior 0.5-0.75L/ha (Ferrugem, Bayer R$125), Priori 0.5-0.75L/ha (Ferrugem, Syngenta R$105), Mancozebe 1.5-2.0kg/ha (Mancha-alvo R$45), Headline 0.5-0.75L/ha (Mancha-alvo, BASF R$98), Amistar 0.5-0.75L/ha (Ferrugem, Syngenta R$112).\nINSETICIDAS: Engeo Pleno 0.5-1.0L/ha (Lagarta, Syngenta R$145), Ampligo 0.4-0.8L/ha (Lagarta, Syngenta R$130), Orthene 0.75-1.5kg/ha (Percevejo, UPL R$35), Decis 0.3-0.5L/ha (Lagarta, Bayer R$65), Actara 0.2-0.4kg/ha (Mosca-branca, Syngenta R$120), Karate 0.3-0.5L/ha (Lagarta, Syngenta R$72), Confidor 0.3-0.5L/ha (Pulg√£o, Bayer R$88).\nHERBICIDAS: Glifosato 2-4L/ha (Pr√©/P√≥s-emerg√™ncia, desseca√ß√£o), Roundup 2-3L/ha, Verdict 0.6-1.2L/ha (Gram√≠neas p√≥s), Select 0.5-1.0L/ha (Gram√≠neas).\n\nREGRAS CR√çTICAS:\n‚ùå Fungicida N√ÉO controla praga (lagarta, percevejo, √°caro, mosca-branca)\n‚ùå Inseticida N√ÉO controla doen√ßa f√∫ngica (ferrugem, mancha-alvo, antracnose)\n‚ö†Ô∏è N√£o aplicar com vento >12km/h (risco de deriva)\n‚ö†Ô∏è N√£o aplicar com chuva prevista nas pr√≥ximas 2-4h\n‚ö†Ô∏è Respeitar car√™ncia antes da colheita\n\nALERTAS CLIM√ÅTICOS PARA FERRUGEM ASI√ÅTICA: risco ALTO quando umidade >70% + temperatura 20-28¬∞C + chuvas frequentes. Janela de aplica√ß√£o: 90% de infec√ß√£o ocorre nos est√°dios R1-R3.\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìå SUAS RESPONSABILIDADES COMO AGRO-COPILOT\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n1. Responder perguntas do produtor sobre seus dados reais (custos, produ√ß√£o, clima, estoque).\n2. Identificar inconsist√™ncias (ex: fungicida usado para praga ‚Üí gerar alerta ‚ùå).\n3. Analisar dados clim√°ticos e alertar sobre riscos para a lavoura.\n4. Calcular estimativas de receita, custo e retorno por talh√£o.\n5. Alertar sobre estoque baixo, manuten√ß√µes pendentes e riscos clim√°ticos.\n6. Indicar no fim da resposta se o alerta deve ser enviado ao produtor.\n7. Sempre indicar no fim da resposta se o alerta deve ser enviado ao WhatsApp (formato JSON: {"whatsapp_alert": true, "mensagem": "..."}).\n8. Responder em portugu√™s brasileiro, de forma clara e direta, como um consultor agron√¥mico experiente.\n\n‚ö†Ô∏è AVISO OBRIGAT√ìRIO AO FINAL DE RECOMENDA√á√ïES DE DEFENSIVOS:\n"‚ö†Ô∏è Esta sugest√£o √© gerada por IA. Consulte sempre um agr√¥nomo habilitado antes de aplicar qualquer defensivo. Receita agron√¥mica √© obrigat√≥ria por lei."\n\nPlano do usu√°rio: ${_} | Data de hoje: ${a.toISOString().substring(0,10)}`}async function _callAI(e){const a={model:"gpt-4o",messages:[{role:"system",content:_buildFullContext()},..._copilotMessages.slice(-20).map(e=>({role:"bot"===e.role?"assistant":"user",content:e.text})),{role:"user",content:e}],max_tokens:2e3,temperature:.7};try{const e="undefined"!=typeof AuthService?await AuthService.getSession():null;if(e?.access_token&&"undefined"!=typeof SUPABASE_URL){const o=await fetch(SUPABASE_URL+"/functions/v1/openai-proxy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.access_token,apikey:"undefined"!=typeof SUPABASE_ANON?SUPABASE_ANON:""},body:JSON.stringify(a)});if(o.ok){const e=await o.json();return{ok:!0,text:e.choices?.[0]?.message?.content||"Sem resposta."}}const t=await o.json().catch(()=>({})),n=t.error?.message||t.error||`HTTP ${o.status}`;if(429===o.status)return{ok:!1,msg:"Limite de consultas por hora atingido. Aguarde alguns minutos."};if(401===o.status)return{ok:!1,msg:"Sess√£o expirada. Fa√ßa login novamente."};throw new Error(n)}}catch(a){return"TypeError"===a.name||a.message.includes("fetch")?_localFallbackAI(e):{ok:!1,msg:"Erro ao consultar IA: "+a.message}}return _localFallbackAI(e)}function _localFallbackAI(e){const a=getDB(),o=e.toLowerCase(),t=getSafraId?getSafraId():a.session?.safraId,n=e=>(e||[]).filter(e=>!t||e.safraId===t||!e.safraId),s=n(a.talhoes),i=n(a.aplicacoes),r=n(a.estoque),d=n(a.clima).sort((e,a)=>a.data?.localeCompare(e.data)).slice(0,7),l=n(a.colheitas),c=n(a.manutencoes);a.parametros;let u="";if(o.includes("custo")||o.includes("gasto")||o.includes("financeiro")||o.includes("lucro")||o.includes("receita")){let e=0;const a=s.map(a=>{const o=Number(a.areaHa||0),t=i.filter(e=>e.talhaoId===a.id).reduce((e,a)=>e+(a.produtos||[]).reduce((e,a)=>e+Number(a.quantidade||0)*Number(a.precoPorUnidade||0)*o,0),0);return e+=t,`‚Ä¢ **${a.nome}** (${a.cultura||"N/I"}, ${o}ha): R$${t.toFixed(2)}`});u=`## üí∞ An√°lise de Custos\n\n${a.join("\n")||"‚Ä¢ Nenhum talh√£o cadastrado"}\n\n**Total safra: R$${e.toFixed(2)}**\n\n`,l.length>0&&(u+=`### Colheitas registradas:\n${l.map(e=>`‚Ä¢ Talh√£o ${e.talhaoId}: ${e.producaoTotal} ${e.unidade}`).join("\n")}`)}else if(o.includes("clima")||o.includes("chuva")||o.includes("ferrugem")||o.includes("doen√ßa")||o.includes("doenca")||o.includes("fungo"))if(0===d.length)u="üì≠ Nenhum dado clim√°tico registrado. Cadastre as coordenadas da fazenda e importe o clima na p√°gina **Clima/Chuva** para receber an√°lises de risco.";else{const e=d.map(e=>Number(e.umidade||0)),a=d.map(e=>Number(e.chuvaMm||0)),o=e.reduce((e,a)=>e+a,0)/e.length,t=a.reduce((e,a)=>e+a,0),n=o>70?"üî¥ ALTO":o>55?"üü° M√âDIO":"üü¢ BAIXO";u=`## üå¶ An√°lise Clim√°tica (√∫ltimos ${d.length} dias)\n\n`,u+=d.map(e=>`‚Ä¢ **${e.data}**: üåß ${e.chuvaMm}mm | üå° ${e.tempMin}-${e.tempMax}¬∞C | üíß ${e.umidade}%`).join("\n"),u+=`\n\n**Chuva total: ${t.toFixed(1)}mm | Umidade m√©dia: ${o.toFixed(1)}%**\n\n`,u+=`### üçÑ Risco de Ferrugem Asi√°tica: ${n}\n`,o>70&&(u+="\n‚ö†Ô∏è **ALERTA**: Umidade acima de 70% ‚Äî condi√ß√µes favor√°veis para ferrugem. Avalie aplica√ß√£o preventiva de fungicida (Fox, Elatus, Opera).")}else if(o.includes("estoque")||o.includes("insumo")||o.includes("produto"))if(0===r.length)u="üì≠ Nenhum estoque cadastrado. Acesse **Produtos & Estoque** para registrar seus insumos.";else{const e=a.produtos||[];u="## üì¶ Estoque de Insumos\n\n",u+=r.map(a=>{const o=e.find(e=>e.id===a.produtoId),t=o?.nome||a.produtoNome||"Produto",n=Number(a.qtd||0),s=Number(a.qtdMinima||0);return`‚Ä¢ ${s>0&&n<=s?"‚ö†Ô∏è BAIXO":"‚úÖ"} **${t}**: ${n} ${a.unidade||"un"} ${s>0?`(m√≠n: ${s})`:""}`}).join("\n")}else if(o.includes("manuten√ß√£o")||o.includes("manutencao")||o.includes("m√°quina")||o.includes("maquina")){const e=c.filter(e=>"pendente"===e.status||"atrasado"===e.status);e.length>0?(u="## üîß Manuten√ß√µes Pendentes\n\n",u+=e.map(e=>`‚Ä¢ ‚ö†Ô∏è **${e.tipo||e.descricao}** ‚Äî M√°quina: ${e.maquinaId||"N/I"} ‚Äî Prevista: ${e.dataManutencao||"N/I"}`).join("\n")):u="‚úÖ Nenhuma manuten√ß√£o pendente no momento."}else if(o.includes("solo")||o.includes("ph")||o.includes("fertilidade")||o.includes("laudo")||o.includes("calagem")||o.includes("gessagem")||o.includes("v%")||o.includes("satura√ß√£o de bases")||o.includes("nutrientes")){const e=n(a.analiseSolo||[]).sort((e,a)=>(a.data||"").localeCompare(e.data||""));if(u="## üî¨ An√°lise de Solo\n\n",0===e.length)u+="Nenhuma an√°lise de solo registrada ainda.\n\nüëâ Acesse **An√°lise de Solo** no menu para registrar laudos de fertilidade.\nCom os dados do laudo, poderei fazer recomenda√ß√µes de calagem, gessagem e aduba√ß√£o de base personalizadas.";else{u+=`**${e.length} an√°lise(s) registrada(s):**\n\n`,e.slice(0,5).forEach(e=>{const a=e.ph<5.5?"‚ö†Ô∏è √Åcido":e.ph<=7?"‚úÖ Ideal":"üîµ Alcalino";u+=`‚Ä¢ **${e.talhaoNome||"N/I"}** (${e.data}): pH ${e.ph??"N/I"} ${a} | V%: ${e.vPct??"N/I"}% | M.O.: ${e.mo??"N/I"} g/dm¬≥\n`,e.recomCalagem&&(u+=`  üìå Calagem: ${e.recomCalagem} t/ha\n`)});const a=s.filter(a=>!e.find(e=>e.talhaoId===a.id));a.length>0&&(u+=`\n‚ö†Ô∏è **${a.length} talh√£o(√µes) sem an√°lise de solo:** ${a.map(e=>e.nome).join(", ")}`),u+="\n\nüëâ Acesse **An√°lise de Solo** para detalhes completos e recomenda√ß√µes por talh√£o."}}else if(o.includes("folha")||o.includes("salarial")||o.includes("sal√°rio")||o.includes("pagamento")||o.includes("funcion√°rio")||o.includes("inss")||o.includes("horas extras")){const e=n(a.folhaSalarial||[]),o=e.reduce((e,a)=>e+Number(a.salarioBruto||0),0),t=e.reduce((e,a)=>e+Number(a.salarioLiquido||0),0),s=e.filter(e=>"pago"!==e.status).reduce((e,a)=>e+Number(a.salarioLiquido||0),0);u="## üí∞ Folha Salarial\n\n",0===e.length?u+="Nenhum registro de folha salarial ainda.\n\nüëâ Acesse **Folha Salarial** no menu para lan√ßar pagamentos.":(u+=`**${e.length} registro(s)** de folha:\n\n`,u+=`‚Ä¢ üí∞ Total Bruto: **R$ ${o.toFixed(2).replace(".",",")}**\n`,u+=`‚Ä¢ ‚úÖ Total L√≠quido: **R$ ${t.toFixed(2).replace(".",",")}**\n`,u+=s>0?`‚Ä¢ ‚è≥ **A pagar: R$ ${s.toFixed(2).replace(".",",")}** ‚Äî h√° sal√°rios pendentes!\n`:"‚Ä¢ ‚úÖ Nenhum pagamento pendente.\n",u+="\nüëâ Acesse **Folha Salarial** para detalhes e marcar como pago.")}else if(o.includes("aplica√ß")||o.includes("aplicacao")||o.includes("defensivo")||o.includes("fungicida")||o.includes("inseticida")||o.includes("herbicida")){u="## üß™ √öltimas Aplica√ß√µes\n\n";const e=i.slice(-10).reverse();0===e.length?u+="Nenhuma aplica√ß√£o registrada nesta safra.":u+=e.map(e=>{const a=s.find(a=>a.id===e.talhaoId);return`‚Ä¢ **${e.data}** ‚Äî Talh√£o: ${a?.nome||"N/I"} ‚Äî ${e.operacao||"Aplica√ß√£o"} ‚Äî Produtos: ${(e.produtos||[]).map(e=>e.produtoNome).join(", ")||"N/I"} ‚Äî Alvo: ${e.alvo||"N/I"}`}).join("\n")}else if(o.includes("recomendar")||o.includes("recomenda√ß√£o")||o.includes("o que fazer")||o.includes("pr√≥ximo passo")||o.includes("proximo passo")){u="## üå± Recomenda√ß√µes Gerais\n\n";const e=c.filter(e=>"pendente"===e.status).length,a=r.filter(e=>Number(e.qtd||0)<=Number(e.qtdMinima||0)&&Number(e.qtdMinima||0)>0);if(e>0&&(u+=`üîß H√° **${e} manuten√ß√£o(√µes) pendente(s)** ‚Äî verifique em M√°quinas.\n`),a.length>0&&(u+=`üì¶ Estoque baixo para: **${a.map(e=>e.produtoNome||"Produto").join(", ")}**.\n`),d.length>0){const e=d.reduce((e,a)=>e+Number(a.umidade||0),0)/d.length;e>70&&(u+=`‚ö†Ô∏è Umidade m√©dia alta (${e.toFixed(0)}%) ‚Äî risco de ferrugem asi√°tica.\n`)}0===s.length&&(u+="üå± Cadastre seus talh√µes em **Minha Propriedade** para an√°lises detalhadas.\n"),u.includes("‚Ä¢")||u.includes("üîß")||u.includes("üì¶")||(u+="‚úÖ Tudo parece estar em ordem! Para an√°lises detalhadas por talh√£o, pergunte sobre um talh√£o espec√≠fico ou sobre custos, clima ou estoque.")}else if(s.some(e=>o.includes(e.nome?.toLowerCase()))){const e=s.find(e=>o.includes(e.nome?.toLowerCase())),a=i.filter(a=>a.talhaoId===e.id),t=l.find(a=>a.talhaoId===e.id);u=`## üå± Talh√£o: ${e.nome}\n\nCultura: **${e.cultura||"N/I"}** | √Årea: **${e.areaHa}ha** | Solo: ${e.solo||"N/I"}\n\n`,u+=`**${a.length} aplica√ß√µes** nesta safra.\n`,t&&(u+=`**Colheita**: ${t.producaoTotal} ${t.unidade} em ${t.dataColheita}\n`)}else u='Ol√°! Sou o **Agro-Copilot** ü§ñ\n\nPosso ajudar com:\n‚Ä¢ üí∞ An√°lise de custos e receita por talh√£o\n‚Ä¢ üå¶ Risco clim√°tico e ferrugem\n‚Ä¢ üì¶ Situa√ß√£o do estoque de insumos\n‚Ä¢ üîß Manuten√ß√µes pendentes\n‚Ä¢ üß™ Hist√≥rico de aplica√ß√µes\n\nTry: *"Qual o custo do talh√£o X?"*, *"Tem risco de ferrugem?"*, *"Como est√° meu estoque?"*\n\n'+(0===s.length?"‚ö†Ô∏è Cadastre safra, fazenda e talh√µes para an√°lises completas.":`Voc√™ tem **${s.length} talh√£o(√µes)** cadastrado(s).`);return{ok:!0,text:u,local:!0}}function _parseWhatsAppAlert(e){try{const a=e.match(/\{[\s\S]*"whatsapp_alert"\s*:\s*true[\s\S]*\}/);if(a){const e=JSON.parse(a[0]);if(e.whatsapp_alert&&e.mensagem)return e.mensagem}}catch(e){}return null}function _stripJsonBlock(e){return e.replace(/\{[\s\S]*"whatsapp_alert"\s*:\s*true[\s\S]*\}/g,"").trim()}function _sendWhatsAppAlert(e){const a=getDB(),o=(()=>{try{return JSON.parse(localStorage.getItem("agro_session")||"{}")}catch(e){return{}}})(),t=(o?.user?.phone||a?.meta?.whatsappAlertas||"").replace(/\D/g,""),n=`https://wa.me/${t.startsWith("55")?t:t.length>=10?"55"+t:"5599991360547"}?text=${encodeURIComponent(`ü§ñ *Agro-Copilot ‚Äî Alerta Autom√°tico*\n\n${e}\n\n_Enviado pelo Agro Pro em ${(new Date).toLocaleDateString("pt-BR")}_`)}`;window.open(n,"_blank"),toast("üì± WhatsApp","Abrindo WhatsApp com o alerta...",4e3)}function _gerarAlertasAutomaticos(){const e=getDB(),a=getSafraId?getSafraId():e.session?.safraId,o=e=>(e||[]).filter(e=>!a||e.safraId===a||!e.safraId),t=[],n=o(e.estoque),s=e.produtos||[];n.forEach(e=>{if(Number(e.qtdMinima||0)>0&&Number(e.qtd||0)<=Number(e.qtdMinima||0)){const a=s.find(a=>a.id===e.produtoId);t.push(`üì¶ *Estoque baixo*: ${a?.nome||e.produtoNome||"Produto"} com ${e.qtd} ${e.unidade} (m√≠nimo: ${e.qtdMinima}).`)}});const i=o(e.manutencoes).filter(e=>"pendente"===e.status||"atrasado"===e.status);i.length>0&&t.push(`üîß *Manuten√ß√µes pendentes*: ${i.length} servi√ßo(s) aguardando ‚Äî ${i.slice(0,3).map(e=>e.tipo||e.descricao).join(", ")}.`);const r=o(e.clima).sort((e,a)=>a.data?.localeCompare(e.data)).slice(0,5);if(r.length>=3){const e=r.reduce((e,a)=>e+Number(a.umidade||0),0)/r.length,a=r.reduce((e,a)=>e+Number(a.chuvaMm||0),0);e>75&&a>30&&t.push(`üå¶ *Alerta Clim√°tico*: Umidade m√©dia ${e.toFixed(0)}% e ${a.toFixed(1)}mm nos √∫ltimos ${r.length} dias ‚Äî risco ALTO de Ferrugem Asi√°tica. Avalie aplica√ß√£o de fungicida.`)}const d=o(e.aplicacoes),l="undefined"!=typeof defensivosDBExpandida?defensivosDBExpandida.fungicidas.map(e=>e.nome.toLowerCase()):[],c=["lagarta","percevejo","mosca-branca","√°caro","tripes","pulg√£o","acaro"],u=["ferrugem","mancha-alvo","antracnose","o√≠dio","oidio","cercospora"];return d.slice(-20).forEach(e=>{(e.produtos||[]).forEach(a=>{const o=(a.produtoNome||"").toLowerCase(),n=(e.alvo||"").toLowerCase(),s=l.includes(o),i=c.some(e=>n.includes(e));u.some(e=>n.includes(e)),s&&i&&t.push(`‚ùå *Aplica√ß√£o incorreta*: Fungicida "${a.produtoNome}" foi aplicado para "${e.alvo}" ‚Äî fungicidas n√£o controlam pragas!`)})}),t}function _renderMessage(e){const a="bot"===e.role,o=a?"ü§ñ":"üë®‚Äçüåæ",t=a?"msg bot":"msg user";let n=e.text.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^## (.*)/gm,'<h3 style="margin:8px 0 4px;font-size:15px;color:var(--brand,#2e7d32)">$1</h3>').replace(/^### (.*)/gm,'<h4 style="margin:6px 0 3px;font-size:13px;">$1</h4>').replace(/^‚Ä¢ (.*)/gm,"<li>$1</li>").replace(/\n/g,"<br>");return n=n.replace(/(<li>.*?<\/li>(<br>)?)+/gs,e=>`<ul style="margin:4px 0 4px 16px;padding:0;">${e.replace(/<br>/g,"")}</ul>`),`\n    <div class="${t}" style="display:flex; gap:10px; align-items:flex-start; max-width:90%;">\n      <div style="font-size:24px; flex-shrink:0; line-height:1;">${o}</div>\n      <div style="flex:1;">\n        <div style="background:${a?"var(--card-bg,white)":"var(--brand,#2e7d32)"}; color:${a?"var(--text,#334155)":"white"}; border-radius:${a?"4px 12px 12px 12px":"12px 4px 12px 12px"}; padding:12px 16px; border:${a?"1px solid var(--border,#e2e8f0)":"none"}; font-size:14px; line-height:1.6;">\n          ${n}\n        </div>\n        <div style="font-size:10px; color:var(--text-muted,#94a3b8); margin-top:3px; text-align:${a?"left":"right"};">${(new Date).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</div>\n      </div>\n    </div>`}function _scrollToBottom(){const e=document.getElementById("copilotMessages");e&&(e.scrollTop=e.scrollHeight)}function _addMessage(e,a){const o={role:e,text:a,ts:Date.now()};_copilotMessages.push(o);const t=document.getElementById("copilotMessages");return t&&(t.insertAdjacentHTML("beforeend",_renderMessage(o)),_scrollToBottom()),o}function _setTyping(e){_copilotTyping=e;const a=document.getElementById("copilotSendBtn"),o=document.getElementById("copilotInput");a&&(a.disabled=e,a.textContent=e?"‚åõ":"‚û§"),o&&(o.disabled=e);const t=document.getElementById("copilotTyping");if(e&&!t){const e=document.getElementById("copilotMessages");e&&(e.insertAdjacentHTML("beforeend",'\n        <div id="copilotTyping" style="display:flex; gap:10px; align-items:center; padding:8px 0;">\n          <span style="font-size:24px;">ü§ñ</span>\n          <div style="background:var(--card-bg,white); border:1px solid var(--border,#e2e8f0); border-radius:4px 12px 12px 12px; padding:12px 16px; font-size:13px; color:var(--text-muted,#94a3b8);">\n            <span class="copilot-dot">‚óè</span><span class="copilot-dot">‚óè</span><span class="copilot-dot">‚óè</span>\n            <style>\n              .copilot-dot { animation: copilotBlink 1.2s infinite; display:inline-block; margin:0 1px; }\n              .copilot-dot:nth-child(2) { animation-delay:.3s; }\n              .copilot-dot:nth-child(3) { animation-delay:.6s; }\n              @keyframes copilotBlink { 0%,80%,100%{opacity:.3} 40%{opacity:1} }\n            </style>\n          </div>\n        </div>'),_scrollToBottom())}else!e&&t&&t.remove()}async function _sendMessage(){if(_copilotTyping)return;const e=document.getElementById("copilotInput");if(!e)return;const a=e.value.trim();if(a){e.value="",_addMessage("user",a),_setTyping(!0);try{const e=await _callAI(a);if(_setTyping(!1),!e.ok)return void _addMessage("bot",`‚ùå Erro ao consultar a IA: ${e.msg||"Tente novamente."}\n\n_Modo offline ativo ‚Äî respostas baseadas em regras locais._`);let o=e.text;const t=_parseWhatsAppAlert(o);if(o=_stripJsonBlock(o),_addMessage("bot",o),t){const e=document.getElementById("copilotMessages");e&&(e.insertAdjacentHTML("beforeend",`\n          <div style="text-align:center; margin:8px 0;">\n            <button onclick="_sendWhatsAppAlert(${JSON.stringify(t).replace(/"/g,"&quot;")})"\n              style="background:#25d366; color:white; border:none; border-radius:8px; padding:8px 20px; font-size:13px; cursor:pointer; font-weight:600;">\n              üì± Enviar este alerta no WhatsApp\n            </button>\n          </div>`),_scrollToBottom())}if(e.local){const e=document.getElementById("copilotMessages");e&&e.insertAdjacentHTML("beforeend",'<div style="text-align:center; font-size:11px; color:var(--text-muted,#94a3b8); padding:4px;">üì¥ Modo offline ‚Äî resposta baseada em regras locais</div>')}}catch(e){_setTyping(!1),_addMessage("bot",`‚ùå Erro inesperado: ${e.message}`)}}}function pageCopilot(){document.getElementById("content").innerHTML=_renderIAComingSoon("Agro-Copilot","Seu assistente agron√¥mico com IA est√° sendo aprimorado para entregar ainda mais valor.",[{icon:"üí¨",title:"Chat Inteligente",desc:"Converse sobre sua safra e receba insights em tempo real"},{icon:"üîî",title:"Alertas Proativos",desc:"Receba avisos de clima, pragas e janelas de aplica√ß√£o"},{icon:"üìä",title:"An√°lise de Dados",desc:"IA analisa seus dados e sugere insights para sua safra"},{icon:"üì±",title:"WhatsApp Integrado",desc:"Receba alertas direto no seu celular via WhatsApp"}])}function _clearCopilotChat(){_copilotMessages=[];const e=document.getElementById("copilotMessages");e&&(e.innerHTML="",_addMessage("bot","Conversa reiniciada. Como posso ajudar?"))}function _sendWhatsAppAlerts(){const e=_gerarAlertasAutomaticos();0!==e.length?_sendWhatsAppAlert(`üåæ *Agro Pro ‚Äî Alertas da sua Propriedade*\n\n${e.join("\n\n")}\n\nüìÖ ${(new Date).toLocaleDateString("pt-BR")} √†s ${(new Date).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}`):toast("Sem alertas","Nenhum alerta autom√°tico no momento.",3e3)}async function analisarTalhaoIA(e){void 0!==pageCopilot&&(navigate("copilot"),setTimeout(async()=>{const a=(getDB().talhoes||[]).find(a=>a.id===e);if(!a)return;const o=document.getElementById("copilotInput");o&&(o.value=`Fa√ßa uma an√°lise completa do talh√£o "${a.nome}" ‚Äî custos, clima, aplica√ß√µes, risco de pragas e doen√ßas, e recomenda√ß√µes para os pr√≥ximos 14 dias.`,_sendMessage())},800))}