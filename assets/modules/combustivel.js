function pageCombustivel(){const t=getDB(),e=onlySafra(t.fazendas);let a=onlySafra(t.talhoes);fazendaAtual&&(a=a.filter(t=>t.fazendaId===fazendaAtual));const n=onlySafra(t.equipe),l=onlySafra(t.maquinas),s=onlySafra(t.dieselEstoque),d=onlySafra(t.dieselEntradas||[]).sort((t,e)=>e.data.localeCompare(t.data)),i=onlySafra(t.combustivel||[]).sort((t,e)=>e.data.localeCompare(t.data));setTopActions('\n    <button class="btn" id="btnExportCSV">ðŸ“¥ Exportar CSV</button>\n    <button class="btn" id="btnExportPDF" style="background:var(--brand,#2e7d32);color:white;">ðŸ“„ Gerar PDF</button>\n  ');const o=document.getElementById("content"),r=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],c=new Array(12).fill(0),m=new Array(12).fill(0);i.forEach(t=>{if(t.data){const e=parseInt(t.data.substring(5,7))-1;c[e]+=Number(t.litros||0)}}),d.forEach(t=>{if(t.data){const e=parseInt(t.data.substring(5,7))-1;m[e]+=Number(t.litros||0)}});const p=Math.max(...c,1),v=Math.max(...m,1),u=s.reduce((t,e)=>t+Number(e.litros||0),0),b=s[0]?.precoVigente||0;function h(t,e="nome"){return t.map(t=>`<option value="${t.id}">${escapeHtml(t[e]||"")}</option>`).join("")}const f=s.map(t=>`<option value="${escapeHtml(t.deposito||"Tanque Principal")}">${escapeHtml(t.deposito||"Tanque Principal")}</option>`).join("");o.innerHTML=`\n    <style>\n      .combustivel-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr 1fr;\n        gap: 15px;\n        margin-bottom: 20px;\n      }\n      .combustivel-card {\n        background: #ffffff;\n        border-radius: 12px;\n        padding: 20px;\n        border-left: 4px solid #3b82f6;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.05);\n      }\n      .combustivel-card h3 {\n        margin: 0 0 10px 0;\n        color: #3b82f6;\n        font-size: 16px;\n      }\n      .combustivel-valor {\n        font-size: 32px;\n        font-weight: bold;\n        color: #0f172a;\n      }\n      .combustivel-label {\n        color: #475569;\n        font-size: 12px;\n      }\n      .grafico-barras {\n        display: flex;\n        align-items: flex-end;\n        gap: 8px;\n        height: 150px;\n        margin: 15px 0;\n      }\n      .barra {\n        flex: 1;\n        background: #3b82f6;\n        border-radius: 4px 4px 0 0;\n        min-height: 20px;\n        transition: height 0.3s;\n      }\n      .barra-label {\n        text-align: center;\n        font-size: 10px;\n        color: #475569;\n        margin-top: 5px;\n      }\n    </style>\n\n    <div class="combustivel-grid">\n      <div class="combustivel-card">\n        <h3>â›½ Estoque Atual</h3>\n        <div class="combustivel-valor">${num(u,1)} L</div>\n        <div class="combustivel-label">${s.some(t=>t.litros<0)?'<span style="color:#f44336;">Negativo</span>':"DisponÃ­vel"}</div>\n      </div>\n      <div class="combustivel-card">\n        <h3>ðŸ’° PreÃ§o Vigente</h3>\n        <div class="combustivel-valor">${kbrl(b)}/L</div>\n        <div class="combustivel-label">Ãšltima entrada</div>\n      </div>\n      <div class="combustivel-card">\n        <h3>ðŸ“Š Total Abastecido</h3>\n        <div class="combustivel-valor">${num(i.reduce((t,e)=>t+Number(e.litros||0),0),1)} L</div>\n        <div class="combustivel-label">${i.length} operaÃ§Ãµes</div>\n      </div>\n    </div>\n\n    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">\n      <div class="card">\n        <h4>ðŸ“‰ Consumo Mensal de Diesel</h4>\n        <div class="grafico-barras">\n          ${r.map((t,e)=>`\n              <div style="flex:1; text-align:center;">\n                <div class="barra" style="height: ${c[e]/p*130}px;"></div>\n                <div class="barra-label">${t}</div>\n                <div style="font-size:9px; color:#475569;">${num(c[e],0)} L</div>\n              </div>\n            `).join("")}\n        </div>\n      </div>\n      <div class="card">\n        <h4>ðŸ“ˆ Entradas de Diesel</h4>\n        <div class="grafico-barras">\n          ${r.map((t,e)=>`\n              <div style="flex:1; text-align:center;">\n                <div class="barra" style="height: ${m[e]/v*130}px; background: #4CAF50;"></div>\n                <div class="barra-label">${t}</div>\n                <div style="font-size:9px; color:#475569;">${num(m[e],0)} L</div>\n              </div>\n            `).join("")}\n        </div>\n      </div>\n    </div>\n\n    <div class="section">\n      <div class="card">\n        <h3>â›½ Registrar entrada de diesel</h3>\n        <form id="frmEntrada" class="formGrid">\n          <div><small>Data</small><input class="input" name="data" placeholder="${nowISO()}" /></div>\n          <div class="full">\n            <small>DepÃ³sito / Tanque</small>\n            <select class="select" name="deposito">${f||'<option value="Tanque Principal">Tanque Principal</option>'}</select>\n          </div>\n          <div><small>Litros</small><input class="input" name="litros" type="number" step="0.1" placeholder="0" required /></div>\n          <div><small>PreÃ§o por litro (R$)</small><input class="input" name="precoLitro" type="number" step="0.01" placeholder="0" required /></div>\n          <div class="full"><small>ObservaÃ§Ãµes</small><textarea class="textarea" name="obs"></textarea></div>\n          <div class="full row" style="justify-content:flex-end">\n            <button class="btn primary" type="submit">Registrar entrada</button>\n          </div>\n        </form>\n      </div>\n\n      <div class="card">\n        <h3>ðŸšœ Registrar abastecimento (saÃ­da)</h3>\n        <form id="frmSaida" class="formGrid">\n          <div><small>Data</small><input class="input" name="data" placeholder="${nowISO()}" /></div>\n          <div class="full">\n            <small>DepÃ³sito / Tanque</small>\n            <select class="select" name="deposito">${f||'<option value="Tanque Principal">Tanque Principal</option>'}</select>\n          </div>\n          <div><small>Fazenda</small><select class="select" name="fazendaId" required>${h(e)}</select></div>\n          <div><small>TalhÃ£o (opcional)</small><select class="select" name="talhaoId"><option value="">(sem talhÃ£o)</option>${h(a)}</select></div>\n          <div><small>MÃ¡quina</small><select class="select" name="maquinaId"><option value="">(opcional)</option>${h(l)}</select></div>\n          <div><small>Operador</small><select class="select" name="operadorId"><option value="">(opcional)</option>${h(n)}</select></div>\n          <div><small>Litros</small><input class="input" name="litros" type="number" step="0.1" placeholder="0" required /></div>\n          <div><small>KM ou HorÃ­metro</small><input class="input" name="kmOuHora" type="number" step="0.1" placeholder="0" /></div>\n          <div><small>Posto</small><input class="input" name="posto" placeholder="Posto / NF / origem" /></div>\n          <div class="full"><small>ObservaÃ§Ãµes</small><textarea class="textarea" name="obs"></textarea></div>\n          <div class="full row" style="justify-content:flex-end">\n            <button class="btn primary" type="submit">Registrar saÃ­da</button>\n          </div>\n        </form>\n      </div>\n    </div>\n\n    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top:20px;">\n      <div class="tableWrap">\n        <h4>ðŸ“‹ Entradas de diesel</h4>\n        <table>\n          <thead>\n            <tr><th>Data</th><th>DepÃ³sito</th><th>Litros</th><th>PreÃ§o/L</th><th>Total</th><th>Obs</th></tr>\n          </thead>\n          <tbody>\n            ${d.map(t=>`\n              <tr>\n                <td>${t.data}</td>\n                <td>${escapeHtml(t.deposito)}</td>\n                <td>${num(t.litros,1)}</td>\n                <td>${kbrl(t.precoLitro)}</td>\n                <td>${kbrl(t.litros*t.precoLitro)}</td>\n                <td>${escapeHtml(t.obs||"")}</td>\n              </tr>\n            `).join("")||'<tr><td colspan="6">Sem entradas</td></tr>'}\n          </tbody>\n        </table>\n      </div>\n\n      <div class="tableWrap">\n        <h4>ðŸ“‹ Abastecimentos</h4>\n        <table>\n          <thead>\n            <tr><th>Data</th><th>Fazenda</th><th>TalhÃ£o</th><th>Litros</th><th>PreÃ§o/L</th><th>Custo</th></tr>\n          </thead>\n          <tbody id="tbodySaidas">\n            ${i.map(t=>{const n=findNameById(e,t.fazendaId),l=t.talhaoId?findNameById(a,t.talhaoId):"â€”";return`\n                <tr>\n                  <td>${t.data}</td>\n                  <td>${escapeHtml(n)}</td>\n                  <td>${escapeHtml(l)}</td>\n                  <td>${num(t.litros,1)}</td>\n                  <td>${kbrl(t.precoLitro)}</td>\n                  <td>${kbrl(t.litros*t.precoLitro)}</td>\n                </tr>\n              `}).join("")||'<tr><td colspan="6">Sem abastecimentos</td></tr>'}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  `,document.getElementById("frmEntrada").addEventListener("submit",t=>{t.preventDefault();const e=new FormData(t.target),a=Number(e.get("litros")||0);if(a<=0)return void alert("Litros deve ser > 0");const n=Number(e.get("precoLitro")||0);if(n<=0)return void alert("PreÃ§o deve ser > 0");const l=getDB();registrarEntradaDiesel(l,e.get("deposito")||"Tanque Principal",a,n,e.get("data")||nowISO(),e.get("obs")||""),setDB(l),t.target.reset(),toast("Entrada registrada","Diesel adicionado ao estoque."),pageCombustivel()}),document.getElementById("frmSaida").addEventListener("submit",t=>{t.preventDefault();const e=new FormData(t.target),a=Number(e.get("litros")||0);if(a<=0)return void alert("Litros deve ser > 0");const n=getDB(),l=e.get("deposito")||"Tanque Principal";if(!n.dieselEstoque.find(t=>t.safraId===getSafraId()&&t.deposito===l))return void alert("Tanque nÃ£o encontrado");const s=baixaDiesel(n,l,a);if(!s.ok)return void alert(s.msg);const d={id:uid("cmb"),safraId:getSafraId(),data:e.get("data")||nowISO(),tipo:"Diesel S10",deposito:l,posto:e.get("posto")||"",maquinaId:e.get("maquinaId")||"",operadorId:e.get("operadorId")||"",fazendaId:e.get("fazendaId"),talhaoId:e.get("talhaoId")||"",litros:a,precoLitro:s.precoLitro,kmOuHora:Number(e.get("kmOuHora")||0),obs:e.get("obs")||""};n.combustivel=n.combustivel||[],n.combustivel.push(d),setDB(n),t.target.reset(),toast("SaÃ­da registrada","Abastecimento concluÃ­do."),pageCombustivel()}),document.getElementById("btnExportCSV").addEventListener("click",()=>{const t=getDB();downloadText(`combustivel-${nowISO()}.csv`,toCSV(onlySafra(t.combustivel||[]))),toast("Exportado","CSV baixado.")}),document.getElementById("btnExportPDF").addEventListener("click",()=>{const t=d.reduce((t,e)=>t+Number(e.litros||0),0),e=d.reduce((t,e)=>t+Number(e.litros||0)*Number(e.precoLitro||0),0),s=i.reduce((t,e)=>t+Number(e.litros||0),0),o=i.reduce((t,e)=>t+Number(e.litros||0)*Number(e.precoLitro||0),0),r=t>0?e/t:0,c=`\n    <div class="pdf-kpi-grid">\n      <div class="pdf-kpi" style="border-left-color:#f97316;"><div class="label">Diesel Comprado</div><div class="value">${num(t,0)} L</div><div class="sub">${kbrl(e)}</div></div>\n      <div class="pdf-kpi" style="border-left-color:#3b82f6;"><div class="label">Diesel Consumido</div><div class="value">${num(s,0)} L</div><div class="sub">${kbrl(o)}</div></div>\n      <div class="pdf-kpi" style="border-left-color:#16a34a;"><div class="label">Preco Medio</div><div class="value">${kbrl(r)}/L</div></div>\n      <div class="pdf-kpi" style="border-left-color:#8b5cf6;"><div class="label">Saldo Estimado</div><div class="value">${num(t-s,0)} L</div></div>\n    </div>`,m=d.length>0?`\n    <div class="pdf-section-title">Entradas de Combustivel</div>\n    <table>\n      <thead><tr><th>#</th><th>Data</th><th>Litros</th><th>Preco/L</th><th>Total</th><th>Fornecedor</th><th>NF</th></tr></thead>\n      <tbody>\n        ${d.map((t,e)=>`<tr>\n          <td>${e+1}</td>\n          <td>${t.data||"â€”"}</td>\n          <td style="text-align:right;">${num(t.litros||0,1)}</td>\n          <td style="text-align:right;">${kbrl(t.precoLitro||0)}</td>\n          <td style="text-align:right;" class="text-bold">${kbrl((t.litros||0)*(t.precoLitro||0))}</td>\n          <td>${escapeHtml(t.fornecedor||"â€”")}</td>\n          <td>${escapeHtml(t.nf||"â€”")}</td>\n        </tr>`).join("")}\n        <tr class="total-row">\n          <td colspan="2"><b>TOTAL</b></td>\n          <td style="text-align:right;"><b>${num(t,0)} L</b></td>\n          <td></td>\n          <td style="text-align:right;"><b>${kbrl(e)}</b></td>\n          <td colspan="2"></td>\n        </tr>\n      </tbody>\n    </table>`:"",p=i.length>0?`\n    <div class="pdf-section-title">Saidas / Abastecimentos</div>\n    <table>\n      <thead><tr><th>#</th><th>Data</th><th>Maquina</th><th>Operador</th><th>Talhao</th><th>Litros</th><th>Horimetro</th><th>Obs.</th></tr></thead>\n      <tbody>\n        ${i.map((t,e)=>`<tr>\n          <td>${e+1}</td>\n          <td>${t.data||"â€”"}</td>\n          <td>${escapeHtml(findNameById(l,t.maquinaId))}</td>\n          <td>${escapeHtml(findNameById(n,t.operadorId))}</td>\n          <td>${escapeHtml(findNameById(a,t.talhaoId))}</td>\n          <td style="text-align:right;">${num(t.litros||0,1)}</td>\n          <td style="text-align:right;">${t.horimetro||"â€”"}</td>\n          <td style="font-size:9px;">${escapeHtml(t.obs||"â€”")}</td>\n        </tr>`).join("")}\n        <tr class="total-row">\n          <td colspan="5"><b>TOTAL</b></td>\n          <td style="text-align:right;"><b>${num(s,0)} L</b></td>\n          <td colspan="2"></td>\n        </tr>\n      </tbody>\n    </table>`:"";gerarPDF({titulo:"Relatorio de Combustivel",subtitulo:"Entradas, Saidas e Controle de Estoque Diesel",conteudoHTML:c+m+p,orientacao:"landscape"})})}