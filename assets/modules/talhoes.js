function pageTalhoes(){const t=getDB(),a=onlySafra(t.fazendas);function e(){const t=getDB();let a=onlySafra(t.talhoes||[]);fazendaAtual&&(a=a.filter(t=>t.fazendaId===fazendaAtual)),document.getElementById("tbody").innerHTML=a.slice().reverse().map(a=>{const e=findNameById(onlySafra(t.fazendas),a.fazendaId);return`\n        <tr>\n          <td><b>${escapeHtml(a.nome||"")}</b></td>\n          <td>${escapeHtml(e)}</td>\n          <td>${escapeHtml(num(a.areaHa||0,1))}</td>\n          <td>${escapeHtml(a.cultura||"")}</td>\n          <td>${escapeHtml(a.safra||"")}</td>\n          <td>${escapeHtml(a.solo||"")}</td>\n          <td class="noPrint"><button class="btn danger" onclick="window.__delTal('${a.id}')">Excluir</button></td>\n        </tr>\n      `}).join("")||'<tr><td colspan="7">Sem talhões.</td></tr>';const e=calcCustosPorTalhao(t);document.getElementById("tbodyCustos").innerHTML=e.map(t=>`\n      <tr>\n        <td><b>${escapeHtml(t.talhao)}</b></td>\n        <td>${escapeHtml(t.fazenda)}</td>\n        <td>${escapeHtml(num(t.areaHa||0,1))}</td>\n        <td><b>${escapeHtml(kbrl(t.custoTotal||0))}</b></td>\n        <td>${escapeHtml(kbrl(t.custoHa||0))}</td>\n        <td>${escapeHtml(String(t.ops||0))}</td>\n        <td>${escapeHtml(t.last||"-")}</td>\n      </tr>\n    `).join("")||'<tr><td colspan="7">Sem dados.</td></tr>'}setTopActions('<button class="btn" id="btnExportCSV">Exportar CSV</button>'),document.getElementById("content").innerHTML=`\n    <div class="section">\n      <div class="card">\n        <h3>Cadastrar talhão</h3>\n        <div class="help">Área, cultura, safra e dados de campo.</div>\n        <div class="hr"></div>\n        <form id="frm" class="formGrid">\n          <div class="full">\n            <small>Fazenda</small>\n            <select class="select" name="fazendaId" required>\n              ${a.map(t=>`<option value="${t.id}">${escapeHtml(t.nome)}</option>`).join("")}\n            </select>\n          </div>\n          <div><small>Nome do talhão</small><input class="input" name="nome" required></div>\n          <div><small>Área (ha)</small><input class="input" name="areaHa" type="number" step="0.1" placeholder="0"></div>\n          <div><small>Cultura</small><input class="input" name="cultura" placeholder="Soja"></div>\n          <div><small>Safra</small><input class="input" name="safra" placeholder="2025/26"></div>\n          <div class="full"><small>Solo</small><input class="input" name="solo" placeholder="Argiloso / Arenoso..."></div>\n          <div class="full"><small>Coordenadas/Geo</small><input class="input" name="coordenadas" placeholder="Opcional"></div>\n          <div class="full"><small>Observações</small><textarea class="textarea" name="observacoes"></textarea></div>\n          <div class="full row" style="justify-content:flex-end">\n            <button class="btn primary" type="submit">Salvar</button>\n          </div>\n        </form>\n      </div>\n\n      <div class="tableWrap">\n        <table>\n          <thead>\n            <tr>\n              <th>Talhão</th><th>Fazenda</th><th>Área (ha)</th><th>Cultura</th><th>Safra</th><th>Solo</th><th class="noPrint">Ações</th>\n            </tr>\n          </thead>\n          <tbody id="tbody"></tbody>\n        </table>\n      </div>\n    </div>\n\n    <div class="tableWrap" style="margin-top:12px">\n      <table>\n        <thead>\n          <tr><th colspan="7">Custo por talhão (acumulado)</th></tr>\n          <tr>\n            <th>Talhão</th><th>Fazenda</th><th>Área (ha)</th><th>Custo total</th><th>Custo/ha</th><th>Operações</th><th>Último</th>\n          </tr>\n        </thead>\n        <tbody id="tbodyCustos"></tbody>\n      </table>\n    </div>\n  `,window.__delTal=t=>{if(!confirm("Excluir este talhão?"))return;const a=getDB();a.talhoes=(a.talhoes||[]).filter(a=>a.id!==t),setDB(a),toast("Excluído","Talhão removido."),e()},document.getElementById("frm").addEventListener("submit",t=>{t.preventDefault();const a=new FormData(t.target),n={id:uid("tal"),safraId:getSafraId(),fazendaId:a.get("fazendaId"),nome:a.get("nome"),areaHa:Number(a.get("areaHa")||0),cultura:a.get("cultura")||"",safra:a.get("safra")||"",solo:a.get("solo")||"",coordenadas:a.get("coordenadas")||"",observacoes:a.get("observacoes")||""},l=getDB();l.talhoes=l.talhoes||[];const s={Trial:9999,"Básico":5,Pro:9999,Master:9999};l.talhoes.filter(t=>t.fazendaId===n.fazendaId).length>=s[planoAtual]?alert(`Limite de ${s[planoAtual]} talhões por fazenda atingido para o plano ${planoAtual}.`):(l.talhoes.push(n),setDB(l),t.target.reset(),toast("Salvo","Talhão adicionado."),e())}),document.getElementById("btnExportCSV").addEventListener("click",()=>{const t=getDB();downloadText(`talhoes-${nowISO()}.csv`,toCSV(onlySafra(t.talhoes||[]))),toast("Exportado","CSV baixado.")}),e()}