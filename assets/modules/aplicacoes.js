function pageAplicacoes(){const t=getDB(),e=onlySafra(t.fazendas);let a=onlySafra(t.talhoes);fazendaAtual&&(a=a.filter(t=>t.fazendaId===fazendaAtual));const n=onlySafra(t.equipe),o=onlySafra(t.maquinas),l=onlySafra(t.produtos);function d(t){return t.map(t=>`<option value="${t.id}">${escapeHtml(t.nome)}</option>`).join("")}function i(){return l.map(t=>`<option value="${t.id}" data-preco="${t.preco||0}" data-unidade="${t.unidade}">${escapeHtml(t.nome)} â€” ${escapeHtml(t.tipo)} (R$ ${t.preco||0}/${t.unidade})</option>`).join("")}setTopActions('\n    <button class="btn" id="btnExportCSV">Exportar CSV</button>\n    <button class="btn" id="btnExportPDF" style="background:var(--brand,#2e7d32);color:white;">ğŸ“„ Gerar PDF</button>\n  '),document.getElementById("content").innerHTML=`\n    <div class="section">\n      <div class="card">\n        <h3>ğŸ“ Registrar nova aplicaÃ§Ã£o</h3>\n        <div class="help">Preencha os dados da aplicaÃ§Ã£o. O custo total Ã© calculado automaticamente.</div>\n        <div class="hr"></div>\n        \n        <form id="frm" class="formGrid">\n          <div><small>ğŸ“… Data</small><input class="input" name="data" placeholder="${nowISO()}" /></div>\n          <div><small>ğŸ¢ Fazenda</small><select class="select" name="fazendaId" required>${d(e)}</select></div>\n          <div><small>ğŸ§­ TalhÃ£o</small><select class="select" name="talhaoId" required>${d(a)}</select></div>\n          <div><small>ğŸ“ Ãrea aplicada (ha)</small><input class="input" name="areaHaAplicada" type="number" step="0.1" required /></div>\n          <div><small>ğŸŒ± Cultura</small><input class="input" name="cultura" placeholder="Soja" /></div>\n          <div><small>ğŸ¯ Alvo</small><input class="input" name="alvo" placeholder="Praga / DoenÃ§a" /></div>\n          <div><small>ğŸšœ OperaÃ§Ã£o</small><input class="input" name="operacao" placeholder="PulverizaÃ§Ã£o" /></div>\n          <div><small>âš™ï¸ MÃ¡quina</small><select class="select" name="maquinaId"><option value="">(opcional)</option>${d(o)}</select></div>\n          <div><small>ğŸ‘¤ Operador</small><select class="select" name="operadorId"><option value="">(opcional)</option>${d(n)}</select></div>\n          <div><small>ğŸŒ¬ï¸ Vento (km/h)</small><input class="input" name="vento" type="number" /></div>\n          <div><small>ğŸŒ¡ï¸ Temperatura (Â°C)</small><input class="input" name="temp" type="number" /></div>\n          <div><small>ğŸ’§ Umidade (%)</small><input class="input" name="umidade" type="number" /></div>\n\n          <div class="full">\n            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">\n              <h4 style="margin:0;">ğŸ§ª Produtos aplicados</h4>\n              <button type="button" class="btn primary" id="btnAdicionarProduto" style="font-size:12px;">+ Adicionar produto</button>\n            </div>\n            <div class="help">Selecione o produto e informe a dose por hectare. O custo serÃ¡ somado automaticamente.</div>\n            <div class="hr"></div>\n            \n            <div id="produtos-container">\n              <div class="produto-linha" style="display:grid; grid-template-columns: 3fr 1fr 1fr 1fr; gap:10px; margin-bottom:10px; align-items:center;">\n                <select class="select" name="produtoId[]" onchange="window.atualizarPrecoUnit(this, 0)">\n                  <option value="">Selecione um produto...</option>\n                  ${i()}\n                </select>\n                <input class="input" name="dose[]" type="number" step="0.01" placeholder="Dose/ha" onchange="window.calcularCustoTotal()" />\n                <span class="badge" id="unidade-0" style="background:#2a2a30; padding:8px; text-align:center;">â€”</span>\n                <span class="badge" id="custo-0" style="background:#2a2a30; color:#4CAF50; padding:8px; text-align:center; font-weight:bold;">R$ 0,00</span>\n              </div>\n            </div>\n          </div>\n\n          <div class="full"><small>ğŸ“ ObservaÃ§Ãµes</small><textarea class="textarea" name="obs"></textarea></div>\n\n          <div class="full" style="margin-top:20px;">\n            <div style="background: linear-gradient(135deg, #1a2a3a, #0f1a24); padding:20px; border-radius:8px;">\n              <div style="display:flex; justify-content:space-between; align-items:center;">\n                <div>\n                  ${canSeeFinanceiro()?'<h4 style="margin:0; color:#888;">ğŸ’µ CUSTO TOTAL ESTIMADO</h4>\n                  <div style="font-size:32px; font-weight:bold; color:#4CAF50;" id="custoTotalDisplay">R$ 0,00</div>':'<h4 style="margin:0; color:#888;">Registro de AplicaÃ§Ã£o</h4>'}\n                </div>\n                <button class="btn primary" type="submit" style="font-size:16px; padding:12px 24px;">âœ… Salvar aplicaÃ§Ã£o</button>\n              </div>\n              <div style="margin-top:10px; font-size:12px; color:#888;" id="detalheCusto">Nenhum produto selecionado</div>\n            </div>\n          </div>\n        </form>\n      </div>\n\n      <div class="tableWrap" style="margin-top:20px;">\n        <h3>ğŸ“‹ Ãšltimas aplicaÃ§Ãµes</h3>\n        <table>\n          <thead><tr><th>Data</th><th>TalhÃ£o</th><th>Ãrea</th><th>Produtos</th>${canSeeFinanceiro()?"<th>Custo</th>":""}<th style="text-align:center;">AÃ§Ãµes</th></tr></thead>\n          <tbody id="tbody"></tbody>\n        </table>\n      </div>\n      <div id="pagination" class="row" style="justify-content:center; margin-top:15px; display:none;">\n        <button class="btn" id="btnCarregarMais">Carregar Mais</button>\n      </div>\n    </div>\n  `;let s=1;document.getElementById("btnAdicionarProduto").addEventListener("click",()=>{const t=document.getElementById("produtos-container"),e=document.createElement("div");e.className="produto-linha",e.classList.add("grid-dynamic-row"),e.innerHTML=`\n      <select class="select" name="produtoId[]" onchange="window.atualizarPrecoUnit(this, ${s})">\n        <option value="">Selecione um produto...</option>\n        ${i()}\n      </select>\n      <input class="input" name="dose[]" type="number" step="0.01" placeholder="Dose/ha" onchange="window.calcularCustoTotal()" />\n      <span class="badge" id="unidade-${s}" style="background:#2a2a30; padding:8px; text-align:center;">â€”</span>\n      <div style="display:flex; gap:5px;">\n        <span class="badge" id="custo-${s}" style="background:#2a2a30; color:#4CAF50; padding:8px; text-align:center; font-weight:bold; flex:1;">R$ 0,00</span>\n        <button type="button" class="btn danger" style="padding:8px;" onclick="removerLinhaProduto(this)">âœ•</button>\n      </div>\n    `,t.appendChild(e),s++}),window.removerLinhaProduto=t=>{document.querySelectorAll(".produto-linha").length<=1?toast("Aviso","Mantenha pelo menos um produto"):(t.closest(".produto-linha").remove(),window.calcularCustoTotal())},window.atualizarPrecoUnit=(t,e)=>{const a=t.options[t.selectedIndex].dataset.unidade||"";document.getElementById(`unidade-${e}`).innerText=a||"â€”",window.calcularCustoTotal()},window.calcularCustoTotal=()=>{let t=0;const e=parseFloat(document.querySelector('input[name="areaHaAplicada"]').value)||0,a=document.querySelectorAll(".produto-linha");let n=[];return a.forEach((a,o)=>{const l=a.querySelector('select[name="produtoId[]"]'),d=parseFloat(a.querySelector('input[name="dose[]"]').value)||0;if(l&&l.value&&d>0){const i=l.options[l.selectedIndex],s=parseFloat(i.dataset.preco)||0,r=i.text.split(" â€” ")[0],c=s*d*e;t+=c,a.querySelector(`#custo-${o}`).innerText=kbrl(c),a.querySelector(`#custo-${o}`).classList.add("text-success"),n.push(`${r}: ${num(d,2)} ${i.dataset.unidade||""} Ã— ${num(e,1)} ha = ${kbrl(c)}`)}else{const t=a.querySelector(`#custo-${o}`);t&&(t.innerText="R$ 0,00",t.classList.add("text-muted"))}}),document.getElementById("custoTotalDisplay").innerText=kbrl(t),document.getElementById("detalheCusto").innerHTML=n.length>0?n.join("<br>"):"Nenhum produto selecionado",t},document.querySelector('input[name="areaHaAplicada"]').addEventListener("input",window.calcularCustoTotal);let r=15;function c(){const t=getDB();let e=onlySafra(t.aplicacoes||[]);if(fazendaAtual){const a=onlySafra(t.talhoes||[]).filter(t=>t.fazendaId===fazendaAtual).map(t=>t.id);e=e.filter(t=>a.includes(t.talhaoId))}const n=e.length,o=e.slice().reverse().slice(0,r);document.getElementById("tbody").innerHTML=o.map(t=>{const e=findNameById(a,t.talhaoId),n=(t.produtos||[]).map(t=>t.produtoNome).join(" + ");return`<tr><td>${t.data}</td><td><b>${escapeHtml(e)}</b></td><td>${num(t.areaHaAplicada,1)} ha</td><td>${escapeHtml(n||"â€”")}</td>${canSeeFinanceiro()?`<td style="color:#4CAF50;">${kbrl(t.custoTotal)}</td>`:""}<td style="text-align:center;">${canDeleteOnPage("aplicacoes")?`<button class="btn danger" style="padding:4px 8px;" onclick="window.__delA('${t.id}')">Excluir</button>`:"â€”"}</td></tr>`}).join("")||'<tr><td colspan="6" style="text-align:center;">Nenhuma aplicaÃ§Ã£o registrada</td></tr>';const l=document.getElementById("pagination");n>r?(l.style.display="flex",document.getElementById("btnCarregarMais").innerHTML=`Carregar Mais (${r} de ${n})`,document.getElementById("btnCarregarMais").onclick=()=>{r+=15,c()}):l.style.display="none"}window.__delA=t=>{if(!canDeleteOnPage("aplicacoes"))return void toast("Sem permissÃ£o","Seu perfil nÃ£o permite excluir.");if(!confirm("Excluir esta aplicaÃ§Ã£o?"))return;const e=getDB();e.aplicacoes=e.aplicacoes.filter(e=>e.id!==t),setDB(e),toast("ExcluÃ­da","AplicaÃ§Ã£o removida"),c()},document.getElementById("frm").addEventListener("submit",t=>{t.preventDefault();const e=new FormData(t.target),a=Number(e.get("areaHaAplicada")||0);if(a<=0)return void alert("Ãrea deve ser > 0");const n=[],o=e.getAll("produtoId[]").filter(t=>t),d=e.getAll("dose[]").map(t=>Number(t)||0);for(let t=0;t<o.length;t++)if(o[t]&&d[t]>0){const e=l.find(e=>e.id===o[t]);e&&n.push({produtoId:e.id,produtoNome:e.nome,dosePorHa:d[t],unidade:e.unidade,precoUnit:e.preco||0})}if(0===n.length)return void alert("Selecione pelo menos um produto com dose vÃ¡lida");const i=n.reduce((t,e)=>t+e.precoUnit*e.dosePorHa*a,0),r={id:uid("apl"),safraId:getSafraId(),data:e.get("data")||nowISO(),fazendaId:e.get("fazendaId"),talhaoId:e.get("talhaoId"),areaHaAplicada:a,cultura:e.get("cultura")||"",alvo:e.get("alvo")||"",operacao:e.get("operacao")||"",maquinaId:e.get("maquinaId")||"",operadorId:e.get("operadorId")||"",condicoes:{vento:Number(e.get("vento")||0),temp:Number(e.get("temp")||0),umidade:Number(e.get("umidade")||0)},produtos:n,custoTotal:i,obs:e.get("obs")||""},u=getDB();u.aplicacoes=u.aplicacoes||[],u.aplicacoes.push(r);const p=[];for(const t of n){const e=t.dosePorHa*a,n=baixaEstoqueProdutoPorId(u,t.produtoId,e,t.unidade);n.ok&&p.push(n.msg)}setDB(u),t.target.reset(),document.querySelectorAll(".produto-linha").forEach((t,e)=>{e>0?t.remove():(t.querySelector("select").value="",t.querySelector('input[name="dose[]"]').value="",document.getElementById("unidade-0").innerText="â€”",document.getElementById("custo-0").innerText="R$ 0,00")}),s=1,window.calcularCustoTotal(),toast("Salvo","AplicaÃ§Ã£o registrada. Baixa no estoque."),p.length&&toast("Baixas",p.slice(0,3).join(" â€¢ ")),c()}),document.getElementById("btnExportCSV").addEventListener("click",()=>{const t=getDB();downloadText(`aplicacoes-${nowISO()}.csv`,toCSV(onlySafra(t.aplicacoes||[])))}),document.getElementById("btnExportPDF").addEventListener("click",()=>{const t=getDB(),e=onlySafra(t.aplicacoes||[]).sort((t,e)=>(e.data||"").localeCompare(t.data||"")),l=e.reduce((t,e)=>t+Number(e.custoTotal||0),0),d=e.reduce((t,e)=>t+Number(e.areaHaAplicada||0),0),i={};e.forEach(t=>{(t.produtos||[]).forEach(t=>{i[t.produtoNome]=(i[t.produtoNome]||0)+1})});const s=Object.entries(i).sort((t,e)=>e[1]-t[1]).slice(0,10),r=`\n    <div class="pdf-kpi-grid">\n      <div class="pdf-kpi" style="border-left-color:#3b82f6;"><div class="label">Total Aplicacoes</div><div class="value">${e.length}</div></div>\n      <div class="pdf-kpi" style="border-left-color:#16a34a;"><div class="label">Area Total Aplicada</div><div class="value">${num(d,1)} ha</div></div>\n      <div class="pdf-kpi" style="border-left-color:#f59e0b;"><div class="label">Custo Total</div><div class="value">${kbrl(l)}</div></div>\n      <div class="pdf-kpi" style="border-left-color:#8b5cf6;"><div class="label">Custo Medio</div><div class="value">${kbrl(e.length>0?l/e.length:0)}</div><div class="sub">por aplicacao</div></div>\n    </div>`,c=e.length>0?`\n    <div class="pdf-section-title">Detalhamento das Aplicacoes</div>\n    <table>\n      <thead><tr><th>#</th><th>Data</th><th>Talhao</th><th>Tipo</th><th>Produtos</th><th>Area (ha)</th><th>Maquina</th><th>Operador</th><th>Custo Total</th><th>Obs.</th></tr></thead>\n      <tbody>\n        ${e.map((t,e)=>{const l=(t.produtos||[]).map(t=>`${t.produtoNome} (${t.dose} ${t.unidade})`).join(", ")||"â€”";return`<tr>\n            <td>${e+1}</td>\n            <td>${t.data||"â€”"}</td>\n            <td><b>${escapeHtml(findNameById(a,t.talhaoId))}</b></td>\n            <td>${escapeHtml(t.tipoAplicacao||"â€”")}</td>\n            <td style="font-size:9px;">${escapeHtml(l)}</td>\n            <td style="text-align:right;">${num(t.areaHaAplicada||0,1)}</td>\n            <td style="font-size:9px;">${escapeHtml(findNameById(o,t.maquinaId))}</td>\n            <td style="font-size:9px;">${escapeHtml(findNameById(n,t.operadorId))}</td>\n            <td style="text-align:right;" class="text-bold">${kbrl(t.custoTotal||0)}</td>\n            <td style="font-size:9px;">${escapeHtml(t.obs||"â€”")}</td>\n          </tr>`}).join("")}\n        <tr class="total-row">\n          <td colspan="5"><b>TOTAL</b></td>\n          <td style="text-align:right;"><b>${num(d,1)} ha</b></td>\n          <td colspan="2"></td>\n          <td style="text-align:right;"><b>${kbrl(l)}</b></td>\n          <td></td>\n        </tr>\n      </tbody>\n    </table>`:'<p style="color:#94a3b8;">Nenhuma aplicacao registrada.</p>',u=s.length>0?`\n    <div class="pdf-section-title">Top 10 Produtos Mais Utilizados</div>\n    <table>\n      <thead><tr><th>Produto</th><th>Vezes Utilizado</th><th>% das Aplicacoes</th></tr></thead>\n      <tbody>\n        ${s.map(([t,a])=>`<tr>\n          <td><b>${escapeHtml(t)}</b></td>\n          <td style="text-align:center;">${a}</td>\n          <td style="text-align:right;">${e.length>0?(a/e.length*100).toFixed(1):0}%</td>\n        </tr>`).join("")}\n      </tbody>\n    </table>`:"";gerarPDF({titulo:"Relatorio de Aplicacoes",subtitulo:"Defensivos, Produtos e Custos por Talhao",conteudoHTML:r+c+u,orientacao:"landscape"})}),c()}window.setPlano=async t=>{if(localStorage.removeItem("agro_trial"),trialInfo=null,localStorage.setItem("agro_plano",t),planoAtual=t,"undefined"!=typeof AuthService&&"function"==typeof isSupabaseReady&&isSupabaseReady())try{const e={Free:"free",Pro:"pro",Master:"master"};await AuthService.updateProfile({plan_type:e[t]||"free"})}catch(t){}location.reload()};