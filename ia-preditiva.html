<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Agro Pro - IA Preditiva</title>
  <link rel="stylesheet" href="style.css">
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
      <!-- 1. Supabase SDK (CDN UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <!-- 2. Supabase Client -->
    <script src="assets/supabase-client.js?v=8.4"></script>

    <!-- 3. Módulos da aplicação (ordem de dependência) -->
    <script src="assets/modules/core.js?v=8.4"></script>
    <script src="assets/modules/shell.js?v=8.4"></script>
    <script src="assets/modules/login.js?v=8.4"></script>
    <script src="assets/modules/safras.js?v=8.4"></script>
    <script src="assets/modules/dashboard.js?v=8.4"></script>
    <script src="assets/modules/centralgestao.js?v=8.4"></script>
    <script src="assets/modules/fazendas.js?v=8.4"></script>
    <script src="assets/modules/talhoes.js?v=8.4"></script>
    <script src="assets/modules/produtos.js?v=8.4"></script>
    <script src="assets/modules/estoque.js?v=8.4"></script>
    <script src="assets/modules/insumosbase.js?v=8.4"></script>
    <script src="assets/modules/aplicacoes.js?v=8.4"></script>
    <script src="assets/modules/combustivel.js?v=8.4"></script>
    <script src="assets/modules/clima.js?v=8.4"></script>
    <script src="assets/modules/colheitas.js?v=8.4"></script>
    <script src="assets/modules/manutencao.js?v=8.4"></script>
    <script src="assets/modules/equipe.js?v=8.4"></script>
    <script src="assets/modules/maquinas.js?v=8.4"></script>
    <script src="assets/modules/relatorios.js?v=8.4"></script>
    <script src="assets/modules/configuracoes.js?v=8.4"></script>
    <script src="assets/modules/ajuda.js?v=8.4"></script>
    <script src="assets/modules/ia-helpers.js?v=8.4"></script>
    <script src="assets/modules/defensivos.js?v=8.4"></script>
    <script src="assets/modules/copilot.js?v=8.4"></script>

    <!-- 4. Inicializador / Router (último) -->
    <script src="assets/modules/app-init.js?v=8.4"></script>
</head>
<body>
  <div id="app"></div>

  <script>
    // Renderiza o shell da aplicação
    renderShell("ia", "IA Preditiva", "Análises inteligentes para manejo agrícola");

    // Função da página IA Preditiva
    function pageIA(){
      const db = getDB();
      const ia = new IAPredictiva(db);
      const talhoes = onlyEmpresa(db.talhoes);

      if(talhoes.length === 0){
        document.getElementById("content").innerHTML = `
          <div class="section">
            <div class="card">
              <h3>IA Preditiva</h3>
              <p>Nenhum talhão cadastrado na empresa ativa.</p>
            </div>
          </div>
        `;
        return;
      }

      let html = `<div class="section">
        <div class="card">
          <h3>Análises de IA Preditiva</h3>
          <div class="help">Resultados de produtividade, risco de pragas e janela ideal de aplicação.</div>
          <div class="hr"></div>
          <div class="formGrid">`;

      talhoes.forEach(t => {
        const prod = ia.preverProdutividade(t.id, t.safra);
        const pragas = ia.preverRiscoPragas(t.id);
        const janela = ia.calcularJanelaIdeal(t.id);

        html += `
          <div class="full">
            <h4>Talhão ${escapeHtml(t.nome)} (${escapeHtml(t.cultura)})</h4>
            <p><b>Produtividade estimada:</b> ${num(prod.produtividadeEstimada,1)} sc/ha</p>
            <p><b>Risco geral de pragas:</b> ${num(pragas.riscoGeral,1)}%</p>
            <p><b>Melhor janela de aplicação:</b> ${janela.recomendacao}</p>
            ${prod.alertas.map(a=>`<p class="pill danger">${escapeHtml(a.mensagem)} - ${escapeHtml(a.acao)}</p>`).join("")}
            ${pragas.alertas.map(a=>`<p class="pill danger">${escapeHtml(a.mensagem)} - ${escapeHtml(a.acao)}</p>`).join("")}
            ${janela.alertas.map(a=>`<p class="pill warning">${escapeHtml(a.mensagem)} - ${escapeHtml(a.detalhe)}</p>`).join("")}
          </div>
        `;
      });

      html += `</div></div></div>`;
      document.getElementById("content").innerHTML = html;
    }

    // Chama a função da página
    pageIA();
  </script>
</body>
</html>